function PA_Step4JobView(){this.name="PA_Step4JobView";this.items=[];this.pathwayViews=[];this.currentView=null;this.showPathwayView=function(pathwayID){var pathwaysPanelsContainer=this.getComponent().queryById("pathwaysPanelsContainer");if(this.currentView!==null){pathwaysPanelsContainer.remove(this.currentView.getComponent(),false)}this.currentView=this.getPathwayView(pathwayID)||this.addPathwayView(pathwayID);pathwaysPanelsContainer.add(this.currentView.getComponent());return this.currentView};this.getPathwayView=function(pathwayID){for(var i in this.pathwayViews){if(this.pathwayViews[i].getModel().getID()===pathwayID){return this.pathwayViews[i]}}return null};this.addPathwayView=function(pathwayID){var me=this;var pathwayModel=this.getModel().getPathway(pathwayID);var pathwayView=new PA_Step4PathwayView;pathwayView.setParent(this);pathwayView.setController(application.getController("PathwayController"));pathwayView.loadModel(pathwayModel);this.pathwayViews.push(pathwayView);if(this.pathwayViews.length>MAX_PATHWAYS_OPENED){console.info("Removing a pathway");var previous_view=this.pathwayViews.shift();previous_view.getComponent().destroy()}$("#pathwayHistoryContainer > div").prepend(this.createThumbnail(pathwayID,pathwayView.getModel().getName())).children("#"+pathwayID+"_thumb").click(function(){$(this).prependTo($("#pathwayHistoryContainer > div"));me.showPathwayView($(this).attr("id").replace("_thumb",""));me.toogleHistoryPanel(true)});if($("#pathwayHistoryContainer .step4ThumbContainer").length>8){$("#pathwayHistoryContainer .step4ThumbContainer:gt(7)").remove()}return pathwayView};this.createThumbnail=function(pathwayID,pathwayName){return'<div class="step4ThumbContainer" id="'+pathwayID+'_thumb">'+'    <div class="step4PathwayThumbnailHover">Open</div>'+'    <div class="step4ThumbTitleContainer">'+pathwayName+"</div>"+'    <div class="step4ThumbWrapper" style="background-image: url(\''+location.pathname+"kegg_data/"+pathwayID+"_thumb')\"></div>"+"   </div>"};this.toogleHistoryPanel=function(forceHide){forceHide=forceHide||false;var currentLeft=$("#pathwayHistoryContainer").css("left");$("#pathwayHistoryContainer").css({left:currentLeft==="0px"||forceHide?"-405px":"0px"});return this};this.backButtonHandler=function(){this.toogleHistoryPanel(true);this.controller.showJobInstance(this.getModel(),{doUpdate:false});return this};this.initComponent=function(){var me=this;this.component=Ext.widget({xtype:"container",id:"pathwaysPanelsWrapper",flex:1,layout:{type:"vbox",pack:"start",align:"stretch"},items:[{xtype:"container",cls:"toolbar secondTopToolbar",items:[{xtype:"box",html:'<a href="javascript:void(0)" class="button btn-danger helpTip" id="visualSettingsButton"><i class="fa fa-wrench"></i> Settings</a>'+'<a href="javascript:void(0)" class="button btn-info helpTip" id="searchButton"><i class="fa fa-search"></i> Search</a>'+'<a href="javascript:void(0)" class="button btn-secondary helpTip" id="globalHeatmapButton"><i class="fa fa-th"></i> Show Heatmap</a>'+'<a href="javascript:void(0)" class="button btn-primary helpTip" id="showPathwayButton"><i class="fa fa-sitemap"></i>  Show Pathway</a></div>'+'<a href="javascript:void(0)" class="button btn-default backButton"><i class="fa fa-arrow-left"></i> Go back</a>'+'<a href="javascript:void(0)" class="button helpTip" style=" float: left; background-color: #D66379; color: #fff;" id="showHistoryButton"><i class="fa fa-history"></i> History</a>'+'<div id="pathwayHistoryContainer" class="step4HistoryBox"><h2>History</h2><div></div></div>'}]},{xtype:"container",flex:1,style:"padding: 5px 10px;",itemId:"pathwaysPanelsContainer",layout:"fit",items:[]}],listeners:{boxready:function(){$(".backButton").click(function(){me.backButtonHandler()});$("#showPathwayButton").click(function(){me.currentView.showDiagramPanel()});$("#globalHeatmapButton").click(function(){me.currentView.showGlobalHeatmap()});$("#searchButton").click(function(){me.currentView.showFindFeaturesPanel()});$("#visualSettingsButton").click(function(){me.currentView.showVisualOptionsPanel()});$("#showHistoryButton").click(function(){me.toogleHistoryPanel()});initializeTooltips(".helpTip")},beforedestroy:function(){for(var i in this.pathwayViews){this.pathwayViews[i].getComponent().destroy();delete this.pathwayViews[i]}me.getModel().deleteObserver(me)}}});return this.component};return this}PA_Step4JobView.prototype=new View;function PA_Step4PathwayView(){this.name="PA_Step4PathwayView";this.visualOptions=null;this.dataDistributionSummaries=null;this.searchFeatureIndex=null;this.diagramPanel=null;this.globalHeatmapView=null;this.featureSetDetailsPanel=null;this.findFeaturesPanel=null;this.visualOptionsPanel=null;this.loadModel=function(model){if(this.model!=null){this.model.deleteObserver(this)}this.model=model;this.model.addObserver(this);if(window.sessionStorage&&sessionStorage.getItem("visualOptions")!==null){this.visualOptions=JSON.parse(sessionStorage.getItem("visualOptions"))}else{this.visualOptions={}}var update=false;if(!this.visualOptions.colorReferences){this.visualOptions.colorReferences=this.model.getGraphicalOptions().getColorReferences();update=true}if(!this.visualOptions.visibleOmics){this.visualOptions.visibleOmics=this.model.getGraphicalOptions().getVisibleOmics();update=true}if(!this.visualOptions.colorScale){this.visualOptions.colorScale=this.model.getGraphicalOptions().getColorScale();update=true}if(update){this.getParent().getController().updateStoredVisualOptions(this.getParent().getModel().getJobID(),this.visualOptions)}this.showDiagramPanel();this.showFindFeaturesPanel();return this};this.getDataDistributionSummaries=function(propertyName){if(this.dataDistributionSummaries===null){this.dataDistributionSummaries=this.getParent().getModel().getDataDistributionSummaries()}if(this.dataDistributionSummaries!==null&&propertyName!==undefined){return this.dataDistributionSummaries[propertyName]}return this.dataDistributionSummaries};this.getVisualOptions=function(propertyName){if(this.visualOptions!==null&&propertyName!==undefined){return this.visualOptions[propertyName]}return this.visualOptions};this.setVisualOptions=function(propertyName,value){this.visualOptions[propertyName]=value};this.getOmicsValues=function(){return this.getParent().getModel().getOmicsValues()};this.getGeneBasedInputOmics=function(){return this.getParent().getModel().getGeneBasedInputOmics()};this.getCompoundBasedInputOmics=function(){return this.getParent().getModel().getCompoundBasedInputOmics()};this.showDiagramPanel=function(){if(this.diagramPanel===null){this.diagramPanel=new PA_Step4KeggDiagramView;this.diagramPanel.setParent(this);this.searchFeatureIndex=this.diagramPanel.loadModel(this.getModel());this.getComponent().add(this.diagramPanel.getComponent())}this.diagramPanel.toggle(true)};this.hideDiagramPanel=function(destroy){if(this.diagramPanel!==null){this.diagramPanel.toggle(false);if(destroy===true){this.diagramPanel.getComponent().destroy();this.diagramPanel=null}}};this.showFindFeaturesPanel=function(){this.hideVisualOptionsPanel();if(this.findFeaturesPanel===null){this.findFeaturesPanel=new PA_Step4FindFeaturesView;this.findFeaturesPanel.setParent(this);this.findFeaturesPanel.loadModel(this.getModel());this.getComponent().add(this.findFeaturesPanel.getComponent())}this.findFeaturesPanel.toggle(true);this.adjustChildrenWidth()};this.hideFindFeaturesPanel=function(destroy){if(this.findFeaturesPanel!==null){this.findFeaturesPanel.toggle(false);if(destroy===true){this.findFeaturesPanel.getComponent().destroy();this.findFeaturesPanel=null}}};this.showVisualOptionsPanel=function(){this.hideFindFeaturesPanel();if(this.visualOptionsPanel===null){this.visualOptionsPanel=new PA_Step4VisualOptionsView;this.visualOptionsPanel.setParent(this);this.visualOptionsPanel.loadModel(this.getModel());this.getComponent().add(this.visualOptionsPanel.getComponent())}this.visualOptionsPanel.toggle(true);this.adjustChildrenWidth()};this.hideVisualOptionsPanel=function(destroy){if(this.visualOptionsPanel!==null){this.visualOptionsPanel.toggle(false);if(destroy===true){this.visualOptionsPanel.getComponent().destroy();this.visualOptionsPanel=null}}};this.showGlobalHeatmap=function(){this.hideFeatureSetDetails();if(this.globalHeatmapView===null){this.globalHeatmapView=new PA_Step4GlobalHeatmapView;this.globalHeatmapView.setParent(this);this.globalHeatmapView.loadModel(this.getModel());this.getComponent().insert(1,this.globalHeatmapView.getComponent())}this.globalHeatmapView.toggle(true)};this.hideGlobalHeatmapPanel=function(destroy){if(this.globalHeatmapView!==null){this.globalHeatmapView.toggle(false);if(destroy===true){this.globalHeatmapView.getComponent().destroy();this.globalHeatmapView=null}}};this.showFeatureSetDetails=function(targetID,targetModel){this.hideGlobalHeatmapPanel();var addComponent=false;if(this.featureSetDetailsPanel===null){this.featureSetDetailsPanel=new PA_Step4DetailsView;this.featureSetDetailsPanel.setParent(this);addComponent=true}if(this.featureSetDetailsPanel.getTargetID()!==targetID){this.featureSetDetailsPanel.loadModel(targetModel,this.dataDistributionSummaries,this.visualOptions)}if(addComponent){this.getComponent().insert(1,this.featureSetDetailsPanel.getComponent())}else{this.featureSetDetailsPanel.toggle(true)}this.featureSetDetailsPanel.updateObserver()};this.hideFeatureSetDetails=function(destroy){if(this.featureSetDetailsPanel!==null){this.featureSetDetailsPanel.toggle(false);if(destroy===true){this.featureSetDetailsPanel.getComponent().destroy();this.featureSetDetailsPanel=null}}};this.setHeight=function(height){};this.adjustChildrenWidth=function(){var savedSpace=450;var parentSize=$("#pathwaysPanelsWrapper").width();if(this.findFeaturesPanel&&this.findFeaturesPanel.isVisible()||this.visualOptionsPanel&&this.visualOptionsPanel.isVisible()){savedSpace+=350}if(this.globalHeatmapView){this.globalHeatmapView.getComponent().setWidth(Math.min(parentSize-savedSpace,this.globalHeatmapView.getComponent().getWidth()))}if(this.featureSetDetailsPanel){this.featureSetDetailsPanel.getComponent().setWidth(Math.min(parentSize-savedSpace,this.featureSetDetailsPanel.getComponent().getWidth()))}};this.updateObserver=function(){debugger;this.diagramPanel.updateObserver();this.globalHeatmapView.updateObserver()};this.applyVisualSettings=function(){var me=this;this.diagramPanel.updateObserver();this.globalHeatmapView!==null&&this.globalHeatmapView.updateObserver();this.getController().updateStoredVisualOptions(this.getParent().getModel().getJobID(),this.visualOptions);return this};this.initComponent=function(){var me=this;this.component=Ext.widget({xtype:"container",flex:1,defaults:{border:false},layout:{type:"hbox",pack:"start",align:"stretch"},items:[],listeners:{beforedestroy:function(){if(me.globalHeatmapView!==null){Ext.destroy(me.globalHeatmapView.getComponent());me.globalHeatmapView=null}if(me.diagramPanel!==null){Ext.destroy(me.diagramPanel.getComponent());me.diagramPanel=null}if(me.searchTool!==null){Ext.destroy(me.searchTool);me.searchTool=null}me.getModel().deleteObserver(me)}}});return this.component};return this}PA_Step4PathwayView.prototype=new View;function PA_Step4KeggDiagramView(){this.name="PA_Step4KeggDiagramView";this.items=[];this.loadModel=function(pathway){if(this.model!==null){this.model.deleteObserver(this)}this.model=pathway;this.model.addObserver(this);var xyTable={};var searchFeatureIndex={};searchFeatureIndex=this.generateFeaturesViews(this.getModel().getMatchedGenes(),xyTable,searchFeatureIndex);searchFeatureIndex=this.generateFeaturesViews(this.getModel().getMatchedCompounds(),xyTable,searchFeatureIndex);var featureSets=Object.values(xyTable);var view=null;for(var i in featureSets){view=(new PA_Step4KeggDiagramFeatureSetView).loadModel(featureSets[i],this.getModel().getID()).setParent(this.getParent());featureSets[i].addObserver(view);this.items.push(view)}return searchFeatureIndex};this.toggle=function(visible){visible=visible===undefined?!this.getComponent().isVisible():visible;this.getComponent().setVisible(visible);return this};this.expand=function(){this.isExpanded=true;$("#expandDiagramPanelButton").hide();$("#shrinkDiagramPanelButton").show();this.getComponent().flex=1;this.getParent().getComponent().doLayout()};this.shrink=function(){this.isExpanded=false;$("#expandDiagramPanelButton").show();$("#shrinkDiagramPanelButton").hide();this.getComponent().flex=0;this.getParent().getComponent().doLayout()};this.download=function(){this.getParent().getController().downloadPathwayHandler(this.getParent(),this.getParent("PA_Step4JobView").getModel().getJobID(),"png");return this};this.generateFeaturesViews=function(featuresIDs,xyTable,searchFeatureIndex){var featureSetElem,pos;var graphicalOptions=this.getModel().getGraphicalOptions();var omicsValues=this.getParent().getOmicsValues();for(var i in featuresIDs){var data=graphicalOptions.findFeatureGraphicalData(featuresIDs[i]);if(!(data instanceof Array)){data=[data]}for(var k in data){featureSetElem=new FeatureSetElem(omicsValues[featuresIDs[i]],data[k]);searchFeatureIndex[omicsValues[featuresIDs[i]].name]=featureSetElem;for(var j in omicsValues[featuresIDs[i]].omicsValues){searchFeatureIndex[omicsValues[featuresIDs[i]].omicsValues[j].inputName]=featureSetElem}pos=data[k].getX()+"#"+data[k].getY();if(xyTable[pos]===undefined){xyTable[pos]=new FeatureSet(data[k].getX(),data[k].getY())}xyTable[pos].addFeature(featureSetElem);featureSetElem.setParent(xyTable[pos])}}return searchFeatureIndex};this.updateObserver=function(){for(var i in this.items){this.items[i].updateObserver()}return this};this.applyVisualSettings=function(){debugger;this.updateObserver();return this};this.initComponent=function(){var me=this;this.component=Ext.widget({xtype:"box",cls:"lateralOptionsPanel",defaults:{border:false},flex:1,minWidth:400,previousWidth:400,width:400,height:$("#mainViewCenterPanel").height()-100,html:'<div class="lateralOptionsPanel-header" style="background: #337ab7;">'+'   <div class="lateralOptionsPanel-toolbar">'+'    <a href="javascript:void(0)" class="toolbarOption btn-primary helpTip" id="hideDiagramPanelButton" title="Hide this panel"><i class="fa fa-times"></i></a>'+'    <a href="javascript:void(0)" class="toolbarOption btn-primary helpTip" id="expandDiagramPanelButton" style="display:none;"  title="Expand this panel"><i class="fa fa-expand"></i></a>'+'    <a href="javascript:void(0)" class="toolbarOption btn-primary helpTip" id="shrinkDiagramPanelButton" title="Shrink this panel"><i class="fa fa-compress"></i></a>'+'    <a href="javascript:void(0)" class="toolbarOption btn-default downloadTool helpTip" id="downloadDiagramPanelButton" title="Download the diagram"><i class="fa fa-download"></i> Download</a>'+"   </div>"+"   <h2>"+this.model.getName()+"</h2>"+"</div>"+'<div class="lateralOptionsPanel-body">'+'  <svg xmlns="http://www.w3.org/2000/svg" class="keggPathwaySVG" version="1.1" ></svg>'+"</div>",listeners:{boxready:function(){var graphicalOptions=me.getModel().getGraphicalOptions();var dataDistributionSummaries=me.getParent().getDataDistributionSummaries();var visualOptions=me.getParent().getVisualOptions();var viewportWidth=$(this.el.dom).width();var headerHeight=$(this.el.dom).find(".lateralOptionsPanel-header").outerHeight();var viewportHeight=$("#mainViewCenterPanel").height()-headerHeight-90;var imageWidth=graphicalOptions.getImageWidth();var imageHeight=graphicalOptions.getImageHeight();var imageProportion=imageHeight/imageWidth;var adjustFactor=1;if(viewportWidth<imageWidth){imageWidth=viewportWidth*.98;imageHeight=imageWidth*imageProportion;adjustFactor=imageWidth/graphicalOptions.getImageWidth()}if(viewportHeight<imageHeight){imageHeight=viewportHeight*.98;imageWidth=imageHeight/imageProportion;adjustFactor=imageHeight/graphicalOptions.getImageHeight()}me.getParent().setVisualOptions("adjustFactor",adjustFactor);me.getParent().setHeight(imageHeight+200);canvas=SVG($(this.el.dom).find(".keggPathwaySVG")[0]);canvas.size("100%",imageHeight);canvas.viewbox({x:0,y:0,width:imageWidth,height:imageHeight});canvas.image(location.pathname+"kegg_data/"+me.model.getID().replace(/\D/g,""),imageWidth,imageHeight).addClass("keggImageBack");try{featureSetViews={};var featuresAux=null,featureShape;for(var i in me.items){featureShape=me.items[i].drawComponent(canvas,dataDistributionSummaries,visualOptions);featuresAux=me.items[i].getModel().getFeatures();for(var j in featuresAux){featureSetViews[featuresAux[j].getFeature().getName()]=featureShape}}}catch(error){showErrorMessage(error.message,{message:error.stack})}$("#hideDiagramPanelButton").click(function(){me.getParent().hideDiagramPanel()});$("#expandDiagramPanelButton").click(function(){me.expand()});$("#shrinkDiagramPanelButton").click(function(){me.shrink()});$("#downloadDiagramPanelButton").click(function(){me.download()});me.zoomTool=$(this.el.dom).find(".keggPathwaySVG").svgPanZoom({zoomFactor:.1,initialViewBox:{width:imageWidth,height:imageHeight}});$(this.el.dom).append('<div class="zoomTool">'+'  <a href="javascript:void(0)" class="zoomIn" title="Zoom-in (110%)"><i class="fa fa-plus"></i></a>'+'  <a href="javascript:void(0)" class="zoomOut" title="Zoom-out (90%)"><i class="fa fa-minus"></i></a>'+"</div>");$("a.zoomIn").click(function(){me.zoomTool.zoomIn()});$("a.zoomOut").click(function(){me.zoomTool.zoomOut()})},beforedestroy:function(){for(var i in me.items){me.items[i].getModel().deleteObserver(me.items[i]);Ext.destroy(me.items[i].getComponent());delete me.items[i]}me.getModel().deleteObserver(me)}}});return this.component};return this}PA_Step4KeggDiagramView.prototype=new View;function PA_Step4KeggDiagramFeatureSetView(){this.name="PA_Step4KeggDiagramFeatureSetView";this.featureView=null;this.adjustFactor=1;this.loadModel=function(featureSet,pathwayID){this.model=featureSet;var pos=0;var features=this.model.getFeatures();for(var i in features){if(features[i].getFeature().isRelevant()){pos=i;break}}this.model.setMainFeature(features[pos]);this.featureView=(new PA_Step4KeggDiagramFeatureSetSVGBox).setParent(this).loadModel(this.model.getMainFeature()).setComponentID(pathwayID+"_"+this.model.getX()+"_"+this.model.getY()).setIsUnique(this.model.getFeatures().length===1);return this};this.showTooltip=function(dataDistributionSummaries,visualOptions){var tooltip=new PA_Step4KeggDiagramFeatureSetTooltip;tooltip.loadModel(this.getModel());tooltip.setParent(this.getParent());tooltip.show(this.component.id,dataDistributionSummaries,visualOptions)};this.drawComponent=function(canvas,dataDistributionSummaries,visualOptions){var me=this;this.adjustFactor=visualOptions.adjustFactor;var featureAux=this.initComponent(dataDistributionSummaries,visualOptions);var featureShape=canvas.image(featureAux.src,featureAux.width,featureAux.height).move(featureAux.x,featureAux.y).attr("id",featureAux.id);var displayTooltip=function(){me.timer=setTimeout(function(){me.timer=null;me.showTooltip(dataDistributionSummaries,visualOptions)},500)};featureShape.on("mouseover",displayTooltip).on("click",displayTooltip).on("mouseleave",function(){clearTimeout(me.timer)});return featureShape};this.updateObserver=function(){this.featureView.loadModel(this.getModel().getMainFeature()).updateObserver()};this.initComponent=function(dataDistributionSummaries,visualOptions){var me=this;visualOptions.adjustFactor=this.adjustFactor;this.component=this.featureView.initComponent(dataDistributionSummaries,visualOptions);return this.component};return this}PA_Step4KeggDiagramFeatureSetView.prototype=new View;function PA_Step4KeggDiagramFeatureSetTooltip(){if(arguments.callee._singletonInstance){return arguments.callee._singletonInstance}arguments.callee._singletonInstance=this;this.name="PA_Step4KeggDiagramFeatureSetTooltip";this.targetID=null;this.featureView=null;this.show=function(targetID){this.getComponent().showBy(targetID);if(this.targetID!==targetID){this.getComponent().setTarget(targetID);this.targetID=targetID;this.updateObserver()}};this.hide=function(force){this.forceHide=force;this.getComponent().hide()};this.showFeatureSetDetails=function(targetID,feature){this.getParent().showFeatureSetDetails(targetID,this.getModel(),feature)};this.changeVisibleFeature=function(sense){var currentFeaturePos=this.getModel().features.indexOf(this.getModel().getMainFeature());currentFeaturePos=(currentFeaturePos+sense+this.getModel().features.length)%this.getModel().features.length;this.getModel().setMainFeature(this.getModel().features[currentFeaturePos]);this.getModel().setChanged();this.getModel().notifyObservers();return this};this.updateObserver=function(){var me=this;var mainFeatureSetItem=this.getModel().getMainFeature();var featureType=mainFeatureSetItem.getFeature().getFeatureType();var message="";var nOtherItems=this.model.getFeatures().length-1;if(nOtherItems>0){$("#otherFeaturesMessage").html(nOtherItems+" more "+featureType+(nOtherItems>1?"s":"")+" at this position.");$("#otherFeaturesLabel").show()}else{$("#otherFeaturesLabel").hide()}this.featureView.loadModel(mainFeatureSetItem);this.featureView.updateObserver(true);this.getComponent().updateLayout();return this};this.initComponent=function(){var me=this;this.featureView=new PA_Step4KeggDiagramFeatureView;this.featureView.setParent(me);this.featureView.setCollapsible(false);this.featureView.setClosable(true);this.component=Ext.create("Ext.tip.ToolTip",{target:"",id:"theTooltip",style:"background: #fff; border: solid 2px #B7C7CF; border-radius : 2px; margin:0; padding:0;",dismissDelay:0,trackMouse:false,bodyPadding:0,autoHeight:true,width:260,minHeight:240,items:[this.featureView.getComponent(),{xtype:"box",html:'<div style="text-align: center;margin: 10px 0px;">'+'  <a href="javascript:void(0)" id="step4TooltipMoreButton" style="color: #fff;" class="button btn-primary btn-no-float"><i class="fa fa-search-plus"></i> Show details</a>'+"</div>"+'<div id="otherFeaturesLabel" style="text-align: center; display: block;">'+'  <span id="step4TooltipPrevButton" class="tooltipDetailsSpan" style="display: inline;">'+'    <i class="fa fa-caret-left" style="padding-right: 3px;"></i><a href="javascript:void(0)" style="display:inline-block"> Prev.</a>'+"  </span>"+'  <span id="otherFeaturesMessage" class="tooltipDetailsSpan" > N more Genes at this position.</span>'+'  <span id="step4TooltipNextButton" class="tooltipDetailsSpan" style="display: inline;">'+'    <a href="javascript:void(0)" style="display:inline-block">Next</a><i class="fa fa-caret-right" style="padding-left: 3px;"></i>'+"  </span>"+"</div>"}],showBy:function(el,pos){if(this.el==null){this.show()}this.showAt(this.el.getAlignToXY(el,pos||this.defaultAlign,[20,20]))},listeners:{boxready:function(){$("#step4TooltipMoreButton").click(function(){me.getComponent().hide();me.showFeatureSetDetails(me.targetID,me.getModel())});$("#step4TooltipPrevButton").click(function(){me.changeVisibleFeature(-1)});$("#step4TooltipNextButton").click(function(){me.changeVisibleFeature(1)})},beforehide:function(){if($("#theTooltip").is(":hover")&&me.forceHide!==true){return false}delete me.forceHide}}});return this.component};return this}PA_Step4KeggDiagramFeatureSetTooltip.prototype=new View;function PA_Step4KeggDiagramFeatureView(showButtons){this.name="PA_Step4KeggDiagramFeatureView";this.collapsible=true;this.closable=false;this.showButtons=showButtons===true;this.setCollapsible=function(collapsible){this.collapsible=collapsible};this.setClosable=function(closable){this.closable=closable};this.updateObserver=function(hideLinks){var me=this;var dataDistributionSummaries=this.getParent("PA_Step4PathwayView").getDataDistributionSummaries();var visualOptions=this.getParent("PA_Step4PathwayView").getVisualOptions();var componentID="#"+this.getComponent().getId();var componentNames=this.getModel().getFeature().getName().split(",");$(componentID+" .featureNameLabel").text(" "+componentNames[0]);$(componentID+" .featureNameLabelRelevant").toggle(this.getModel().getFeature().isRelevant());if($(componentID).hasClass("neverExpanded")){if(me.collapsible){return}$(componentID).find(".geneInfoContainer").show()}var featureType=this.getModel().getFeature().getFeatureType();var omicsValues=this.getModel().getFeature().getOmicsValues();var specie=application.getMainView().currentView.getModel().getOrganism();if(this.getModel().getFeature().isRelevant()){$(componentID+" .relevantFeatureField").show()}else{$(componentID+" .relevantFeatureField").hide()}var visibleOmics=[];var allOmics=null;if(featureType.toLowerCase()==="gene"){allOmics=this.getParent("PA_Step4PathwayView").getGeneBasedInputOmics()}else{allOmics=this.getParent("PA_Step4PathwayView").getCompoundBasedInputOmics()}for(var i in allOmics){visibleOmics.push(allOmics[i].omicName)}var divHeight=Math.max(visibleOmics.length*40,120);$(componentID+" .step4_plotwrappers").html("  <div class='twoOptionsButtonWrapper'>"+'      <a href="javascript:void(0)" class="button twoOptionsButton selected" name="heatmap-chart">Heatmap</a>'+'      <a href="javascript:void(0)" class="button twoOptionsButton" name="line-chart">Line chart</a>'+"  </div>"+"  <div class='step4-tooltip-plot-container selected' name='heatmap-chart'>"+"    <div id='"+this.getComponent().getId()+"_heatmapcontainer' name='heatmap-chart' style='height:"+divHeight+"px;width: 230px;'></div>"+"  </div>"+"  <div class='step4-tooltip-plot-container' name='line-chart' style='display:none;'>"+"    <div id='"+this.getComponent().getId()+"_plotcontainer' style='height:"+divHeight+"px;width: 230px;'></div>"+"  </div>");this.generateHeatmap(this.getComponent().getId()+"_heatmapcontainer",visibleOmics,dataDistributionSummaries,visualOptions);this.generatePlot(this.getComponent().getId()+"_plotcontainer",visibleOmics,dataDistributionSummaries,visualOptions);$("#"+me.getComponent().getId()+" a.twoOptionsButton").click(function(){var parent=$(this).parent(".twoOptionsButtonWrapper");var target=$(this).attr("name").replace("show","");$(this).siblings("a.twoOptionsButton.selected").removeClass("selected");$(this).addClass("selected");parent.siblings("div.step4-tooltip-plot-container.selected").removeClass("selected").toggle();parent.siblings("div.step4-tooltip-plot-container[name="+target+"]").addClass("selected").toggle()});if(hideLinks===true){$(componentID+" .extraInfoPanel").hide()}else{this.generateExtraInfoPanelContent(componentID+" .extraInfoPanel",specie,componentNames,this.getModel().getFeature().getID(),featureType)}};this.generateExtraInfoPanelContent=function(target,specie,componentNames,featureID,featureType){var me=this;$.getJSON(SERVER_URL_GET_AVAILABLE_SPECIES,function(data){var htmlCode="";var featureName=componentNames.shift();if(componentNames.length>0){htmlCode+="<p><b>Other names:</b> "+componentNames.join(", ")+"</p>"}htmlCode+="<div class='externalLinksContainer'>"+"<b>External links</b>"+"  <ul style='list-style-type: none;'>";var species=data.species;var specieName="";for(var i in species){if(species[i].value===specie){specieName=species[i].name;break}}var alternativeName=specieName.split("(")[1];alternativeName=alternativeName.substring(0,1).toUpperCase()+alternativeName.substring(1,alternativeName.length-1);if(featureType.toLowerCase()==="gene"){htmlCode+="    <li><a href='http://www.kegg.jp/dbget-bin/www_bget?"+specie+":"+featureID+"' target='_blank'><i class='fa fa-external-link'></i> Search at KEGG Database</a></li>"+"    <li><a id='ensemblGenomesSearch' href='http://ensemblgenomes.org/search/eg/"+featureName+"' target='_blank'><i class='fa fa-external-link'></i> Search at Ensembl Genomes</a></li>"+"    <li><a id='ensemblSearch' href='http://www.ensembl.org/Multi/Search/Results?q="+encodeURIComponent(featureName)+";facet_species="+encodeURIComponent(alternativeName)+"' target='_blank'><i class='fa fa-external-link'></i> Search at Ensembl (vertebrates)</a></li>"+(specie==="hsa"?"<li><a href='http://www.genecards.org/cgi-bin/carddisp.pl?gene="+featureName+"' target='_blank'><i class='fa fa-external-link'></i> Search at GeneCards Database</a></li>":"")+"    <li><a href='http://www.ncbi.nlm.nih.gov/pubmed/?term="+specieName+"' target='_blank'><i class='fa fa-external-link'></i> Find related publications (PubMed)</a></li>"+"    <li><a href='http://www.ncbi.nlm.nih.gov/gene/?term="+encodeURIComponent("("+featureName+"[Gene Name]) AND ()"+alternativeName+"[Organism])")+"' target='_blank'><i class='fa fa-external-link'></i> Search at NCBI Gene</a></li>"+"    <li><a href='http://www.ncbi.nlm.nih.gov/gquery/?term="+encodeURIComponent(featureName+" "+specieName)+"' target='_blank'><i class='fa fa-external-link'></i> Search at all NCBI Databases</a></li>"}else{htmlCode+="    <li><a href='http://www.kegg.jp/dbget-bin/www_bget?"+featureID+"' target='_blank'><i class='fa fa-external-link'></i>Search at KEGG Database</a></li>"+"    <li><a href='http://www.ncbi.nlm.nih.gov/pccompound?term="+featureID+"' target='_blank'><i class='fa fa-external-link'></i>Search at PubChem Compound</a></li>"+"    <li><a href='https://www.ebi.ac.uk/chebi/advancedSearchFT.do?searchString="+featureID+"' target='_blank'><i class='fa fa-external-link'></i>Search at ChEBI Database</a></li>"}htmlCode+="  </ul></div>";if(me.showButtons===true){htmlCode+='<div style=" text-align: center; margin: 15px 0px; ">'+'  <a class="button btn-info btn-sm btn-no-float findInMapButton"><i class="fa fa-map-marker"></i> Find in Pathway</a>'+'  <a class="button btn-default btn-sm btn-no-float moreDetailsButton"><i class="fa fa-search-plus"></i> Show details</a>'+"</div>"}$(target).html(htmlCode).css({display:"inline-block"});$(target).find(".findInMapButton").click(function(){me.parent.diagramPanel.zoomTool.reset();var matches=[],featureSetView,featureSetElem;for(var i in me.parent.diagramPanel.items){featureSetView=me.parent.diagramPanel.items[i];for(var j in featureSetView.model.features){featureSetElem=featureSetView.model.features[j];if(featureSetElem.getFeature().getID()===me.model.feature.ID){featureSetView.model.setMainFeature(featureSetElem);featureSetView.updateObserver();matches.push($("#"+featureSetView.getComponent().id)[0])}}}$(matches).data("powertip",me.model.feature.name.split(",")[0]);$(matches).powerTip({smartPlacement:true,placement:"s"});var showAllPositions=function(){if(matches.length>0){var elem=$(matches.shift());$.powerTip.show(elem);$.powerTip.destroy(elem);setTimeout(showAllPositions,1700)}else{$.powerTip.hide()}};showAllPositions()});$(target).find(".moreDetailsButton").click(function(){me.parent.showFeatureSetDetails("",me.model.parent)})});return this};this.generateHeatmap=function(divID,visibleOmics,dataDistributionSummaries,visualOptions){var feature=this.getModel().getFeature();var omicName,omicValues,position;var x=0,y=0,maxX=-1;var series=[],yAxisCat=[],serie,later=[],values,scaledValues,min,max;for(var i=visibleOmics.length-1;i>=0;i--){x=0;omicName=visibleOmics[i].split("#")[0];omicValues=feature.getOmicValues(omicName);if(omicValues!==null){serie={name:(omicValues.isRelevant()===true?"* ":"")+omicName+"#"+omicValues.inputName};yAxisCat.push((omicValues.isRelevant()===true?"* ":"")+omicName+"#"+omicValues.inputName);values=omicValues.getValues();serie.data=[];scaledValues=[];var limits=getMinMax(dataDistributionSummaries[omicName],visualOptions.colorReferences);for(var j in values){serie.data.push({x:x,y:y,value:values[j],color:getColor(limits,values[j],visualOptions.colorScale)});x++;maxX=Math.max(maxX,x)}series.push(serie)}else{later.push({omicName:omicName,position:y});yAxisCat.push(omicName);series.push(null)}y++}for(var i in later){x=0;omicName=later[i].omicName;position=later[i].position;serie={name:omicName};serie.data=[];for(var j=0;j<maxX;j++){serie.data.push([x,position,null]);x++}series[position]=serie}var xAxisCat=[];for(var i=0;i<maxX;i++){xAxisCat.push("Timepoint "+(i+1))}var heatmap=new Highcharts.Chart({chart:{type:"heatmap",renderTo:divID},title:null,credits:{enabled:false},legend:{enabled:false},tooltip:{
borderColor:"#333",formatter:function(){var title=this.point.series.name.split("#");title[1]=title.length>1?title[1]:"";return"<b>"+title[0].replace("*",'<i class="relevantFeature"></i>')+"</b><br/>"+"<i class='tooltipInputName'>"+title[1]+"</i>"+(this.point.value===null?"No data":this.point.value)},useHTML:true},xAxis:{categories:xAxisCat,labels:{enabled:false}},yAxis:{categories:yAxisCat,title:null,labels:{formatter:function(){var title=this.value.split("#");title[1]=title.length>1?title[1]:"No data";return(title[0].length>10?title[0].substring(0,10)+"...":title[0]).replace("*",'<i class="relevantFeature"></i>')+'</br><i class="tooltipInputName yAxisLabel">'+(title[1].length>10?title[1].substring(0,10)+"...":title[1])+"</i>"},style:{fontSize:"9px"},useHTML:true}},series:series,plotOptions:{heatmap:{borderColor:"#000000",borderWidth:.5}}});return heatmap};this.generatePlot=function(divID,visibleOmics,dataDistributionSummaries,visualOptions){var feature=this.getModel().getFeature();var omicName,omicValues=null,values=null;var series=[],scaledValues,min,max,maxVal=-1e8,minVal=1e8,tmpValue,yAxis=[],yAxisItem;for(var i in visibleOmics){omicName=visibleOmics[i].split("#")[0];omicValues=feature.getOmicValues(omicName);if(omicValues!==null){scaledValues=[];var limits=getMinMax(dataDistributionSummaries[omicName],visualOptions.colorReferences);values=omicValues.getValues();for(var j in values){tmpValue=scaleValue(values[j],limits.min,limits.max);maxVal=Math.max(tmpValue,maxVal);minVal=Math.min(tmpValue,minVal);scaledValues.push({y:tmpValue,marker:tmpValue>1||tmpValue<-1?{fillColor:"#ff6e00"}:null})}series.push({name:omicName,type:"spline",startOnTick:false,endOnTick:false,data:scaledValues,yAxis:0})}}maxVal=Math.ceil(Math.max(maxVal,1));minVal=Math.floor(Math.min(minVal,-1));var plot=new Highcharts.Chart({chart:{renderTo:divID},title:null,credits:{enabled:false},xAxis:[{labels:{enabled:false}}],yAxis:{title:null,min:minVal,max:maxVal,plotLines:[{label:{text:"-1",align:"right",style:{color:"gray"}},color:"#dedede",value:-1,width:1},{label:{text:"0",align:"right",style:{color:"gray"}},color:"#dedede",value:0,width:1},{label:{text:"1",align:"right",style:{color:"gray"}},color:"#dedede",value:1,width:1}]},series:series,legend:{itemStyle:{fontSize:"9px",fontWeight:"lighter"},margin:5,padding:5},tooltip:{enabled:false}});plot.yAxis[0].setExtremes(minVal,maxVal);return plot};this.initComponent=function(){var me=this;this.component=Ext.widget({xtype:"box",cls:"contentbox mainInfoPanel neverExpanded",style:"margin:0;",html:(this.closable?'<a class="toolbarOption hideOption" style="margin: 2px; "><i class="fa fa-times"></i></a>':"")+"<h3 class='geneInfoTitle'>"+(this.collapsible?"<i class='fa fa-chevron-circle-right'></i>":"")+"  <span class='featureNameLabel'></span><i class='featureNameLabelRelevant relevantFeature'></i>"+"</h3>"+"<div class='geneInfoContainer' style='display:none;'>"+"  <div class='otherOmicsLabel' style='padding:2px 0px'></div>"+"  <div class='step4_plotwrappers'></div>"+"  <span><p class='relevantFeatureField' style='padding: 0px; margin: 0px; font-size: 10px;float: right;'><i class='relevantFeature'></i>  Relevant for this omic</p></span>"+"  <div class='extraInfoPanel'></div>"+"</div>",listeners:{boxready:function(){$(this.el.dom).find(".geneInfoTitle").click(function(){var elem=$(this);if(elem.parents(".mainInfoPanel").first().hasClass("neverExpanded")){elem.parents(".mainInfoPanel").first().removeClass("neverExpanded");me.updateObserver()}if(elem.hasClass("expanded")){elem.removeClass("expanded");elem.find("i").removeClass("fa-chevron-circle-down").addClass("fa-chevron-circle-right")}else{elem.addClass("expanded");elem.find("i").removeClass("fa-chevron-circle-right").addClass("fa-chevron-circle-down")}$(this).siblings(".geneInfoContainer").toggle()});$(this.el.dom).find(".hideOption").click(function(){if(me.parent.hide!==undefined){me.parent.hide(true)}})},beforedestroy:function(){me.getModel().deleteObserver(me)}}});return this.component};return this}PA_Step4KeggDiagramFeatureView.prototype=new View;function PA_Step4KeggDiagramFeatureSetSVGBox(){this.name="PA_Step4KeggDiagramFeatureSetSVGBox";this.imageCode=null;this.componentID=null;this.isUnique=true;this.getID=function(){console.warn("Calling to deprecated getID method");return this.getComponentID()};this.getComponentID=function(){return this.componentID};this.setComponentID=function(componentID){this.componentID=componentID+"_"+this.model.getFeature().getID();return this};this.setIsUnique=function(isUnique){this.isUnique=isUnique;return this};this.updateObserver=function(){var dataDistributionSummaries=this.getParent("PA_Step4PathwayView").getDataDistributionSummaries();var visualOptions=this.getParent("PA_Step4PathwayView").getVisualOptions();$("#"+this.getComponentID()).attr("href",this.generateBox(dataDistributionSummaries,visualOptions));return this};this.drawComponent=function(dataDistributionSummaries,visualOptions){return this.initComponent(dataDistributionSummaries,visualOptions)};this.generateBox=function(dataDistributionSummaries,visualOptions){var scaleFactor=10;var boxPadding=1;var boxProportion=1;var feature=this.getModel().getFeature();var featureGraphicalData=this.getModel().getFeatureGraphicalData();var isRelevant=feature.isRelevant();var visibleOmics=visualOptions.visibleOmics.filter(function(elem){return elem.indexOf(feature.getFeatureType().toLowerCase()+"based")>-1});boxPadding=18;var width=(featureGraphicalData.getBoxWidth()||10)*scaleFactor;var height=(featureGraphicalData.getBoxHeight()||10)*scaleFactor;var boxHeigth=(height-boxPadding*2)/visibleOmics.length*boxProportion;var boxWidth=width-boxPadding*2;var xPos=boxPadding,yPos=boxPadding;var canvas=$("<canvas>");canvas.attr({width:width,height:height});var context=canvas[0].getContext("2d");var omicName,omicValues=null,values=null;for(var i in visibleOmics){boxWidth=width-boxPadding*2;omicName=visibleOmics[i].split("#")[0];omicValues=feature.getOmicValues(omicName);if(omicValues!==null){values=omicValues.getValues();boxWidth=boxWidth/values.length;var limits=getMinMax(dataDistributionSummaries[omicName],visualOptions.colorReferences);for(var j in values){context.beginPath();context.rect(xPos,yPos,boxWidth,boxHeigth);context.fillStyle=getColor(limits,values[j],visualOptions.colorScale);context.fill();context.lineWidth=1;context.strokeStyle="#bcbcbc";context.stroke();xPos+=boxWidth}}else{context.beginPath();context.rect(xPos,yPos,width,boxHeigth);context.fillStyle="#f9f9f9";context.fill()}yPos+=boxHeigth;xPos=boxPadding}var fontSize=13;if(feature.getName().length>6){fontSize=10}context.beginPath();context.rect(boxPadding/2,boxPadding/2,width-boxPadding,height-boxPadding);context.lineWidth=boxPadding;context.strokeStyle="#e8e8e8";if(visibleOmics.length===0){context.fillStyle="#f9f9f9";context.fill()}if(isRelevant===true){context.strokeStyle="#000"}if(width>80){context.stroke();context.font="normal "+fontSize*scaleFactor+"px serif";context.fillStyle="black";context.fillText(feature.getName(),0,fontSize*scaleFactor)}if(isRelevant===true){context.beginPath();context.arc(xPos+width-40,25,25,0,2*Math.PI,false);context.fillStyle="red";context.fill();context.lineWidth=5;context.strokeStyle="#003300";context.stroke();context.font="normal 35px FontAwesome";context.fillStyle="#FFFFFF";context.fillText("",xPos+width-57,40)}if(!this.isUnique){context.beginPath();context.arc(xPos+width-40,yPos-10,25,0,2*Math.PI,false);context.fillStyle="green";context.fill();context.lineWidth=5;context.strokeStyle="#003300";context.stroke();context.font="normal 35px FontAwesome";context.fillStyle="#FFFFFF";context.fillText("",xPos+width-52,yPos+5)}this.imageCode=canvas[0].toDataURL("image/png");return this.imageCode};this.getPopUpInformation=function(visualOptions){var omicsValues={};var feature=this.getModel().getFeature();var featureGraphicalData=this.getModel().getFeatureGraphicalData();var visibleOmics=visualOptions.visibleOmics.filter(function(elem){return elem.indexOf(feature.getFeatureType().toLowerCase()+"based")>-1});var omicName,omicValues;for(var i in visibleOmics){omicName=visibleOmics[i].split("#")[0];omicValues=feature.getOmicValues(omicName);if(omicValues==null){omicValues="No data"}else{omicValues=omicValues.getValues()}omicsValues[omicName]=omicValues}var width=this.getModel().getFeatureGraphicalData().getBoxWidth()*visualOptions.adjustFactor;var height=this.getModel().getFeatureGraphicalData().getBoxHeight()*visualOptions.adjustFactor;return{name:feature.getName(),values:omicsValues,x:featureGraphicalData.getX()*visualOptions.adjustFactor+width/2,y:featureGraphicalData.getY()*visualOptions.adjustFactor+height/2}};this.initComponent=function(dataDistributionSummaries,visualOptions){var me=this;var width=this.getModel().getFeatureGraphicalData().getBoxWidth()*visualOptions.adjustFactor||20;var height=this.getModel().getFeatureGraphicalData().getBoxHeight()*visualOptions.adjustFactor||20;this.component={id:me.componentID,type:"image",src:this.generateBox(dataDistributionSummaries,visualOptions),width:width,height:height,x:this.getModel().getFeatureGraphicalData().getX()*visualOptions.adjustFactor-width/2||0,y:this.getModel().getFeatureGraphicalData().getY()*visualOptions.adjustFactor-height/2||0};return this.component};return this}PA_Step4KeggDiagramFeatureSetSVGBox.prototype=new View;function PA_Step4VisualOptionsView(){this.name="PA_Step4VisualOptionsView";this.toggle=function(visible){visible=visible===undefined?!this.getComponent().isVisible():visible;this.getComponent().setVisible(visible);return this};this.applyVisualSettings=function(){var selectedOptions=[];$("div.lateralOptionsSelector.omicSelector input:checked").each(function(){selectedOptions.push($(this).attr("id"))});this.getParent().setVisualOptions("visibleOmics",selectedOptions);selectedOptions=$("div.lateralOptionsSelector input[name=colorByCheckbox]:checked").first().val();this.getParent().setVisualOptions("colorReferences",selectedOptions);selectedOptions=$("div.lateralOptionsSelector input[name=colorScaleCheckbox]:checked").first().val();this.getParent().setVisualOptions("colorScale",selectedOptions);this.getParent().applyVisualSettings();return this};this.initComponent=function(){var me=this;var visualOptions=this.getParent().getVisualOptions();var windowContent="<h4>Choose the omics to draw</h4>"+'<div class="lateralOptionsSelector omicSelector">'+"  <h5>Gene based omics</h5>";var omicsAux=me.getParent().getGeneBasedInputOmics();for(var i in omicsAux){windowContent+=' <div class="checkbox">'+"   <input "+(visualOptions.visibleOmics.indexOf(omicsAux[i].omicName+"#genebased")>-1?"checked":"")+' type="checkbox" id="'+omicsAux[i].omicName+'#genebased">'+'   <label for="'+omicsAux[i].omicName+'#genebased">'+omicsAux[i].omicName+"</label>"+" </div>"}omicsAux=me.getParent().getCompoundBasedInputOmics();windowContent+="<h5>Compound based omics</h5>";for(var i in omicsAux){windowContent+=' <div class="checkbox">'+"  <input "+(visualOptions.visibleOmics.indexOf(omicsAux[i].omicName+"#compoundbased")>-1?"checked":"")+' type="checkbox" id="'+omicsAux[i].omicName+"#compoundbased"+'">'+'  <label for="'+omicsAux[i].omicName+'#compoundbased">'+omicsAux[i].omicName+"</label>"+" </div>"}windowContent+="</div>"+'<div class="lateralOptionsSelector">'+"  <h4>Coloring options</h4>"+"  <h5>Reference values</h5>"+"  <div>"+'    <div class="radio"><input '+(visualOptions.colorReferences==="p10p90"?"checked ":"")+'type="radio" id="colorByCheckbox1" name="colorByCheckbox" value="p10p90"><label for="colorByCheckbox1">Percentiles 10 and 90</label></div>'+'    <div class="radio"><input '+(visualOptions.colorReferences==="absoluteMinMax"?"checked ":"")+'type="radio" id="colorByCheckbox2" name="colorByCheckbox" value="absoluteMinMax"><label for="colorByCheckbox2">Global Min/Max (including outliers).</label></div>'+'    <div class="radio"><input '+(visualOptions.colorReferences==="riMinMax"?"checked ":"")+'type="radio" id="colorByCheckbox3" name="colorByCheckbox" value="riMinMax"><label for="colorByCheckbox3">Global Min/Max (without outliers).</label></div>'+"  </div>"+"  <h5>Color scale</h5>"+"  <div>"+'    <div class="radio"><img class="colorScaleThumb" src="resources/images/bwrscale_120x18.jpg"><input '+(visualOptions.colorScale==="bwr"?"checked ":"")+'type="radio" id="colorScaleCheckbox1" name="colorScaleCheckbox" value="bwr"><label for="colorScaleCheckbox1">Blue-White-Red</label></div>'+'    <div class="radio"><img class="colorScaleThumb" src="resources/images/gbrscale_120x18.jpg"><input '+(visualOptions.colorScale==="rbg"?"checked ":"")+'type="radio" id="colorScaleCheckbox3" name="colorScaleCheckbox" value="rbg"><label for="colorScaleCheckbox3">Green-Black-Red</label></div>'+"  </div>"+"</div>";this.component=Ext.widget({xtype:"box",cls:"lateralOptionsPanel",width:300,height:$("#mainViewCenterPanel").height()-100,html:"<div class='lateralOptionsPanel-header' style='background: #d9534f;'>"+'  <div class="lateralOptionsPanel-toolbar">'+'    <a href="javascript:void(0)" class="toolbarOption btn-danger helpTip" id="hideVisualSettingsPanelButton" title="Close this panel"><i class="fa fa-times"></i></a>'+"  </div>"+"  <h2>Visual settings</h2>"+"</div>"+"<div class='lateralOptionsPanel-body'>"+windowContent+'    <a href="javascript:void(0)" class="button btn-success helpTip" id="applyVisualSettingsButton" style="margin-top: 20px;" title="Apply changes"><i class="fa fa-check"></i> Apply</a>'+"</div>",listeners:{boxready:function(){$("#hideVisualSettingsPanelButton").click(function(){me.toggle(false)});$("#applyVisualSettingsButton").click(function(){me.applyVisualSettings()})},beforedestroy:function(){me.getModel().deleteObserver(me)}}});return this.component};return this}PA_Step4VisualOptionsView.prototype=new View;function PA_Step4FindFeaturesView(){this.name="PA_Step4FindFeaturesView";this.items=null;this.pathwayDetailsView=null;this.searchResultsView=null;this.toggle=function(visible){visible=visible===undefined?!this.getComponent().isVisible():visible;this.getComponent().setVisible(visible);return this};this.searchFeatures=function(searchValue){var availableTags=this.getParent().searchFeatureIndex;var results={},elemAux;for(var i in availableTags){if(i.toLowerCase().indexOf(searchValue.toLowerCase())!==-1){elemAux=this.getParent().searchFeatureIndex[i];results[elemAux.getFeature().getName()]=elemAux}}availableTags=Object.keys(results).sort();this.items=[];var itemAux;for(i in availableTags){this.items.push(new PA_Step4KeggDiagramFeatureView(true).loadModel(results[availableTags[i]]).setParent(this.getParent()))}this.updateObserver();return this};this.updateObserver=function(){if(this.searchResultsView===null){this.searchResultsView=Ext.widget({xtype:"container",renderTo:"resultsContainer",items:[]})}$("#resultsCounter").text("Found "+this.items.length+" features.");$("#searchResultsWrapper").show();this.searchResultsView.removeAll();var components=[];for(var i in this.items){components.push(this.items[i].getComponent())}this.searchResultsView.add(components);this.searchResultsView.setVisible(true);for(i in this.items){this.items[i].updateObserver()}};this.showPathwayDetails=function(){if(this.pathwayDetailsView===null){this.pathwayDetailsView=new PA_Step3PathwayDetailsView;this.pathwayDetailsView.getComponent("patwaysDetailsContainer");this.pathwayDetailsView.setParent(this)}this.pathwayDetailsView.loadModel(this.getParent().getModel());var omicNames=[];var inputOmics=this.getParent().getParent().getModel().getGeneBasedInputOmics();for(var i in inputOmics){omicNames.push(inputOmics[i].omicName)}this.pathwayDetailsView.updateObserver(omicNames,this.getParent().getParent().getModel().getDataDistributionSummaries(),this.getParent().getVisualOptions());return this};this.getClusterColor=function(cluster){var COLORS=["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#eded84","#b15928","#003b46","#f5b549","#B38867"];cluster=Number.parseInt(cluster.replace(/[a-z]*/,""));if(!Number.isNaN(cluster)&&cluster<COLORS.length){return COLORS[cluster]}console.warn("Unable to find a color for cluster "+cluster);return"#333"};this.initComponent=function(){var me=this,selected,omicsAux;this.component=Ext.widget({xtype:"container",cls:"lateralOptionsPanel",width:300,height:$("#mainViewCenterPanel").height()-100,items:[{xtype:"box",html:"<div class='lateralOptionsPanel-header' style='background: #5bc0de;'>"+'  <div class="lateralOptionsPanel-toolbar">'+'    <a href="javascript:void(0)" class="toolbarOption btn-info helpTip" id="hideFindFeaturePanelButton" title="Close this panel"><i class="fa fa-times"></i></a>'+"  </div>"+"  <h2>Pathway information</h2>"+"</div>"+"<div class='lateralOptionsPanel-body findFeaturesContainer'>"+"  <div>"+"    <h4>Search in this pathway</h4>"+'    <div id="findFeaturesInput" class="input" style="width:170px; display:inline-block;"><input type="text" style="width:160px;"></div>'+'    <a class="button btn-info helpTip" id="findFeatureButton" style="margin: 20px 5px" title="Find features"><i class="fa fa-search"></i> Search</a>'+'    <div class="applyWaitMessage" style="color:#4c4c4c; margin: 10px;"> Searching...<i class="fa fa-cog fa-spin" style=" float: left; margin-right: 10px; "></i></div>'+"  </div>"+'  <div id="patwaysDetailsContainer"></div>'+'  <div id="searchResultsWrapper" style="display:none;">'+'    <a href="javascript:void(0)" id="backToPathwayDetailsButton" style="margin: 5px 0px;"><i class="fa fa-long-arrow-left"></i> Back to Pathway details</a>'+'    <h3 id="resultsCounter">Found N features.</h3>'+'    <div id="resultsContainer" style="width:245px; margin-left: 10px; padding-bottom:20px;"></div>'+"  </div>"+"</div>"}],listeners:{boxready:function(){me.showPathwayDetails();var availableTags=Object.keys(me.getParent().searchFeatureIndex).sort();$("#hideFindFeaturePanelButton").click(function(){me.toggle(false)});$("#findFeatureButton").click(function(){$(this).next(".applyWaitMessage").fadeIn(400,function(){$("#patwaysDetailsContainer").hide();me.searchFeatures($("#findFeaturesInput > input").val());$(this).hide()})});$("#findFeaturesInput > input").autocomplete({source:availableTags,minLength:2});$("#backToPathwayDetailsButton").click(function(){$("#patwaysDetailsContainer").show();$("#searchResultsWrapper").hide()});initializeTooltips(".helpTip")},resize:function(view,width,height,oldWidth,oldHeight,eOpts){var componentHeight=$(view.getEl().dom).outerHeight();var headerHeight=$(view.getEl().dom).find(".lateralOptionsPanel-header").outerHeight()+10;$(view.getEl().dom).find(".lateralOptionsPanel-body").height($("#mainViewCenterPanel").height()-headerHeight-100)},beforedestroy:function(){if(me.items!==null){for(var i in me.items){Ext.destroy(me.items[i].getComponent())}}me.getModel().deleteObserver(me)}}});return this.component};return this}PA_Step4FindFeaturesView.prototype=new View;function PA_Step4GlobalHeatmapView(){this.name="PA_Step4GlobalHeatmapView";this.showConfigurator=false;this.automaticUpdate=true;this.toggle=function(visible){visible=visible===undefined?!this.getComponent().isVisible():visible;this.getComponent().setVisible(visible);return this};this.expand=function(){this.isExpanded=true;$("#expandHeatmapButton").hide();$("#shrinkHeatmapButton").show();this.getComponent().flex=1;this.getParent().getComponent().doLayout()};this.shrink=function(){this.isExpanded=false;$("#expandHeatmapButton").show();$("#shrinkHeatmapButton").hide();this.getComponent().flex=0;this.getParent().getComponent().doLayout()};this.download=function(){throw"Not implemented"};this.updateObserver=function(){var start=new Date;var divName,referenceOmics,featureOmicValues,omicValue,dataMatrix={},otherDataMatrix={},selectedOmics={},kValues=[];$("div.globalHeatmapConfigurator div.omicSelection input[type=checkbox]:checked").each(function(){var omicName=$(this).val();var option=this.id.replace("-check","-radio");option=$("input[name="+option+"]:checked").val();selectedOmics[omicName]=option});var clusterize=$("#clusterize-check").is(":checked");if(clusterize){clusterize=$("input[name=clusterize-radio]:checked").val();$(".kSelection input").each(function(){kValues.push(this.value)})}var forceOrder=$("#order-check").is(":checked");if(clusterize){clusterize={algorithm:clusterize,distance:"euclidean",linkage:"complete",dendogram:clusterize==="hierarchical"?{width:80,reorder:true,color:"#333"}:false}}var globalHeatmapContainer=$("#globalHeatmapContainer");globalHeatmapContainer.empty();for(var omicName in selectedOmics){divName="globalHeatmapContainer-"+omicName.toLowerCase().replace(/ /g,"-");globalHeatmapContainer.append("<div class='omicHeatmapsContainer'>"+"<h3>"+omicName+"</h3>"+"<div id='"+divName+"'></div></div>");dataMatrix[omicName]={};otherDataMatrix[omicName]={}}var matchedGenes=this.getModel().getMatchedGenes();var omicsValues=this.getParent().getOmicsValues();for(var i=matchedGenes.length;i--;){featureOmicValues=omicsValues[matchedGenes[i]].getOmicsValues();for(var j=featureOmicValues.length;j--;){omicValue=featureOmicValues[j];if(selectedOmics[omicValue.omicName]===undefined){continue}if(selectedOmics[omicValue.omicName]==="all"||omicValue.isRelevant()){referenceOmics=dataMatrix}else{referenceOmics=otherDataMatrix}referenceOmics[omicValue.omicName][omicsValues[matchedGenes[i]].getName()]={keggName:omicsValues[matchedGenes[i]].getName(),inputName:omicValue.getInputName(),isRelevant:omicValue.isRelevant(),values:omicValue.getValues()}}}if(forceOrder){referenceOmics=Object.keys(selectedOmics);if(clusterize){clusterize.k=kValues[0]}this.generateContent(referenceOmics,dataMatrix,otherDataMatrix,clusterize,0)}else{var k=0;for(var omicName in selectedOmics){var aux={};aux[omicName]=dataMatrix[omicName];if(clusterize){clusterize.k=kValues[k]}k++;this.generateContent([omicName],aux,null,clusterize,0)}}$(".updateMessageContainer").hide();start=new Date-start;this.automaticUpdate=start<1e4;console.log("Rendered in "+start+" ms")};this.generateContent=function(referenceOmics,dataMatrix,otherDataMatrix,clusterize,level){var referenceOmic=referenceOmics.shift();if(referenceOmic===undefined){return}var omicValues=Object.values(dataMatrix[referenceOmic]);var showLabels=true;var divName="globalHeatmapContainer-"+referenceOmic.toLowerCase().replace(/ /g,"-");var divWidth=200;if(omicValues.length===0){$("#"+divName).append("<h4 style='width:"+divWidth+"px;'>No data</h4>");return}divWidth+=showLabels?50:0;divWidth+=clusterize&&clusterize.dendogram?80:0;var divHeight=(omicValues.length+1)*30;$("#"+divName).append("<div id='"+divName+"-"+level+"' class='heatmapContainer' style='width:"+divWidth+"px; height:"+divHeight+"px'></div>");var referenceHeatmap=this.generateHeatmap(divName+"-"+level,referenceOmic,omicValues,this.getParent().getDataDistributionSummaries(),this.getParent().getVisualOptions(),showLabels,clusterize);var orderedGenes=referenceHeatmap.yAxis[0].categories;var featureName;for(var omicName in referenceOmics){omicName=referenceOmics[omicName];omicValues=[];for(var i=orderedGenes.length;i--;){featureName=orderedGenes[i].split("#")[0].replace("* ","");if(dataMatrix[omicName][featureName]!==undefined){omicValues.push(dataMatrix[omicName][featureName]);delete dataMatrix[omicName][featureName]}else if(otherDataMatrix&&otherDataMatrix[omicName][featureName]!==undefined){omicValues.push(otherDataMatrix[omicName][featureName])}else{omicValues.push({keggName:featureName,inputName:"NO DATA",isRelevant:false,values:null})}}divName="globalHeatmapContainer-"+omicName.toLowerCase().replace(/ /g,"-");divWidth=200;divWidth+=showLabels?50:0;$("#"+divName).append("<div id='"+divName+"-"+level+"' class='heatmapContainer' style='width:"+divWidth+"px; height:"+divHeight+"px;'></div>");this.generateHeatmap(divName+"-"+level,omicName,omicValues,this.getParent().getDataDistributionSummaries(),this.getParent().getVisualOptions(),true,false,referenceHeatmap.xAxis[0].categories.length)}this.generateContent(referenceOmics,dataMatrix,otherDataMatrix,clusterize,level+1)};this.generateHeatmap=function(targetID,omicName,omicsValues,dataDistributionSummaries,visualOptions,showLabels,clusterize,maxX){var featureValues,x=0,y=0,series=[],yAxisCat=[],serie,later=[],position;maxX=maxX||-1;showLabels=showLabels===undefined?true:showLabels;for(var i=omicsValues.length-1;i>=0;i--){x=0;var limits=getMinMax(dataDistributionSummaries[omicName],visualOptions.colorReferences);featureValues=omicsValues[i].values;serie={name:(omicsValues[i].isRelevant===true?"* ":"")+omicsValues[i].keggName+"#"+omicsValues[i].inputName,data:[],turboThreshold:Number.MAX_VALUE};yAxisCat.push((omicsValues[i].isRelevant===true?"* ":"")+omicsValues[i].keggName+"#"+omicsValues[i].inputName);if(featureValues!==null){for(var j in featureValues){serie.data.push({x:x,y:y,value:featureValues[j],color:getColor(limits,featureValues[j],visualOptions.colorScale)});x++;maxX=Math.max(maxX,x)}series.push(serie)}else{later.push({serie:serie,position:y});series.push(null)}y++}for(var i in later){x=0;serie=later[i].serie;position=later[i].position;for(var j=0;j<maxX;j++){serie.data.push([x,position,null]);x++}series[position]=serie}var xAxisCat=[];for(var i=0;i<maxX;i++){xAxisCat.push("Timepoint "+(i+1))}var heatmap=new Highcharts.Chart({chart:{type:"heatmap",renderTo:targetID},title:null,legend:{enabled:false},credits:{enabled:false},heatmapSelector:{color:"#000",lineWidth:3},clusterize:clusterize,tooltip:{borderColor:"#333",formatter:function(){var title=this.point.series.name.split("#");title[1]=title.length>1?title[1]:"";return"<b>"+title[0].replace("*",'<i class="relevantFeature"></i>')+"</b><br/>"+"<i class='tooltipInputName'>"+title[1]+"</i>"+(this.point.value===null?"No data":this.point.value)},useHTML:true},xAxis:{categories:xAxisCat,labels:{enabled:false}},yAxis:{categories:yAxisCat,title:null,width:50,labels:{formatter:function(){if(this.value.split!==undefined){var title=this.value.split("#");title[1]=title.length>1?title[1]:"No data";return'<span style="width: 50px;display: block; text-align: right;">'+(title[0].length>10?title[0].substring(0,5)+"..."+title[0].substring(title[0].length-4,title[0].length):title[0]).replace("*",'<i class="relevantFeature"></i>')+'</br><i class="tooltipInputName yAxisLabel">'+(title[1].length>10?title[1].substring(0,5)+"..."+title[1].substring(title[1].length-4,title[1].length):title[1])+"</i></span>"}},style:{fontSize:"9px"},useHTML:true,enabled:showLabels}},series:series,plotOptions:{heatmap:{borderColor:"#000000",borderWidth:.5},series:{point:{events:{mouseOver:function(){var me=this;$("div.heatmapContainer").each(function(){var heatmap=$(this).highcharts();var serie=heatmap.series[me.series.index];var keggName=me.series.name.split("#")[0].replace("* ","");if(serie!==undefined&&serie.name.split("#")[0].replace("* ","")===keggName){serie.showHeatmapSelector(undefined,me.y);return true}else{for(var i in heatmap.series){if(heatmap.series[i].name.split("#")[0].replace("* ","")===keggName){heatmap.series[i].showHeatmapSelector();return true}}}heatmap.series[0].hideHeatmapSelector()})}}}}}});return heatmap};this.applyVisualSettings=function(){var me=this;debugger;if(this.automaticUpdate===false){$(".updateMessageContainer").fadeIn();return}$(".applyWaitMessage").fadeIn(400,function(){me.updateObserver();$(".applyWaitMessage").fadeOut()});return this};this.initComponent=function(){var me=this,divName;var htmlCode="<h4>Choose the omics to draw</h4>"+'<span class="infoTip"><span style=" color: rgb(158, 58, 179); font-weight: bold; ">Drag and drop</span> to change the order in which heatmaps will be drawn.</span>'+'<div id="omicSelectionWrapper">';var omicNames=Object.keys(this.model.getSignificanceValues());for(var i in omicNames){if(omicNames[i].toLowerCase()!=="metabolomics"&&this.getModel().getSignificanceValues()[omicNames[i]][0]!==0){divName="lateralOptionsSelector-"+omicNames[i].toLowerCase().replace(/ /g,"-");htmlCode+='<div class="lateralOptionsSelector omicSelection">'+' <div class="omicPosition">'+(parseInt(i)+1)+"</div>"+" <div>"+'   <div class="checkbox"><input checked type="checkbox" id="'+divName+'-check" value="'+omicNames[i]+'"><label for="'+divName+'-check">'+omicNames[i]+"</label></div>"+'   <div class="radio"><input type="radio" id="'+divName+'-radio1" name="'+divName+'-radio" value="all"><label for="'+divName+'-radio1">All features (Genes or compounds)</label></div>'+'   <div class="radio"><input checked type="radio" id="'+divName+'-radio2" name="'+divName+'-radio" value="relevant"><label for="'+divName+'-radio2">Only relevant features</label></div>'+" </div>"+"</div>"}}htmlCode+="</div>"+"<h4>Advanced options</h4>"+'<span class="infoTip">Depending on the selected settings, heatmap generation can take up to 10 seconds.</span>'+' <div class="checkbox"><input type="checkbox" id="order-check"><label for="order-check"> Force order for features.</label></div>'+' <div class="checkbox"><input checked type="checkbox" id="clusterize-check"><label for="clusterize-check"> Clusterize data</label></div>'+' <div class="lateralOptionsSelector clusterSelection">'+'    <div class="radio"><input checked type="radio" id="clusterize-hcluster" name="clusterize-radio" value="hierarchical"><label for="clusterize-hcluster">Hierarchical clustering </label></div>'+'    <div class="radio"><input  type="radio" id="clusterize-kcluster" name="clusterize-radio" value="kmeans"><label for="clusterize-kcluster">K-means clustering </label></div>'+'    <div id="kMeansSelectors" style="display:none; margin-left:50px;">'+'    <span class="infoTip">Choose the number of clusters (k) for each omic.</span>';for(var i in omicNames){var k=this.getModel().getSignificanceValues()[omicNames[i]][0];if(k!==0){k=Math.ceil(Math.sqrt(k/2));divName="kMeansSelector-"+omicNames[i].toLowerCase().replace(/ /g,"-");htmlCode+='      <div id="'+divName+'" class="lateralOptionsSelector kSelection">'+"        <label>"+omicNames[i]+': </label> <input type="number" min="1" step="1" value="'+k+'" SIZE="6">'+"      </div>"}}htmlCode+="     </div>"+"</div>";this.component=Ext.widget({xtype:"box",cls:"lateralOptionsPanel",flex:0,height:$("#mainViewCenterPanel").height()-100,resizable:{handles:"w",listeners:{beforeresize:function(){return!me.isExpanded},resize:function(resizer,width,height){me.getParent().adjustChildrenWidth()}}},previousWidth:400,width:400,minWidth:400,html:'<div class="lateralOptionsPanel-header" style="background: #55c9a6;">'+'  <div class="lateralOptionsPanel-toolbar">'+'    <a href="javascript:void(0)" class="toolbarOption btn-secondary helpTip" id="hideHeatmapPanelButton" title="Hide this panel"><i class="fa fa-times"></i></a>'+'    <a href="javascript:void(0)" class="toolbarOption btn-secondary helpTip" id="configureHeatmapButton" title="Configure heatmap"><i class="fa fa-cogs"></i></a>'+'    <a href="javascript:void(0)" class="toolbarOption btn-secondary helpTip" id="expandHeatmapButton" title="Expand this panel"><i class="fa fa-expand"></i></a>'+'    <a href="javascript:void(0)" class="toolbarOption btn-secondary helpTip" id="shrinkHeatmapButton" style="display:none;"  title="Shrink this panel"><i class="fa fa-compress"></i></a>'+"  </div>"+"  <h2>Global heatmap</h2>"+"</div>"+"<div class='lateralOptionsPanel-body globalHeatmapView-body'>"+'  <p>This panel contains the heatmap for all the features involved on this pathway. <br>Choose the visible omics features will be visible using the <i class="fa fa-cogs"></i> Settings button.</p>'+'  <div class="updateMessageContainer"> <h3>Visual changes detected! </h3> <p>Some visual settings changed recently but the Heatmap content did not change.<br>Click <a id="refreshHeatmap" href="javascript:void(0)">here</a> if you want to refresh the Heatmap content. </p> </div>'+'  <div class="globalHeatmapConfigurator" '+(this.showConfigurator?'style="display:none"':"")+">"+htmlCode+'    <a href="javascript:void(0)" class="button btn-success helpTip" id="updateHeatmapButton" title="Apply changes"><i class="fa fa-check"></i> Apply</a>'+'    <div class="applyWaitMessage"><i class="fa fa-cog fa-spin"></i> Drawing heatmap...</div>'+"  </div>"+"  <div id='globalHeatmapContainer'></div>"+"</div>",
listeners:{boxready:function(){$("#configureHeatmapButton").click(function(){$(".globalHeatmapConfigurator").slideToggle(400,function(){if($(this).css("display")==="block"){$(".globalHeatmapView-body").animate({scrollTop:$(".globalHeatmapConfigurator").offset().top},500)}})});$("#hideHeatmapPanelButton").click(function(){me.getParent().hideGlobalHeatmapPanel()});$("#updateHeatmapButton").click(function(){$(this).next(".applyWaitMessage").fadeIn(400,function(){me.updateObserver();$(".globalHeatmapConfigurator").slideUp();$(this).hide()})});$("#refreshHeatmap").click(function(){me.updateObserver()});$("#expandHeatmapButton").click(function(){me.expand()});$("#shrinkHeatmapButton").click(function(){me.shrink()});$("#downloadHeatmapButton").click(function(){me.download()});$("#clusterize-check").click(function(){$(".clusterSelection").slideToggle()});$("input[name='clusterize-radio']").change(function(){if($(this).val()!=="kmeans"){$("#kMeansSelectors").slideUp()}else{$("#kMeansSelectors").slideDown()}});dragula($("#omicSelectionWrapper")[0],{moves:function(el,container,handle){if(handle.tagName==="LABEL"){return false}return true}}).on("drop",function(el,container,source){$(".omicPosition").each(function(index){$(this).text(index+1)})});initializeTooltips(".helpTip")},resize:function(view,width,height,oldWidth,oldHeight,eOpts){var componentHeight=$(view.getEl().dom).outerHeight();var headerHeight=$(view.getEl().dom).find(".lateralOptionsPanel-header").outerHeight()+10;$(view.getEl().dom).find(".lateralOptionsPanel-body").height($("#mainViewCenterPanel").height()-headerHeight-100)},beforedestroy:function(){me.getModel().deleteObserver(me)}}});return this.component};return this}PA_Step4GlobalHeatmapView.prototype=new View;function PA_Step4DetailsView(){this.name="PA_Step4DetailsView";this.items=null;this.targetID=null;this.loadModel=function(model){if(this.model!==null){this.model.deleteObserver(this)}this.model=model;model.addObserver(this);var features=this.getModel().getFeatures();this.items=[];for(var i in features){this.items.push((new PA_Step4KeggDiagramFeatureView).loadModel(features[i]).setParent(this))}return this};this.getTargetID=function(){return this.targetID};this.toggle=function(visible){visible=visible===undefined?!this.getComponent().isVisible():visible;this.getComponent().setVisible(visible);return this};this.expand=function(){this.isExpanded=true;$("#expandFeatureSetButton").hide();$("#shrinkFeatureSetButton").show();this.getComponent().flex=1;this.getParent().getComponent().doLayout()};this.shrink=function(){this.isExpanded=false;$("#expandFeatureSetButton").show();$("#shrinkFeatureSetButton").hide();this.getComponent().flex=0;this.getParent().getComponent().doLayout()};this.updateObserver=function(){var featureSetElems=this.getModel().getFeatures();var featureType=featureSetElems[0].getFeature().getFeatureType();var entriesTable={};var addTableEntrie=function(omicValue,featureName,entrieName){if(omicValue.isCompoundOmicsValue()){var omicValues=omicValue.getValues();for(var i in omicValues){addTableEntrie(omicValues[i],featureName,entrieName+omicValue.getName()+"#")}}else if(omicValue.isVisibleAtFeatureFamilyDetails()){if(entrieName===""){entrieName=omicValue.getOmicName()}if(entriesTable[entrieName]==null){entriesTable[entrieName]=[]}entriesTable[entrieName].push({keggName:featureName+(entrieName===omicValue.getOmicName()?"":" "+omicValue.getOmicName()),inputName:omicValue.inputName,isRelevant:omicValue.isRelevant(),values:omicValue.getValues()})}};var omicValues,featureName;for(var i in featureSetElems){featureName=featureSetElems[i].getFeature().getName();omicValues=featureSetElems[i].getFeature().getOmicsValues();for(var j in omicValues){addTableEntrie(omicValues[j],featureName,"")}}var omicNames=Object.keys(entriesTable).sort();var elem=$("#featureFamilyOverviewContainer");elem.empty();var divWidth=elem.width()-400;var heatmap,plot,divId,htmlCode;for(var i in omicNames){divId=omicNames[i].replace(" ","_");htmlCode="<div class='contentbox'>"+"  <h3>"+omicNames[i].replace("#"," ")+"</h3>"+"  <div class='PA_step5_heatmapContainer' id='"+divId+"_heatmapContainer'  style='height: "+(entriesTable[omicNames[i]].length*30+100)+"px'><i class='fa fa-cog fa-spin'></i> Loading..</div>"+"  <div class='PA_step5_plotContainer' id='"+divId+"_plotContainer'  style='width:"+divWidth+"px;height: "+(entriesTable[omicNames[i]].length*30+100)+"px'><i class='fa fa-cog fa-spin'></i> Loading..</div>"+"</div>";elem.append(htmlCode);heatmap=this.generateHeatmap(divId+"_heatmapContainer",omicNames[i].split("#")[0],entriesTable[omicNames[i]],this.getParent("PA_Step4PathwayView").getDataDistributionSummaries(),this.getParent("PA_Step4PathwayView").getVisualOptions());plot=this.generatePlot(divId+"_plotContainer",omicNames[i].split("#")[0],entriesTable[omicNames[i]],this.getParent("PA_Step4PathwayView").getDataDistributionSummaries(),divId+"_plotlegendContainer",this.getParent("PA_Step4PathwayView").getVisualOptions())}$(".featureSetOptionsToolbar").next("h2").html(featureType+" family overview");var components=[];for(var i in this.items){components.push(this.items[i].getComponent())}this.getComponent().queryById("itemsContainer").removeAll(true);this.getComponent().queryById("itemsContainer").add(components);for(i in this.items){this.items[i].updateObserver()}};this.generateHeatmap=function(targetID,omicName,omicsValues,dataDistributionSummaries,visualOptions){var featureValues,x=0,y=0,maxX=-1,series=[],yAxisCat=[],serie;for(var i in omicsValues){x=0;featureValues=omicsValues[i].values;serie={name:(omicsValues[i].isRelevant===true?"* ":"")+omicsValues[i].keggName+"#"+omicsValues[i].inputName,data:[]};yAxisCat.push((omicsValues[i].isRelevant===true?"* ":"")+omicsValues[i].keggName+"#"+omicsValues[i].inputName);var limits=getMinMax(dataDistributionSummaries[omicName],visualOptions.colorReferences);for(var j in featureValues){serie.data.push({x:x,y:y,value:featureValues[j],color:getColor(limits,featureValues[j],visualOptions.colorScale)});x++;maxX=Math.max(maxX,x)}series.push(serie);y++}var xAxisCat=[];for(var i=0;i<maxX;i++){xAxisCat.push("Timepoint "+(i+1))}var heatmap=new Highcharts.Chart({chart:{type:"heatmap",renderTo:targetID},heatmapSelector:{color:"#000",lineWidth:3},title:null,legend:{enabled:false},credits:{enabled:false},tooltip:{borderColor:"#333",formatter:function(){var title=this.point.series.name.split("#");title[1]=title.length>1?title[1]:"";return"<b>"+title[0].replace("*",'<i class="relevantFeature"></i>')+"</b><br/>"+"<i class='tooltipInputName'>"+title[1]+"</i>"+(this.point.value===null?"No data":this.point.value)},useHTML:true},xAxis:{categories:xAxisCat,labels:{enabled:false}},yAxis:{categories:yAxisCat,title:null,width:100,labels:{formatter:function(){var title=this.value.split("#");title[1]=title.length>1?title[1]:"No data";return'<span style="width: 100px;display: block;   text-align: right;">'+(title[0].length>14?title[0].substring(0,14)+"...":title[0]).replace("*",'<i class="relevantFeature"></i>')+'</br><i class="tooltipInputName yAxisLabel">'+(title[1].length>14?title[1].substring(0,14)+"...":title[1])+"</i></span>"},style:{fontSize:"9px"},useHTML:true}},series:series,plotOptions:{heatmap:{borderColor:"#000000",borderWidth:.5},series:{point:{events:{mouseOver:function(){var plot=$(this.series.chart.container).parent().next().highcharts();for(var i in plot.series){if(plot.series[i].name!==this.series.name){plot.series[i].graph&&plot.series[i].graph.attr("stroke","#E2E2E2");plot.series[i].markerGroup&&plot.series[i].markerGroup.attr("visibility","hidden")}}},mouseOut:function(){var plot=$(this.series.chart.container).parent().next().highcharts();for(var i in plot.series){plot.series[i].graph&&plot.series[i].graph.attr("stroke",plot.series[i].color);plot.series[i].markerGroup&&plot.series[i].markerGroup.attr("visibility","visible")}}}}}}});return heatmap};this.generatePlot=function(targetID,omicName,omicsValues,dataDistributionSummaries,legendContainerId,visualOptions){var series=[],maxX=-1;var yAxisItem={title:null},omicsValue,auxValues;var limits=getMinMax(dataDistributionSummaries[omicName],visualOptions.colorReferences);for(var i in omicsValues){auxValues=[];omicsValue=omicsValues[i];maxX=Math.max(maxX,omicsValue.values.length);for(var j in omicsValue.values){auxValues.push({y:omicsValue.values[j],marker:omicsValue.values[j]>limits.max||omicsValue.values[j]<limits.min?{fillColor:"#ff6e00"}:null})}series.push({name:(omicsValue.isRelevant===true?"* ":"")+omicsValue.keggName+"#"+omicsValue.inputName,type:"spline",data:auxValues})}if(limits.max!==limits.absMax&&limits.min!==limits.absMin){yAxisItem.plotLines=[{label:{text:"min",align:"right",style:{color:"gray"}},color:"#dedede",value:limits.min,width:1},{label:{text:"max",align:"right",style:{color:"gray"}},color:"#dedede",value:limits.max,width:1}]}var xAxisCat=[];for(var i=0;i<maxX;i++){xAxisCat.push("Timepoint "+(i+1))}var plot=new Highcharts.Chart({chart:{renderTo:targetID},title:null,legend:{enabled:false},credits:{enabled:false},tooltip:{borderColor:"#333",formatter:function(){var title=this.point.series.name.split("#");title[1]=title.length>1?title[1]:"";return"<b>"+title[0].replace("*",'<i class="relevantFeature"></i>')+"</b><br/>"+"<i class='tooltipInputName'>"+title[1]+"</i>"+(this.point.y===null?"No data":this.point.y)},useHTML:true},xAxis:[{categories:xAxisCat,labels:{enabled:false}}],yAxis:yAxisItem,series:series});return plot};this.initComponent=function(){var me=this;this.component=Ext.widget({xtype:"container",cls:"lateralOptionsPanel",flex:0,width:400,minWidth:400,height:$("#mainViewCenterPanel").height()-100,resizable:{handles:"w",listeners:{beforeresize:function(){return!me.isExpanded},resize:function(resizer,width,height){me.getParent().adjustChildrenWidth()}}},items:[{xtype:"box",html:'<div class="lateralOptionsPanel-header" style="background: #55c9a6;">'+'  <div class="lateralOptionsPanel-toolbar">'+'    <a class="toolbarOption btn-secondary helpTip" id="hideFeatureSetButton" title="Hide this panel"><i class="fa fa-times"></i></a>'+'    <a class="toolbarOption btn-secondary helpTip" id="expandFeatureSetButton" title="Expand this panel"><i class="fa fa-expand"></i></a>'+'    <a class="toolbarOption btn-secondary helpTip" id="shrinkFeatureSetButton" style="display:none;"  title="Shrink this panel"><i class="fa fa-compress"></i></a>'+"  </div>"+"  <h2>Feature set overview</h2>"+"</div>"},{xtype:"container",cls:"lateralOptionsPanel-body",items:[{xtype:"box",html:"<h2> Features in this set </h2>"},{xtype:"container",itemId:"itemsContainer",style:"padding:10px;",items:[]},{xtype:"box",html:"<h2> Values by omic type</h2>"},{xtype:"box",html:"<div id='featureFamilyOverviewContainer'></div>"}]}],listeners:{boxready:function(){$("#hideFeatureSetButton").click(function(){me.getParent().hideFeatureSetDetails()});$("#expandFeatureSetButton").click(function(){me.expand()});$("#shrinkFeatureSetButton").click(function(){me.shrink()});initializeTooltips(".helpTip")},beforedestroy:function(){me.getModel().deleteObserver(me)},resize:function(view,width){var componentHeight=$(view.getEl().dom).outerHeight();var headerHeight=$(view.getEl().dom).find(".lateralOptionsPanel-header").outerHeight()+10;$(view.getEl().dom).find(".lateralOptionsPanel-body").height($("#mainViewCenterPanel").height()-headerHeight-100);$(".PA_step5_plotContainer").width(Math.max(300,width-400));$(".PA_step5_plotContainer .highcharts-container").width(Math.max(300,width-400));$(".PA_step5_plotContainer").each(function(){$(this).highcharts().reflow()})}}});return this.component};return this}PA_Step4DetailsView.prototype=new View;