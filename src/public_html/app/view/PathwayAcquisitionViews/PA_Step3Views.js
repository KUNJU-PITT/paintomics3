function PA_Step3JobView(){this.name="PA_Step3JobView";this.visualOptions=null;this.classificationData=null;this.indexedPathways=null;this.pathwayClassificationView=null;this.pathwayNetworkView=null;this.pathwayTableView=null;this.significativePathways=0;this.loadModel=function(model){if(this.model!==null){this.model.deleteObserver(this)}this.model=model;this.model.addObserver(this);var pathways=this.getModel().getPathways();if(window.sessionStorage&&sessionStorage.getItem("visualOptions")!==null){this.visualOptions=JSON.parse(sessionStorage.getItem("visualOptions"))}else{this.visualOptions={pathwaysVisibility:[],minFeatures:.5,minPValue:.05,minSharedFeatures:.9,colorBy:"classification",backgroundLayout:false,showNodeLabels:true,edgesClass:"l"};for(var i in pathways){this.visualOptions.pathwaysVisibility.push(pathways[i].getID())}this.getController().updateStoredApplicationData("visualOptions",this.visualOptions)}this.indexedPathways={};var pathwayInstance;for(var i in pathways){pathwayInstance=pathways[i];pathwayInstance.setVisible(this.visualOptions.pathwaysVisibility.indexOf(pathwayInstance.getID())!==-1);this.indexedPathways[pathwayInstance.getID()]=pathwayInstance}if(this.visualOptions.pathwaysPositions!==undefined){var data;for(var i in this.visualOptions.pathwaysPositions){data=this.visualOptions.pathwaysPositions[i].split("#");this.indexedPathways[data[0]].networkCoordX=Number.parseFloat(data[1]);this.indexedPathways[data[0]].networkCoordY=Number.parseFloat(data[2])}}this.classificationData={};for(var i in pathways){pathwayInstance=pathways[i];this.significativePathways+=pathwayInstance.getCombinedSignificanceValues()<=.05?1:0;mainClassificationName=pathwayInstance.getClassification().split(";");secClassificationName=mainClassificationName[1];mainClassificationName=mainClassificationName[0];mainClassificationID=mainClassificationName.toLowerCase().replace(/ /g,"_");secClassificationID=secClassificationName.toLowerCase().replace(/ /g,"_");if(this.classificationData[mainClassificationID]===undefined){this.classificationData[mainClassificationID]={name:mainClassificationName,count:0,children:{}}}this.classificationData[mainClassificationID].count++;if(this.classificationData[mainClassificationID].children[secClassificationID]===undefined){this.classificationData[mainClassificationID].children[secClassificationID]={name:secClassificationName,count:0,children:[]}}this.classificationData[mainClassificationID].children[secClassificationID].count++;this.classificationData[mainClassificationID].children[secClassificationID].children.push(pathwayInstance.getID())}if(this.pathwayClassificationView===null){this.pathwayClassificationView=new PA_Step3PathwayClassificationView;this.pathwayClassificationView.setController(this.getController());this.pathwayClassificationView.setParent(this)}this.pathwayClassificationView.loadModel(model);if(this.pathwayNetworkView===null){this.pathwayNetworkView=new PA_Step3PathwayNetworkView;this.pathwayNetworkView.setController(this.getController());this.pathwayNetworkView.setParent(this)}this.pathwayNetworkView.loadModel(model);if(this.pathwayTableView===null){this.pathwayTableView=new PA_Step3PathwayTableView;this.pathwayTableView.setController(this.getController());this.pathwayTableView.setParent(this)}this.pathwayTableView.loadModel(model);if(this.getModel().isRecoveredJob&&this.getModel().getStepNumber()===3){$(".backButton").hide()}return this};this.getVisualOptions=function(){return this.visualOptions};this.setVisualOptions=function(propertyName,value){this.visualOptions[propertyName]=value};this.getClassificationData=function(){return this.classificationData};this.getIndexedPathways=function(){return this.indexedPathways};this.getClassificationColor=function(classificationID,otherColors){var colors=["#007AFF","#4CD964","#FF2D55","#FFCD02","#5AC8FB","#C644FC"];var pos=["cellular_processes","environmental_information_processing","genetic_information_processing","human_diseases","metabolism","organismal_systems"].indexOf(classificationID);if(pos!==-1){return colors[pos]}else if(otherColors.length>0){return otherColors.shift()}else{return"#333"}};this.backButtonHandler=function(){this.controller.backButtonClickHandler(this)};this.resetViewHandler=function(){this.controller.resetButtonClickHandler(this)};this.updateObserver=function(){var me=this;$("#jobIdField").html(this.getModel().getJobID());this.pathwayClassificationView.updateObserver();this.pathwayTableView.updateObserver();this.pathwayNetworkView.updateObserver();setTimeout(function(){$("#foundPathwaysTag").html(me.getModel().getPathways().length);$("#significantPathwaysTag").html(me.significativePathways)},1e3);initializeTooltips(".helpTip");return this};this.applyVisualSettings=function(caller){var me=this;if(caller==="PA_Step3PathwayClassificationView"){this.pathwayTableView.updateVisiblePathways()}this.pathwayNetworkView.updateObserver();me.getController().updateStoredVisualOptions(me.getModel().getJobID(),me.visualOptions);return this};this.paintSelectedPathway=function(pathwayID){this.pathwayNetworkView.stopNetworkLayout();this.getController().step3OnFormSubmitHandler(this,pathwayID);return this};this.initComponent=function(){var me=this;this.component=Ext.widget({xtype:"container",padding:"10",border:0,maxWidth:1300,items:[{xtype:"box",cls:"toolbar secondTopToolbar",html:'<a href="javascript:void(0)" class="button btn-danger btn-right" id="resetButton"><i class="fa fa-refresh"></i> Reset</a>'+'<a href="javascript:void(0)" class="button btn-default btn-right backButton"><i class="fa fa-arrow-left"></i> Go back</a>'},{xtype:"container",itemId:"pathwaysSummaryPanel",layout:"column",style:"max-width:1300px; margin: 5px 10px; margin-top:50px;",items:[{xtype:"box",cls:"contentbox omicSummaryBox",html:'<div id="about">'+"  <h2>Pathways selection</h2>"+"  <p>"+"     We found the following Pathways for the provided data.<br>Each Pathway has a set of significance values for each submitted <i>omic data</i>,"+"     those values are calculated based on the total number of features (compounds and genes) for each Pathway as well as the number of features from the input involved on that Pathway.<br>"+"     Additionally, when the input includes 2 or more different omic types, we provide a Combined Significance Value, which allow us to identify those Pathways that are potentially more relevant."+"  </p>"+'  <a id="download_mapping_file"><i class="fa fa-paint-brush-o"></i> Choose the pathways below and  Paint!</a> '+"</div>"},{xtype:"box",cls:"contentbox omicSummaryBox",html:"<h2>Pathways summary</h2>"+'<h3 style="text-align:center;">Your Job ID is <b id="jobIdField">[JOB ID]</b><span class="infoTip" style=" font-size: 12px; ">Use this ID to recover your information in the future (option available at <b>Cloud Drive</b> section).</span></h3>'+'<div style="text-align:center;font-size: 25px;line-height: 120px;">'+'  <span class="myDataSummaryCount" style=" margin: 0; padding-right: 0; "><i class="fa fa-sitemap"></i> </span>'+'  <div id="foundPathwaysTag" class="odometer odometer-theme-default">000</div>  Found Pathways'+'  <span class="myDataSummaryCount" style=" margin: 0; padding-right: 0;"><i class="fa fa-star" style="background-color: #F1CC28;"></i> </span>'+'  <div id="significantPathwaysTag" class="odometer odometer-theme-default">000</div> Significant'+"</div>"}]},me.pathwayClassificationView.getComponent(),me.pathwayNetworkView.getComponent(),me.pathwayTableView.getComponent()],listeners:{boxready:function(){$(".backButton").click(function(){me.backButtonHandler()});$("#resetButton").click(function(){me.resetViewHandler()});new Odometer({el:$("#foundPathwaysTag")[0],value:0});new Odometer({el:$("#significantPathwaysTag")[0],value:0})},beforedestroy:function(){me.getModel().deleteObserver(me)}}});return this.component};return this}PA_Step3JobView.prototype=new View;function PA_Step3PathwayClassificationView(){this.name="PA_Step3PathwayClassificationView";this.updateObserver=function(){var me=this;var OTHER_COLORS=["#FF9500","#E0F8D8","#55EFCB","#FFD3E0"];var classificationData=this.getParent().getClassificationData();var indexedPathways=this.getParent().getIndexedPathways();var pathways=this.getModel().getPathways();var mainClassifications=[],secondClassifications=[],mainClassificationInstance,secClassificationInstance,drilldownAux;var classificationID,secondClassificationID;for(classificationID in classificationData){mainClassificationInstance=classificationData[classificationID];mainClassifications.push({name:mainClassificationInstance.name,y:mainClassificationInstance.count/pathways.length*100,color:this.getParent().getClassificationColor(classificationID,OTHER_COLORS),drilldown:classificationID});drilldownAux={name:mainClassificationInstance.name,id:classificationID,data:[]};for(secondClassificationID in mainClassificationInstance.children){secClassificationInstance=mainClassificationInstance.children[secondClassificationID];drilldownAux.data.push([secClassificationInstance.name,secClassificationInstance.count/pathways.length*100])}secondClassifications.push(drilldownAux)}$("#pathwayDistributionsContainer").highcharts({chart:{type:"pie"},title:null,credits:{enabled:false},plotOptions:{series:{animation:false,dataLabels:{enabled:true,useHTML:true,formatter:function(){if(this.point.drilldown!==undefined){return'<i class="classificationNameBox" style="line-height: 20px;border-color:'+this.point.color+"; color:"+this.point.color+';">'+this.point.name.charAt(0).toUpperCase()+"</i>"+this.percentage.toFixed(2)+"%"}else{return"<b>"+this.point.name+"</b><br>"+this.percentage.toFixed(2)+"%"}}}}},tooltip:{headerFormat:'<span style="font-size:11px">{series.name}</span><br>',pointFormat:'<span style="color:{point.color}">{point.name}</span>: <b>{point.y:.2f}%</b> of total<br/>'},series:[{name:"Pathways Classification",colorByPoint:true,data:mainClassifications}],drilldown:{series:secondClassifications}});OTHER_COLORS=["#FF9500","#E0F8D8","#55EFCB","#FFD3E0"];var htmlContent="",mainClassificationHTMLcode,secClassificationHTMLcode,pathClassificationHTMLcode,color,pathwayID,temporalCodeTable,namesAux,posAux,isCustomMainClass,isHiddenMainClass,isCustomSecClass,isHiddenSecClass;var mainClassificationIDs=Object.keys(classificationData).sort();while(mainClassificationIDs.length>0){classificationID=mainClassificationIDs.shift();mainClassificationInstance=classificationData[classificationID];color=this.getParent().getClassificationColor(classificationID,OTHER_COLORS);secClassificationHTMLcode="";isCustomMainClass=false;isHiddenMainClass=true;var secClassificationIDs=Object.keys(mainClassificationInstance.children).sort();while(secClassificationIDs.length>0){secondClassificationID=secClassificationIDs.shift();secClassificationInstance=mainClassificationInstance.children[secondClassificationID];pathClassificationHTMLcode="";isCustomSecClass=false;isHiddenSecClass=true;temporalCodeTable=[];namesAux=[];for(var i in secClassificationInstance.children){pathwayID=secClassificationInstance.children[i];posAux=Array.binaryInsert(indexedPathways[pathwayID].getName(),namesAux);temporalCodeTable.splice(posAux,0,'<div class="checkbox step3ClassificationsPathway">'+'  <input type="checkbox" '+(indexedPathways[pathwayID].isVisible()?"checked":"")+' id="'+pathwayID+'">'+'  <label for="'+pathwayID+'">'+indexedPathways[pathwayID].getName()+"</label>"+"</div>");isCustomSecClass=isCustomSecClass||!indexedPathways[pathwayID].isVisible();isHiddenSecClass=isHiddenSecClass&&!indexedPathways[pathwayID].isVisible()}pathClassificationHTMLcode+=temporalCodeTable.join("\n");secClassificationHTMLcode+='<div class="step3ClassificationsWrapper'+(isHiddenSecClass?" disabled":"")+'">'+'  <div class="step3ClassificationsTitle'+(isHiddenSecClass?" disabled":"")+'">'+'   <i class="fa fa-caret-right" style="color: #B1B1B1; margin-right: 5px;"></i>'+secClassificationInstance.name+'   <div class="step3ClassificationsOptions">'+'     <a class="hideOption'+(isHiddenSecClass?" selected":"")+'">Hide</a>'+'     <a class="showOption'+(!(isHiddenSecClass||isCustomSecClass)?" selected":"")+'">Show</a>'+'     <a class="customOption'+(isCustomSecClass&&!isHiddenSecClass?" selected":"")+'">Custom</a>'+"   </div>"+"  </div>"+'  <div class="step3ClassificationsChildrenContainer">'+pathClassificationHTMLcode+"</div>"+"</div>";isCustomMainClass=isCustomMainClass||isCustomSecClass;isHiddenMainClass=isHiddenMainClass&&isHiddenSecClass}htmlContent+='<div class="step3ClassificationsWrapper'+(isHiddenMainClass?" disabled":"")+'">'+'  <div class="step3ClassificationsTitle'+(isHiddenMainClass?" disabled":"")+'">'+'   <i class="classificationNameBox" style="border-color:'+color+"; color:"+color+';">'+mainClassificationInstance.name.charAt(0).toUpperCase()+"</i>"+'   <i class="fa fa-caret-right" style="color: #B1B1B1; margin-right: 5px;"></i>'+mainClassificationInstance.name+'   <div class="step3ClassificationsOptions">'+'     <a class="hideOption'+(isHiddenMainClass?" selected":"")+'">Hide</a>'+'     <a class="showOption'+(!(isCustomMainClass||isHiddenMainClass)?" selected":"")+'">Show</a>'+'     <a class="customOption'+(isCustomMainClass&&!isHiddenMainClass?" selected":"")+'">Custom</a>'+"   </div>"+"  </div>"+'  <div class="step3ClassificationsChildrenContainer" style="padding-left: 25px;">'+secClassificationHTMLcode+"</div>"+"</div>"}$("#pathwayClassificationContainer").html(htmlContent);var updateStatus=function(elem){$(elem).parents(".step3ClassificationsWrapper").last().find(".step3ClassificationsWrapper").andSelf().each(function(){var totalPathways=$(this).find("input").size();var totalCheckedPathways=$(this).find("input:checked").size();var className="";if(totalCheckedPathways===0){$(this).children(".step3ClassificationsTitle").addClass("disabled");className=".hideOption"}else if(totalCheckedPathways===totalPathways){$(this).children(".step3ClassificationsTitle").removeClass("disabled");className=".showOption"}else{$(this).children(".step3ClassificationsTitle").removeClass("disabled");className=".customOption"}$(this).children(".step3ClassificationsTitle").find("a").removeClass("selected");$(this).children(".step3ClassificationsTitle").find("a"+className).addClass("selected")})};$(".step3ClassificationsTitle").click(function(event){if(event.target.nodeName==="A"){if($(event.target).hasClass("selected")){return}if(event.target.text==="Show"){$(this).next(".step3ClassificationsChildrenContainer").find("input").prop("checked",true)}else if(event.target.text==="Hide"){$(this).next(".step3ClassificationsChildrenContainer").find("input").removeAttr("checked")}updateStatus(this)}else{$(this).next(".step3ClassificationsChildrenContainer").slideToggle();$(this).find("i.fa").each(function(){if($(this).hasClass("fa-caret-right")){$(this).removeClass("fa-caret-right").addClass("fa-caret-down")}else{$(this).removeClass("fa-caret-down").addClass("fa-caret-right")}})}});$(".step3ClassificationsPathway > input").change(function(){updateStatus(this)});return this};this.applyVisualSettings=function(){var me=this;var pathwaysVisibility=[];var indexedPathways=me.getParent().getIndexedPathways();$("#pathwayClassificationContainer").find("input").each(function(){indexedPathways[this.id].setVisible($(this).is(":checked"));if(indexedPathways[this.id].isVisible()){pathwaysVisibility.push(this.id)}});me.getParent().setVisualOptions("pathwaysVisibility",pathwaysVisibility);me.getParent().applyVisualSettings(me.getName());return this};this.initComponent=function(){var me=this;this.component=Ext.widget({xtype:"box",cls:"contentbox",maxWidth:1300,html:"<h2>Pathways classification</h2>"+'<div id="pathwayClassificationPlot1Box" style="padding-left: 10px;overflow:hidden;  min-height:300px; width: 45%; float: left;">'+'  <h4>Category Distribution<span class="infoTip">Click on each slice to view the distribution of the subcategories.</span></h4> '+'  <div id="pathwayDistributionsContainer" style="height: 240px;"></div>'+"</div>"+'<div id="pathwayClassificationPlot2Box" style="overflow:hidden;  min-height:300px; width: 55%; display:inline-block; padding: 0px 30px">'+'  <h4>Filter by category<span class="infoTip">Use this tool to <b>Show or Hide Pathways</b> based on their classification</span></h4> '+'  <div id="pathwayClassificationContainer"></div>'+'  <a href="javascript:void(0)" class="button btn-success btn-right helpTip" id="applyClassificationSettingsButton" style="margin: 0px 50px 17px 0px;" title="Apply changes"><i class="fa fa-check"></i> Apply</a>'+"</div>",listeners:{boxready:function(){$("#applyClassificationSettingsButton").click(function(){me.applyVisualSettings()});initializeTooltips(".helpTip")}}});return this.component};return this}PA_Step3PathwayClassificationView.prototype=new View;function PA_Step3PathwayNetworkView(){this.name="PA_Step3PathwayNetworkView";this.network=null;this.tooltips=null;this.filters=null;this.select=null;this.multinodeSelector=null;this.pathwayDetailsView=null;this.generateNetwork=function(data){var me=this;var visualOptions=this.getParent().getVisualOptions();var indexedPathways=this.getParent().getIndexedPathways();var CLUSTERS={};$("#pathwayNetworkWaitBox").fadeIn();if(this.network!==null){sigma.layouts.killForceLink();sigma.plugins.killFilter(this.network);this.filters=null;this.network.kill();this.network=null}var elem,nodesAux=[],edgesAux=[],matchedPathway=null,ignoredPathways={};var nElems=data.nodes.length;for(var i=nElems;i--;){elem=data.nodes[i];matchedPathway=indexedPathways[elem.data.id];if(elem.group!=="nodes"||elem.data.is_classification!==undefined||matchedPathway===undefined||elem.data.id===this.getModel().getOrganism()+"01100"||!matchedPathway.isVisible()){ignoredPathways[elem.data.id]=true;continue}matchedPathway.setTotalFeatures(matchedPathway.getMatchedGenes().length+matchedPathway.getMatchedCompounds().length);if(elem.data.total_features*visualOptions.minFeatures>matchedPathway.getTotalFeatures()){ignoredPathways[elem.data.id]=true;continue}else{if(matchedPathway.networkCoordX!==undefined&&matchedPathway.networkCoordY!==undefined){elem.data.x=matchedPathway.networkCoordX;elem.data.y=matchedPathway.networkCoordY}var pValue=1;try{pValue=visualOptions.colorBy==="classification"?matchedPathway.getCombinedSignificanceValues():matchedPathway.getSignificanceValues()[visualOptions.colorBy][2]}catch(error){pValue=1}elem.data.size=pValue<=visualOptions.minPValue?20+2*(visualOptions.minPValue-pValue):12;elem.data.colors=[];elem.data.clusters=[];if(visualOptions.colorBy==="classification"){elem.data.colors.push(this.getParent().getClassificationColor(elem.data.parent[0]))}else{var metagenes=matchedPathway.metagenes[visualOptions.colorBy];if(metagenes){for(var n in metagenes){CLUSTERS[metagenes[n].cluster]=this.getClusterColor(metagenes[n].cluster);elem.data.colors.push(this.getClusterColor(metagenes[n].cluster));elem.data.clusters.push(metagenes[n].cluster)}}else{elem.data.colors.push("#dfdfdf")}}elem.data.glyphs=[{position:"bottom-right",textColor:this.getParent().getClassificationColor(elem.data.parent[0]),strokeColor:this.getParent().getClassificationColor(elem.data.parent[0]),content:elem.data.parent[0].charAt(0).toUpperCase()}];nodesAux.push(elem.data)}}nElems=data.edges.length;for(var i=nElems;i--;){elem=data.edges[i];if(elem.group!=="edges"||elem.data.class!==visualOptions.edgesClass||(ignoredPathways[elem.data.source]||ignoredPathways[elem.data.target])||(indexedPathways[elem.data.source]===undefined||indexedPathways[elem.data.target]===undefined)||(!indexedPathways[elem.data.source].isVisible()||!indexedPathways[elem.data.target].isVisible())||(elem.data.source===this.getModel().getOrganism()+"01100"||elem.data.target===this.getModel().getOrganism()+"01100")){continue}var similarity=1;if(visualOptions.edgesClass==="s"){var totalIntersection=Array.intersect(indexedPathways[elem.data.target].getMatchedGenes(),indexedPathways[elem.data.source].getMatchedGenes()).length;totalIntersection+=Array.intersect(indexedPathways[elem.data.target].getMatchedCompounds(),indexedPathways[elem.data.source].getMatchedCompounds()).length;similarity=2*totalIntersection/(indexedPathways[elem.data.target].getMatchedGenes().length+indexedPathways[elem.data.target].getMatchedCompounds().length+(indexedPathways[elem.data.source].getMatchedGenes().length+indexedPathways[elem.data.source].getMatchedCompounds().length))}if(visualOptions.minSharedFeatures>similarity){continue}else{elem.data.type="dotted";elem.data.color="#e2e2e2";elem.data.size=similarity;edgesAux.push(elem.data)}}this.network=new sigma({graph:{nodes:nodesAux,edges:edgesAux},renderers:[{container:$("#pathwayNetworkBox")[0],type:"canvas"}],settings:{zoomMin:.01,zoomMax:10,zoomingRatio:1.2,dragNodeStickiness:.01,labelThreshold:10,labelMaxLength:15,drawEdges:false,batchEdgesDrawing:false,hideEdgesOnMove:true,defaultEdgeType:"line",drawGlyphs:false,glyphScale:.4,glyphFillColor:"#fff",glyphFontStyle:"bold",glyphLineWidth:4,glyphTextThreshold:3,glyphThreshold:2,borderSize:2,outerBorderSize:3,defaultNodeBorderColor:"#fff",defaultNodeOuterBorderColor:"rgb(236, 81, 72)",nodeHaloColor:"#ff8e8e",edgeHaloColor:"#ff8e8e",nodeHaloSize:5,edgeHaloSize:3}});me.drawGlyphs=false;me.network.renderers[0].bind("render",function(e){if(me.drawGlyphs){me.network.renderers[0].glyphs({draw:me.drawGlyphs})}});var activeState=sigma.plugins.activeState(me.network);this.select=sigma.plugins.select(me.network,activeState);this.select.selectAllNodes=function(){activeState.dropEdges();if(activeState.nodes().length===me.network.graph.nodes().length){activeState.dropNodes()}else{activeState.addNodes()}me.network.refresh({skipIndexation:true})};this.select.selectAllNeighbors=function(){activeState.addNeighbors();me.network.refresh({skipIndexation:true})};this.select.selectByCategory=function(){var nodes=activeState.nodes();var categories=[];for(var i in nodes){categories=categories.concat(me.getParent().getVisualOptions().colorBy==="classification"?nodes[i].parent:nodes[i].clusters)}categories=Array.unique(categories);nodes=me.network.graph.nodes();var selection=[];for(var i in nodes){if(Array.intersect(categories,me.getParent().getVisualOptions().colorBy==="classification"?nodes[i].parent:nodes[i].clusters).length>0){selection.push(nodes[i].id)}}activeState.addNodes(selection);me.network.refresh({skipIndexation:true})};var dragListener=sigma.plugins.dragNodes(me.network,me.network.renderers[0],activeState);dragListener.bind("startdrag",function(event){$("html,body").css("cursor","move")});dragListener.bind("dragend",function(event){$("html,body").css("cursor","inherit")});this.filters=sigma.plugins.filter(me.network);this.multinodeSelector=new sigma.plugins.lasso(me.network,me.network.renderers[0],{strokeStyle:"black",lineWidth:2,fillWhileDrawing:true,fillStyle:"rgba(41, 41, 41, 0.2)",cursor:"crosshair"});this.select.bindLasso(this.multinodeSelector);this.multinodeSelector.deactivate();this.multinodeSelector.bind("selectedNodes",function(event){setTimeout(function(){me.multinodeSelector.deactivate();me.network.refresh({skipIdexation:true})},0)});me.network.bind("hovers",function(e){var adjacentNodes=[],adjacentEdges=[];if(!e.data.enter.nodes.length)return;e.data.enter.nodes.forEach(function(node){adjacentNodes=adjacentNodes.concat(me.network.graph.adjacentNodes(node.id))});adjacentNodes=Array.unique(adjacentNodes.concat(e.data.enter.nodes));e.data.enter.nodes.forEach(function(node){adjacentEdges=adjacentEdges.concat(me.network.graph.adjacentEdges(node.id))});adjacentEdges=Array.unique(adjacentEdges);me.network.renderers[0].halo({nodes:adjacentNodes,edges:adjacentEdges})});this.tooltips=(new PA_Step3PathwayNetworkTooltipView).setParent(this);this.network.bind("hovers",function(e){if(e.data.current.nodes.length>0){PA_Step3PathwayNetworkTooltipView().timeoutID=setTimeout(function(){PA_Step3PathwayNetworkTooltipView().show(e.data.captor.clientX,e.data.captor.clientY,me.getModel().getPathway(e.data.current.nodes[0].id),[visualOptions.colorBy],me.getModel().getDataDistributionSummaries(),visualOptions)},600)}else{clearTimeout(PA_Step3PathwayNetworkTooltipView().timeoutID)}});$("canvas.sigma-mouse").mouseleave(function(){clearTimeout(PA_Step3PathwayNetworkTooltipView().timeoutID);PA_Step3PathwayNetworkTooltipView().hide()});var htmlCode="";$("#networkClustersContainer h4").text("Coloring by "+visualOptions.colorBy);$("#networkClustersContainer span.infoTip").toggle(visualOptions.colorBy!=="classification");$("#networkClustersContainer h5").toggle(visualOptions.colorBy!=="classification");if(visualOptions.colorBy==="classification"){var color,classification;for(var classificationID in me.getParent().classificationData){classification=me.getParent().classificationData[classificationID];color=color=this.getParent().getClassificationColor(classificationID,[]);htmlCode+='<div style="text-align:left;"><i class="classificationNameBox" style="border-color:'+color+"; color:"+color+';">'+classification.name.charAt(0).toUpperCase()+"</i>"+classification.name+"</div>"}$("#networkClustersContainer div").html(htmlCode)}else{$("#networkClustersContainer h5").text(Object.keys(CLUSTERS).length+" Clusters found.");var img_path;for(var cluster in CLUSTERS){img_path=SERVER_URL_GET_CLUSTER_IMAGE+"/"+this.getModel().getJobID()+"/output/"+visualOptions.colorBy+"_cluster_"+cluster+".png";htmlCode+='<span class="networkClusterImage" name="'+cluster+'"><i class="fa fa-eye-slash fa-2x"></i><img src="'+img_path+'"><p><i class="fa fa-square" style="color:'+CLUSTERS[cluster]+'"></i> Cluster '+cluster+"</p></span>"}$("#networkClustersContainer div").html(htmlCode);$(".networkClusterImage").click(function(){var cluster=$(this).attr("name");if($(this).hasClass("disabled")){$(this).removeClass("disabled");me.filters.undo("cluster-filter-"+cluster).apply()}else{$(this).addClass("disabled");me.filters.nodesBy(function(node,params){return node.clusters.indexOf(params.cluster)===-1},{cluster:cluster},"cluster-filter-"+cluster).apply()}})}var afterStopEvent=function(){$("#resumeLayoutButton").addClass("resumeLayout");$("#resumeLayoutButton").html('<i class="fa fa-play"></i> Resume layout');me.drawGlyphs=true;me.network.renderers[0].glyphs({draw:me.drawGlyphs});me.network.settings({drawEdges:true,labelThreshold:visualOptions.showNodeLabels===true?1:8});me.network.renderers[0].render();clearTimeout(me.timeoutID);me.timeoutID=null;$("#pathwayNetworkWaitBox").fadeOut()};sigma.layouts.configForceLink(this.network,{linLogMode:true,gravity:2,startingIterations:1,iterationsPerRender:2,maxIterations:2e4,avgDistanceThreshold:.05,autoStop:true,alignNodeSiblings:true,nodeSiblingsAngleMin:.55,nodeSiblingsScale:2,worker:true,easing:"cubicInOut",background:visualOptions.backgroundLayout===true,randomize:"globally"}).bind("stop",afterStopEvent);if(visualOptions.pathwaysPositions!==undefined){setTimeout(function(){afterStopEvent()},2e3)}else{setTimeout(function(){me.startNetworkLayout()},2e3)}return this};this.startNetworkLayout=function(){var me=this;$("#pathwayNetworkWaitBox").fadeIn();$("#resumeLayoutButton").removeClass("resumeLayout");$("#resumeLayoutButton").html('<i class="fa fa-pause"></i> Stop layout');this.drawGlyphs=false;this.network.renderers[0].glyphs({draw:false});this.network.settings({drawEdges:false});sigma.layouts.startForceLink(this.network);this.timeoutID=setTimeout(function(){me.stopNetworkLayout()},2e4);return this};this.stopNetworkLayout=function(){sigma.layouts.stopForceLink();return this};this.fullScreenNetwork=function(){this.network.renderers[0].fullScreen();return this};this.showPathwayDetails=function(pathway){if(this.pathwayDetailsView===null){this.pathwayDetailsView=new PA_Step3PathwayDetailsView;this.pathwayDetailsView.getComponent("patwaysDetailsContainer");this.pathwayDetailsView.setParent(this)}this.pathwayDetailsView.loadModel(pathway);var omicNames=[];var inputOmics=this.getModel().getGeneBasedInputOmics();for(var i in inputOmics){omicNames.push(inputOmics[i].omicName)}this.pathwayDetailsView.updateObserver(omicNames,this.getModel().getDataDistributionSummaries(),this.getParent().getVisualOptions());if(!$("#networkDetailsPanel").is(":visible")){$("#networkSettingsPanel").hide();$("#networkClustersContainer").hide();$("#networkDetailsPanel").show(200,function(){$("#patwaysDetailsWrapper").show()})}else{$("#networkClustersContainer").slideUp(200,function(){$("#patwaysDetailsWrapper").slideDown()})}return this};this.hidePathwayDetails=function(){$("#networkClustersContainer").slideDown();$("#patwaysDetailsWrapper").slideUp();return this};this.paintSelectedPathway=function(pathwayID){this.getParent().paintSelectedPathway(pathwayID);return this};this.getClusterColor=function(cluster){var COLORS=["#a6cee3","#1f78b4","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#eded84","#b15928","#003b46","#f5b549","#B38867"];cluster=Number.parseInt(cluster.replace(/[a-z]*/,""));if(!Number.isNaN(cluster)&&cluster<COLORS.length){return COLORS[cluster]}console.warn("Unable to find a color for cluster "+cluster);return"#333"};this.updateNodePositions=function(updateCache){var visualOptions=this.getParent().getVisualOptions();var indexedPathways=this.getParent().getIndexedPathways();for(var pathwayID in indexedPathways){delete indexedPathways[pathwayID].networkCoordX;delete indexedPathways[pathwayID].networkCoordY}var nodes=this.network.graph.nodes();delete visualOptions.pathwaysPositions;visualOptions.pathwaysPositions=[];for(var i in nodes){visualOptions.pathwaysPositions.push(nodes[i].id+"# "+nodes[i].x+"#"+nodes[i].y);indexedPathways[nodes[i].id].networkCoordX=nodes[i].x;indexedPathways[nodes[i].id].networkCoordY=nodes[i].y}if(updateCache){this.getController().updateStoredVisualOptions(this.getModel().getJobID(),visualOptions)}return this};this.clearNodePositions=function(){var visualOptions=this.getParent().getVisualOptions();var indexedPathways=this.getParent().getIndexedPathways();for(var pathwayID in indexedPathways){delete indexedPathways[pathwayID].networkCoordX;delete indexedPathways[pathwayID].networkCoordY}delete visualOptions.pathwaysPositions;return this};this.selectNodes=function(option){if(option==="category"){this.select.selectByCategory()}else if(option==="free"){$("#step3-network-toolbar-message").removeClass("successMessage").html("<i class='fa fa-info-circle'></i> Select the region that contains the nodes and drag to move.").fadeIn(100,function(){setTimeout(function(){$("#step3-network-toolbar-message").fadeOut(100)},1500)});this.multinodeSelector.activate()}else if(option==="adjacent"){this.select.selectAllNeighbors()}else if(option==="all"){this.select.selectAllNodes()}return this};this.downloadNetwork=function(option){if(option==="png"){var newCanvas=$("<canvas/>")[0];newCanvas.height=$("#pathwayNetworkBox").height();newCanvas.width=$("#pathwayNetworkBox").width();var ctx3=newCanvas.getContext("2d");ctx3.drawImage($("canvas.sigma-scene")[0],0,0);ctx3.drawImage($("canvas.sigma-glyphs")[0],0,0);$('<a target="_blank" id="downloadNetworkLink" download="paintomics_network_'+this.getParent("PA_Step3JobView").getModel().getJobID()+'.png" style="display:none;"></a>').attr("href",newCanvas.toDataURL("image/png"))[0].click()}return this};this.reorderNodes=function(option,size){var selectedNodes=sigma.plugins.activeState(this.network).nodes();if(selectedNodes.length===0){return this}if(option==="random"){var nodes=this.network.graph.nodes();var minX=Number.MAX_VALUE,maxX=Number.MIN_VALUE,minY=Number.MAX_VALUE,maxY=Number.MIN_VALUE,node;for(var i in nodes){node=nodes[i];minX=node.x<minX?node.x:minX;maxX=node.x>maxX?node.x:maxX;minY=node.y<minY?node.y:minY;maxY=node.y>maxY?node.y:maxY}for(var i in selectedNodes){selectedNodes[i].x=Math.random()*maxX+minX;selectedNodes[i].y=Math.random()*maxY+minY}this.network.refresh();return this}else if(option==="block"){var initX=selectedNodes[0].x,y=selectedNodes[0].y,x=initX;size=size||$('#reorderOptions h3[name="block"]').attr("value");

for(var i=0;i<selectedNodes.length;i++){selectedNodes[i].x=x;selectedNodes[i].y=y;x+=30;if((i+1)%size===0){x=initX;y+=30}}}else if(option==="ring"){size=size||$('#reorderOptions h3[name="ring"]').attr("value");var x=selectedNodes[0].x,y=selectedNodes[0].y;for(var i=0;i<selectedNodes.length;i++){selectedNodes[i].x=x+Math.cos(2*i*Math.PI/selectedNodes.length)*selectedNodes.length*size;selectedNodes[i].y=y+Math.sin(2*i*Math.PI/selectedNodes.length)*selectedNodes.length*size}}$('#reorderOptions h3[name="block"]').toggle(option==="block");$('#reorderOptions h3[name="ring"]').toggle(option==="ring");$("#reorderOptions").slideDown();this.network.refresh();return this};this.applyVisualSettings=function(){var me=this;var visualOptions=this.getParent().getVisualOptions();$("#pathwayNetworkWaitBox").fadeIn();var updateNeeded=false;var newValue,id;$("#pathwayNetworkToolsBox div.slider-ui").each(function(){newValue=$(this).attr("id")!=="minPValueSlider"?$(this).slider("value")/100:$(this).slider("value");id=$(this).attr("id").replace("Slider","");updateNeeded=updateNeeded||visualOptions[id]!==newValue;visualOptions[id]=newValue});newValue=$("#colorByContainer div.radio input:checked").val();updateNeeded=updateNeeded||visualOptions.colorBy!==newValue;visualOptions.colorBy=newValue;visualOptions.backgroundLayout=$("#background-layout-check").is(":checked");visualOptions.showNodeLabels=$("#show-node-labels-check").is(":checked");newValue=$("#edgesClassContainer div.radio input:checked").val();updateNeeded=updateNeeded||visualOptions.edgesClass!==newValue;visualOptions.edgesClass=newValue;newValue=$("#save-node-positions-check").is(":checked");if(newValue&&visualOptions.pathwaysPositions===undefined){this.updateNodePositions(false)}else if(!newValue&&visualOptions.pathwaysPositions!==undefined){this.clearNodePositions();updateNeeded=true}if(updateNeeded){me.getParent().applyVisualSettings(me.getName())}else{me.network.settings({drawEdges:true,labelThreshold:visualOptions.showNodeLabels===true?1:8});me.network.renderers[0].render();me.getController().updateStoredVisualOptions(me.getModel().getJobID(),visualOptions);$("#pathwayNetworkWaitBox").fadeOut()}};this.updateObserver=function(){var visualOptions=this.getParent().getVisualOptions();var htmlContent='<div class="radio"><input type="radio" '+(visualOptions.colorBy==="classification"?"checked":"")+' id="classification-check"  name="colorByCheckbox" value="classification"><label for="classification-check">Classification</label></div>';var inputOmics=this.getModel().getGeneBasedInputOmics();for(var i in inputOmics){htmlContent+='<div class="radio">'+'  <input type="radio" '+(visualOptions.colorBy===inputOmics[i].omicName?"checked":"")+' id="'+inputOmics[i].omicName.replace(/ /g,"_").toLowerCase()+'-check" name="colorByCheckbox" value="'+inputOmics[i].omicName+'">'+'  <label for="'+inputOmics[i].omicName.replace(/ /g,"_").toLowerCase()+'-check">'+inputOmics[i].omicName+"</label>"+"</div>"}$("#colorByContainer").html(htmlContent);$("#minFeaturesSlider").slider({value:visualOptions.minFeatures*100});$("#minFeaturesValue").html(visualOptions.minFeatures*100);$("#minSharedFeaturesSlider").slider({value:visualOptions.minSharedFeatures*100});$("#minSharedFeaturesValue").html(visualOptions.minSharedFeatures*100);$("#minPValueSlider").slider({value:visualOptions.minPValue});$("#minPValueValue").html(visualOptions.minPValue*100);$("#background-layout-check").attr("checked",visualOptions.backgroundLayout===true);$("#show-node-labels-check").attr("checked",visualOptions.showNodeLabels===true);$("#save-node-positions-check").attr("checked",visualOptions.pathwaysPositions!==undefined);this.getController().step3GetPathwaysNetworkDataHandler(this);initializeTooltips(".helpTip");return this};this.initComponent=function(){var me=this;var visualOptions=this.getParent().getVisualOptions();this.component=Ext.widget({xtype:"container",style:"max-width:1300px; margin: 5px 10px; ",items:[{xtype:"box",id:"networkDetailsPanel",cls:"contentbox lateralOptionsPanel",html:'<div class="lateralOptionsPanel-toolbar"><a href="javascript:void(0)" class="toolbarOption helpTip hideOption" id="hideNetworkDetailsPanelButton" title="Hide this panel"><i class="fa fa-times"></i></a></div>'+"<h2>Details</h2>"+'<div id="networkClustersContainer">'+'  <h4>TheName For AnOmic</h4><span class="infoTip">Click on each cluster to hide/show the nodes in the network</span>'+"  <h5>N Clusters founds</h5>"+'  <div style="text-align: center;"> </div>'+"</div>"+'<div id="patwaysDetailsWrapper" style="display:none;">'+'  <a href="javascript:void(0)" id="backToClusterDetailsButton" style="margin: 5px 0px;"><i class="fa fa-long-arrow-left"></i> Back to Cluster details</a>'+'  <div id="patwaysDetailsContainer"></div>'+"</div>"},{xtype:"box",id:"networkSettingsPanel",cls:"contentbox lateralOptionsPanel",html:'<div class="lateralOptionsPanel-toolbar"><a href="javascript:void(0)" class="toolbarOption helpTip hideOption" id="hideNetworkSettingsPanelButton" title="Hide this panel"><i class="fa fa-times"></i></a></div>'+'<h2>Tools<span class="helpTip" title="Some options may affect to the table below."></h2>'+'<div id="pathwayNetworkToolsBox" style="overflow:hidden; padding: 2px 10px;">'+"  <h4>Visual settings:</h4>"+'  <h5>Node coloring: <span class="helpTip" style="float:right;" title="Change the way in which nodes are colored."></span></h5>'+'  <div id="colorByContainer"></div>'+'  <h5>Choose what edges represents: <span class="helpTip" style="float:right;" title="By default an edge between 2 nodes indicates that both pathways are closely related in biological terms. These relationships are inferred from the pathways maps which usually contains links to other KEGG pathways that indicates the existence of functional elements shared between pathways and processes. Alternatively, edges can be configured to represent the existence of shared genes or compounds between separated biological processes, where thickness of the edge increases with the similarity between both set of biological features (percentage of shared features on total features in both process)."></span></h5>'+'  <div id="edgesClassContainer">'+'    <div class="radio">'+'      <input type="radio" '+(visualOptions.edgesClass==="l"?"checked":"")+' id="edgesLinkedPathways" name="edgesClassCheckbox-check" value="l">'+'      <label for="edgesLinkedPathways">Linked biological processes</label>'+"    </div>"+'    <div class="radio">'+'      <input type="radio" '+(visualOptions.edgesClass==="s"?"checked":"")+' id="edgesSharedFeatures" name="edgesClassCheckbox-check" value="s">'+'      <label for="edgesSharedFeatures">Shared biological features</label>'+"    </div>"+"  </div>"+"  <h5>Other settings:</h5>"+'  <div class="checkbox"><input type="checkbox" id="show-node-labels-check" name="showNodeLabelsCheckbox">'+'    <label for="show-node-labels-check">Show all node labels <span class="helpTip" style="float:right;" title="Shows labels for nodes (reduces performance). By default labels are visible when zooming the network."</span></label>'+"  </div>"+"  <h4>Network layout settings</h4>"+'  <div class="checkbox"><input type="checkbox" id="save-node-positions-check" name="saveNodePositionsCheckbox">'+'    <label for="save-node-positions-check">Save the nodes positions<span class="helpTip" style="float:right;" title="Use this option if you want to save the position for nodes in the network (increases performance)."></span><span class="commentTip" style="padding-left:21px;">Disable the auto-layout for network.</span></label>'+"  </div>"+'  <div class="checkbox"><input type="checkbox" id="background-layout-check" name="backgroundLayoutCheckbox">'+'    <label for="background-layout-check">Calculate layout on background <span class="helpTip" style="float:right;" title="Run the layout on background, apply the new nodes position on stop (increases performance)."></span><span class="commentTip" style="padding-left:21px;">Increases performance.</span></label>'+"  </div>"+"  <h4>Node filtering options</h4>"+'  <h5>Min features in pathway (<span id="minFeaturesValue">50</span>%)<span class="helpTip" style="float:right;" title="Min % of features (genes + compounds) of a pathway found at the input. Pathways with lower values will be excluded from the network. E.g. Using min=50%, if we find 80 features from the input data, at a Pathway that contains 200 features, the pathway will be excluded (80 < 100)."></span></h5>'+'  <div class="slider-ui" style="margin:10px;" id="minFeaturesSlider"></div>'+'  <h5>Min shared features (<span id="minSharedFeaturesValue">10</span>%)<span class="helpTip" style="float:right;" title="Min. % of features shared between 2 pathways (using the smaller pathway as reference). Edges showing a smaller relationship will be excluded.<br>E.g. Taking min=10%, Pathway A (60 features) and B (90 features), if shared features=5 the edge will be ignored (5 < Min(60,90) * 0.1)"></span></h5>'+'  <div class="slider-ui" style="margin:10px;" id="minSharedFeaturesSlider"></div>'+'  <h5>Min p-value for the pathway (<span id="minPValue">0.05</span>)<span class="helpTip" style="float:right;" title="Pathways with lower p-value (more significant) will be represented with bigger nodes. Pathways with higher p-value (less significant), will be shown as small nodes."</span></h5>'+'  <div class="slider-ui" style="margin:10px;" id="minPValueSlider"></div>'+'  <a href="javascript:void(0)" class="button btn-success btn-right helpTip" id="applyNetworkSettingsButton" style="margin-top: 20px;" title="Apply changes"><i class="fa fa-check"></i> Apply</a>'+"</div>"},{xtype:"box",cls:"contentbox",style:"overflow: hidden; margin:0;",html:'<div class="lateralOptionsPanel-toolbar">'+'  <a href="javascript:void(0)" class="toolbarOption downloadTool helpTip" id="downloadNetworkTool" title="Download the network" style="margin-top: 10px;"><i class="fa fa-download"></i> Download</a>'+"</div>"+'<h2>Pathways network <span class="helpTip" title="This Network represents the relationships between matched pathways."></h2>'+'<div id="step3-network-toolbar">'+' <div class="lateralOptionsPanel" id="reorderOptions" style="display:none;">'+'  <div class="lateralOptionsPanel-toolbar">'+'    <a href="javascript:void(0)" class="toolbarOption helpTip hideOption" title="Hide this panel"><i class="fa fa-times"></i></a>'+"  </div>"+'  <h3 name="block" value="10">Nodes per row:</h3>'+'  <h3 name="ring" style="display: none;" value="2">Ring size:</h3>'+"  <span>"+'    <i class="fa fa-minus-square fa-2x" name="less" style="margin-right: 22px;padding-top: 5px; color: #DA643D;"></i>'+'    <i class="fa fa-plus-square fa-2x"  name="more" style="color: #DA643D;"></i>'+"  </span>"+" </div>"+'  <a href="javascript:void(0)" class="toolbarOption helpTip" id="showNetworkSettingsPanelButton" ><i class="fa fa-cog"></i> Configure</a>'+'  <div class="menu">'+'    <a href="javascript:void(0)" class="toolbarOption menuOption helpTip"><i class="fa fa-mouse-pointer"></i> Node selection</a>'+'    <div class="menuBody">'+'      <a href="javascript:void(0)" class="toolbarOption helpTip submenuOption selectNodesOption" name="category" title="Select all nodes based on the categories/clusters for current selection"><i class="fa fa-object-ungroup"></i> Category-based selection</a>'+'      <a href="javascript:void(0)" class="toolbarOption helpTip submenuOption selectNodesOption" name="free" title="Select nodes at a hand-drawn region"><i class="fa fa-cut"></i> Free select tool</a>'+'      <a href="javascript:void(0)" class="toolbarOption helpTip submenuOption selectNodesOption" name="adjacent" title="Select adjacent nodes for selected nodes"><i class="fa fa-share-alt"></i> Select adjacent nodes</a>'+'      <a href="javascript:void(0)" class="toolbarOption helpTip submenuOption selectNodesOption" name="all" title="Select all nodes in the network"><i class="fa fa-object-group"></i> Select all nodes</a>'+"    </div>"+"  </div>"+'  <div class="menu">'+'    <a href="javascript:void(0)" class="toolbarOption menuOption helpTip"><i class="fa fa-mouse-pointer"></i> Reorder selected nodes</a>'+'    <div class="menuBody">'+'      <a href="javascript:void(0)" class="toolbarOption helpTip submenuOption reorderNodesOption" name="block" title="Organize selected nodes in to a block"><i class="fa fa-th"></i> Display as block</a>'+'      <a href="javascript:void(0)" class="toolbarOption helpTip submenuOption reorderNodesOption" name="ring" title="Organize selected nodes into a ring"><i class="fa fa-spinner"></i> Display as ring</a>'+'      <a href="javascript:void(0)" class="toolbarOption helpTip submenuOption reorderNodesOption" name="random" title="Set random positions for selected nodes"><i class="fa fa-random"></i> Randomize positions</a>'+"    </div>"+"  </div>"+'  <a href="javascript:void(0)" class="toolbarOption helpTip" id="fullscreenSettingsPanelButton" ><i class="fa fa-arrows-alt"></i> Full screen</a>'+'  <a href="javascript:void(0)" class="toolbarOption helpTip resumeLayout" id="resumeLayoutButton" style="float:right"><i class="fa fa-play"></i> Resume layout</a>'+'  <a href="javascript:void(0)" class="toolbarOption resumeLayout helpTip" id="saveNodePositionsButton"  style="float:right"><i class="fa fa-floppy-o"></i> Save Node Positions</a>'+'  <p id="step3-network-toolbar-message"></p>'+"</div>"+'<div id="pathwayNetworkBox" style="position: relative;overflow:hidden; height:595px; width: 100%;"><div id="pathwayNetworkWaitBox"><i class="fa fa-cog fa-spin"></i> Building network...</div></div>'}],listeners:{boxready:function(){$("#minFeaturesSlider").slider({value:0,min:0,max:100,step:5,slide:function(event,ui){$("#minFeaturesValue").html(ui.value)}});$("#minSharedFeaturesSlider").slider({value:0,min:0,max:100,step:5,slide:function(event,ui){$("#minSharedFeaturesValue").html(ui.value)}});$("#minPValueSlider").slider({value:0,min:.005,max:.05,step:.005,slide:function(event,ui){$("#minPValueSlider").html(ui.value)}});$("#applyNetworkSettingsButton").click(function(){me.applyVisualSettings()});$("#downloadNetworkTool").click(function(){me.stopNetworkLayout();me.downloadNetwork("png")});$("#step3-network-toolbar .selectNodesOption").click(function(){me.stopNetworkLayout();me.selectNodes($(this).attr("name"))});$("#step3-network-toolbar .reorderNodesOption").click(function(){me.stopNetworkLayout();me.reorderNodes($(this).attr("name"))});$("#resumeLayoutButton").click(function(){if($(this).hasClass("resumeLayout")){var visualOptions=me.getParent().getVisualOptions();if(visualOptions.pathwaysPositions!==undefined){Ext.MessageBox.confirm("Confirm","This option will invalidate current node positions,</br> Are you sure you want resume layout?",function(option){if(option==="yes"){$("#save-node-positions-check").attr("checked",false);$("#save-node-positions-check").prop("checked",false);$("#applyNetworkSettingsButton").click()}})}else{me.startNetworkLayout()}}else{me.stopNetworkLayout()}});$("#saveNodePositionsButton").click(function(){$("#save-node-positions-check").prop("checked",true);me.stopNetworkLayout();me.updateNodePositions(true);$("#step3-network-toolbar-message").addClass("successMessage").html("<i class='fa fa-check'></i> Saved").fadeIn(100,function(){setTimeout(function(){$("#step3-network-toolbar-message").fadeOut(100)},1500)})});$("#fullscreenSettingsPanelButton").click(function(){me.fullScreenNetwork()});$("#step3-network-toolbar-message").hover(function(){$(this).fadeOut(100)});$("#step3-network-toolbar .menuOption").click(function(){var isVisible=$(this).siblings(".menuBody").first().is(":visible");$("#step3-network-toolbar .menuBody").hide();$(this).siblings(".menuBody").first().toggle(!isVisible)});$("#step3-network-toolbar .submenuOption").click(function(){$(this).parent(".menuBody").first().toggle()});$("#showNetworkSettingsPanelButton").click(function(){$("#networkSettingsPanel").show()});$("#reorderOptions span i").click(function(){var option=$("#reorderOptions h3:visible");var value=Math.max(Number.parseInt(option.attr("value"))+($(this).attr("name")==="less"?-1:1),1);option.attr("value",value);me.reorderNodes(option.attr("name"),value)});$(".hideOption").click(function(){$(this).parents(".lateralOptionsPanel").first().hide();me.network.refresh()});$("#backToClusterDetailsButton").click(function(){me.hidePathwayDetails()});Ext.create("Ext.resizer.Resizer",{target:this,handles:"s",pinned:true,maxWidth:1300,minHeight:700,dynamic:true,transparent:true,listeners:{beforeresize:function(resizer,width,height){resizer.prevHeight=height},resize:function(resizer,width,height){var diff=height-resizer.prevHeight;var panels=["pathwayNetworkBox","networkDetailsPanel","networkSettingsPanel","patwaysDetailsContainer"];for(var i in panels){var elem=$("#"+panels[i]);elem.height(elem.height()+diff)}}}});initializeTooltips(".helpTip")}}});return this.component};return this}PA_Step3PathwayNetworkView.prototype=new View;function PA_Step3PathwayNetworkTooltipView(){if(arguments.callee._singletonInstance){return arguments.callee._singletonInstance}arguments.callee._singletonInstance=this;this.name="PA_Step3PathwayNetworkTooltipView";this.featureView=null;this.show=function(x,y,model,omicDataType,dataDistributionSummaries,visualOptions){this.getComponent().showAtPos(x,y);if(this.featureView.getModel()!==model){this.featureView.loadModel(model);this.featureView.updateObserver(omicDataType,dataDistributionSummaries,visualOptions)}return this};this.hide=function(){this.getComponent().hide()};this.showPathwayDetails=function(){this.getParent().showPathwayDetails(this.featureView.getModel())};this.hidePathwayDetails=function(){this.getParent().hidePathwayDetails()};this.initComponent=function(){var me=this;this.featureView=new PA_Step3PathwayDetailsView;this.featureView.setParent(me);this.component=Ext.create("Ext.tip.ToolTip",{target:"",id:"sigmaTooltip",style:"background:#fff; padding:2px 5px;",dismissDelay:0,trackMouse:false,autoHeight:true,width:270,items:[this.featureView.getComponent(),{xtype:"box",html:"  <div style='text-align: center;margin: 10px 0px;'>"+'     <a href="javascript:void(0)" class="button" id="step3TooltipMoreButton" style="float: none;"><i class="fa fa-search-plus"></i> Show details</a>'+'     <a href="javascript:void(0)" class="button" id="step3TooltipPaintButton" style="float: none; background-color:#0076E2;"><i class="fa fa-paint-brush"></i> Paint</a>'+"  </div>"}],showAtPos:function(x,y){if(this.el==null){this.show()}this.showAt([x,y+10])},listeners:{boxready:function(){$("#otherFeaturesLabel").click(function(){me.getComponent().hide()});$("#sigmaTooltip").mouseleave(function(){me.getComponent().hide()});$("#step3TooltipMoreButton").click(function(){me.showPathwayDetails()});$("#step3TooltipPaintButton").click(function(){me.getParent().paintSelectedPathway(me.featureView.getModel().getID())})},beforehide:function(){var me=this;if($("#sigmaTooltip").length>0&&$("#sigmaTooltip").is(":hover")){return false}}}});return this.component};return this}PA_Step3PathwayNetworkTooltipView.prototype=new View;function PA_Step3PathwayDetailsView(){this.name="PA_Step3PathwayDetailsView";this.updateObserver=function(omicDataType,dataDistributionSummaries,visualOptions){var me=this;var componentID="#"+this.getComponent().getId();$(componentID+" .pathwayNameLabel h4").text(this.getModel().getName());$(componentID+" .pathwayClassificationLabel").html("<b>Classification:</b>"+"<ul style='margin: 0;'>"+"  <li>"+this.getModel().getClassification().replace(";","</li><li>")+"</li>"+"</ul>");if(this.getParent().getName()!=="PA_Step3PathwayNetworkTooltipView"){var htmlCode="<tbody><tr><th></th><th>Matched<br>features</th><th>p-value</th></tr>";var significanceValues=this.getModel().getSignificanceValues();var renderedValue;for(var i in significanceValues){renderedValue=significanceValues[i][2]>.001||significanceValues[i][2]===0?parseFloat(significanceValues[i][2]).toFixed(6):parseFloat(significanceValues[i][2]).toExponential(4);htmlCode+="<tr><td>"+i+"</td><td>"+significanceValues[i][0]+" ("+significanceValues[i][1]+")</td><td>"+renderedValue+"</td></tr>"}htmlCode+="</tbody>";$(componentID+" .pathwaySummaryTable").html('<table style="padding: 10px;text-align: center;">'+htmlCode+"</table>")}var pathwayPlotwrappers=$(componentID+" .pathwayPlotwrappers");pathwayPlotwrappers.empty();for(var i in omicDataType){var metagenes=this.getModel().metagenes[omicDataType[i]];if(omicDataType[i]==="classification"){pathwayPlotwrappers.html('<div class="step3ChartWrapper" style="background-image: url(\''+location.pathname+"kegg_data/"+this.getModel().getID()+"_thumb')\"></div>");this.getComponent().setHeight(200);break}else if(metagenes===undefined){pathwayPlotwrappers.append("<h4 style='color: #D16949;font-size: 13px;margin: 0;'>"+omicDataType[i]+"</h4>"+"<b>No data for this pathway.</b>");this.getComponent().setHeight(120)}else{var divName=this.getComponent().getId()+"_"+omicDataType[i].replace(/ /g,"_").toLowerCase();pathwayPlotwrappers.append("<div>"+"  <h4>"+omicDataType[i]+"</h4>"+"  <span class='tooltipDetailsSpan'><i class='fa fa-info-circle'></i> "+metagenes.length+" major trends in this pathway.</span></br>"+"  <div class='twoOptionsButtonWrapper'>"+'      <a href="javascript:void(0)" class="button twoOptionsButton" name="heatmap-chart">Heatmap</a>'+'      <a href="javascript:void(0)" class="button twoOptionsButton selected" name="line-chart">Line chart</a>'+"  </div>"+"  <div class='step3-tooltip-plot-container' name='heatmap-chart'  style='display:none;'>"+"    <div id='"+divName+"_heatmapcontainer' name='heatmap-chart' style='height:"+(metagenes.length*35+10)+"px;width: 230px;'></div>"+"  </div>"+"  <div class='step3-tooltip-plot-container selected' name='line-chart'>"+"    <div id='"+divName+"_plotcontainer' style='height:100px;width: 230px;'></div>"+"  </div>"+"</div>");var heatmap=this.generateHeatmap(divName+"_heatmapcontainer",omicDataType[i],metagenes,dataDistributionSummaries);this.generatePlot(divName+"_plotcontainer",omicDataType[i],metagenes,dataDistributionSummaries,heatmap)}}$("#"+me.getComponent().getId()+" a.twoOptionsButton").click(function(){var parent=$(this).parent(".twoOptionsButtonWrapper");var target=$(this).attr("name").replace("show","");$(this).siblings("a.twoOptionsButton.selected").removeClass("selected");$(this).addClass("selected");parent.siblings("div.step3-tooltip-plot-container.selected").removeClass("selected").toggle();parent.siblings("div.step3-tooltip-plot-container[name="+target+"]").addClass("selected").toggle()});this.getComponent().setHeight(230);return this};this.generateHeatmap=function(targetID,omicName,metagenes,dataDistributionSummaries){var featureValues,x=0,y=0,maxX=-1,series=[],yAxisCat=[],serie;for(var i in metagenes){x=0;featureValues=metagenes[i].values.map(Number);serie={name:"Trend "+(i+1),data:[]};yAxisCat.push("Trend "+(i+1)+"#Cluster "+metagenes[i].cluster);var limits=getMinMax(dataDistributionSummaries[omicName],"p10p90");for(var j in featureValues){serie.data.push({x:x,y:y,value:featureValues[j],color:getColor(limits,featureValues[j],"bwr")});x++;maxX=Math.max(maxX,x)}series.push(serie);y++}var xAxisCat=[];for(var i=0;i<maxX;i++){xAxisCat.push("Timepoint "+(i+1))}var heatmap=new Highcharts.Chart({chart:{type:"heatmap",renderTo:targetID},title:null,legend:{enabled:false},credits:{enabled:false},tooltip:{borderColor:"#333",formatter:function(){var title=this.point.series.name.split("#");title[1]=title.length>1?title[1]:"";return"<b>"+title[0].replace("*",'<i class="relevantFeature"></i>')+"</b><br/>"+"<i class='tooltipInputName'>"+title[1]+"</i>"+(this.point.value===null?"No data":this.point.value)},useHTML:true},xAxis:{categories:xAxisCat,labels:{enabled:false}},yAxis:{categories:yAxisCat,title:null,width:100,labels:{formatter:function(){var title=this.value.split("#");title[1]=title.length>1?title[1]:"No data";return'<span style="width: 55px;display: block;   text-align: right;">'+(title[0].length>14?title[0].substring(0,14)+"...":title[0]).replace("*",'<i class="relevantFeature"></i>')+'</br><i class="tooltipInputName yAxisLabel">'+(title[1].length>14?title[1].substring(0,14)+"...":title[1])+"</i></span>"},style:{fontSize:"9px"},useHTML:true}},series:series,plotOptions:{heatmap:{borderColor:"#000000",borderWidth:.5},series:{point:{events:{mouseOver:function(){var plot=$("#"+this.series.chart.renderTo.id.replace("heatmap","plot")).highcharts();for(var i in plot.series){plot.series[i].setVisible(this.series.name.split("#")[0]===plot.series[i].name)}},mouseOut:function(){var plot=$("#"+this.series.chart.renderTo.id.replace("heatmap","plot")).highcharts();for(var i in plot.series){plot.series[i].setVisible(true)}}}}}}});return heatmap};this.generatePlot=function(targetID,omicName,metagenes,dataDistributionSummaries,heatmap){var series=[],scaledValues,min,max,maxVal=-1e8,minVal=1e8,tmpValue,yAxis=[],yAxisItem;for(var i in metagenes){scaledValues=[];featureValues=metagenes[i].values.map(Number);var limits=getMinMax(dataDistributionSummaries[omicName],"p10p90");for(var j in featureValues){tmpValue=scaleValue(featureValues[j],limits.min,limits.max);tmpValue=featureValues[j];maxVal=Math.max(tmpValue,maxVal);minVal=Math.min(tmpValue,minVal);scaledValues.push({y:tmpValue,marker:tmpValue>1||tmpValue<-1?{fillColor:"#ff6e00"}:null})}var parentAux=this.getParent("PA_Step3PathwayNetworkView");if(parentAux===null){parentAux=this.getParent()}series.push({name:"Cluster "+metagenes[i].cluster,type:"spline",color:parentAux.getClusterColor(metagenes[i].cluster),startOnTick:false,endOnTick:false,data:scaledValues,yAxis:0})}maxVal=Math.ceil(Math.max(maxVal,1));minVal=Math.floor(Math.min(minVal,-1));var plot=new Highcharts.Chart({chart:{renderTo:targetID},title:null,credits:{enabled:false},xAxis:[{labels:{enabled:false}}],yAxis:{title:null,min:minVal,max:maxVal,plotLines:[{label:{text:"-1",align:"right",style:{color:"gray"}},color:"#dedede",value:-1,width:1},{label:{text:"0",align:"right",style:{color:"gray"}},color:"#dedede",value:0,width:1},{label:{text:"1",align:"right",style:{color:"gray"}},color:"#dedede",value:1,width:1}]},series:series,legend:{itemStyle:{fontSize:"9px",fontWeight:"lighter"},margin:5,padding:5},tooltip:{enabled:false},plotOptions:{series:{point:{events:{mouseOver:function(){heatmap.tooltip.refresh(heatmap.series[heatmap.series.length-this.series.index-1].data[this.x])}}}}}});plot.yAxis[0].setExtremes(minVal,maxVal);return plot};this.initComponent=function(renderTo){var me=this;this.component=Ext.widget({xtype:"box",renderTo:renderTo,html:"<div class='mainInfoPanel' >"+"  <div class='pathwayNameLabel' style='padding:2px 0px'><h4 style='font-size: 13px;margin: 0;'></h4></div>"+"  <div class='pathwayClassificationLabel' style='padding:2px 0px'></div>"+"  <div class='pathwaySummaryTable'></div>"+"  <div class='pathwayPlotwrappers'></div>"+"</div>",listeners:{beforedestroy:function(){me.getModel().deleteObserver(me)}}});return this.component};return this}PA_Step3PathwayDetailsView.prototype=new View;function PA_Step3PathwayTableView(){this.name="PA_Step3PathwayTableView";this.tableData=null;this.loadModel=function(model){var me=this;if(this.model!==null){this.model.deleteObserver(this)}this.model=model;this.model.addObserver(this);this.tableData=[];var pathways=this.model.getPathways();var pathwayData,pathwayModel,omicName,significanceValues;var significativePathways=0;for(var i in pathways){pathwayModel=pathways[i];if(pathwayModel.getID()===this.getModel().getOrganism()+"01100"){continue}pathwayData={pathwayID:pathwayModel.getID(),title:pathwayModel.getName(),matchedGenes:pathwayModel.getMatchedGenes().length,matchedCompounds:pathwayModel.getMatchedCompounds().length,combinedSignificancePvalue:pathwayModel.getCombinedSignificanceValues(),mainCategory:pathwayModel.getClassification().split(";")[0],secCategory:pathwayModel.getClassification().split(";")[1],visible:pathwayModel.isVisible()};significanceValues=pathwayModel.getSignificanceValues();for(var j in significanceValues){omicName="-"+j.toLowerCase().replace(/ /g,"-");pathwayData["totalMatched"+omicName]=significanceValues[j][0];pathwayData["totalRelevantMatched"+omicName]=significanceValues[j][1];pathwayData["pValue"+omicName]=significanceValues[j][2]}this.tableData.push(pathwayData);significativePathways+=pathwayModel.getCombinedSignificanceValues()<=.05?1:0}};this.updateObserver=function(){var me=this;var columns=[{xtype:"customactioncolumn",text:"Paint",menuDisabled:true,width:55,items:[{icon:"fa-paint-brush-o",text:"",tooltip:"Paint this pathway",style:"font-size: 20px;",handler:function(grid,rowIndex,colIndex){me.getParent().paintSelectedPathway(grid.getStore().getAt(rowIndex).get("pathwayID"))}}]},{text:"ID",dataIndex:"pathwayID",hidden:true},{text:"Pathway name",dataIndex:"title",filterable:true,flex:1},{text:"",dataIndex:"classification",filterable:true,width:10,resizable:false,renderer:function(value,metadata,record){metadata.style="height: 33px; padding: 0; width: 10px; background-color:"+me.getParent().getClassificationColor(record.get("mainCategory").toLowerCase().replace(/ /g,"_"),[])+";";metadata.tdAttr='data-qtip="'+"<b>Classification</b><br>"+record.get("mainCategory")+"<br>"+record.get("secCategory")+'"';return""}},{text:"Features",columns:[{text:"Unique</br>genes",cls:"header-90deg",sortable:true,align:"center",width:50,filter:{type:"numeric"},dataIndex:"matchedGenes"},{text:"Unique</br>metabol.",cls:"header-90deg",sortable:true,align:"center",width:50,filter:{type:"numeric"},dataIndex:"matchedCompounds"}]}];var rowModel={pathwayID:{name:"pathwayID"},title:{name:"title",defaultValue:""},matchedGenes:{name:"matchedGenes",defaultValue:"0"},matchedCompounds:{name:"matchedCompounds",defaultValue:"0"},combinedSignificancePvalue:{name:"combinedSignificancePvalue",defaultValue:""},mainCategory:{name:"mainCategory",defaultValue:""},secCategory:{name:"secCategory",defaultValue:""},visible:{name:"visible",defaultValue:true}};var secondaryColumns=[];var hidden=Object.keys(this.model.getGeneBasedInputOmics()).length+Object.keys(this.model.getCompoundBasedInputOmics()).length>5||$("#mainViewCenterPanel").hasClass("mobileMode");this.generateColumns(this.model.getGeneBasedInputOmics(),secondaryColumns,rowModel,hidden);this.generateColumns(this.model.getCompoundBasedInputOmics(),secondaryColumns,rowModel,hidden);if(secondaryColumns.length>1){secondaryColumns.push({text:"Combined </br>pValue",cls:"header-45deg",dataIndex:"combinedSignificancePvalue",sortable:true,filter:{type:"numeric"},align:"center",minWidth:100,flex:1,height:75,renderer:function(value,metadata,record){var myToolTipText="<b style='display:block; width:200px'>"+metadata.column.text+"</b>";metadata.style="height: 33px; font-size:10px;";if(value===""){myToolTipText=myToolTipText+"<i>No data for this pathway</i>";metadata.tdAttr='data-qtip="'+myToolTipText+'"';metadata.style+=" background-color:#D4D4D4;";return"-"}if(value<=.065){var color=Math.round(161*(value/.065));metadata.style+="background-color:rgb(255, "+color+","+color+");"}return value>.001||value===0?parseFloat(value).toFixed(5):parseFloat(value).toExponential(4)}})}columns.push({text:"Significance tests",columns:secondaryColumns});columns.push({xtype:"customactioncolumn",text:"External links",width:150,items:[{icon:"fa-external-link",text:"KEGG",tooltip:"Find pathway in KEGG Database",handler:function(grid,rowIndex,colIndex){var term=grid.getStore().getAt(rowIndex).get("pathwayID");window.open("http://www.genome.jp/dbget-bin/www_bget?pathway+"+term,"_blank")}},{icon:"fa-search",text:"PubMed",tooltip:"Find related publications",handler:function(grid,rowIndex,colIndex){var term=grid.getStore().getAt(rowIndex).get("title");window.open("http://www.ncbi.nlm.nih.gov/pubmed/?term="+term.replace(" ","%20"),"_blank")}}]});var tableStore=Ext.create("Ext.data.Store",{fields:Object.values(rowModel),data:this.tableData,sorters:[{property:secondaryColumns.length>1?"combinedSignificancePvalue":secondaryColumns[0].dataIndex,
direction:"ASC"}]});var gridPanel=this.getComponent().queryById("pathwaysGridPanel");gridPanel.reconfigure(tableStore,columns);this.updateVisiblePathways()};this.updateVisiblePathways=function(){var store=this.getComponent().queryById("pathwaysGridPanel").getStore();var indexedPathways=this.getParent().getIndexedPathways();var filterBy=function(elem){return indexedPathways[elem.get("pathwayID")].isVisible()};store.filterBy(filterBy)};this.generateColumns=function(omics,columns,rowModel,hidden){var omicName;var me=this;var renderFunction=function(value,metadata,record){var myToolTipText="<b style='display:block; width:200px'>"+metadata.column.text.replace(/<\/br>/g," ")+"</b>";metadata.style="height: 33px; font-size:10px;";if(value==="-"){myToolTipText=myToolTipText+"<i>No data for this pathway</i>";metadata.tdAttr='data-qtip="'+myToolTipText+'"';metadata.style+="background-color:#D4D4D4;";return"-"}var renderedValue=value>.001||value===0?parseFloat(value).toFixed(5):parseFloat(value).toExponential(4);var omicName="-"+metadata.column.text.toLowerCase().replace(/ /g,"-").replace(/<\/br>/g,"-");if(value<=.065){var color=Math.round(225*(value/.065));metadata.style+="background-color:rgb(255, "+color+","+color+");"}var totalFeatures=1e4;var totalRelevant=5e3;var foundFeatures=record.get("totalMatched"+omicName);var foundRelevant=record.get("totalRelevantMatched"+omicName);var foundNotRelevant=foundFeatures-foundRelevant;var notFoundRelevant=totalRelevant-foundRelevant;var notFoundNotRelev=totalFeatures-foundFeatures-notFoundRelevant;myToolTipText+="<b>p-value:</b>"+(value===-1?"-":renderedValue)+"</br>"+"<table class='contingencyTable'>"+" <thead><th></th><th>Relevant</th><th>Not Relevant</th><th></th></thead>"+"  <tr><td>Found</td><td>"+foundRelevant+"</td><td>"+foundNotRelevant+"</td><td>"+foundFeatures+"</td></tr>"+"  <tr><td>Not found</td><td>"+notFoundRelevant+"</td><td>"+notFoundNotRelev+"</td><td>"+(totalFeatures-foundFeatures)+"</td></tr>"+"  <tr><td></td><td>"+totalRelevant+"</td><td>"+(totalFeatures-totalRelevant)+"</td><td>"+totalFeatures+"</td></tr>"+"</table>";metadata.tdAttr='data-qtip="'+myToolTipText+'"';return renderedValue};for(var i in omics){omicName="-"+omics[i].omicName.toLowerCase().replace(/ /g,"-");columns.push({text:omics[i].omicName.replace(" ","</br>"),cls:"header-45deg",dataIndex:"pValue"+omicName,width:90,flex:1,hidden:hidden,sortable:true,align:"center",filter:{type:"numeric"},renderer:renderFunction});rowModel["totalMatched"+omicName]={name:"totalMatched"+omicName,defaultValue:0};rowModel["totalRelevantMatched"+omicName]={name:"totalRelevantMatched"+omicName,defaultValue:0};rowModel["pValue"+omicName]={name:"pValue"+omicName,defaultValue:"-"}}return this};this.getSelectedPathways=function(){var selectedPathways=[];this.getComponent().queryById("pathwaysGridPanel").getStore().query("selected",true).each(function(item){selectedPathways.push(item.get("pathwayID"))});return selectedPathways};this.initComponent=function(){var me=this;this.component=Ext.widget({xtype:"container",cls:"contentbox",items:[{xtype:"box",flex:1,html:"<h2>Matched Pathways</h2>"},{xtype:"livesearchgrid",itemId:"pathwaysGridPanel",searchFor:"title",defaults:{border:false},columnLines:true,stripeRows:false,download:{title:"Paintomics pathways "+me.getModel().getJobID(),ignoreColums:[1]},store:Ext.create("Ext.data.Store",{fields:["name","email","phone"]}),columns:[{text:"name",flex:1,dataIndex:"name"}]}]});return this.component};return this}PA_Step3PathwayTableView.prototype=new View;var getMinMax=function(dataDistributionSummaries,option){var min,max,absMin,absMax;absMax=dataDistributionSummaries[8]<0?0:Math.max(Math.abs(dataDistributionSummaries[2]),Math.abs(dataDistributionSummaries[8]));absMin=dataDistributionSummaries[2]>0?0:-absMax;if(option==="absoluteMinMax"){max=dataDistributionSummaries[8]<0?0:Math.max(Math.abs(dataDistributionSummaries[2]),Math.abs(dataDistributionSummaries[8]));min=dataDistributionSummaries[2]>0?0:-max}else if(option==="riMinMax"){max=dataDistributionSummaries[10]<0?0:Math.max(Math.abs(dataDistributionSummaries[9]),Math.abs(dataDistributionSummaries[10]));min=dataDistributionSummaries[9]>0?0:-max}else if(option==="p10p90"){max=dataDistributionSummaries[7]<0?0:Math.max(Math.abs(dataDistributionSummaries[3]),Math.abs(dataDistributionSummaries[7]));min=dataDistributionSummaries[3]>0?0:-max;absMax=dataDistributionSummaries[8]<0?0:Math.max(Math.abs(dataDistributionSummaries[2]),Math.abs(dataDistributionSummaries[8]));absMin=dataDistributionSummaries[2]>0?0:-absMax}else{console.error("getMinMax:"+option+"Not implemented!!");debugger}return{min:min,max:max,absMin:absMin,absMax:absMax}};var getColor=function(limits,value,colorScale){var red,blue,green;if(colorScale==="rbg"){var percentage=Math.abs(value>0?value/limits.max:value/limits.min);green=value>0?0:255*percentage;red=value>0?255*percentage:0;blue=0}else if(colorScale==="bwr"){var percentage=Math.max(0,1-Math.abs(value>0?value/limits.max:value/limits.min));var outlierPercentage=Math.max(0,Math.abs(value>0?(value-limits.max)/(limits.absMax-limits.max):(value-limits.min)/(limits.absMin-limits.min)));green=percentage*255;red=value>0?value>limits.max?255-outlierPercentage*128:255:percentage*255;blue=value<0?value<limits.min?255-outlierPercentage*128:255:percentage*255}else if(colorScale==="bwr2"){var percentage=Math.max(0,1-Math.abs(value>0?value/limits.max:value/limits.min));var outlierPercentage=Math.max(0,Math.abs(value>0?(value-limits.max)/(limits.absMax-limits.max):(value-limits.min)/(limits.absMin-limits.min)));green=value>limits.max||value<limits.min?outlierPercentage*128:percentage*255;red=value>0?255:percentage*255;blue=value>0?percentage*255:255}else{console.error("Color scale "+colorScale+"Not implemented!!");debugger}return"rgb("+Math.round(red)+", "+Math.round(green)+","+Math.round(blue)+")"};