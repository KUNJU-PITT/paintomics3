Ext.define("Ext.tree.ViewDropZone",{extend:"Ext.view.DropZone",allowParentInserts:false,allowContainerDrops:false,appendOnly:false,expandDelay:500,indicatorCls:Ext.baseCSSPrefix+"tree-ddindicator",expandNode:function(node){var view=this.view;this.expandProcId=false;if(!node.isLeaf()&&!node.isExpanded()){view.expand(node);this.expandProcId=false}},queueExpand:function(node){this.expandProcId=Ext.Function.defer(this.expandNode,this.expandDelay,this,[node])},cancelExpand:function(){if(this.expandProcId){clearTimeout(this.expandProcId);this.expandProcId=false}},getPosition:function(e,node){var view=this.view,record=view.getRecord(node),y=e.getPageY(),noAppend=record.isLeaf(),noBelow=false,region=Ext.fly(node).getRegion(),fragment;if(record.isRoot()){return"append"}if(this.appendOnly){return noAppend?false:"append"}if(!this.allowParentInserts){noBelow=record.hasChildNodes()&&record.isExpanded()}fragment=(region.bottom-region.top)/(noAppend?2:3);if(y>=region.top&&y<region.top+fragment){return"before"}else if(!noBelow&&(noAppend||y>=region.bottom-fragment&&y<=region.bottom)){return"after"}else{return"append"}},isValidDropPoint:function(node,position,dragZone,e,data){if(!node||!data.item){return false}var view=this.view,targetNode=view.getRecord(node),draggedRecords=data.records,dataLength=draggedRecords.length,ln=draggedRecords.length,i,record;if(!(targetNode&&position&&dataLength)){return false}for(i=0;i<ln;i++){record=draggedRecords[i];if(record.isNode&&record.contains(targetNode)){return false}}if(position==="append"&&targetNode.get("allowDrop")===false){return false}else if(position!="append"&&targetNode.parentNode.get("allowDrop")===false){return false}if(Ext.Array.contains(draggedRecords,targetNode)){return false}return view.fireEvent("nodedragover",targetNode,position,data,e)!==false},onNodeOver:function(node,dragZone,e,data){var position=this.getPosition(e,node),returnCls=this.dropNotAllowed,view=this.view,targetNode=view.getRecord(node),indicator=this.getIndicator(),indicatorY=0;this.cancelExpand();if(position=="append"&&!this.expandProcId&&!Ext.Array.contains(data.records,targetNode)&&!targetNode.isLeaf()&&!targetNode.isExpanded()){this.queueExpand(targetNode)}if(this.isValidDropPoint(node,position,dragZone,e,data)){this.valid=true;this.currentPosition=position;this.overRecord=targetNode;indicator.setWidth(Ext.fly(node).getWidth());indicatorY=Ext.fly(node).getY()-Ext.fly(view.el).getY()-1;if(position=="before"){returnCls=targetNode.isFirst()?Ext.baseCSSPrefix+"tree-drop-ok-above":Ext.baseCSSPrefix+"tree-drop-ok-between";indicator.showAt(0,indicatorY);dragZone.proxy.show()}else if(position=="after"){returnCls=targetNode.isLast()?Ext.baseCSSPrefix+"tree-drop-ok-below":Ext.baseCSSPrefix+"tree-drop-ok-between";indicatorY+=Ext.fly(node).getHeight();indicator.showAt(0,indicatorY);dragZone.proxy.show()}else{returnCls=Ext.baseCSSPrefix+"tree-drop-ok-append";indicator.hide()}}else{this.valid=false}this.currentCls=returnCls;return returnCls},onNodeOut:function(n,dd,e,data){this.valid=false;this.getIndicator().hide()},onContainerOver:function(dd,e,data){return e.getTarget("."+this.indicatorCls)?this.currentCls:this.dropNotAllowed},notifyOut:function(){this.callParent(arguments);this.cancelExpand()},handleNodeDrop:function(data,targetNode,position){var me=this,targetView=me.view,parentNode=targetNode?targetNode.parentNode:targetView.panel.getRootNode(),Model=targetView.getStore().treeStore.model,records,i,len,record,insertionMethod,argList,needTargetExpand,transferData;if(data.copy){records=data.records;data.records=[];for(i=0,len=records.length;i<len;i++){record=records[i];if(record.isNode){data.records.push(record.copy(undefined,true))}else{data.records.push(new Model(record.data,record.getId()))}}}me.cancelExpand();if(position=="before"){insertionMethod=parentNode.insertBefore;argList=[null,targetNode];targetNode=parentNode}else if(position=="after"){if(targetNode.nextSibling){insertionMethod=parentNode.insertBefore;argList=[null,targetNode.nextSibling]}else{insertionMethod=parentNode.appendChild;argList=[null]}targetNode=parentNode}else{if(!(targetNode.isExpanded()||targetNode.isLoading())){needTargetExpand=true}insertionMethod=targetNode.appendChild;argList=[null]}transferData=function(){var color,n;Ext.suspendLayouts();targetView.getSelectionModel().clearSelections();for(i=0,len=data.records.length;i<len;i++){record=data.records[i];if(!record.isNode){if(record.isModel){record=new Model(record.data,record.getId())}else{record=new Model(record)}data.records[i]=record}argList[0]=record;insertionMethod.apply(targetNode,argList)}if(me.sortOnDrop){targetNode.sort(targetNode.getOwnerTree().store.generateComparator())}Ext.resumeLayouts(true);if(Ext.enableFx&&me.dropHighlight){color=me.dropHighlightColor;for(i=0;i<len;i++){n=targetView.getNode(data.records[i]);if(n){Ext.fly(n).highlight(color)}}}};if(needTargetExpand){targetNode.expand(false,transferData)}else if(targetNode.isLoading()){targetNode.on({expand:transferData,delay:1,single:true})}else{transferData()}}});