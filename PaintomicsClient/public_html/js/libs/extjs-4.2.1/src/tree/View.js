Ext.define("Ext.tree.View",{extend:"Ext.view.Table",alias:"widget.treeview",requires:["Ext.data.NodeStore"],isTreeView:true,loadingCls:Ext.baseCSSPrefix+"grid-tree-loading",expandedCls:Ext.baseCSSPrefix+"grid-tree-node-expanded",leafCls:Ext.baseCSSPrefix+"grid-tree-node-leaf",expanderSelector:"."+Ext.baseCSSPrefix+"tree-expander",checkboxSelector:"."+Ext.baseCSSPrefix+"tree-checkbox",expanderIconOverCls:Ext.baseCSSPrefix+"tree-expander-over",nodeAnimWrapCls:Ext.baseCSSPrefix+"tree-animator-wrap",blockRefresh:true,loadMask:false,rootVisible:true,deferInitialRefresh:false,expandDuration:250,collapseDuration:250,toggleOnDblClick:true,stripeRows:false,uiFields:["expanded","loaded","checked","expandable","leaf","icon","iconCls","loading","qtip","qtitle"],treeRowTpl:["{%","this.processRowValues(values);","this.nextTpl.applyOut(values, out, parent);",'delete values.rowAttr["data-qtip"];','delete values.rowAttr["data-qtitle"];',"%}",{priority:10,processRowValues:function(rowValues){var record=rowValues.record,view=rowValues.view,qtip=record.get("qtip"),qtitle=record.get("qttle");rowValues.rowAttr={};if(qtip){rowValues.rowAttr["data-qtip"]=qtip}if(qtitle){rowValues.rowAttr["data-qtitle"]=qtitle}if(record.isExpanded()){rowValues.rowClasses.push(view.expandedCls)}if(record.isLeaf()){rowValues.rowClasses.push(view.leafCls)}if(record.isLoading()){rowValues.rowClasses.push(view.loadingCls)}}}],initComponent:function(){var me=this,treeStore=me.panel.getStore(),store=me.store;if(me.initialConfig.animate===undefined){me.animate=Ext.enableFx}if(!store||store===treeStore){me.store=store=new Ext.data.NodeStore({treeStore:treeStore,recursive:true,rootVisible:me.rootVisible})}if(me.node){me.setRootNode(me.node)}me.animQueue={};me.animWraps={};me.addEvents("afteritemexpand","afteritemcollapse","nodedragover");me.callParent(arguments);me.addRowTpl(Ext.XTemplate.getTpl(me,"treeRowTpl"))},onBeforeFill:function(treeStore,fillRoot){this.store.suspendEvents()},onFillComplete:function(treeStore,fillRoot,newNodes){var me=this,store=me.store,start=store.indexOf(newNodes[0]);store.resumeEvents();fillRoot.triggerUIUpdate();if(!newNodes.length||start===-1){return}me.onAdd(me.store,newNodes,start);me.refreshPartner()},onBeforeSort:function(){this.store.suspendEvents()},onSort:function(o){if(o.isStore){this.store.resumeEvents();this.refresh();this.refreshPartner()}},refreshPartner:function(){var partner=this.lockingPartner;if(partner){partner.refresh()}},getMaskStore:function(){return this.panel.getStore()},afterRender:function(){var me=this;me.callParent(arguments);me.el.on({scope:me,delegate:me.expanderSelector,mouseover:me.onExpanderMouseOver,mouseout:me.onExpanderMouseOut,click:{delegate:me.checkboxSelector,fn:me.onCheckboxChange,scope:me}})},afterComponentLayout:function(){this.callParent(arguments);var stretcher=this.stretcher;if(stretcher){stretcher.setWidth(this.getWidth()-Ext.getScrollbarSize().width)}},processUIEvent:function(e){if(e.getTarget("."+this.nodeAnimWrapCls,this.el)){return false}return this.callParent(arguments)},onClear:function(){this.store.removeAll()},setRootNode:function(node){var me=this;me.store.setNode(node);me.node=node},onCheckboxChange:function(e,t){var me=this,item=e.getTarget(me.getItemSelector(),me.getTargetEl());if(item){me.onCheckChange(me.getRecord(item))}},onCheckChange:function(record){var checked=record.get("checked");if(Ext.isBoolean(checked)){checked=!checked;record.set("checked",checked);this.fireEvent("checkchange",record,checked)}},getChecked:function(){var checked=[];this.node.cascadeBy(function(rec){if(rec.get("checked")){checked.push(rec)}});return checked},isItemChecked:function(rec){return rec.get("checked")},createAnimWrap:function(record,index){var me=this,node=me.getNode(record),tmpEl,nodeEl,columnSizer=[];me.renderColumnSizer(columnSizer);nodeEl=Ext.get(node);tmpEl=nodeEl.insertSibling({tag:"tr",html:['<td colspan="'+me.panel.headerCt.getColumnCount()+'">','<div class="'+me.nodeAnimWrapCls+'">','<table class="'+Ext.baseCSSPrefix+me.id+"-table "+Ext.baseCSSPrefix+'grid-table" style="border:0" cellspacing="0" cellpadding="0">',columnSizer.join(""),"<tbody></tbody></table>","</div>","</td>"].join("")},"after");return{record:record,node:node,el:tmpEl,expanding:false,collapsing:false,animating:false,animateEl:tmpEl.down("div"),targetEl:tmpEl.down("tbody")}},getAnimWrap:function(parent,bubble){if(!this.animate){return null}var wraps=this.animWraps,wrap=wraps[parent.internalId];if(bubble!==false){while(!wrap&&parent){parent=parent.parentNode;if(parent){wrap=wraps[parent.internalId]}}}return wrap},doAdd:function(records,index){var me=this,nodes=me.bufferRender(records,index,true),record=records[0],parent=record.parentNode,all=me.all,relativeIndex,animWrap=me.getAnimWrap(parent),targetEl,children,len;if(!animWrap||!animWrap.expanding){return me.callParent(arguments)}parent=animWrap.record;targetEl=animWrap.targetEl;children=targetEl.dom.childNodes;len=children.length;relativeIndex=index-me.indexInStore(parent)-1;if(!len||relativeIndex>=len){targetEl.appendChild(nodes)}else{Ext.fly(children[relativeIndex]).insertSibling(nodes,"before",true)}all.insert(index,nodes);if(animWrap.isAnimating){me.onExpand(parent)}},onRemove:function(ds,records,indexes){var me=this,empty,i;if(me.viewReady){empty=me.store.getCount()===0;if(empty){me.refresh()}else{for(i=indexes.length-1;i>=0;--i){me.doRemove(records[i],indexes[i])}}if(me.hasListeners.itemremove){for(i=indexes.length-1;i>=0;--i){me.fireEvent("itemremove",records[i],indexes[i])}}}},doRemove:function(record,index){var me=this,all=me.all,animWrap=me.getAnimWrap(record),item=all.item(index),node=item?item.dom:null;if(!node||!animWrap||!animWrap.collapsing){return me.callParent(arguments)}animWrap.targetEl.dom.insertBefore(node,animWrap.targetEl.dom.firstChild);all.removeElement(index)},onBeforeExpand:function(parent,records,index){var me=this,animWrap;if(me.rendered&&me.all.getCount()&&me.animate){if(me.getNode(parent)){animWrap=me.getAnimWrap(parent,false);if(!animWrap){animWrap=me.animWraps[parent.internalId]=me.createAnimWrap(parent);animWrap.animateEl.setHeight(0)}else if(animWrap.collapsing){animWrap.targetEl.select(me.itemSelector).remove()}animWrap.expanding=true;animWrap.collapsing=false}}},onExpand:function(parent){var me=this,queue=me.animQueue,id=parent.getId(),node=me.getNode(parent),index=node?me.indexOf(node):-1,animWrap,animateEl,targetEl,fromHeight=Ext.isIEQuirks?1:0;if(me.singleExpand){me.ensureSingleExpand(parent)}if(index===-1){return}animWrap=me.getAnimWrap(parent,false);if(!animWrap){parent.isExpandingOrCollapsing=false;me.fireEvent("afteritemexpand",parent,index,node);me.refreshSize();return}animateEl=animWrap.animateEl;targetEl=animWrap.targetEl;animateEl.stopAnimation();queue[id]=true;animateEl.dom.style.height=fromHeight+"px";animateEl.animate({from:{height:fromHeight},to:{height:targetEl.getHeight()},duration:me.expandDuration,listeners:{afteranimate:function(){var items=targetEl.query(me.itemSelector);if(items.length){animWrap.el.insertSibling(items,"before",true)}animWrap.el.remove();me.refreshSize();delete me.animWraps[animWrap.record.internalId];delete queue[id]}},callback:function(){parent.isExpandingOrCollapsing=false;me.fireEvent("afteritemexpand",parent,index,node)}});animWrap.isAnimating=true},onBeforeCollapse:function(parent,records,index,callback,scope){var me=this,animWrap;if(me.rendered&&me.all.getCount()){if(me.animate){if(Ext.Array.contains(parent.stores,me.store)){animWrap=me.getAnimWrap(parent);if(!animWrap){animWrap=me.animWraps[parent.internalId]=me.createAnimWrap(parent,index)}else if(animWrap.expanding){animWrap.targetEl.select(this.itemSelector).remove()}animWrap.expanding=false;animWrap.collapsing=true;animWrap.callback=callback;animWrap.scope=scope}}else{me.onCollapseCallback=callback;me.onCollapseScope=scope}}},onCollapse:function(parent){var me=this,queue=me.animQueue,id=parent.getId(),node=me.getNode(parent),index=node?me.indexOf(node):-1,animWrap=me.getAnimWrap(parent),animateEl;if(!me.all.getCount()||!Ext.Array.contains(parent.stores,me.store)){return}if(!animWrap){parent.isExpandingOrCollapsing=false;me.fireEvent("afteritemcollapse",parent,index,node);me.refreshSize();Ext.callback(me.onCollapseCallback,me.onCollapseScope);me.onCollapseCallback=me.onCollapseScope=null;return}animateEl=animWrap.animateEl;queue[id]=true;animateEl.stopAnimation();animateEl.animate({to:{height:Ext.isIEQuirks?1:0},duration:me.collapseDuration,listeners:{afteranimate:function(){animWrap.el.remove();me.refreshSize();delete me.animWraps[animWrap.record.internalId];delete queue[id]}},callback:function(){parent.isExpandingOrCollapsing=false;me.fireEvent("afteritemcollapse",parent,index,node);Ext.callback(animWrap.callback,animWrap.scope);animWrap.callback=animWrap.scope=null}});animWrap.isAnimating=true},isAnimating:function(node){return!!this.animQueue[node.getId()]},expand:function(record,deep,callback,scope){var me=this,doAnimate=!!me.animate,result;if(!doAnimate||!record.isExpandingOrCollapsing){if(!record.isLeaf()){record.isExpandingOrCollapsing=doAnimate}Ext.suspendLayouts();result=record.expand(deep,callback,scope);Ext.resumeLayouts(true);return result}},collapse:function(record,deep,callback,scope){var me=this,doAnimate=!!me.animate;if(!doAnimate||!record.isExpandingOrCollapsing){if(!record.isLeaf()){record.isExpandingOrCollapsing=doAnimate}return record.collapse(deep,callback,scope)}},toggle:function(record,deep,callback,scope){if(record.isExpanded()){this.collapse(record,deep,callback,scope)}else{this.expand(record,deep,callback,scope)}},onItemDblClick:function(record,item,index){var me=this,editingPlugin=me.editingPlugin;me.callParent(arguments);if(me.toggleOnDblClick&&record.isExpandable()&&!(editingPlugin&&editingPlugin.clicksToEdit===2)){me.toggle(record)}},onBeforeItemMouseDown:function(record,item,index,e){if(e.getTarget(this.expanderSelector,item)){return false}return this.callParent(arguments)},onItemClick:function(record,item,index,e){if(e.getTarget(this.expanderSelector,item)&&record.isExpandable()){this.toggle(record,e.ctrlKey);return false}return this.callParent(arguments)},onExpanderMouseOver:function(e,t){e.getTarget(this.cellSelector,10,true).addCls(this.expanderIconOverCls)},onExpanderMouseOut:function(e,t){e.getTarget(this.cellSelector,10,true).removeCls(this.expanderIconOverCls)},getStoreListeners:function(){var me=this,listeners=me.callParent(arguments);return Ext.apply(listeners,{beforeexpand:me.onBeforeExpand,expand:me.onExpand,beforecollapse:me.onBeforeCollapse,collapse:me.onCollapse,write:me.onStoreWrite,datachanged:me.onStoreDataChanged})},onBindStore:function(){var me=this,treeStore=me.getTreeStore();me.callParent(arguments);me.mon(treeStore,{scope:me,beforefill:me.onBeforeFill,fillcomplete:me.onFillComplete});if(!treeStore.remoteSort){me.mon(treeStore,{scope:me,beforesort:me.onBeforeSort,sort:me.onSort})}},onUnbindStore:function(){var me=this,treeStore=me.getTreeStore();me.callParent(arguments);me.mun(treeStore,{scope:me,beforefill:me.onBeforeFill,fillcomplete:me.onFillComplete});if(!treeStore.remoteSort){me.mun(treeStore,{scope:me,beforesort:me.onBeforeSort,sort:me.onSort})}},getTreeStore:function(){return this.panel.store},ensureSingleExpand:function(node){var parent=node.parentNode;if(parent){parent.eachChild(function(child){if(child!==node&&child.isExpanded()){child.collapse()}})}},shouldUpdateCell:function(record,column,changedFieldNames){if(changedFieldNames){var i=0,len=changedFieldNames.length;for(;i<len;++i){if(Ext.Array.contains(this.uiFields,changedFieldNames[i])){return true}}}return this.callParent(arguments)},onStoreWrite:function(store,operation){var treeStore=this.panel.store;treeStore.fireEvent("write",treeStore,operation)},onStoreDataChanged:function(store,operation){var treeStore=this.panel.store;treeStore.fireEvent("datachanged",treeStore)}});