Ext.define("Ext.selection.RowModel",{extend:"Ext.selection.Model",alias:"selection.rowmodel",requires:["Ext.util.KeyNav"],deltaScroll:5,enableKeyNav:true,ignoreRightMouseSelection:false,constructor:function(){this.addEvents("beforedeselect","beforeselect","deselect","select");this.views=[];this.callParent(arguments)},bindComponent:function(view){var me=this;view.on({itemmousedown:me.onRowMouseDown,itemclick:me.onRowClick,scope:me});if(me.enableKeyNav){me.initKeyNav(view)}},initKeyNav:function(view){var me=this;if(!view.rendered){view.on("render",Ext.Function.bind(me.initKeyNav,me,[view],0),me,{single:true});return}view.el.set({tabIndex:-1});me.keyNav=new Ext.util.KeyNav({target:view,ignoreInputFields:true,eventName:"itemkeydown",processEvent:function(view,record,node,index,event){event.record=record;event.recordIndex=index;return event},up:me.onKeyUp,down:me.onKeyDown,right:me.onKeyRight,left:me.onKeyLeft,pageDown:me.onKeyPageDown,pageUp:me.onKeyPageUp,home:me.onKeyHome,end:me.onKeyEnd,space:me.onKeySpace,enter:me.onKeyEnter,scope:me})},onUpdate:function(record){var me=this,view=me.view,index;if(view&&me.isSelected(record)){index=view.indexOf(record);view.onRowSelect(index);if(record===me.lastFocused){view.onRowFocus(index,true)}}},getRowsVisible:function(){var rowsVisible=false,view=this.views[0],firstRow=view.all.first(),rowHeight,gridViewHeight;if(firstRow){rowHeight=firstRow.getHeight();gridViewHeight=view.el.getHeight();rowsVisible=Math.floor(gridViewHeight/rowHeight)}return rowsVisible},onKeyEnd:function(e){var me=this,view=me.views[0];if(view.bufferedRenderer){view.bufferedRenderer.scrollTo(me.store.getCount()-1,false,function(newIdx,newRecord){me.afterKeyNavigate(e,newRecord)})}else{me.afterKeyNavigate(e,view.getRecord(view.all.getCount()-1))}},onKeyHome:function(e){var me=this,view=me.views[0];if(view.bufferedRenderer){view.bufferedRenderer.scrollTo(0,false,function(newIdx,newRecord){me.afterKeyNavigate(e,newRecord)})}else{me.afterKeyNavigate(e,view.getRecord(0))}},onKeyPageUp:function(e){var me=this,view=me.views[0],rowsVisible=me.getRowsVisible(),newIdx,newRecord;if(rowsVisible){if(view.bufferedRenderer){newIdx=Math.max(e.recordIndex-rowsVisible,0);(me.lastKeyEvent||(me.lastKeyEvent=new Ext.EventObjectImpl)).setEvent(e.browserEvent);view.bufferedRenderer.scrollTo(newIdx,false,me.afterBufferedScrollTo,me)}else{newRecord=view.walkRecs(e.record,-rowsVisible);me.afterKeyNavigate(e,newRecord)}}},onKeyPageDown:function(e){var me=this,view=me.views[0],rowsVisible=me.getRowsVisible(),newIdx,newRecord;if(rowsVisible){if(view.bufferedRenderer){newIdx=Math.min(e.recordIndex+rowsVisible,me.store.getCount()-1);(me.lastKeyEvent||(me.lastKeyEvent=new Ext.EventObjectImpl)).setEvent(e.browserEvent);view.bufferedRenderer.scrollTo(newIdx,false,me.afterBufferedScrollTo,me)}else{newRecord=view.walkRecs(e.record,rowsVisible);me.afterKeyNavigate(e,newRecord)}}},onKeySpace:function(e){var record=this.lastFocused;if(record){this.afterKeyNavigate(e,record)}},onKeyEnter:Ext.emptyFn,onKeyUp:function(e){var newRecord=this.views[0].walkRecs(e.record,-1);if(newRecord){this.afterKeyNavigate(e,newRecord)}},onKeyDown:function(e){var newRecord=this.views[0].walkRecs(e.record,1);if(newRecord){this.afterKeyNavigate(e,newRecord)}},afterBufferedScrollTo:function(newIdx,newRecord){this.afterKeyNavigate(this.lastKeyEvent,newRecord)},scrollByDeltaX:function(delta){var view=this.views[0],section=view.up(),hScroll=section.horizontalScroller;if(hScroll){hScroll.scrollByDeltaX(delta)}},onKeyLeft:function(e){this.scrollByDeltaX(-this.deltaScroll)},onKeyRight:function(e){this.scrollByDeltaX(this.deltaScroll)},onRowMouseDown:function(view,record,item,index,e){var me=this;if(index!==-1){if(!me.allowRightMouseSelection(e)){return}if(!me.isSelected(record)){me.mousedownAction=true;me.processSelection(view,record,item,index,e)}else{me.mousedownAction=false}}},onVetoUIEvent:function(type,view,cell,rowIndex,cellIndex,e,record){if(type=="mousedown"){this.mousedownAction=!this.isSelected(record)}},onRowClick:function(view,record,item,index,e){if(this.mousedownAction){this.mousedownAction=false}else{this.processSelection(view,record,item,index,e)}},processSelection:function(view,record,item,index,e){this.selectWithEvent(record,e)},allowRightMouseSelection:function(e){var disallow=this.ignoreRightMouseSelection&&e.button!==0;if(disallow){disallow=this.hasSelection()}return!disallow},onSelectChange:function(record,isSelected,suppressEvent,commitFn){var me=this,views=me.views,viewsLn=views.length,rowIdx=views[0].indexOf(record),eventName=isSelected?"select":"deselect",i=0;if((suppressEvent||me.fireEvent("before"+eventName,me,record,rowIdx))!==false&&commitFn()!==false){for(;i<viewsLn;i++){if(isSelected){views[i].onRowSelect(rowIdx,suppressEvent)}else{views[i].onRowDeselect(rowIdx,suppressEvent)}}if(!suppressEvent){me.fireEvent(eventName,me,record,rowIdx)}}},onLastFocusChanged:function(oldFocused,newFocused,supressFocus){var views=this.views,viewsLn=views.length,rowIdx,i=0;if(oldFocused){rowIdx=views[0].indexOf(oldFocused);if(rowIdx!=-1){for(;i<viewsLn;i++){views[i].onRowFocus(rowIdx,false,true)}}}if(newFocused){rowIdx=views[0].indexOf(newFocused);if(rowIdx!=-1){for(i=0;i<viewsLn;i++){views[i].onRowFocus(rowIdx,true,supressFocus)}}}this.callParent(arguments)},onEditorTab:function(editingPlugin,e){var me=this,view=me.views[0],record=editingPlugin.getActiveRecord(),header=editingPlugin.getActiveColumn(),position=view.getPosition(record,header),direction=e.shiftKey?"left":"right";do{position=view.walkCells(position,direction,e,me.preventWrap)}while(position&&(!position.columnHeader.getEditor(record)||!editingPlugin.startEditByPosition(position)))},getCurrentPosition:function(){var firstSelection=this.selected.items[0];if(firstSelection){return new Ext.grid.CellContext(this.view).setPosition(this.store.indexOf(firstSelection),0)}},selectByPosition:function(position){this.select(this.store.getAt(position.row))},selectNext:function(keepExisting,suppressEvent){var me=this,store=me.store,selection=me.getSelection(),record=selection[selection.length-1],index=me.views[0].indexOf(record)+1,success;if(index===store.getCount()||index===0){success=false}else{me.doSelect(index,keepExisting,suppressEvent);success=true}return success},selectPrevious:function(keepExisting,suppressEvent){var me=this,selection=me.getSelection(),record=selection[0],index=me.views[0].indexOf(record)-1,success;if(index<0){success=false}else{me.doSelect(index,keepExisting,suppressEvent);success=true}return success},isRowSelected:function(record,index){return this.isSelected(record)}});