Ext.define("Ext.selection.Model",{extend:"Ext.util.Observable",alternateClassName:"Ext.AbstractSelectionModel",requires:["Ext.data.StoreManager"],mixins:{bindable:"Ext.util.Bindable"},allowDeselect:undefined,toggleOnClick:true,selected:null,pruneRemoved:true,suspendChange:0,constructor:function(cfg){var me=this;cfg=cfg||{};Ext.apply(me,cfg);me.addEvents("selectionchange","focuschange");me.modes={SINGLE:true,SIMPLE:true,MULTI:true};me.setSelectionMode(cfg.mode||me.mode);me.selected=new Ext.util.MixedCollection(null,me.getSelectionId);me.callParent(arguments)},bindStore:function(store,initial){var me=this;me.mixins.bindable.bindStore.apply(me,arguments);if(me.store&&!initial){me.refresh()}},getStoreListeners:function(){var me=this;return{add:me.onStoreAdd,clear:me.onStoreClear,bulkremove:me.onStoreRemove,update:me.onStoreUpdate,load:me.onStoreLoad,idchanged:me.onModelIdChanged,refresh:me.onStoreRefresh}},suspendChanges:function(){++this.suspendChange},resumeChanges:function(){if(this.suspendChange){--this.suspendChange}},selectAll:function(suppressEvent){var me=this,selections=me.store.getRange(),i=0,len=selections.length,start=me.getSelection().length;me.suspendChanges();for(;i<len;i++){me.doSelect(selections[i],true,suppressEvent)}me.resumeChanges();if(!suppressEvent){me.maybeFireSelectionChange(me.getSelection().length!==start)}},deselectAll:function(suppressEvent){var me=this,selections=me.getSelection(),selIndexes={},store=me.store,start=selections.length,i,l,rec;for(i=0,l=selections.length;i<l;i++){rec=selections[i];selIndexes[rec.internalId]=store.indexOf(rec)}selections=Ext.Array.sort(selections,function(r1,r2){var idx1=selIndexes[r1.internalId],idx2=selIndexes[r2.internalId];return idx1<idx2?-1:1});me.suspendChanges();me.doDeselect(selections,suppressEvent);me.resumeChanges();if(!suppressEvent){me.maybeFireSelectionChange(me.getSelection().length!==start)}},selectWithEvent:function(record,e){var me=this,isSelected=me.isSelected(record),shift=e.shiftKey,ctrl=e.ctrlKey,start=me.selectionStart,selected=me.getSelection(),len=selected.length,allowDeselect=me.allowDeselect,toDeselect,i,item;switch(me.selectionMode){case"MULTI":if(shift&&start){me.selectRange(start,record,ctrl)}else if(ctrl&&isSelected){me.doDeselect(record,false)}else if(ctrl){me.doSelect(record,true,false)}else if(isSelected&&!shift&&!ctrl&&len>1){toDeselect=[];for(i=0;i<len;++i){item=selected[i];if(item!==record){toDeselect.push(item)}}me.doDeselect(toDeselect)}else if(!isSelected){me.doSelect(record,false)}break;case"SIMPLE":if(isSelected){me.doDeselect(record)}else{me.doSelect(record,true)}break;case"SINGLE":if(allowDeselect&&!ctrl){allowDeselect=me.toggleOnClick}if(allowDeselect&&isSelected){me.doDeselect(record)}else{me.doSelect(record,false)}break}if(!shift){if(me.isSelected(record)){me.selectionStart=record}else{me.selectionStart=null}}},afterKeyNavigate:function(e,record){var me=this,recIdx,fromIdx,isSelected=me.isSelected(record),from=me.selectionStart&&me.isSelected(me.lastFocused)?me.selectionStart:me.selectionStart=me.lastFocused,key=e.getCharCode(),isSpace=key===e.SPACE,direction=key===e.UP||key===e.PAGE_UP?"up":key===e.DOWN||key===e.DOWN?"down":null;switch(me.selectionMode){case"MULTI":if(isSpace){if(e.shiftKey){me.selectRange(from,record,e.ctrlKey)}else{if(isSelected){me.doDeselect(record,e.ctrlKey);me.setLastFocused(null);me.setLastFocused(record)}else{me.doSelect(record,e.ctrlKey)}}}else if(e.shiftKey&&from){fromIdx=me.store.indexOf(from);recIdx=me.store.indexOf(record);if(direction==="up"&&fromIdx<=recIdx){me.deselectRange(me.lastFocused,recIdx+1)}else if(direction==="down"&&fromIdx>=recIdx){me.deselectRange(me.lastFocused,recIdx-1)}else if(from!==record){me.selectRange(from,record,e.ctrlKey)}me.lastSelected=record;me.setLastFocused(record)}else if(e.ctrlKey&&isSelected){me.setLastFocused(record)}else if(e.ctrlKey){me.setLastFocused(record)}else{me.doSelect(record,false)}break;case"SIMPLE":if(isSelected){me.doDeselect(record)}else{me.doSelect(record,true)}break;case"SINGLE":if(isSpace){if(isSelected){me.doDeselect(record);me.setLastFocused(record)}else{me.doSelect(record)}}else if(e.ctrlKey){me.setLastFocused(record)}else if(me.allowDeselect&&isSelected){me.doDeselect(record)}else{me.doSelect(record,false)}break}if(!e.shiftKey){if(me.isSelected(record)){me.selectionStart=record}}},selectRange:function(startRow,endRow,keepExisting){var me=this,store=me.store,selected=me.selected.items,result,i,len,toSelect,toDeselect,idx,rec;if(me.isLocked()){return}result=me.normalizeRowRange(startRow,endRow);startRow=result[0];endRow=result[1];toSelect=[];for(i=startRow;i<=endRow;i++){if(!me.isSelected(store.getAt(i))){toSelect.push(store.getAt(i))}}if(!keepExisting){toDeselect=[];me.suspendChanges();for(i=0,len=selected.length;i<len;++i){rec=selected[i];idx=store.indexOf(rec);if(idx<startRow||idx>endRow){toDeselect.push(rec)}}for(i=0,len=toDeselect.length;i<len;++i){me.doDeselect(toDeselect[i])}me.resumeChanges()}me.doMultiSelect(toSelect,true)},deselectRange:function(startRow,endRow){var me=this,store=me.store,result,i,toDeselect,record;if(me.isLocked()){return}result=me.normalizeRowRange(startRow,endRow);startRow=result[0];endRow=result[1];toDeselect=[];for(i=startRow;i<=endRow;i++){record=store.getAt(i);if(me.isSelected(record)){toDeselect.push(record)}}me.doDeselect(toDeselect)},normalizeRowRange:function(startRow,endRow){var store=this.store,tmp;if(!Ext.isNumber(startRow)){startRow=store.indexOf(startRow)}startRow=Math.max(0,startRow);if(!Ext.isNumber(endRow)){endRow=store.indexOf(endRow)}endRow=Math.min(endRow,store.getCount()-1);if(startRow>endRow){tmp=endRow;endRow=startRow;startRow=tmp}return[startRow,endRow]},onModelIdChanged:function(store,model,oldId,newId,oldInternalId){this.selected.updateKey(oldInternalId,newId)},select:function(records,keepExisting,suppressEvent){if(Ext.isDefined(records)){this.doSelect(records,keepExisting,suppressEvent)}},deselect:function(records,suppressEvent){this.doDeselect(records,suppressEvent)},doSelect:function(records,keepExisting,suppressEvent){var me=this,record;if(me.locked||!me.store){return}if(typeof records==="number"){record=me.store.getAt(records);if(!record){return}records=[record]}if(me.selectionMode=="SINGLE"&&records){record=records.length?records[0]:records;me.doSingleSelect(record,suppressEvent)}else{me.doMultiSelect(records,keepExisting,suppressEvent)}},doMultiSelect:function(records,keepExisting,suppressEvent){var me=this,selected=me.selected,change=false,result,i,len,record,commit;if(me.locked){return}records=!Ext.isArray(records)?[records]:records;len=records.length;if(!keepExisting&&selected.getCount()>0){result=me.deselectDuringSelect(records,selected.getRange(),suppressEvent);if(result[0]){me.maybeFireSelectionChange(result[1]>0&&!suppressEvent);return}}commit=function(){selected.add(record);change=true};for(i=0;i<len;i++){record=records[i];if(me.isSelected(record)){continue}me.lastSelected=record;me.onSelectChange(record,true,suppressEvent,commit)}if(!me.preventFocus){me.setLastFocused(record,suppressEvent)}me.maybeFireSelectionChange(change&&!suppressEvent)},deselectDuringSelect:function(toSelect,selected,suppressEvent){var me=this,len=selected.length,changed=0,failed=false,item,i;me.suspendChanges();for(i=0;i<len;++i){item=selected[i];if(!Ext.Array.contains(toSelect,item)){if(me.doDeselect(item,suppressEvent)){++changed}else{failed=true}}}me.resumeChanges();return[failed,changed]},doDeselect:function(records,suppressEvent){var me=this,selected=me.selected,i=0,len,record,attempted=0,accepted=0,commit;if(me.locked||!me.store){return false}if(typeof records==="number"){record=me.store.getAt(records);if(!record){return false}records=[record]}else if(!Ext.isArray(records)){records=[records]}commit=function(){++accepted;selected.remove(record)};len=records.length;me.suspendChanges();for(;i<len;i++){record=records[i];if(me.isSelected(record)){if(me.lastSelected===record){me.lastSelected=selected.last();if(me.lastFocused===record){me.setLastFocused(null)}}++attempted;me.onSelectChange(record,false,suppressEvent,commit)}}me.resumeChanges();me.maybeFireSelectionChange(accepted>0&&!suppressEvent);return accepted===attempted},doSingleSelect:function(record,suppressEvent){var me=this,changed=false,selected=me.selected,commit;if(me.locked){return}if(me.isSelected(record)){return}if(selected.getCount()){me.suspendChanges();if(!me.doDeselect(me.lastSelected,suppressEvent)){me.resumeChanges();return}me.resumeChanges()}commit=function(){selected.add(record);me.lastSelected=record;changed=true};me.onSelectChange(record,true,suppressEvent,commit);if(changed){if(!suppressEvent&&!me.preventFocus){me.setLastFocused(record)}me.maybeFireSelectionChange(!suppressEvent)}},setLastFocused:function(record,supressFocus){var me=this,recordBeforeLast=me.lastFocused;if(record!==recordBeforeLast){me.lastFocused=record;me.onLastFocusChanged(recordBeforeLast,record,supressFocus)}},isFocused:function(record){return record===this.getLastFocused()},maybeFireSelectionChange:function(fireEvent){var me=this;if(fireEvent&&!me.suspendChange){me.fireEvent("selectionchange",me,me.getSelection())}},getLastSelected:function(){return this.lastSelected},getLastFocused:function(){return this.lastFocused},getSelection:function(){return this.selected.getRange()},getSelectionMode:function(){return this.selectionMode},setSelectionMode:function(selMode){selMode=selMode?selMode.toUpperCase():"SINGLE";this.selectionMode=this.modes[selMode]?selMode:"SINGLE"},isLocked:function(){return this.locked},setLocked:function(locked){this.locked=!!locked},isRangeSelected:function(startRow,endRow){var me=this,store=me.store,i,result;result=me.normalizeRowRange(startRow,endRow);startRow=result[0];endRow=result[1];for(i=startRow;i<=endRow;i++){if(!me.isSelected(store.getAt(i))){return false}}return true},isSelected:function(record){record=Ext.isNumber(record)?this.store.getAt(record):record;return this.selected.contains(record)},hasSelection:function(){return this.selected.getCount()>0},getSelectionId:function(record){return record.internalId},pruneIf:function(){var me=this,selected=me.selected,toRemove=[],len=selected.length,i,item;if(me.pruneRemoved){for(i=0;i<len;i++){item=selected.getAt(i);if(!this.storeHasSelected(item)){toRemove.push(item)}}if(toRemove.length){for(i=0,len=toRemove.length;i<len;i++){selected.remove(toRemove[i])}me.maybeFireSelectionChange(true)}}},storeHasSelected:function(record){var store=this.store,records,len,id,i;if(record.hasId()&&store.getById(record)){return true}else{records=store.data.items;len=records.length;id=record.internalId;for(i=0;i<len;++i){if(id===records[i].internalId){return true}}}return false},refresh:function(){var me=this,store=me.store,rec,toBeSelected=[],toBeReAdded=[],oldSelections=me.getSelection(),len=oldSelections.length,selection,change,i=0,lastFocused=me.getLastFocused();if(!store){return}for(;i<len;i++){selection=oldSelections[i];if(store.indexOf(selection)!==-1){toBeSelected.push(selection)}else if(!me.pruneRemoved){rec=store.getById(selection.getId());if(rec){toBeSelected.push(rec)}else{toBeReAdded.push(selection)}}if(me.mode==="SINGLE"&&toBeReAdded.length){break}}if(me.selected.getCount()!=toBeSelected.length+toBeReAdded.length){change=true}me.clearSelections();if(store.indexOf(lastFocused)!==-1){me.setLastFocused(lastFocused,true)}if(toBeSelected.length){me.doSelect(toBeSelected,false,true)}if(toBeReAdded.length){me.selected.addAll(toBeReAdded);if(!me.lastSelected){me.lastSelected=toBeReAdded[toBeReAdded.length-1]}}me.maybeFireSelectionChange(change)},clearSelections:function(){this.selected.clear();this.lastSelected=null;this.setLastFocused(null)},onStoreAdd:Ext.emptyFn,onStoreClear:function(){if(this.selected.getCount()>0){this.clearSelections();this.maybeFireSelectionChange(true)}},onStoreRemove:function(store,records,indexes,isMove){var me=this;if(me.selectionStart&&Ext.Array.contains(records,me.selectionStart)){me.selectionStart=null}if(isMove||me.locked||!me.pruneRemoved){return}me.deselectDeletedRecords(records)},deselectDeletedRecords:function(records){var me=this,selected=me.selected,i,length=records.length,removed=0,record;for(i=0;i<length;i++){record=records[i];if(selected.remove(record)){if(me.lastSelected==record){me.lastSelected=null}if(me.getLastFocused()==record){me.setLastFocused(null)}++removed}}if(removed){me.maybeFireSelectionChange(true)}},getCount:function(){return this.selected.getCount()},onUpdate:Ext.emptyFn,destroy:function(){this.clearListeners()},onStoreUpdate:Ext.emptyFn,onStoreRefresh:Ext.emptyFn,onStoreLoad:Ext.emptyFn,onSelectChange:function(record,isSelected,suppressEvent,commitFn){var me=this,eventName=isSelected?"select":"deselect";if((suppressEvent||me.fireEvent("before"+eventName,me,record))!==false&&commitFn()!==false){if(!suppressEvent){me.fireEvent(eventName,me,record)}}},onLastFocusChanged:function(oldFocused,newFocused){this.fireEvent("focuschange",this,oldFocused,newFocused)},onEditorKey:Ext.emptyFn,beforeViewRender:function(view){this.views=this.views||[];this.views.push(view);this.bindStore(view.getStore(),true)},bindComponent:Ext.emptyFn});