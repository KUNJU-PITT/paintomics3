Ext.define("Ext.selection.CellModel",{extend:"Ext.selection.Model",alias:"selection.cellmodel",requires:["Ext.grid.CellContext","Ext.util.KeyNav"],isCellModel:true,enableKeyNav:true,preventWrap:false,noSelection:{row:-1,column:-1},constructor:function(){this.addEvents("deselect","select");this.callParent(arguments)},bindComponent:function(view){var me=this,grid=view.ownerCt;me.primaryView=view;me.views=me.views||[];me.views.push(view);me.bindStore(view.getStore(),true);view.on({cellmousedown:me.onMouseDown,refresh:me.onViewRefresh,scope:me});if(grid.optimizedColumnMove!==false){grid.on("columnmove",me.onColumnMove,me)}if(me.enableKeyNav){me.initKeyNav(view)}},initKeyNav:function(view){var me=this;if(!view.rendered){view.on("render",Ext.Function.bind(me.initKeyNav,me,[view],0),me,{single:true});return}view.el.set({tabIndex:-1});me.keyNav=new Ext.util.KeyNav({target:view.el,ignoreInputFields:true,up:me.onKeyUp,down:me.onKeyDown,right:me.onKeyRight,left:me.onKeyLeft,tab:me.onKeyTab,scope:me})},getHeaderCt:function(){var selection=this.getCurrentPosition(),view=selection?selection.view:this.primaryView;return view.headerCt},onKeyUp:function(e){this.doMove("up",e)},onKeyDown:function(e){this.doMove("down",e)},onKeyLeft:function(e){this.doMove("left",e)},onKeyRight:function(e){this.doMove("right",e)},doMove:function(direction,e){this.keyNavigation=true;this.move(direction,e);this.keyNavigation=false},onVetoUIEvent:Ext.emptyFn,select:function(pos,keepExisting,suppressEvent){var me=this,row,oldPos=me.getCurrentPosition(),store=me.view.store;if(pos||pos===0){if(pos.isModel){row=store.indexOf(pos);if(row!==-1){pos={row:row,column:oldPos?oldPos.column:0}}else{pos=null}}else if(typeof pos==="number"){pos={row:pos,column:0}}}if(pos){me.selectByPosition(pos,suppressEvent)}else{me.deselect()}},deselect:function(record,suppressEvent){this.selectByPosition(null,suppressEvent)},move:function(dir,e){var me=this,pos=me.getCurrentPosition(),newPos;if(pos){newPos=pos.view.walkCells(pos,dir,e,me.preventWrap);if(newPos){newPos.view=pos.view;return me.setCurrentPosition(newPos)}}return null},getCurrentPosition:function(){return this.selecting?this.nextSelection:this.selection},setCurrentPosition:function(pos,suppressEvent){var me=this,last=me.selection;me.lastSelection=last;if(last){if(pos&&(pos.record===last.record&&pos.columnHeader===last.columnHeader&&pos.view===last.view)){pos=null}else{me.onCellDeselect(me.selection,suppressEvent)}}if(pos){me.nextSelection=new Ext.grid.CellContext(me.primaryView).setPosition(pos);me.selecting=true;me.onCellSelect(me.nextSelection,suppressEvent);me.selecting=false;return me.selection=me.nextSelection}return null},isCellSelected:function(view,row,column){var me=this,testPos,pos=me.getCurrentPosition();if(pos&&pos.view===view){testPos=new Ext.grid.CellContext(view).setPosition({row:row,column:column});return testPos.record===pos.record&&testPos.columnHeader===pos.columnHeader}},onStoreRemove:function(store,records,indexes){var me=this,pos=me.getCurrentPosition(),i,length=records.length,index,shuffleCount=0;me.callParent(arguments);if(pos){if(indexes[0]>pos.row){return}for(i=0;i<length;i++){index=indexes[i];if(index<pos.row){shuffleCount++}else{break}}if(shuffleCount){pos.setRow(pos.row-shuffleCount)}}},onMouseDown:function(view,cell,cellIndex,record,row,recordIndex,e){if(recordIndex!==-1){this.setCurrentPosition({view:view,row:row,column:cellIndex})}},onCellSelect:function(position,supressEvent){if(position&&position.row!==undefined&&position.row>-1){this.doSelect(position.record,false,supressEvent)}},onCellDeselect:function(position,supressEvent){if(position&&position.row!==undefined){this.doDeselect(position.record,supressEvent)}},onSelectChange:function(record,isSelected,suppressEvent,commitFn){var me=this,pos,eventName,view;if(isSelected){pos=me.nextSelection;eventName="select"}else{pos=me.lastSelection||me.noSelection;eventName="deselect"}view=pos.view||me.primaryView;if((suppressEvent||me.fireEvent("before"+eventName,me,record,pos.row,pos.column))!==false&&commitFn()!==false){if(isSelected){view.focusRow(record,true);view.onCellSelect(pos)}else{view.onCellDeselect(pos);delete me.selection}if(!suppressEvent){me.fireEvent(eventName,me,record,pos.row,pos.column)}}},onKeyTab:function(e,t){var me=this,pos=me.getCurrentPosition(),editingPlugin;if(pos){editingPlugin=pos.view.editingPlugin;if(editingPlugin&&me.wasEditing){me.onEditorTab(editingPlugin,e)}else{me.move(e.shiftKey?"left":"right",e)}}},onEditorTab:function(editingPlugin,e){var me=this,direction=e.shiftKey?"left":"right",position=me.move(direction,e);if(position){if(editingPlugin.startEdit(position.record,position.columnHeader)){me.wasEditing=false}else{me.wasEditing=true}}},refresh:function(){var pos=this.getCurrentPosition(),selRowIdx;if(pos&&(selRowIdx=this.store.indexOf(this.selected.last()))!==-1){pos.row=selRowIdx}},onColumnMove:function(headerCt,header,fromIdx,toIdx){var grid=headerCt.up("tablepanel");if(grid){this.onViewRefresh(grid.view)}},onUpdate:function(record){var me=this,pos;if(me.isSelected(record)){pos=me.selecting?me.nextSelection:me.selection;me.view.onCellSelect(pos)}},onViewRefresh:function(view){var me=this,pos=me.getCurrentPosition(),headerCt=view.headerCt,record,columnHeader;if(pos&&pos.view===view){record=pos.record;columnHeader=pos.columnHeader;if(!columnHeader.isDescendantOf(headerCt)){columnHeader=headerCt.queryById(columnHeader.id)||headerCt.down('[text="'+columnHeader.text+'"]')||headerCt.down('[dataIndex="'+columnHeader.dataIndex+'"]')}if(columnHeader&&view.store.indexOfId(record.getId())!==-1){me.setCurrentPosition({row:record,column:columnHeader,view:view})}}},selectByPosition:function(position,suppressEvent){this.setCurrentPosition(position,suppressEvent)}});