Ext.define("Ext.util.TaskRunner",{interval:10,timerId:null,constructor:function(interval){var me=this;if(typeof interval=="number"){me.interval=interval}else if(interval){Ext.apply(me,interval)}me.tasks=[];me.timerFn=Ext.Function.bind(me.onTick,me)},newTask:function(config){var task=new Ext.util.TaskRunner.Task(config);task.manager=this;return task},start:function(task){var me=this,now=Ext.Date.now();if(!task.pending){me.tasks.push(task);task.pending=true}task.stopped=false;task.taskStartTime=now;task.taskRunTime=task.fireOnStart!==false?0:task.taskStartTime;task.taskRunCount=0;if(!me.firing){if(task.fireOnStart!==false){me.startTimer(0,now)}else{me.startTimer(task.interval,now)}}return task},stop:function(task){if(!task.stopped){task.stopped=true;if(task.onStop){task.onStop.call(task.scope||task,task)}}return task},stopAll:function(){Ext.each(this.tasks,this.stop,this)},firing:false,nextExpires:1e99,onTick:function(){var me=this,tasks=me.tasks,now=Ext.Date.now(),nextExpires=1e99,len=tasks.length,expires,newTasks,i,task,rt,remove;me.timerId=null;me.firing=true;for(i=0;i<len||i<(len=tasks.length);++i){task=tasks[i];if(!(remove=task.stopped)){expires=task.taskRunTime+task.interval;if(expires<=now){rt=1;try{rt=task.run.apply(task.scope||task,task.args||[++task.taskRunCount])}catch(taskError){try{Ext.log({msg:taskError,level:"error"});if(task.onError){rt=task.onError.call(task.scope||task,task,taskError)}}catch(ignore){}}task.taskRunTime=now;if(rt===false||task.taskRunCount===task.repeat){me.stop(task);remove=true}else{remove=task.stopped;expires=now+task.interval}}if(!remove&&task.duration&&task.duration<=now-task.taskStartTime){me.stop(task);remove=true}}if(remove){task.pending=false;if(!newTasks){newTasks=tasks.slice(0,i)}}else{if(newTasks){newTasks.push(task)}if(nextExpires>expires){nextExpires=expires}}}if(newTasks){me.tasks=newTasks}me.firing=false;if(me.tasks.length){me.startTimer(nextExpires-now,Ext.Date.now())}if(me.fireIdleEvent!==false){Ext.EventManager.idleEvent.fire()}},startTimer:function(timeout,now){var me=this,expires=now+timeout,timerId=me.timerId;if(timerId&&me.nextExpires-expires>me.interval){clearTimeout(timerId);timerId=null}if(!timerId){if(timeout<me.interval){timeout=me.interval}me.timerId=setTimeout(me.timerFn,timeout);me.nextExpires=expires}}},function(){var me=this,proto=me.prototype;proto.destroy=proto.stopAll;Ext.util.TaskManager=Ext.TaskManager=new me;me.Task=new Ext.Class({isTask:true,stopped:true,fireOnStart:false,constructor:function(config){Ext.apply(this,config)},restart:function(interval){if(interval!==undefined){this.interval=interval}this.manager.start(this)},start:function(interval){if(this.stopped){this.restart(interval)}},stop:function(){this.manager.stop(this)}});proto=me.Task.prototype;proto.destroy=proto.stop});