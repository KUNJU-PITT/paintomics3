Ext.define("Ext.util.History",{singleton:true,alternateClassName:"Ext.History",mixins:{observable:"Ext.util.Observable"},useTopWindow:true,fieldId:Ext.baseCSSPrefix+"history-field",iframeId:Ext.baseCSSPrefix+"history-frame",constructor:function(){var me=this;me.oldIEMode=Ext.isIE7m||!Ext.isStrict&&Ext.isIE8;me.iframe=null;me.hiddenField=null;me.ready=false;me.currentToken=null;me.mixins.observable.constructor.call(me)},getHash:function(){var href=window.location.href,i=href.indexOf("#");return i>=0?href.substr(i+1):null},setHash:function(hash){var me=this,win=me.useTopWindow?window.top:window;try{win.location.hash=hash}catch(e){}},doSave:function(){this.hiddenField.value=this.currentToken},handleStateChange:function(token){this.currentToken=token;this.fireEvent("change",token)},updateIFrame:function(token){var html='<html><body><div id="state">'+Ext.util.Format.htmlEncode(token)+"</div></body></html>",doc;try{doc=this.iframe.contentWindow.document;doc.open();doc.write(html);doc.close();return true}catch(e){return false}},checkIFrame:function(){var me=this,contentWindow=me.iframe.contentWindow,doc,elem,oldToken,oldHash;if(!contentWindow||!contentWindow.document){Ext.Function.defer(this.checkIFrame,10,this);return}doc=contentWindow.document;elem=doc.getElementById("state");oldToken=elem?elem.innerText:null;oldHash=me.getHash();Ext.TaskManager.start({run:function(){var doc=contentWindow.document,elem=doc.getElementById("state"),newToken=elem?elem.innerText:null,newHash=me.getHash();if(newToken!==oldToken){oldToken=newToken;me.handleStateChange(newToken);me.setHash(newToken);oldHash=newToken;me.doSave()}else if(newHash!==oldHash){oldHash=newHash;me.updateIFrame(newHash)}},interval:50,scope:me});me.ready=true;me.fireEvent("ready",me)},startUp:function(){var me=this,hash;me.currentToken=me.hiddenField.value||this.getHash();if(me.oldIEMode){me.checkIFrame()}else{hash=me.getHash();Ext.TaskManager.start({run:function(){var newHash=me.getHash();if(newHash!==hash){hash=newHash;me.handleStateChange(hash);me.doSave()}},interval:50,scope:me});me.ready=true;me.fireEvent("ready",me)}},init:function(onReady,scope){var me=this,DomHelper=Ext.DomHelper;if(me.ready){Ext.callback(onReady,scope,[me]);return}if(!Ext.isReady){Ext.onReady(function(){me.init(onReady,scope)});return}me.hiddenField=Ext.getDom(me.fieldId);if(!me.hiddenField){me.hiddenField=Ext.getBody().createChild({id:Ext.id(),tag:"form",cls:Ext.baseCSSPrefix+"hide-display",children:[{tag:"input",type:"hidden",id:me.fieldId}]},false,true).firstChild}if(me.oldIEMode){me.iframe=Ext.getDom(me.iframeId);if(!me.iframe){me.iframe=DomHelper.append(me.hiddenField.parentNode,{tag:"iframe",id:me.iframeId,src:Ext.SSL_SECURE_URL})}}me.addEvents("ready","change");if(onReady){me.on("ready",onReady,scope,{single:true})}me.startUp()},add:function(token,preventDup){var me=this;if(preventDup!==false){if(me.getToken()===token){return true}}if(me.oldIEMode){return me.updateIFrame(token)}else{me.setHash(token);return true}},back:function(){window.history.go(-1)},forward:function(){window.history.go(1)},getToken:function(){return this.ready?this.currentToken:this.getHash()}});