Ext.define("Ext.util.Floating",{uses:["Ext.Layer","Ext.window.Window"],focusOnToFront:true,shadow:"sides",constrain:false,constructor:function(dom){var me=this;me.fixed=me.fixed&&!(Ext.isIE6||Ext.isIEQuirks);me.el=new Ext.dom.Layer(Ext.apply({preventSync:true,hideMode:me.hideMode,hidden:me.hidden,shadow:typeof me.shadow!="undefined"?me.shadow:"sides",shadowOffset:me.shadowOffset,constrain:false,fixed:me.fixed,shim:me.shim===false?false:undefined},me.floating),dom);if(me.modal&&!(Ext.FocusManager&&Ext.FocusManager.enabled)){me.mon(me.el,{keydown:me.onKeyDown,scope:me})}me.mon(me.el,{mousedown:me.onMouseDown,scope:me});me.floating=true;me.registerWithOwnerCt();me.initHierarchyEvents()},initHierarchyEvents:function(){var me=this,syncHidden=this.syncHidden;if(!me.hasHierarchyEventListeners){me.mon(me.hierarchyEventSource,{hide:syncHidden,collapse:syncHidden,show:syncHidden,expand:syncHidden,added:syncHidden,scope:me});me.hasHierarchyEventListeners=true}},registerWithOwnerCt:function(){var me=this,ownerCt=me.ownerCt,zip=me.zIndexParent;if(zip){zip.unregisterFloatingItem(me)}zip=me.zIndexParent=me.up("[floating]");me.setFloatParent(ownerCt||zip);delete me.ownerCt;if(zip){zip.registerFloatingItem(me)}else{Ext.WindowManager.register(me)}},onKeyDown:function(e){var me=this,shift,focusables,first,last;if(e.getKey()==Ext.EventObject.TAB){shift=e.shiftKey;focusables=me.el.query(":focusable");first=focusables[0];last=focusables[focusables.length-1];if(first&&last&&e.target===(shift?first:last)){e.stopEvent();(shift?last:first).focus(false,true)}}},onMouseDown:function(e){var focusTask=this.focusTask;if(this.floating&&(!focusTask||!focusTask.id)){this.toFront(!!e.getTarget(":focusable"))}},setFloatParent:function(floatParent){var me=this;me.floatParent=floatParent;if((me.constrain||me.constrainHeader)&&!me.constrainTo){me.constrainTo=floatParent?floatParent.getTargetEl():me.container}},syncShadow:function(){if(this.floating){this.el.sync(true)}},onBeforeFloatLayout:function(){this.el.preventSync=true},onAfterFloatLayout:function(){delete this.el.preventSync;this.syncShadow()},syncHidden:function(){var me=this,hidden=me.hidden||!me.rendered,hierarchicallyHidden=me.hierarchicallyHidden=me.isHierarchicallyHidden(),pendingShow=me.pendingShow;if(hidden!==hierarchicallyHidden){if(hierarchicallyHidden){me.hide();me.pendingShow=true}else if(pendingShow){delete me.pendingShow;if(pendingShow.length){me.show.apply(me,pendingShow)}else{me.show()}}}},setZIndex:function(index){var me=this;me.el.setZIndex(index);index+=10;if(me.floatingDescendants){index=Math.floor(me.floatingDescendants.setBase(index)/100)*100+1e4}return index},doConstrain:function(constrainTo){var me=this,xy=me.calculateConstrainedPosition(constrainTo,null,true);if(xy){me.setPosition(xy)}},toFront:function(preventFocus){var me=this,zip=me.zIndexParent,preventFocusSetting=me.preventFocusOnActivate;if(zip&&me.bringParentToFront!==false){zip.toFront(true)}if(!Ext.isDefined(preventFocus)){preventFocus=!me.focusOnToFront}if(preventFocus){me.preventFocusOnActivate=true}if(me.zIndexManager.bringToFront(me,preventFocus)){if(!preventFocus){me.focus(false,true)}}me.preventFocusOnActivate=preventFocusSetting;return me},setActive:function(active,newActive){var me=this;if(active){if(me.el.shadow&&!me.maximized){me.el.enableShadow(true)}if(!me.preventFocusOnActivate){me.focus(false,true)}me.fireEvent("activate",me)}else{if(me.isWindow&&(newActive&&newActive.isWindow)&&me.hideShadowOnDeactivate){me.el.disableShadow()}me.fireEvent("deactivate",me)}},toBack:function(){this.zIndexManager.sendToBack(this);return this},center:function(){var me=this,xy;if(me.isVisible()){xy=me.getAlignToXY(me.container,"c-c");me.setPagePosition(xy)}else{me.needsCenter=true}return me},onFloatShow:function(){if(this.needsCenter){this.center()}delete this.needsCenter},fitContainer:function(animate){var me=this,parent=me.floatParent,container=parent?parent.getTargetEl():me.container,newBox=container.getViewSize(false),newPosition=parent||container.dom!==document.body?[0,0]:container.getXY();newBox.x=newPosition[0];newBox.y=newPosition[1];me.setBox(newBox,animate)}});