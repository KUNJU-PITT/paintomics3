Ext.define("Ext.view.DropZone",{extend:"Ext.dd.DropZone",indicatorHtml:'<div class="'+Ext.baseCSSPrefix+'grid-drop-indicator-left"></div><div class="'+Ext.baseCSSPrefix+'grid-drop-indicator-right"></div>',indicatorCls:Ext.baseCSSPrefix+"grid-drop-indicator",constructor:function(config){var me=this;Ext.apply(me,config);if(!me.ddGroup){me.ddGroup="view-dd-zone-"+me.view.id}me.callParent([me.view.el])},fireViewEvent:function(){var me=this,result;me.lock();result=me.view.fireEvent.apply(me.view,arguments);me.unlock();return result},getTargetFromEvent:function(e){var node=e.getTarget(this.view.getItemSelector()),mouseY,nodeList,testNode,i,len,box;if(!node){mouseY=e.getPageY();for(i=0,nodeList=this.view.getNodes(),len=nodeList.length;i<len;i++){testNode=nodeList[i];box=Ext.fly(testNode).getBox();if(mouseY<=box.bottom){return testNode}}}return node},getIndicator:function(){var me=this;if(!me.indicator){me.indicator=new Ext.Component({html:me.indicatorHtml,cls:me.indicatorCls,ownerCt:me.view,floating:true,shadow:false})}return me.indicator},getPosition:function(e,node){var y=e.getXY()[1],region=Ext.fly(node).getRegion(),pos;if(region.bottom-y>=(region.bottom-region.top)/2){pos="before"}else{pos="after"}return pos},containsRecordAtOffset:function(records,record,offset){if(!record){return false}var view=this.view,recordIndex=view.indexOf(record),nodeBefore=view.getNode(recordIndex+offset,true),recordBefore=nodeBefore?view.getRecord(nodeBefore):null;return recordBefore&&Ext.Array.contains(records,recordBefore)},positionIndicator:function(node,data,e){var me=this,view=me.view,pos=me.getPosition(e,node),overRecord=view.getRecord(node),draggingRecords=data.records,indicatorY;if(!Ext.Array.contains(draggingRecords,overRecord)&&(pos=="before"&&!me.containsRecordAtOffset(draggingRecords,overRecord,-1)||pos=="after"&&!me.containsRecordAtOffset(draggingRecords,overRecord,1))){me.valid=true;if(me.overRecord!=overRecord||me.currentPosition!=pos){indicatorY=Ext.fly(node).getY()-view.el.getY()-1;if(pos=="after"){indicatorY+=Ext.fly(node).getHeight()}me.getIndicator().setWidth(Ext.fly(view.el).getWidth()).showAt(0,indicatorY);me.overRecord=overRecord;me.currentPosition=pos}}else{me.invalidateDrop()}},invalidateDrop:function(){if(this.valid){this.valid=false;this.getIndicator().hide()}},onNodeOver:function(node,dragZone,e,data){var me=this;if(!Ext.Array.contains(data.records,me.view.getRecord(node))){me.positionIndicator(node,data,e)}return me.valid?me.dropAllowed:me.dropNotAllowed},notifyOut:function(node,dragZone,e,data){var me=this;me.callParent(arguments);me.overRecord=me.currentPosition=null;me.valid=false;if(me.indicator){me.indicator.hide()}},onContainerOver:function(dd,e,data){var me=this,view=me.view,count=view.dataSource.getCount();if(count){me.positionIndicator(view.all.last(),data,e)}else{me.overRecord=me.currentPosition=null;me.getIndicator().setWidth(Ext.fly(view.el).getWidth()).showAt(0,0);me.valid=true}return me.dropAllowed},onContainerDrop:function(dd,e,data){return this.onNodeDrop(dd,null,e,data)},onNodeDrop:function(targetNode,dragZone,e,data){var me=this,dropHandled=false,dropHandlers={wait:false,processDrop:function(){me.invalidateDrop();me.handleNodeDrop(data,me.overRecord,me.currentPosition);dropHandled=true;me.fireViewEvent("drop",targetNode,data,me.overRecord,me.currentPosition)},cancelDrop:function(){me.invalidateDrop();dropHandled=true}},performOperation=false;if(me.valid){performOperation=me.fireViewEvent("beforedrop",targetNode,data,me.overRecord,me.currentPosition,dropHandlers);if(dropHandlers.wait){return}if(performOperation!==false){if(!dropHandled){dropHandlers.processDrop()}}}return performOperation},destroy:function(){Ext.destroy(this.indicator);delete this.indicator;this.callParent()}});