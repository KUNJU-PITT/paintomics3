Ext.define("Ext.grid.locking.Lockable",{alternateClassName:"Ext.grid.Lockable",requires:["Ext.grid.locking.View","Ext.grid.header.Container","Ext.grid.locking.HeaderContainer","Ext.view.Table"],syncRowHeight:true,headerCounter:0,scrollDelta:40,lockedGridCls:Ext.baseCSSPrefix+"grid-inner-locked",unlockText:"Unlock",lockText:"Lock",bothCfgCopy:["invalidateScrollerOnRefresh","hideHeaders","enableColumnHide","enableColumnMove","enableColumnResize","sortableColumns","columnLines","rowLines"],normalCfgCopy:["verticalScroller","verticalScrollDock","verticalScrollerType","scroll"],lockedCfgCopy:[],determineXTypeToCreate:function(lockedSide){var me=this,typeToCreate,xtypes,xtypesLn,xtype,superxtype;if(me.subGridXType){typeToCreate=me.subGridXType}else{if(!lockedSide){return"gridpanel"}xtypes=this.getXTypes().split("/");xtypesLn=xtypes.length;xtype=xtypes[xtypesLn-1];superxtype=xtypes[xtypesLn-2];if(superxtype!=="tablepanel"){typeToCreate=superxtype}else{typeToCreate=xtype}}return typeToCreate},injectLockable:function(){this.lockable=true;this.hasView=true;var me=this,scrollbarHeight=Ext.getScrollbarSize().height,store=me.store=Ext.StoreManager.lookup(me.store),selModel=me.getSelectionModel(),allFeatures,allPlugins,lockedGrid,normalGrid,i,columns,lockedHeaderCt,normalHeaderCt,lockedView,normalView,listeners,bufferedRenderer=me.findPlugin("bufferedrenderer");allFeatures=me.constructLockableFeatures();if(me.features){me.features=null}allPlugins=me.constructLockablePlugins();me.plugins=allPlugins.topPlugins;lockedGrid=Ext.apply({id:me.id+"-locked",isLocked:true,ownerLockable:me,xtype:me.determineXTypeToCreate(true),store:store,scrollerOwner:false,animate:false,scroll:scrollbarHeight?false:"vertical",selModel:selModel,border:false,cls:me.lockedGridCls,isLayoutRoot:function(){return false},features:allFeatures.lockedFeatures,plugins:allPlugins.lockedPlugins},me.lockedGridConfig);normalGrid=Ext.apply({id:me.id+"-normal",isLocked:false,ownerLockable:me,xtype:me.determineXTypeToCreate(),store:store,scrollerOwner:false,selModel:selModel,border:false,isLayoutRoot:function(){return false},features:allFeatures.normalFeatures,plugins:allPlugins.normalPlugins},me.normalGridConfig);me.addCls(Ext.baseCSSPrefix+"grid-locked");Ext.copyTo(normalGrid,me,me.bothCfgCopy,true);Ext.copyTo(lockedGrid,me,me.bothCfgCopy,true);Ext.copyTo(normalGrid,me,me.normalCfgCopy,true);Ext.copyTo(lockedGrid,me,me.lockedCfgCopy,true);for(i=0;i<me.normalCfgCopy.length;i++){delete me[me.normalCfgCopy[i]]}for(i=0;i<me.lockedCfgCopy.length;i++){delete me[me.lockedCfgCopy[i]]}me.addEvents("processcolumns","lockcolumn","unlockcolumn");me.addStateEvents(["lockcolumn","unlockcolumn"]);columns=me.processColumns(me.columns);lockedGrid.width=columns.lockedWidth+Ext.num(selModel.headerWidth,0)+(columns.locked.items.length?1:0);lockedGrid.columns=columns.locked;normalGrid.columns=columns.normal;normalGrid.flex=1;lockedGrid.viewConfig=me.lockedViewConfig||{};lockedGrid.viewConfig.loadingUseMsg=false;lockedGrid.viewConfig.loadMask=false;if(scrollbarHeight){lockedGrid.viewConfig.style="border-bottom:"+scrollbarHeight+"px solid #f6f6f6;"+(lockedGrid.viewConfig.style||"")}normalGrid.viewConfig=me.normalViewConfig||{};normalGrid.viewConfig.loadMask=false;if(me.viewConfig&&me.viewConfig.id){Ext.log.warn('id specified on Lockable viewConfig, it will be shared between both views: "'+me.viewConfig.id+'"')}Ext.applyIf(lockedGrid.viewConfig,me.viewConfig);Ext.applyIf(normalGrid.viewConfig,me.viewConfig);me.lockedGrid=Ext.ComponentManager.create(lockedGrid);if(me.isTree){me.lockedGrid.getView().animate=false;normalGrid.store=me.lockedGrid.view.store;normalGrid.deferRowRender=false;normalGrid.viewConfig.stripeRows=me.lockedGrid.view.stripeRows;normalGrid.rowLines=me.lockedGrid.rowLines}lockedView=me.lockedGrid.getView();normalGrid.viewConfig.lockingPartner=lockedView;me.normalGrid=Ext.ComponentManager.create(normalGrid);lockedView.lockingPartner=normalView=me.normalGrid.getView();me.view=new Ext.grid.locking.View({loadingText:normalView.loadingText,loadingCls:normalView.loadingCls,loadingUseMsg:normalView.loadingUseMsg,loadMask:me.loadMask!==false,locked:me.lockedGrid,normal:me.normalGrid,panel:me});listeners=bufferedRenderer?{}:{scroll:{fn:me.onLockedViewScroll,element:"el",scope:me}};if(scrollbarHeight){me.lockedGrid.on({afterlayout:me.afterLockedViewLayout,scope:me});lockedView.getOverflowStyle();if(lockedView.scrollFlags.y){me.lockedGrid.headerCt.forceFit=true}else{listeners.mousewheel={fn:me.onLockedViewMouseWheel,element:"el",scope:me}}}lockedView.on(listeners);listeners=bufferedRenderer?{}:{scroll:{fn:me.onNormalViewScroll,element:"el",scope:me},scope:me};normalView.on(listeners);lockedHeaderCt=me.lockedGrid.headerCt;normalHeaderCt=me.normalGrid.headerCt;me.headerCt=me.view.headerCt=new Ext.grid.locking.HeaderContainer(me);lockedHeaderCt.lockedCt=true;lockedHeaderCt.lockableInjected=true;normalHeaderCt.lockableInjected=true;lockedHeaderCt.on({add:{buffer:1,scope:me,fn:me.onLockedHeaderAdd},columnshow:me.onLockedHeaderShow,columnhide:me.onLockedHeaderHide,sortchange:me.onLockedHeaderSortChange,columnresize:me.onLockedHeaderResize,scope:me});normalHeaderCt.on({sortchange:me.onNormalHeaderSortChange,scope:me});me.modifyHeaderCt();me.items=[me.lockedGrid,me.normalGrid];me.relayHeaderCtEvents(lockedHeaderCt);me.relayHeaderCtEvents(normalHeaderCt);me.storeRelayers=me.relayEvents(store,["filterchange"]);me.layout={type:"hbox",align:"stretch"}},getLockingViewConfig:function(){return{xclass:"Ext.grid.locking.View",locked:this.lockedGrid,normal:this.normalGrid,panel:this}},processColumns:function(columns){var i,len,column,cp=this.dummyHdrCtr||(this.self.prototype.dummyHdrCtr=new Ext.grid.header.Container),lockedHeaders=[],normalHeaders=[],lockedHeaderCt={itemId:"lockedHeaderCt",stretchMaxPartner:"^^>>#normalHeaderCt",items:lockedHeaders},normalHeaderCt={itemId:"normalHeaderCt",stretchMaxPartner:"^^>>#lockedHeaderCt",items:normalHeaders},result={lockedWidth:0,locked:lockedHeaderCt,normal:normalHeaderCt};if(Ext.isObject(columns)){Ext.applyIf(lockedHeaderCt,columns);Ext.applyIf(normalHeaderCt,columns);Ext.apply(cp,columns);columns=columns.items}for(i=0,len=columns.length;i<len;++i){column=columns[i];if(!column.isComponent){column=cp.lookupComponent(cp.applyDefaults(column))}column.processed=true;if(column.locked||column.autoLock){if(!column.hidden){result.lockedWidth+=this.getColumnWidth(column)||cp.defaultWidth}lockedHeaders.push(column)}else{normalHeaders.push(column)}if(!column.headerId){column.headerId=(column.initialConfig||column).id||"h"+ ++this.headerCounter}}this.fireEvent("processcolumns",this,lockedHeaders,normalHeaders);return result},getColumnWidth:function(column){var result=column.width||0,subcols,len,i;if(column.flex){Ext.Error.raise("Columns which are locked do NOT support a flex width. You must set a width on the "+column.text+"column.")}if(!result&&column.isGroupHeader){subcols=column.items.items;len=subcols.length;for(i=0;i<len;i++){result+=this.getColumnWidth(subcols[i])}}return result},afterLockedViewLayout:function(){var me=this,lockedView=me.lockedGrid.getView(),lockedViewEl=lockedView.el.dom,spacerHeight=me.normalGrid.headerCt.tooNarrow?Ext.getScrollbarSize().height:0;if(lockedView.scrollFlags.x&&lockedViewEl.scrollWidth>lockedViewEl.clientWidth){spacerHeight=0}lockedView.el.dom.style.borderBottomWidth=spacerHeight+"px";if(!Ext.isBorderBox){lockedView.el.setHeight(lockedView.lastBox.height)}},onLockedViewMouseWheel:function(e){var me=this,scrollDelta=-me.scrollDelta,deltaY=scrollDelta*e.getWheelDeltas().y,vertScrollerEl=me.lockedGrid.getView().el.dom,verticalCanScrollDown,verticalCanScrollUp;if(!me.ignoreMousewheel){if(vertScrollerEl){verticalCanScrollDown=vertScrollerEl.scrollTop!==vertScrollerEl.scrollHeight-vertScrollerEl.clientHeight;verticalCanScrollUp=vertScrollerEl.scrollTop!==0}if(deltaY<0&&verticalCanScrollUp||deltaY>0&&verticalCanScrollDown){e.stopEvent();vertScrollerEl.scrollTop+=deltaY;me.normalGrid.getView().el.dom.scrollTop=vertScrollerEl.scrollTop;me.onNormalViewScroll()}}},onLockedViewScroll:function(){var me=this,lockedView=me.lockedGrid.getView(),normalView=me.normalGrid.getView(),normalDom=normalView.el.dom,lockedDom=lockedView.el.dom,normalTable,lockedTable;if(normalDom.scrollTop!==lockedDom.scrollTop){normalDom.scrollTop=lockedDom.scrollTop;if(me.store.buffered){lockedTable=lockedView.el.child("table",true);normalTable=normalView.el.child("table",true);normalTable.style.position="absolute";normalTable.style.top=lockedTable.style.top}}},onNormalViewScroll:function(){var me=this,lockedView=me.lockedGrid.getView(),normalView=me.normalGrid.getView(),normalDom=normalView.el.dom,lockedDom=lockedView.el.dom,normalTable,lockedTable;if(normalDom.scrollTop!==lockedDom.scrollTop){lockedDom.scrollTop=normalDom.scrollTop;if(me.store.buffered){lockedTable=lockedView.el.child("table",true);normalTable=normalView.el.child("table",true);lockedTable.style.position="absolute";lockedTable.style.top=normalTable.style.top}}},syncRowHeights:function(){var me=this,i,lockedView=me.lockedGrid.getView(),normalView=me.normalGrid.getView(),lockedRowEls=lockedView.all.slice(),normalRowEls=normalView.all.slice(),ln=lockedRowEls.length,scrollTop;if(normalRowEls.length===ln){for(i=0;i<ln;i++){normalView.syncRowHeights(lockedRowEls[i],normalRowEls[i])}scrollTop=normalView.el.dom.scrollTop;normalView.el.dom.scrollTop=scrollTop;lockedView.el.dom.scrollTop=scrollTop}},modifyHeaderCt:function(){var me=this;me.lockedGrid.headerCt.getMenuItems=me.getMenuItems(me.lockedGrid.headerCt.getMenuItems,true);me.normalGrid.headerCt.getMenuItems=me.getMenuItems(me.normalGrid.headerCt.getMenuItems,false);me.lockedGrid.headerCt.showMenuBy=Ext.Function.createInterceptor(me.lockedGrid.headerCt.showMenuBy,me.showMenuBy);me.normalGrid.headerCt.showMenuBy=Ext.Function.createInterceptor(me.normalGrid.headerCt.showMenuBy,me.showMenuBy)},onUnlockMenuClick:function(){this.unlock()},onLockMenuClick:function(){this.lock()},showMenuBy:function(t,header){var menu=this.getMenu(),unlockItem=menu.down("#unlockItem"),lockItem=menu.down("#lockItem"),sep=unlockItem.prev();if(header.lockable===false){sep.hide();unlockItem.hide();lockItem.hide()}else{sep.show();unlockItem.show();lockItem.show();if(!unlockItem.initialConfig.disabled){unlockItem.setDisabled(header.lockable===false)}if(!lockItem.initialConfig.disabled){lockItem.setDisabled(!header.isLockable())}}},getMenuItems:function(getMenuItems,locked){var me=this,unlockText=me.unlockText,lockText=me.lockText,unlockCls=Ext.baseCSSPrefix+"hmenu-unlock",lockCls=Ext.baseCSSPrefix+"hmenu-lock",unlockHandler=Ext.Function.bind(me.onUnlockMenuClick,me),lockHandler=Ext.Function.bind(me.onLockMenuClick,me);return function(){var o=getMenuItems.call(this);o.push("-",{itemId:"unlockItem",cls:unlockCls,text:unlockText,handler:unlockHandler,disabled:!locked});o.push({itemId:"lockItem",cls:lockCls,text:lockText,handler:lockHandler,disabled:locked});return o}},syncLockedWidth:function(){var me=this,locked=me.lockedGrid,lockedView=locked.view,lockedViewEl=lockedView.el.dom,normal=me.normalGrid,lockedColCount=locked.headerCt.getVisibleGridColumns().length,normalColCount=normal.headerCt.getVisibleGridColumns().length;Ext.suspendLayouts();if(normalColCount){normal.show();if(lockedColCount){if(!locked.headerCt.forceFit){delete locked.flex;locked.setWidth(locked.headerCt.getFullWidth())}locked.addCls(me.lockedGridCls);locked.show()}else{locked.getView().refresh();locked.hide()}lockedView.el.setStyle(lockedView.getOverflowStyle());me.ignoreMousewheel=lockedView.scrollFlags.y}else{normal.hide();lockedViewEl.style.borderBottomWidth="0";locked.flex=1;delete locked.width;locked.removeCls(me.lockedGridCls);locked.show();lockedView.el.setStyle(normal.view.getOverflowStyle());me.ignoreMousewheel=true}Ext.resumeLayouts(true);return[lockedColCount,normalColCount]},onLockedHeaderAdd:function(){if(!this.ignoreAddLockedColumn){this.syncLockedWidth()}},onLockedHeaderResize:function(){this.syncLockedWidth()},onLockedHeaderHide:function(){this.syncLockedWidth()},onLockedHeaderShow:function(){this.syncLockedWidth()},onLockedHeaderSortChange:function(headerCt,header,sortState){if(sortState){this.normalGrid.headerCt.clearOtherSortStates(null,true)}},onNormalHeaderSortChange:function(headerCt,header,sortState){if(sortState){this.lockedGrid.headerCt.clearOtherSortStates(null,true)}},lock:function(activeHd,toIdx){var me=this,normalGrid=me.normalGrid,lockedGrid=me.lockedGrid,normalHCt=normalGrid.headerCt,lockedHCt=lockedGrid.headerCt,refreshFlags,ownerCt;activeHd=activeHd||normalHCt.getMenu().activeHeader;ownerCt=activeHd.ownerCt;if(!activeHd.isLockable()){return}if(activeHd.flex){activeHd.width=activeHd.getWidth();activeHd.flex=null}Ext.suspendLayouts();ownerCt.remove(activeHd,false);activeHd.locked=true;me.ignoreAddLockedColumn=true;if(Ext.isDefined(toIdx)){lockedHCt.insert(toIdx,activeHd)}else{lockedHCt.add(activeHd)}me.ignoreAddLockedColumn=false;refreshFlags=me.syncLockedWidth();if(refreshFlags[0]){lockedGrid.getView().refresh()}if(refreshFlags[1]){normalGrid.getView().refresh()}Ext.resumeLayouts(true);me.fireEvent("lockcolumn",me,activeHd)},unlock:function(activeHd,toIdx){var me=this,normalGrid=me.normalGrid,lockedGrid=me.lockedGrid,normalHCt=normalGrid.headerCt,lockedHCt=lockedGrid.headerCt,refreshFlags;if(!Ext.isDefined(toIdx)){toIdx=0}activeHd=activeHd||lockedHCt.getMenu().activeHeader;Ext.suspendLayouts();activeHd.ownerCt.remove(activeHd,false);activeHd.locked=false;normalHCt.insert(toIdx,activeHd);refreshFlags=me.syncLockedWidth();if(refreshFlags[0]){lockedGrid.getView().refresh()}if(refreshFlags[1]){normalGrid.getView().refresh()}Ext.resumeLayouts(true);me.fireEvent("unlockcolumn",me,activeHd)},reconfigureLockable:function(store,columns){var me=this,oldStore=me.store,lockedGrid=me.lockedGrid,normalGrid=me.normalGrid;Ext.suspendLayouts();if(columns){lockedGrid.headerCt.removeAll();normalGrid.headerCt.removeAll();columns=me.processColumns(columns);me.ignoreAddLockedColumn=true;lockedGrid.headerCt.add(columns.locked.items);me.ignoreAddLockedColumn=false;normalGrid.headerCt.add(columns.normal.items);me.syncLockedWidth()}if(store&&store!==oldStore){store=Ext.data.StoreManager.lookup(store);me.store=store;lockedGrid.bindStore(store);normalGrid.bindStore(store)}else{lockedGrid.getView().refresh();normalGrid.getView().refresh()}Ext.resumeLayouts(true)},constructLockableFeatures:function(){var features=this.features,feature,featureClone,lockedFeatures,normalFeatures,i=0,len;if(features){lockedFeatures=[];normalFeatures=[];len=features.length;for(;i<len;i++){feature=features[i];if(!feature.isFeature){feature=Ext.create("feature."+feature.ftype,feature)}switch(feature.lockableScope){case"locked":lockedFeatures.push(feature);break;case"normal":normalFeatures.push(feature);break;default:feature.lockableScope="both";lockedFeatures.push(feature);normalFeatures.push(featureClone=feature.clone());featureClone.lockingPartner=feature;feature.lockingPartner=featureClone}}}return{normalFeatures:normalFeatures,lockedFeatures:lockedFeatures}},constructLockablePlugins:function(){var plugins=this.plugins,plugin,normalPlugin,lockedPlugin,topPlugins,lockedPlugins,normalPlugins,i=0,len;if(plugins){topPlugins=[];lockedPlugins=[];normalPlugins=[];len=plugins.length;for(;i<len;i++){plugin=plugins[i];switch(plugin.lockableScope){case"both":lockedPlugins.push(lockedPlugin=plugin.clonePlugin());normalPlugins.push(normalPlugin=plugin.clonePlugin());lockedPlugin.lockingPartner=normalPlugin;normalPlugin.lockingPartner=lockedPlugin;Ext.destroy(plugin);break;case"locked":lockedPlugins.push(plugin);break;case"normal":normalPlugins.push(plugin);break;default:topPlugins.push(plugin)}}}return{topPlugins:topPlugins,normalPlugins:normalPlugins,lockedPlugins:lockedPlugins}},destroyLockable:function(){Ext.destroy(this.view)}},function(){this.borrow(Ext.AbstractComponent,["constructPlugin"])});