Ext.define("Ext.grid.feature.RowBody",{extend:"Ext.grid.feature.Feature",alias:"feature.rowbody",rowBodyCls:Ext.baseCSSPrefix+"grid-row-body",rowBodyHiddenCls:Ext.baseCSSPrefix+"grid-row-body-hidden",rowBodyTdSelector:"td."+Ext.baseCSSPrefix+"grid-cell-rowbody",eventPrefix:"rowbody",eventSelector:"tr."+Ext.baseCSSPrefix+"grid-rowbody-tr",tableTpl:{before:function(values,out){var view=values.view,rowValues=view.rowValues;this.rowBody.setup(values.rows,rowValues)},after:function(values,out){var view=values.view,rowValues=view.rowValues;this.rowBody.cleanup(values.rows,rowValues)},priority:100},extraRowTpl:["{%","values.view.rowBodyFeature.setupRowData(values.record, values.recordIndex, values);","this.nextTpl.applyOut(values, out, parent);","%}",'<tr class="'+Ext.baseCSSPrefix+'grid-rowbody-tr {rowBodyCls}">','<td class="'+Ext.baseCSSPrefix+"grid-cell-rowbody"+'" colspan="{rowBodyColspan}">','<div class="'+Ext.baseCSSPrefix+"grid-rowbody"+' {rowBodyDivCls}">{rowBody}</div>',"</td>","</tr>",{priority:100,syncRowHeights:function(firstRow,secondRow){var owner=this.owner,firstRowBody=Ext.fly(firstRow).down(owner.eventSelector,true),secondRowBody,firstHeight,secondHeight;if(firstRowBody&&(secondRowBody=Ext.fly(secondRow).down(owner.eventSelector,true))){if((firstHeight=firstRowBody.offsetHeight)>(secondHeight=secondRowBody.offsetHeight)){Ext.fly(secondRowBody).setHeight(firstHeight)}else if(secondHeight>firstHeight){Ext.fly(firstRowBody).setHeight(secondHeight)}}},syncContent:function(destRow,sourceRow){var owner=this.owner,destRowBody=Ext.fly(destRow).down(owner.eventSelector,true),sourceRowBody;if(destRowBody&&(sourceRowBody=Ext.fly(sourceRow).down(owner.eventSelector,true))){Ext.fly(destRowBody).syncContent(sourceRowBody)}}}],init:function(grid){var me=this,view=me.view;view.rowBodyFeature=me;if(!view.findFeature("rowwrap")){grid.mon(view,{element:"el",mousedown:me.onMouseDown,scope:me});me.mon(grid.getStore(),"remove",me.onStoreRemove,me)}view.headerCt.on({columnschanged:me.onColumnsChanged,scope:me});view.addTableTpl(me.tableTpl).rowBody=me;view.addRowTpl(Ext.XTemplate.getTpl(this,"extraRowTpl"));me.callParent(arguments)},onStoreRemove:function(store,model,index){var view=this.view,node;if(view.rendered){node=view.getNode(index);if(node){node=Ext.fly(node).next(this.eventSelector);if(node){node.remove()}}}},onMouseDown:function(e){var me=this,tableRow=e.getTarget(me.eventSelector);if(tableRow&&Ext.fly(tableRow=tableRow.previousSibling).is(me.view.getItemSelector())){e.target=tableRow;me.view.handleEvent(e)}},getSelectedRow:function(view,rowIndex){var selectedRow=view.getNode(rowIndex,false);if(selectedRow){return Ext.fly(selectedRow).down(this.eventSelector)}return null},onColumnsChanged:function(headerCt){var items=this.view.el.query(this.rowBodyTdSelector),colspan=headerCt.getVisibleGridColumns().length,len=items.length,i;for(i=0;i<len;++i){items[i].colSpan=colspan}},setupRowData:function(record,rowIndex,rowValues){if(this.getAdditionalData){Ext.apply(rowValues,this.getAdditionalData(record.data,rowIndex,record,rowValues))}},setup:function(rows,rowValues){rowValues.rowBodyCls=this.rowBodyCls;rowValues.rowBodyColspan=rowValues.view.getGridColumns().length},cleanup:function(rows,rowValues){rowValues.rowBodyCls=rowValues.rowBodyColspan=rowValues.rowBody=null}});