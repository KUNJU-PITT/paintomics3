Ext.define("Ext.grid.feature.Grouping",{extend:"Ext.grid.feature.Feature",mixins:{summary:"Ext.grid.feature.AbstractSummary"},requires:["Ext.grid.feature.GroupStore"],alias:"feature.grouping",eventPrefix:"group",groupCls:Ext.baseCSSPrefix+"grid-group-hd",eventSelector:"."+Ext.baseCSSPrefix+"grid-group-hd",refreshData:{},groupInfo:{},wrapsItem:true,groupHeaderTpl:"{columnName}: {name}",depthToIndent:17,collapsedCls:Ext.baseCSSPrefix+"grid-group-collapsed",hdCollapsedCls:Ext.baseCSSPrefix+"grid-group-hd-collapsed",hdNotCollapsibleCls:Ext.baseCSSPrefix+"grid-group-hd-not-collapsible",collapsibleCls:Ext.baseCSSPrefix+"grid-group-hd-collapsible",ctCls:Ext.baseCSSPrefix+"group-hd-container",groupByText:"Group by this field",showGroupsText:"Show in groups",hideGroupedHeader:false,startCollapsed:false,enableGroupingMenu:true,enableNoGroups:true,collapsible:true,expandTip:"Click to expand. CTRL key collapses all others",collapseTip:"Click to collapse. CTRL/click collapses all others",showSummaryRow:false,tableTpl:{before:function(values){if(this.groupingFeature.disabled||values.rows.length===1&&values.rows[0].isSummary){return}this.groupingFeature.setup(values.rows,values.view.rowValues)},after:function(values){if(this.groupingFeature.disabled||values.rows.length===1&&values.rows[0].isSummary){return}this.groupingFeature.cleanup(values.rows,values.view.rowValues)},priority:200},groupTpl:["{%","var me = this.groupingFeature;","if (me.disabled) {","values.needsWrap = false;","} else {","me.setupRowData(values.record, values.recordIndex, values);","values.needsWrap = !me.disabled && (values.isFirstRow || values.summaryRecord);","}","%}",'<tpl if="needsWrap">','<tr data-boundView="{view.id}" data-recordId="{record.internalId}" data-recordIndex="{[values.isCollapsedGroup ? -1 : values.recordIndex]}"','class="{[values.itemClasses.join(" ")]} '+Ext.baseCSSPrefix+'grid-wrap-row<tpl if="!summaryRecord"> '+Ext.baseCSSPrefix+'grid-group-row</tpl>">','<td class="'+Ext.baseCSSPrefix+'group-hd-container" colspan="{columns.length}">','<tpl if="isFirstRow">',"{%",'var groupTitleStyle = (!values.view.lockingPartner || (values.view.ownerCt === values.view.ownerCt.ownerLockable.lockedGrid) || (values.view.lockingPartner.headerCt.getVisibleGridColumns().length === 0)) ? "" : "visibility:hidden";',"%}",'<div id="{groupId}" class="'+Ext.baseCSSPrefix+'grid-group-hd {collapsibleCls}" tabIndex="0">','<div class="'+Ext.baseCSSPrefix+'grid-group-title" style="{[groupTitleStyle]}">','{[values.groupHeaderTpl.apply(values.groupInfo, parent) || "&#160;"]}',"</div>","</div>","</tpl>",'<tpl if="summaryRecord || !isCollapsedGroup">','<table class="',Ext.baseCSSPrefix,"{view.id}-table ",Ext.baseCSSPrefix,"grid-table",'<tpl if="summaryRecord"> ',Ext.baseCSSPrefix,'grid-table-summary</tpl>"','border="0" cellspacing="0" cellpadding="0" style="width:100%">',"{[values.view.renderColumnSizer(out)]}",'<tpl if="!isCollapsedGroup">',"{%","values.itemClasses.length = 0;","this.nextTpl.applyOut(values, out, parent);","%}","</tpl>",'<tpl if="summaryRecord">',"{%me.outputSummaryRecord(values.summaryRecord, values, out);%}","</tpl>","</table>","</tpl>","</td>","</tr>","<tpl else>","{%this.nextTpl.applyOut(values, out, parent);%}","</tpl>",{priority:200,syncRowHeights:function(firstRow,secondRow){firstRow=Ext.fly(firstRow,"syncDest");secondRow=Ext.fly(secondRow,"sycSrc");var owner=this.owner,firstHd=firstRow.down(owner.eventSelector,true),secondHd,firstSummaryRow=firstRow.down(owner.summaryRowSelector,true),secondSummaryRow,firstHeight,secondHeight;if(firstHd&&(secondHd=secondRow.down(owner.eventSelector,true))){firstHd.style.height=secondHd.style.height="";if((firstHeight=firstHd.offsetHeight)>(secondHeight=secondHd.offsetHeight)){Ext.fly(secondHd).setHeight(firstHeight)}else if(secondHeight>firstHeight){Ext.fly(firstHd).setHeight(secondHeight)}}if(firstSummaryRow&&(secondSummaryRow=secondRow.down(owner.summaryRowSelector,true))){firstSummaryRow.style.height=secondSummaryRow.style.height="";if((firstHeight=firstSummaryRow.offsetHeight)>(secondHeight=secondSummaryRow.offsetHeight)){Ext.fly(secondSummaryRow).setHeight(firstHeight)}else if(secondHeight>firstHeight){Ext.fly(firstSummaryRow).setHeight(secondHeight)}}},syncContent:function(destRow,sourceRow){destRow=Ext.fly(destRow,"syncDest");sourceRow=Ext.fly(sourceRow,"sycSrc");var owner=this.owner,destHd=destRow.down(owner.eventSelector,true),sourceHd=sourceRow.down(owner.eventSelector,true),destSummaryRow=destRow.down(owner.summaryRowSelector,true),sourceSummaryRow=sourceRow.down(owner.summaryRowSelector,true);if(destHd&&sourceHd){Ext.fly(destHd).syncContent(sourceHd)}if(destSummaryRow&&sourceSummaryRow){Ext.fly(destSummaryRow).syncContent(sourceSummaryRow)}}}],constructor:function(){this.groupCache={};this.callParent(arguments)},init:function(grid){var me=this,view=me.view;view.isGrouping=true;if(me.lockingPartner&&me.lockingPartner.groupCache){me.groupCache=me.lockingPartner.groupCache}me.mixins.summary.init.call(me);me.callParent(arguments);view.headerCt.on({columnhide:me.onColumnHideShow,columnshow:me.onColumnHideShow,columnmove:me.onColumnMove,scope:me});view.addTableTpl(me.tableTpl).groupingFeature=me;view.addRowTpl(Ext.XTemplate.getTpl(me,"groupTpl")).groupingFeature=me;view.preserveScrollOnRefresh=true;if(view.store.buffered){me.collapsible=false}else{if(this.lockingPartner&&this.lockingPartner.dataSource){me.dataSource=view.dataSource=this.lockingPartner.dataSource}else{me.dataSource=view.dataSource=new Ext.grid.feature.GroupStore(me,view.store)}}me.grid.on({reconfigure:me.onReconfigure});view.on({afterrender:me.afterViewRender,scope:me,single:true})},clearGroupCache:function(){var me=this,groupCache=me.groupCache={};if(me.lockingPartner){me.lockingPartner.groupCache=groupCache}return groupCache},vetoEvent:function(record,row,rowIndex,e){if(e.type!=="mouseover"&&e.type!=="mouseout"&&e.type!=="mouseenter"&&e.type!=="mouseleave"&&e.getTarget(this.eventSelector)){return false}},enable:function(){var me=this,view=me.view,store=view.store,groupToggleMenuItem;me.lastGroupField=me.getGroupField();view.isGrouping=true;if(me.lastGroupIndex){me.block();store.group(me.lastGroupIndex);me.unblock()}me.callParent();groupToggleMenuItem=me.view.headerCt.getMenu().down("#groupToggleMenuItem");if(groupToggleMenuItem){groupToggleMenuItem.setChecked(true,true)}me.refreshIf()},disable:function(){var me=this,view=me.view,store=view.store,groupToggleMenuItem,lastGroup;view.isGrouping=false;lastGroup=store.groupers.first();if(lastGroup){me.lastGroupIndex=lastGroup.property;me.block();store.clearGrouping();me.unblock()}me.callParent();groupToggleMenuItem=me.view.headerCt.getMenu().down("#groupToggleMenuItem");if(groupToggleMenuItem){groupToggleMenuItem.setChecked(false,true)}me.refreshIf()},refreshIf:function(){var ownerCt=this.grid.ownerCt,view=this.view;if(!view.store.remoteGroup&&!this.blockRefresh){if(ownerCt&&ownerCt.lockable){ownerCt.view.refresh()}else{view.refresh()}}},afterViewRender:function(){var me=this,view=me.view;view.on({scope:me,groupclick:me.onGroupClick});if(me.enableGroupingMenu){me.injectGroupingMenu()}me.pruneGroupedHeader();me.lastGroupField=me.getGroupField();me.block();me.onGroupChange();me.unblock()},injectGroupingMenu:function(){var me=this,headerCt=me.view.headerCt;headerCt.showMenuBy=me.showMenuBy;headerCt.getMenuItems=me.getMenuItems()},onColumnHideShow:function(headerOwnerCt,header){var view=this.view,headerCt=view.headerCt,menu=headerCt.getMenu(),groupToggleMenuItem=menu.down("#groupMenuItem"),colCount=headerCt.getGridColumns().length,items,len,i;if(groupToggleMenuItem){if(headerCt.getVisibleGridColumns().length>1){groupToggleMenuItem.enable()}else{groupToggleMenuItem.disable()}}if(view.rendered){items=view.el.query("."+this.ctCls);for(i=0,len=items.length;i<len;++i){items[i].colSpan=colCount}}},onColumnMove:function(){var me=this,store=me.view.store,groups,i,len,groupInfo,firstRec,lastRec;if(store.isGrouped()){groups=store.getGroups();len=groups.length;for(i=0;i<len;i++){groupInfo=groups[i];firstRec=groupInfo.children[0];lastRec=groupInfo.children[groupInfo.children.length-1];store.fireEvent("update",store,firstRec,"edit",null);if(lastRec!==firstRec){store.fireEvent("update",store,lastRec,"edit",null)}}}},showMenuBy:function(t,header){var menu=this.getMenu(),groupMenuItem=menu.down("#groupMenuItem"),groupMenuMeth=header.groupable===false||this.view.headerCt.getVisibleGridColumns().length<2?"disable":"enable",groupToggleMenuItem=menu.down("#groupToggleMenuItem"),isGrouped=this.view.store.isGrouped();groupMenuItem[groupMenuMeth]();if(groupToggleMenuItem){groupToggleMenuItem.setChecked(isGrouped,true);groupToggleMenuItem[isGrouped?"enable":"disable"]()}Ext.grid.header.Container.prototype.showMenuBy.apply(this,arguments)},getMenuItems:function(){var me=this,groupByText=me.groupByText,disabled=me.disabled||!me.getGroupField(),showGroupsText=me.showGroupsText,enableNoGroups=me.enableNoGroups,getMenuItems=me.view.headerCt.getMenuItems;return function(){var o=getMenuItems.call(this);o.push("-",{iconCls:Ext.baseCSSPrefix+"group-by-icon",itemId:"groupMenuItem",text:groupByText,handler:me.onGroupMenuItemClick,scope:me});if(enableNoGroups){o.push({itemId:"groupToggleMenuItem",text:showGroupsText,checked:!disabled,checkHandler:me.onGroupToggleMenuItemClick,scope:me})}return o}},onGroupMenuItemClick:function(menuItem,e){var me=this,menu=menuItem.parentMenu,hdr=menu.activeHeader,view=me.view,store=view.store;me.lastGroupIndex=null;me.block();me.enable();store.group(hdr.dataIndex);me.pruneGroupedHeader();me.unblock();me.refreshIf()},block:function(fromPartner){this.blockRefresh=this.view.blockRefresh=true;if(this.lockingPartner&&!fromPartner){this.lockingPartner.block(true)}},unblock:function(fromPartner){this.blockRefresh=this.view.blockRefresh=false;if(this.lockingPartner&&!fromPartner){this.lockingPartner.unblock(true)}},onGroupToggleMenuItemClick:function(menuItem,checked){this[checked?"enable":"disable"]()},pruneGroupedHeader:function(){var me=this,header=me.getGroupedHeader();if(me.hideGroupedHeader&&header){Ext.suspendLayouts();if(me.prunedHeader&&me.prunedHeader!==header){me.prunedHeader.show()}me.prunedHeader=header;header.hide();Ext.resumeLayouts(true)}},getHeaderNode:function(groupName){return Ext.get(this.createGroupId(groupName))},getGroup:function(name){var cache=this.groupCache,item=cache[name];if(!item){item=cache[name]={isCollapsed:false}}return item},isExpanded:function(groupName){return!this.getGroup(groupName).isCollapsed},expand:function(groupName,focus){this.doCollapseExpand(false,groupName,focus)},expandAll:function(){var me=this,view=me.view,groupCache=me.groupCache,groupName,lockingPartner=me.lockingPartner,partnerView;for(groupName in groupCache){if(groupCache.hasOwnProperty(groupName)){groupCache[groupName].isCollapsed=false}}Ext.suspendLayouts();view.suspendEvent("beforerefresh","refresh");if(lockingPartner){partnerView=lockingPartner.view;partnerView.suspendEvent("beforerefresh","refresh")}me.dataSource.onRefresh();view.resumeEvent("beforerefresh","refresh");if(lockingPartner){partnerView.resumeEvent("beforerefresh","refresh")}Ext.resumeLayouts(true);for(groupName in groupCache){if(groupCache.hasOwnProperty(groupName)){me.afterCollapseExpand(false,groupName);if(lockingPartner){lockingPartner.afterCollapseExpand(false,groupName)}}}},collapse:function(groupName,focus){this.doCollapseExpand(true,groupName,focus)},isAllCollapsed:function(){var me=this,groupCache=me.groupCache,groupName;for(groupName in groupCache){if(groupCache.hasOwnProperty(groupName)){if(!groupCache[groupName].isCollapsed){return false}}}return true},isAllExpanded:function(){var me=this,groupCache=me.groupCache,groupName;for(groupName in groupCache){if(groupCache.hasOwnProperty(groupName)){if(groupCache[groupName].isCollapsed){return false}}}return true},collapseAll:function(){var me=this,view=me.view,groupCache=me.groupCache,groupName,lockingPartner=me.lockingPartner,partnerView;for(groupName in groupCache){if(groupCache.hasOwnProperty(groupName)){groupCache[groupName].isCollapsed=true}}Ext.suspendLayouts();view.suspendEvent("beforerefresh","refresh");if(lockingPartner){partnerView=lockingPartner.view;partnerView.suspendEvent("beforerefresh","refresh")}me.dataSource.onRefresh();view.resumeEvent("beforerefresh","refresh");if(lockingPartner){partnerView.resumeEvent("beforerefresh","refresh")}if(lockingPartner&&!lockingPartner.isAllCollapsed()){lockingPartner.collapseAll()}Ext.resumeLayouts(true);for(groupName in groupCache){if(groupCache.hasOwnProperty(groupName)){me.afterCollapseExpand(true,groupName);if(lockingPartner){lockingPartner.afterCollapseExpand(true,groupName)}}}},doCollapseExpand:function(collapsed,groupName,focus){var me=this,lockingPartner=me.lockingPartner,group=me.groupCache[groupName];if(group.isCollapsed!=collapsed){Ext.suspendLayouts();if(collapsed){me.dataSource.collapseGroup(group)}else{me.dataSource.expandGroup(group)}Ext.resumeLayouts(true);me.afterCollapseExpand(collapsed,groupName,focus);if(lockingPartner){lockingPartner.afterCollapseExpand(collapsed,groupName,false)}}},afterCollapseExpand:function(collapsed,groupName,focus){var me=this,view=me.view,header;header=Ext.get(this.getHeaderNode(groupName));view.fireEvent(collapsed?"groupcollapse":"groupexpand",view,header,groupName);if(focus){header.up(view.getItemSelector()).scrollIntoView(view.el,null,true)}},onGroupChange:function(){var me=this,field=me.getGroupField(),menuItem,visibleGridColumns,groupingByLastVisibleColumn;if(me.hideGroupedHeader){if(me.lastGroupField){menuItem=me.getMenuItem(me.lastGroupField);if(menuItem){menuItem.setChecked(true)}}if(field){visibleGridColumns=me.view.headerCt.getVisibleGridColumns();groupingByLastVisibleColumn=visibleGridColumns.length===1&&visibleGridColumns[0].dataIndex==field;menuItem=me.getMenuItem(field);if(menuItem&&!groupingByLastVisibleColumn){menuItem.setChecked(false)}}}me.refreshIf();me.lastGroupField=field},getMenuItem:function(dataIndex){var view=this.view,header=view.headerCt.down("gridcolumn[dataIndex="+dataIndex+"]"),menu=view.headerCt.getMenu();return header?menu.down("menuitem[headerId="+header.id+"]"):null},onGroupKey:function(keyCode,event){var me=this,groupName=me.getGroupName(event.target);if(groupName){me.onGroupClick(me.view,event.target,groupName,event)}},onGroupClick:function(view,rowElement,groupName,e){var me=this,groupCache=me.groupCache,groupIsCollapsed=!me.isExpanded(groupName),g;if(me.collapsible){if(e.ctrlKey){Ext.suspendLayouts();for(g in groupCache){if(g===groupName){if(groupIsCollapsed){me.expand(groupName)}}else{me.doCollapseExpand(true,g,false)}}Ext.resumeLayouts(true);return}if(groupIsCollapsed){me.expand(groupName)}else{me.collapse(groupName)}}},setupRowData:function(record,idx,rowValues){var me=this,data=me.refreshData,groupInfo=me.groupInfo,header=data.header,groupField=data.groupField,store=me.view.dataSource,grouper,groupName,prev,next;rowValues.isCollapsedGroup=false;rowValues.summaryRecord=null;if(data.doGrouping){grouper=me.view.store.groupers.first();if(record.children){groupName=grouper.getGroupString(record.children[0]);rowValues.isFirstRow=rowValues.isLastRow=true;rowValues.itemClasses.push(me.hdCollapsedCls);rowValues.isCollapsedGroup=true;rowValues.groupInfo=groupInfo;groupInfo.groupField=groupField;groupInfo.name=groupName;groupInfo.groupValue=record.children[0].get(groupField);groupInfo.columnName=header?header.text:groupField;rowValues.collapsibleCls=me.collapsible?me.collapsibleCls:me.hdNotCollapsibleCls;rowValues.groupId=me.createGroupId(groupName);groupInfo.rows=groupInfo.children=record.children;if(me.showSummaryRow){rowValues.summaryRecord=data.summaryData[groupName]}return}groupName=grouper.getGroupString(record);rowValues.isFirstRow=idx===0;if(!rowValues.isFirstRow){prev=store.getAt(idx-1);if(prev){rowValues.isFirstRow=!prev.isEqual(grouper.getGroupString(prev),groupName)}}rowValues.isLastRow=idx==store.getTotalCount()-1;if(!rowValues.isLastRow){next=store.getAt(idx+1);if(next){rowValues.isLastRow=!next.isEqual(grouper.getGroupString(next),groupName)}}if(rowValues.isFirstRow){groupInfo.groupField=groupField;groupInfo.name=groupName;groupInfo.groupValue=record.get(groupField);groupInfo.columnName=header?header.text:groupField;rowValues.collapsibleCls=me.collapsible?me.collapsibleCls:me.hdNotCollapsibleCls;rowValues.groupId=me.createGroupId(groupName);if(!me.isExpanded(groupName)){rowValues.itemClasses.push(me.hdCollapsedCls);rowValues.isCollapsedGroup=true}if(store.buffered){groupInfo.rows=groupInfo.children=[]}else{groupInfo.rows=groupInfo.children=me.getRecordGroup(record).children}rowValues.groupInfo=groupInfo}if(rowValues.isLastRow){if(me.showSummaryRow){rowValues.summaryRecord=data.summaryData[groupName]}}}},setup:function(rows,rowValues){var me=this,data=me.refreshData,isGrouping=!me.disabled&&me.view.store.isGrouped();me.skippedRows=0;if(rowValues.view.bufferedRenderer){rowValues.view.bufferedRenderer.variableRowHeight=true}data.groupField=me.getGroupField();data.header=me.getGroupedHeader(data.groupField);data.doGrouping=isGrouping;rowValues.groupHeaderTpl=Ext.XTemplate.getTpl(me,"groupHeaderTpl");if(isGrouping&&me.showSummaryRow){data.summaryData=me.generateSummaryData()}},cleanup:function(rows,rowValues){var data=this.refreshData;rowValues.groupInfo=rowValues.groupHeaderTpl=rowValues.isFirstRow=null;data.groupField=data.header=null},getGroupName:function(element){var me=this,view=me.view,eventSelector=me.eventSelector,parts,targetEl,row;targetEl=Ext.fly(element).findParent(eventSelector);if(!targetEl){row=Ext.fly(element).findParent(view.itemSelector);if(row){targetEl=row.down(eventSelector,true)}}if(targetEl){parts=targetEl.id.split(view.id+"-hd-");if(parts.length===2){return Ext.htmlDecode(parts[1])}}},getRecordGroup:function(record){var grouper=this.view.store.groupers.first();if(grouper){return this.groupCache[grouper.getGroupString(record)]}},createGroupId:function(group){return this.view.id+"-hd-"+Ext.htmlEncode(group)},createGroupCls:function(group){return this.view.id+"-"+Ext.htmlEncode(group)+"-item"},getGroupField:function(){return this.view.store.getGroupField()},getGroupedHeader:function(groupField){var me=this,headerCt=me.view.headerCt,partner=me.lockingPartner,selector,header;groupField=groupField||this.getGroupField();if(groupField){selector="[dataIndex="+groupField+"]";header=headerCt.down(selector);if(!header&&partner){header=partner.view.headerCt.down(selector)}}return header||null},getFireEventArgs:function(type,view,targetEl,e){return[type,view,targetEl,this.getGroupName(targetEl),e]},destroy:function(){var me=this,dataSource=me.dataSource;me.view=me.prunedHeader=me.grid=me.groupCache=me.dataSource=null;me.callParent();if(dataSource){dataSource.bindStore(null)}},onReconfigure:function(grid,store,columns,oldStore,oldColumns){var me=grid;if(store&&store!==oldStore){if(store.buffered!==oldStore.buffered){Ext.Error.raise("Cannot reconfigure grouping switching between buffered and non-buffered stores")}if(store.buffered){me.bindStore(store);me.dataSource.processStore(store)}}}});