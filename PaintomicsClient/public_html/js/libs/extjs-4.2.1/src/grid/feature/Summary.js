Ext.define("Ext.grid.feature.Summary",{extend:"Ext.grid.feature.AbstractSummary",alias:"feature.summary",dock:undefined,dockedSummaryCls:Ext.baseCSSPrefix+"docked-summary",panelBodyCls:Ext.baseCSSPrefix+"summary-",init:function(grid){var me=this,view=me.view;me.callParent(arguments);if(me.dock){grid.headerCt.on({afterlayout:me.onStoreUpdate,scope:me});grid.on({beforerender:function(){var tableCls=[me.summaryTableCls];if(view.columnLines){tableCls[tableCls.length]=view.ownerCt.colLinesCls}me.summaryBar=grid.addDocked({childEls:["innerCt"],renderTpl:['<div id="{id}-innerCt">','<table cellPadding="0" cellSpacing="0" class="'+tableCls.join(" ")+'">','<tr class="'+me.summaryRowCls+'"></tr>',"</table>","</div>"],style:"overflow:hidden",itemId:"summaryBar",cls:[me.dockedSummaryCls,me.dockedSummaryCls+"-"+me.dock],xtype:"component",dock:me.dock,weight:1e7})[0]},afterrender:function(){grid.body.addCls(me.panelBodyCls+me.dock);view.mon(view.el,{scroll:me.onViewScroll,scope:me});me.onStoreUpdate()},single:true});grid.headerCt.afterComponentLayout=Ext.Function.createSequence(grid.headerCt.afterComponentLayout,function(){me.summaryBar.innerCt.setWidth(this.getFullWidth()+Ext.getScrollbarSize().width)})}else{me.view.addFooterFn(me.renderTFoot)}grid.on({columnmove:me.onStoreUpdate,scope:me});view.mon(view.store,{update:me.onStoreUpdate,datachanged:me.onStoreUpdate,scope:me})},renderTFoot:function(values,out){var view=values.view,me=view.findFeature("summary");if(me.showSummaryRow){out.push("<tfoot>");me.outputSummaryRecord(me.createSummaryRecord(view),values,out);out.push("</tfoot>")}},vetoEvent:function(record,row,rowIndex,e){return!e.getTarget(this.summaryRowSelector)},onViewScroll:function(){this.summaryBar.el.dom.scrollLeft=this.view.el.dom.scrollLeft},createSummaryRecord:function(view){var columns=view.headerCt.getVisibleGridColumns(),info={records:view.store.getRange()},colCount=columns.length,i,column,summaryRecord=this.summaryRecord||(this.summaryRecord=new view.store.model(null,view.id+"-summary-record"));summaryRecord.beginEdit();for(i=0;i<colCount;i++){column=columns[i];if(!column.dataIndex){column.dataIndex=column.id}summaryRecord.set(column.dataIndex,this.getSummary(view.store,column.summaryType,column.dataIndex,info))}summaryRecord.endEdit(true);summaryRecord.commit(true);summaryRecord.isSummary=true;return summaryRecord},onStoreUpdate:function(){var me=this,view=me.view,record=me.createSummaryRecord(view),newRowDom=view.createRowElement(record,-1),oldRowDom,partner,p;if(!view.rendered){return}if(me.dock){oldRowDom=me.summaryBar.el.down("."+me.summaryRowCls,true)}else{oldRowDom=me.view.getNode(record)}if(oldRowDom){p=oldRowDom.parentNode;p.insertBefore(newRowDom,oldRowDom);p.removeChild(oldRowDom);partner=me.lockingPartner;if(partner&&partner.grid.rendered&&!me.calledFromLockingPartner){partner.calledFromLockingPartner=true;partner.onStoreUpdate();partner.calledFromLockingPartner=false}}if(me.dock){me.onColumnHeaderLayout()}},onColumnHeaderLayout:function(){var view=this.view,columns=view.headerCt.getVisibleGridColumns(),column,len=columns.length,i,summaryEl=this.summaryBar.el,el;for(i=0;i<len;i++){column=columns[i];el=summaryEl.down(view.getCellSelector(column));if(el){if(column.hidden){el.setDisplayed(false)}else{el.setDisplayed(true);el.setWidth(column.width||(column.lastBox?column.lastBox.width:100))}}}}});