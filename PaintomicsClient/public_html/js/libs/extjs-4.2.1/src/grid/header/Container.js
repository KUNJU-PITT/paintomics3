Ext.define("Ext.grid.header.Container",{extend:"Ext.container.Container",requires:["Ext.grid.ColumnLayout","Ext.grid.plugin.HeaderResizer","Ext.grid.plugin.HeaderReorderer"],uses:["Ext.grid.column.Column","Ext.grid.ColumnManager","Ext.menu.Menu","Ext.menu.CheckItem","Ext.menu.Separator"],border:true,alias:"widget.headercontainer",baseCls:Ext.baseCSSPrefix+"grid-header-ct",dock:"top",weight:100,defaultType:"gridcolumn",detachOnRemove:false,defaultWidth:100,sortAscText:"Sort Ascending",sortDescText:"Sort Descending",sortClearText:"Clear Sort",columnsText:"Columns",headerOpenCls:Ext.baseCSSPrefix+"column-header-open",menuSortAscCls:Ext.baseCSSPrefix+"hmenu-sort-asc",menuSortDescCls:Ext.baseCSSPrefix+"hmenu-sort-desc",menuColsIcon:Ext.baseCSSPrefix+"cols-icon",triStateSort:false,ddLock:false,dragging:false,sortable:true,enableColumnHide:true,initComponent:function(){var me=this;me.headerCounter=0;me.plugins=me.plugins||[];if(!me.isColumn){if(me.enableColumnResize){me.resizer=new Ext.grid.plugin.HeaderResizer;me.plugins.push(me.resizer)}if(me.enableColumnMove){me.reorderer=new Ext.grid.plugin.HeaderReorderer;me.plugins.push(me.reorderer)}}if(me.isColumn&&(!me.items||me.items.length===0)){me.isContainer=false;me.layout={type:"container",calculate:Ext.emptyFn}}else{me.layout=Ext.apply({type:"gridcolumn",align:"stretch"},me.initialConfig.layout);if(me.isRootHeader){me.grid.columnManager=me.columnManager=new Ext.grid.ColumnManager(me)}}me.defaults=me.defaults||{};Ext.applyIf(me.defaults,{triStateSort:me.triStateSort,sortable:me.sortable});me.menuTask=new Ext.util.DelayedTask(me.updateMenuDisabledState,me);me.callParent();me.addEvents("columnresize","headerclick","headercontextmenu","headertriggerclick","columnmove","columnhide","columnshow","columnschanged","sortchange","menucreate")},isLayoutRoot:function(){if(this.hiddenHeaders){return false}return this.callParent()},getOwnerHeaderCt:function(){var me=this;return me.isRootHeader?me:me.up("[isRootHeader]")},onDestroy:function(){var me=this;if(me.menu){me.menu.un("hide",me.onMenuHide,me)}me.menuTask.cancel();Ext.destroy(me.resizer,me.reorderer);me.callParent()},applyColumnsState:function(columns){if(!columns||!columns.length){return}var me=this,items=me.items.items,count=items.length,i=0,length=columns.length,c,col,columnState,index;for(c=0;c<length;c++){columnState=columns[c];for(index=count;index--;){col=items[index];if(col.getStateId&&col.getStateId()==columnState.id){if(i!==index){me.moveHeader(index,i)}if(col.applyColumnState){col.applyColumnState(columnState)}++i;break}}}},getColumnsState:function(){var me=this,columns=[],state;me.items.each(function(col){state=col.getColumnState&&col.getColumnState();if(state){columns.push(state)}});return columns},onAdd:function(c){var me=this;if(!c.headerId){c.headerId=c.initialConfig.id||Ext.id(null,"header-")}if(!c.getStateId()){c.stateId=c.initialConfig.id||"h"+ ++me.headerCounter}if(Ext.global.console&&Ext.global.console.warn){if(!me._usedIDs){me._usedIDs={}}if(me._usedIDs[c.headerId]){Ext.global.console.warn(this.$className,"attempted to reuse an existing id",c.headerId)}me._usedIDs[c.headerId]=true}me.callParent(arguments);me.onColumnsChanged()},onMove:function(){this.callParent(arguments);this.onColumnsChanged()},onShow:function(){this.callParent(arguments);this.onColumnsChanged()},onColumnsChanged:function(){var headerCt=this;while(headerCt){headerCt.purgeCache();if(headerCt.isRootHeader){break}headerCt=headerCt.ownerCt}if(headerCt&&headerCt.rendered){headerCt.fireEvent("columnschanged",headerCt)}},onRemove:function(c){var me=this,ownerCt=me.ownerCt;me.callParent(arguments);if(!me._usedIDs){me._usedIDs={}}delete me._usedIDs[c.headerId];if(!me.destroying){me.onColumnsChanged();if(me.isGroupHeader&&!me.items.getCount()&&ownerCt){me.detachComponent(c);Ext.suspendLayouts();ownerCt.remove(me);Ext.resumeLayouts(true)}}},applyDefaults:function(config){var ret;if(config&&!config.isComponent&&config.xtype=="rownumberer"){ret=config}else{ret=this.callParent(arguments);if(!config.isGroupHeader&&!("width"in ret)&&!ret.flex){ret.width=this.defaultWidth}}return ret},setSortState:function(){var store=this.up("[store]").store,first=store.getFirstSorter(),hd;if(first){hd=this.down("gridcolumn[dataIndex="+first.property+"]");if(hd){hd.setSortState(first.direction,false,true)}}else{this.clearOtherSortStates(null)}},getHeaderMenu:function(){var menu=this.getMenu(),item;if(menu){item=menu.child("#columnItem");if(item){return item.menu}}return null},onHeaderVisibilityChange:function(header,visible){var me=this,menu=me.getHeaderMenu(),item;me.purgeCache();if(menu){item=me.getMenuItemForHeader(menu,header);if(item){item.setChecked(visible,true)}if(menu.isVisible()){me.menuTask.delay(50)}}},updateMenuDisabledState:function(menu){var me=this,columns=me.query(":not([hidden])"),i,len=columns.length,item,checkItem,method;if(!menu){menu=me.getMenu()}for(i=0;i<len;++i){item=columns[i];checkItem=me.getMenuItemForHeader(menu,item);if(checkItem){method=item.isHideable()?"enable":"disable";if(checkItem.menu){method+="CheckChange"}checkItem[method]()}}},getMenuItemForHeader:function(menu,header){return header?menu.down("menucheckitem[headerId="+header.id+"]"):null},onHeaderShow:function(header){var me=this,gridSection=me.ownerCt;if(me.forceFit){delete me.flex}me.onHeaderVisibilityChange(header,true);if(!header.isGroupHeader){if(gridSection){gridSection.onHeaderShow(me,header)}}me.fireEvent("columnshow",me,header);me.fireEvent("columnschanged",this)},onHeaderHide:function(header){var me=this,gridSection=me.ownerCt;me.onHeaderVisibilityChange(header,false);if(!header.isGroupHeader){if(gridSection){gridSection.onHeaderHide(me,header)}}me.fireEvent("columnhide",me,header);me.fireEvent("columnschanged",this)},tempLock:function(){this.ddLock=true;Ext.Function.defer(function(){this.ddLock=false},200,this)},onHeaderResize:function(header,w,suppressFocus){var me=this,view=me.view,gridSection=me.ownerCt;if(view&&view.body.dom){me.tempLock();if(gridSection){gridSection.onHeaderResize(me,header,w)}}me.fireEvent("columnresize",this,header,w)},onHeaderClick:function(header,e,t){header.fireEvent("headerclick",this,header,e,t);this.fireEvent("headerclick",this,header,e,t)},onHeaderContextMenu:function(header,e,t){header.fireEvent("headercontextmenu",this,header,e,t);this.fireEvent("headercontextmenu",this,header,e,t)},onHeaderTriggerClick:function(header,e,t){var me=this;if(header.fireEvent("headertriggerclick",me,header,e,t)!==false&&me.fireEvent("headertriggerclick",me,header,e,t)!==false){me.showMenuBy(t,header)}},showMenuBy:function(t,header){var menu=this.getMenu(),ascItem=menu.down("#ascItem"),descItem=menu.down("#descItem"),sortableMth;menu.activeHeader=menu.ownerButton=header;header.setMenuActive(true);sortableMth=header.sortable?"enable":"disable";if(ascItem){ascItem[sortableMth]()}if(descItem){descItem[sortableMth]()}menu.showBy(t)},onMenuHide:function(menu){menu.activeHeader.setMenuActive(false)},moveHeader:function(fromIdx,toIdx){this.tempLock();this.onHeaderMoved(this.move(fromIdx,toIdx),1,fromIdx,toIdx)},purgeCache:function(){var me=this,menu=me.menu;me.gridDataColumns=me.hideableColumns=null;if(me.columnManager){me.columnManager.invalidate()}if(menu&&menu.hidden){menu.hide();menu.destroy();me.menu=null}},onHeaderMoved:function(header,colsToMove,fromIdx,toIdx){var me=this,gridSection=me.ownerCt;if(gridSection&&gridSection.onHeaderMove){gridSection.onHeaderMove(me,header,colsToMove,fromIdx,toIdx)}me.fireEvent("columnmove",me,header,fromIdx,toIdx)},getMenu:function(){var me=this;if(!me.menu){me.menu=new Ext.menu.Menu({hideOnParentHide:false,items:me.getMenuItems(),listeners:{hide:me.onMenuHide,scope:me}});me.fireEvent("menucreate",me,me.menu)}me.updateMenuDisabledState(me.menu);return me.menu},getMenuItems:function(){var me=this,menuItems=[],hideableColumns=me.enableColumnHide?me.getColumnMenu(me):null;if(me.sortable){menuItems=[{itemId:"ascItem",text:me.sortAscText,cls:me.menuSortAscCls,handler:me.onSortAscClick,scope:me},{itemId:"descItem",text:me.sortDescText,cls:me.menuSortDescCls,handler:me.onSortDescClick,scope:me}]}if(hideableColumns&&hideableColumns.length){if(me.sortable){menuItems.push("-")}menuItems.push({itemId:"columnItem",text:me.columnsText,cls:me.menuColsIcon,menu:hideableColumns,hideOnClick:false})}return menuItems},onSortAscClick:function(){var menu=this.getMenu(),activeHeader=menu.activeHeader;activeHeader.setSortState("ASC")},onSortDescClick:function(){var menu=this.getMenu(),activeHeader=menu.activeHeader;activeHeader.setSortState("DESC")},getColumnMenu:function(headerContainer){var menuItems=[],i=0,item,items=headerContainer.query(">gridcolumn[hideable]"),itemsLn=items.length,menuItem;for(;i<itemsLn;i++){item=items[i];menuItem=new Ext.menu.CheckItem({text:item.menuText||item.text,checked:!item.hidden,hideOnClick:false,headerId:item.id,menu:item.isGroupHeader?this.getColumnMenu(item):undefined,checkHandler:this.onColumnCheckChange,scope:this});menuItems.push(menuItem);item.on({destroy:Ext.Function.bind(menuItem.destroy,menuItem)})}return menuItems},onColumnCheckChange:function(checkItem,checked){var header=Ext.getCmp(checkItem.headerId);header[checked?"show":"hide"]()},getColumnCount:function(){return this.getGridColumns().length},getFullWidth:function(){var fullWidth=0,headers=this.getVisibleGridColumns(),headersLn=headers.length,i=0,header;for(;i<headersLn;i++){header=headers[i];if(header.getDesiredWidth){fullWidth+=header.getDesiredWidth()||0}else{fullWidth+=header.getWidth()}}return fullWidth},clearOtherSortStates:function(activeHeader){var headers=this.getGridColumns(),headersLn=headers.length,i=0;for(;i<headersLn;i++){if(headers[i]!==activeHeader){headers[i].setSortState(null,true)}}},getVisibleGridColumns:function(){var allColumns=this.getGridColumns(),result=[],len=allColumns.length,i;for(i=0;i<len;i++){if(!allColumns[i].hidden){result[result.length]=allColumns[i]}}return result},getGridColumns:function(inResult,hiddenAncestor){if(!inResult&&this.gridDataColumns){return this.gridDataColumns}var me=this,result=inResult||[],items,i,len,item,lastVisibleColumn;hiddenAncestor=hiddenAncestor||me.hidden;if(me.items){items=me.items.items;for(i=0,len=items.length;i<len;i++){item=items[i];if(item.isGroupHeader){item.getGridColumns(result,hiddenAncestor)}else{item.hiddenAncestor=hiddenAncestor;result.push(item)}}}if(!inResult){me.gridDataColumns=result}if(!inResult&&len){for(i=0,len=result.length;i<len;i++){item=result[i];item.isFirstVisible=item.isLastVisible=false;if(!(item.hidden||item.hiddenAncestor)){if(!lastVisibleColumn){item.isFirstVisible=true}lastVisibleColumn=item}}if(lastVisibleColumn){lastVisibleColumn.isLastVisible=true}}return result},getHideableColumns:function(){var me=this,result=me.hideableColumns;if(!result){result=me.hideableColumns=me.query("[hideable]")}return result},getHeaderIndex:function(header){return this.columnManager.getHeaderIndex(header)},getHeaderAtIndex:function(index){return this.columnManager.getHeaderAtIndex(index)},getVisibleHeaderClosestToIndex:function(index){return this.columnManager.getVisibleHeaderClosestToIndex(index)},autoSizeColumn:function(header){var view=this.view;if(view){view.autoSizeColumn(header)}}});