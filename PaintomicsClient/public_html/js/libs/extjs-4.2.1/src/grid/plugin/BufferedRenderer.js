Ext.define("Ext.grid.plugin.BufferedRenderer",{extend:"Ext.AbstractPlugin",requires:["Ext.grid.plugin.BufferedRendererTableView","Ext.grid.plugin.BufferedRendererTreeView"],alias:"plugin.bufferedrenderer",lockableScope:"both",percentageFromEdge:.35,variableRowHeight:false,numFromEdge:8,trailingBufferZone:10,leadingBufferZone:20,synchronousRender:true,scrollToLoadBuffer:200,viewSize:0,rowHeight:21,position:0,lastScrollDirection:1,bodyTop:0,init:function(grid){var me=this,view=grid.view,viewListeners={scroll:{fn:me.onViewScroll,element:"el",scope:me},boxready:me.onViewResize,resize:me.onViewResize,refresh:me.onViewRefresh,scope:me,destroyable:true};if(!me.variableRowHeight&&grid.ownerLockable){grid.ownerLockable.syncRowHeight=false}if(grid.isTree||grid.ownerLockable&&grid.ownerLockable.isTree){view.blockRefresh=false;view.loadMask=true}if(view.positionBody){viewListeners.refresh=me.onViewRefresh}me.grid=grid;me.view=view;view.bufferedRenderer=me;view.preserveScrollOnRefresh=true;me.bindStore(view.dataSource);view.getViewRange=function(){return me.getViewRange()};me.position=0;me.gridListeners=grid.on("reconfigure",me.onReconfigure,me);me.viewListeners=view.on(viewListeners)},bindStore:function(store){var me=this;if(me.store){me.unbindStore()}me.storeListeners=store.on({scope:me,clear:me.onStoreClear,destroyable:true});me.store=store;if(me.view.componentLayout.layoutCount){me.onViewResize(me.view,0,me.view.getHeight())}},onReconfigure:function(grid,store){if(store&&store!==this.store){this.bindStore(store)}},unbindStore:function(){this.storeListeners.destroy();this.store=null},onStoreClear:function(){var me=this;if(me.view.rendered&&!me.store.isDestroyed){if(me.scrollTop!==0){me.ignoreNextScrollEvent=true;me.view.el.dom.scrollTop=me.bodyTop=me.scrollTop=0}me.position=me.scrollHeight=0;me.lastScrollDirection=me.scrollOffset=null;delete me.rowHeight}},onViewRefresh:function(){var me=this,view=me.view,oldScrollHeight=me.scrollHeight,scrollHeight;if(view.all.getCount()){delete me.rowHeight}scrollHeight=me.getScrollHeight();if(!oldScrollHeight||scrollHeight!=oldScrollHeight){me.stretchView(view,scrollHeight)}if(me.scrollTop!==view.el.dom.scrollTop){me.onViewScroll()}else{me.setBodyTop(me.bodyTop);if(view.all.getCount()){me.viewSize=0;me.onViewResize(view,null,view.getHeight())}}},onViewResize:function(view,width,height,oldWidth,oldHeight){if(!oldHeight||height!==oldHeight){var me=this,newViewSize;newViewSize=Math.ceil(height/me.rowHeight)+me.trailingBufferZone+me.leadingBufferZone;me.viewSize=me.setViewSize(newViewSize)}},stretchView:function(view,scrollRange){var me=this,recordCount=me.store.buffered?me.store.getTotalCount():me.store.getCount();if(me.stretcher){me.stretcher.dom.style.marginTop=scrollRange-1+"px"}else{var el=view.el;if(view.refreshCounter){view.fixedNodes++}if(recordCount&&me.view.all.endIndex===recordCount-1){scrollRange=me.bodyTop+view.body.dom.offsetHeight}this.stretcher=el.createChild({style:{width:"1px",height:"1px",marginTop:scrollRange-1+"px",left:0,position:"absolute"}},el.dom.firstChild)}},setViewSize:function(viewSize){if(viewSize!==this.viewSize){this.scrollTop=this.view.el.dom.scrollTop;var me=this,store=me.store,elCount=me.view.all.getCount(),start,end,lockingPartner=me.lockingPartner;me.viewSize=store.viewSize=viewSize;if(elCount){start=me.view.all.startIndex;end=Math.min(start+viewSize-1,(store.buffered?store.getTotalCount():store.getCount())-1);if(lockingPartner){lockingPartner.disable()}me.renderRange(start,end);if(lockingPartner){lockingPartner.enable()}}}return viewSize},getViewRange:function(){var me=this,rows=me.view.all,store=me.store;if(store.data.getCount()){return store.getRange(rows.startIndex,rows.startIndex+(me.viewSize||me.store.defaultViewSize)-1)}else{return[]}},scrollTo:function(recordIdx,doSelect,callback,scope){var me=this,view=me.view,viewDom=view.el.dom,store=me.store,total=store.buffered?store.getTotalCount():store.getCount(),startIdx,endIdx,targetRec,targetRow,tableTop;recordIdx=Math.min(Math.max(recordIdx,0),total-1);startIdx=Math.max(Math.min(recordIdx-(me.leadingBufferZone+me.trailingBufferZone)/2,total-me.viewSize+1),0);tableTop=startIdx*me.rowHeight;endIdx=Math.min(startIdx+me.viewSize-1,total-1);store.getRange(startIdx,endIdx,{callback:function(range,start,end){me.renderRange(start,end,true);targetRec=store.data.getRange(recordIdx,recordIdx)[0];targetRow=view.getNode(targetRec,false);view.body.dom.style.top=tableTop+"px";me.position=me.scrollTop=viewDom.scrollTop=tableTop=Math.min(Math.max(0,tableTop-view.body.getOffsetsTo(targetRow)[1]),viewDom.scrollHeight-viewDom.clientHeight);if(Ext.isIE){viewDom.scrollTop=tableTop}if(doSelect){view.selModel.select(targetRec)}if(callback){callback.call(scope||me,recordIdx,targetRec)}}})},onViewScroll:function(e,t){var me=this,store=me.store,totalCount=store.buffered?store.getTotalCount():store.getCount(),vscrollDistance,scrollDirection,scrollTop=me.scrollTop=me.view.el.dom.scrollTop,scrollHandled=false;if(me.ignoreNextScrollEvent){me.ignoreNextScrollEvent=false;return}if(!(me.disabled||totalCount<me.viewSize)){vscrollDistance=scrollTop-me.position;scrollDirection=vscrollDistance>0?1:-1;if(Math.abs(vscrollDistance)>=20||scrollDirection!==me.lastScrollDirection){me.lastScrollDirection=scrollDirection;me.handleViewScroll(me.lastScrollDirection);scrollHandled=true}}if(!scrollHandled){if(me.lockingPartner&&me.lockingPartner.scrollTop!==scrollTop){me.lockingPartner.view.el.dom.scrollTop=scrollTop}}},handleViewScroll:function(direction){var me=this,rows=me.view.all,store=me.store,viewSize=me.viewSize,totalCount=store.buffered?store.getTotalCount():store.getCount(),requestStart,requestEnd;if(direction==-1){if(rows.startIndex){if(me.getFirstVisibleRowIndex()-rows.startIndex<me.numFromEdge){requestStart=Math.max(0,me.getLastVisibleRowIndex()+me.trailingBufferZone-viewSize)}}}else{if(rows.endIndex<totalCount-1){if(rows.endIndex-me.getLastVisibleRowIndex()<me.numFromEdge){requestStart=Math.max(0,me.getFirstVisibleRowIndex()-me.trailingBufferZone)}}}if(requestStart!=null){requestEnd=Math.min(requestStart+viewSize-1,totalCount-1);if(requestStart!==rows.startIndex||requestEnd!==rows.endIndex){me.renderRange(requestStart,requestEnd);return}}if(me.lockingPartner&&me.lockingPartner.view.el&&me.lockingPartner.scrollTop!==me.scrollTop){me.lockingPartner.view.el.dom.scrollTop=me.scrollTop}},renderRange:function(start,end,forceSynchronous){var me=this,store=me.store;if(store.rangeCached(start,end)){me.cancelLoad();if(me.synchronousRender||forceSynchronous){me.onRangeFetched(null,start,end)}else{if(!me.renderTask){me.renderTask=new Ext.util.DelayedTask(me.onRangeFetched,me,null,false)}me.renderTask.delay(1,null,null,[null,start,end])}}else{me.attemptLoad(start,end)}},onRangeFetched:function(range,start,end,fromLockingPartner){var me=this,view=me.view,oldStart,rows=view.all,removeCount,increment=0,calculatedTop=start*me.rowHeight,top,lockingPartner=me.lockingPartner;if(view.isDestroyed){return}if(!range){range=me.store.getRange(start,end);if(!range){return}}if(start>rows.endIndex||end<rows.startIndex){rows.clear(true);top=calculatedTop}if(!rows.getCount()){view.doAdd(range,start)}else if(end>rows.endIndex){removeCount=Math.max(start-rows.startIndex,0);if(me.variableRowHeight){increment=rows.item(rows.startIndex+removeCount,true).offsetTop}rows.scroll(Ext.Array.slice(range,rows.endIndex+1-start),1,removeCount,start,end);if(me.variableRowHeight){top=me.bodyTop+increment}else{top=calculatedTop}}else{removeCount=Math.max(rows.endIndex-end,0);oldStart=rows.startIndex;rows.scroll(Ext.Array.slice(range,0,rows.startIndex-start),-1,removeCount,start,end);if(me.variableRowHeight){top=me.bodyTop-rows.item(oldStart,true).offsetTop}else{top=calculatedTop}}me.position=me.scrollTop;if(view.positionBody){me.setBodyTop(top,calculatedTop)}if(lockingPartner&&!lockingPartner.disabled&&!fromLockingPartner){lockingPartner.onRangeFetched(range,start,end,true);if(lockingPartner.scrollTop!==me.scrollTop){lockingPartner.view.el.dom.scrollTop=me.scrollTop}}},setBodyTop:function(bodyTop,calculatedTop){var me=this,view=me.view,store=me.store,body=view.body.dom,delta;bodyTop=Math.floor(bodyTop);if(calculatedTop!==undefined){delta=bodyTop-calculatedTop;bodyTop=calculatedTop}body.style.position="absolute";body.style.top=(me.bodyTop=bodyTop)+"px";if(delta){me.scrollTop=me.position=view.el.dom.scrollTop-=delta}if(view.all.endIndex===(store.buffered?store.getTotalCount():store.getCount())-1){me.stretchView(view,me.bodyTop+body.offsetHeight)}},getFirstVisibleRowIndex:function(startRow,endRow,viewportTop,viewportBottom){var me=this,view=me.view,rows=view.all,elements=rows.elements,clientHeight=view.el.dom.clientHeight,target,targetTop;if(rows.getCount()&&me.variableRowHeight){if(!arguments.length){startRow=rows.startIndex;endRow=rows.endIndex;viewportTop=me.scrollTop;viewportBottom=viewportTop+clientHeight;if(me.bodyTop>viewportBottom||me.bodyTop+view.body.getHeight()<viewportTop){return Math.floor(me.scrollTop/me.rowHeight)}target=startRow+Math.min(me.numFromEdge+(me.lastScrollDirection==-1?me.leadingBufferZone:me.trailingBufferZone),Math.floor((endRow-startRow)/2))}else{target=startRow+Math.floor((endRow-startRow)/2)}targetTop=me.bodyTop+elements[target].offsetTop;if(targetTop+elements[target].offsetHeight<viewportTop){return me.getFirstVisibleRowIndex(target+1,endRow,viewportTop,viewportBottom)}if(targetTop<=viewportTop){return target}else if(target!==startRow){return me.getFirstVisibleRowIndex(startRow,target-1,viewportTop,viewportBottom)}}return Math.floor(me.scrollTop/me.rowHeight)},getLastVisibleRowIndex:function(startRow,endRow,viewportTop,viewportBottom){var me=this,view=me.view,rows=view.all,elements=rows.elements,clientHeight=view.el.dom.clientHeight,target,targetTop,targetBottom;if(rows.getCount()&&me.variableRowHeight){if(!arguments.length){startRow=rows.startIndex;endRow=rows.endIndex;viewportTop=me.scrollTop;viewportBottom=viewportTop+clientHeight;if(me.bodyTop>viewportBottom||me.bodyTop+view.body.getHeight()<viewportTop){return Math.floor(me.scrollTop/me.rowHeight)+Math.ceil(clientHeight/me.rowHeight)}target=endRow-Math.min(me.numFromEdge+(me.lastScrollDirection==1?me.leadingBufferZone:me.trailingBufferZone),Math.floor((endRow-startRow)/2))}else{target=startRow+Math.floor((endRow-startRow)/2)}targetTop=me.bodyTop+elements[target].offsetTop;if(targetTop>viewportBottom){return me.getLastVisibleRowIndex(startRow,target-1,viewportTop,viewportBottom)}targetBottom=targetTop+elements[target].offsetHeight;if(targetBottom>=viewportBottom){return target}else if(target!==endRow){return me.getLastVisibleRowIndex(target+1,endRow,viewportTop,viewportBottom)}}return me.getFirstVisibleRowIndex()+Math.ceil(clientHeight/me.rowHeight)},getScrollHeight:function(){var me=this,view=me.view,store=me.store,doCalcHeight=!me.hasOwnProperty("rowHeight"),storeCount=me.store.getCount();if(!storeCount){return 0}if(doCalcHeight){if(view.all.getCount()){me.rowHeight=Math.floor(view.body.getHeight()/view.all.getCount())}}return this.scrollHeight=Math.floor((store.buffered?store.getTotalCount():store.getCount())*me.rowHeight)},attemptLoad:function(start,end){var me=this;if(me.scrollToLoadBuffer){if(!me.loadTask){me.loadTask=new Ext.util.DelayedTask(me.doAttemptLoad,me,[])}me.loadTask.delay(me.scrollToLoadBuffer,me.doAttemptLoad,me,[start,end])}else{me.store.getRange(start,end,{callback:me.onRangeFetched,scope:me,fireEvent:false})}},cancelLoad:function(){if(this.loadTask){this.loadTask.cancel()}},doAttemptLoad:function(start,end){this.store.getRange(start,end,{callback:this.onRangeFetched,scope:this,fireEvent:false})},destroy:function(){var me=this,view=me.view;if(view&&view.el){view.el.un("scroll",me.onViewScroll,me)}Ext.destroy(me.viewListeners,me.storeListeners,me.gridListeners)}});