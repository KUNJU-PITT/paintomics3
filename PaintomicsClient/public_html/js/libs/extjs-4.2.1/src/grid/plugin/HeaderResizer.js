Ext.define("Ext.grid.plugin.HeaderResizer",{extend:"Ext.AbstractPlugin",requires:["Ext.dd.DragTracker","Ext.util.Region"],alias:"plugin.gridheaderresizer",disabled:false,config:{dynamic:false},colHeaderCls:Ext.baseCSSPrefix+"column-header",minColWidth:40,maxColWidth:1e3,wResizeCursor:"col-resize",eResizeCursor:"col-resize",init:function(headerCt){this.headerCt=headerCt;headerCt.on("render",this.afterHeaderRender,this,{single:true})},destroy:function(){if(this.tracker){this.tracker.destroy()}},afterHeaderRender:function(){var headerCt=this.headerCt,el=headerCt.el;headerCt.mon(el,"mousemove",this.onHeaderCtMouseMove,this);this.tracker=new Ext.dd.DragTracker({disabled:this.disabled,onBeforeStart:Ext.Function.bind(this.onBeforeStart,this),onStart:Ext.Function.bind(this.onStart,this),onDrag:Ext.Function.bind(this.onDrag,this),onEnd:Ext.Function.bind(this.onEnd,this),tolerance:3,autoStart:300,el:el})},onHeaderCtMouseMove:function(e,t){var me=this,prevSiblings,headerEl,overHeader,resizeHeader,resizeHeaderOwnerGrid,ownerGrid;if(me.headerCt.dragging){if(me.activeHd){me.activeHd.el.dom.style.cursor="";delete me.activeHd}}else{headerEl=e.getTarget("."+me.colHeaderCls,3,true);if(headerEl){overHeader=Ext.getCmp(headerEl.id);if(overHeader.isOnLeftEdge(e)){resizeHeader=overHeader.previousNode("gridcolumn:not([hidden]):not([isGroupHeader])");if(resizeHeader){ownerGrid=me.headerCt.up("tablepanel");resizeHeaderOwnerGrid=resizeHeader.up("tablepanel");if(!(resizeHeaderOwnerGrid===ownerGrid||ownerGrid.ownerCt.isXType("tablepanel")&&ownerGrid.ownerCt.view.lockedGrid===resizeHeaderOwnerGrid)){resizeHeader=null}}}else if(overHeader.isOnRightEdge(e)){resizeHeader=overHeader}else{resizeHeader=null}if(resizeHeader){if(resizeHeader.isGroupHeader){prevSiblings=resizeHeader.getGridColumns();resizeHeader=prevSiblings[prevSiblings.length-1]}if(resizeHeader&&!(resizeHeader.fixed||resizeHeader.resizable===false||me.disabled)){me.activeHd=resizeHeader;overHeader.el.dom.style.cursor=me.eResizeCursor;if(overHeader.triggerEl){overHeader.triggerEl.dom.style.cursor=me.eResizeCursor}}}else{overHeader.el.dom.style.cursor="";if(overHeader.triggerEl){overHeader.triggerEl.dom.style.cursor=""}me.activeHd=null}}}},onBeforeStart:function(e){this.dragHd=this.activeHd;if(!!this.dragHd&&!this.headerCt.dragging){this.tracker.constrainTo=this.getConstrainRegion();return true}else{this.headerCt.dragging=false;return false}},getConstrainRegion:function(){var me=this,dragHdEl=me.dragHd.el,rightAdjust=0,nextHd,lockedGrid;if(me.headerCt.forceFit){nextHd=me.dragHd.nextNode("gridcolumn:not([hidden]):not([isGroupHeader])");if(nextHd){if(!me.headerInSameGrid(nextHd)){nextHd=null}rightAdjust=nextHd.getWidth()-me.minColWidth}}else if((lockedGrid=me.dragHd.up("tablepanel")).isLocked){rightAdjust=me.dragHd.up("[scrollerOwner]").getWidth()-lockedGrid.getWidth()-30}else{rightAdjust=me.maxColWidth-dragHdEl.getWidth()}return me.adjustConstrainRegion(dragHdEl.getRegion(),0,rightAdjust,0,me.minColWidth)},onStart:function(e){var me=this,dragHd=me.dragHd,width=dragHd.el.getWidth(),headerCt=dragHd.getOwnerHeaderCt(),x,y,gridSection,markerOwner,lhsMarker,rhsMarker,markerHeight;me.headerCt.dragging=true;me.origWidth=width;if(!me.dynamic){gridSection=markerOwner=headerCt.up("tablepanel");if(gridSection.ownerLockable){markerOwner=gridSection.ownerLockable}x=me.getLeftMarkerX(markerOwner);lhsMarker=markerOwner.getLhsMarker();rhsMarker=markerOwner.getRhsMarker();markerHeight=gridSection.body.getHeight()+headerCt.getHeight();y=headerCt.getOffsetsTo(markerOwner)[1];lhsMarker.setLocalY(y);rhsMarker.setLocalY(y);lhsMarker.setHeight(markerHeight);rhsMarker.setHeight(markerHeight);me.setMarkerX(lhsMarker,x);me.setMarkerX(rhsMarker,x+width)}},onDrag:function(e){var me=this,markerOwner;if(me.dynamic){me.doResize()}else{markerOwner=this.headerCt.up("tablepanel");if(markerOwner.ownerLockable){markerOwner=markerOwner.ownerLockable}this.setMarkerX(this.getMovingMarker(markerOwner),this.calculateDragX(markerOwner))}},getMovingMarker:function(markerOwner){return markerOwner.getRhsMarker()},onEnd:function(e){this.headerCt.dragging=false;if(this.dragHd){if(!this.dynamic){var markerOwner=this.headerCt.up("tablepanel");if(markerOwner.ownerLockable){markerOwner=markerOwner.ownerLockable}this.setMarkerX(markerOwner.getLhsMarker(),-9999);this.setMarkerX(markerOwner.getRhsMarker(),-9999)}this.doResize()}},doResize:function(){var me=this,dragHd=me.dragHd,nextHd,offset;if(dragHd){offset=me.tracker.getOffset("point");if(dragHd.flex){delete dragHd.flex}Ext.suspendLayouts();me.adjustColumnWidth(offset[0]);if(me.headerCt.forceFit){nextHd=dragHd.nextNode("gridcolumn:not([hidden]):not([isGroupHeader])");if(nextHd&&!me.headerInSameGrid(nextHd)){nextHd=null}if(nextHd){delete nextHd.flex;nextHd.setWidth(nextHd.getWidth()-offset[0])}}Ext.resumeLayouts(true)}},headerInSameGrid:function(header){var grid=this.dragHd.up("tablepanel");return!!header.up(grid)},disable:function(){this.disabled=true;if(this.tracker){this.tracker.disable()}},enable:function(){this.disabled=false;if(this.tracker){this.tracker.enable()}},calculateDragX:function(markerOwner){return this.tracker.getXY("point")[0]-markerOwner.getX()-markerOwner.el.getBorderWidth("l")},getLeftMarkerX:function(markerOwner){return this.dragHd.getX()-markerOwner.getX()-markerOwner.el.getBorderWidth("l")-1},setMarkerX:function(marker,x){marker.setLocalX(x)},adjustConstrainRegion:function(region,t,r,b,l){return region.adjust(t,r,b,l)},adjustColumnWidth:function(offsetX){this.dragHd.setWidth(this.origWidth+offsetX)}});