Ext.define("Ext.grid.column.Column",{extend:"Ext.grid.header.Container",alias:"widget.gridcolumn",requires:["Ext.util.KeyNav","Ext.grid.ColumnComponentLayout","Ext.grid.ColumnLayout"],alternateClassName:"Ext.grid.Column",baseCls:Ext.baseCSSPrefix+"column-header",hoverCls:Ext.baseCSSPrefix+"column-header-over",handleWidth:4,sortState:null,possibleSortStates:["ASC","DESC"],childEls:["titleEl","triggerEl","textEl"],noWrap:true,renderTpl:'<div id="{id}-titleEl" {tipMarkup}class="'+Ext.baseCSSPrefix+'column-header-inner">'+'<span id="{id}-textEl" class="'+Ext.baseCSSPrefix+"column-header-text"+'{childElCls}">'+"{text}"+"</span>"+'<tpl if="!menuDisabled">'+'<div id="{id}-triggerEl" class="'+Ext.baseCSSPrefix+"column-header-trigger"+'{childElCls}"></div>'+"</tpl>"+"</div>"+"{%this.renderContainer(out,values)%}",dataIndex:null,text:"&#160;",menuText:null,emptyCellText:"&#160;",sortable:true,resizable:true,hideable:true,menuDisabled:false,renderer:false,editRenderer:false,align:"left",draggable:true,tooltipType:"qtip",initDraggable:Ext.emptyFn,tdCls:"",isHeader:true,isColumn:true,ascSortCls:Ext.baseCSSPrefix+"column-header-sort-ASC",descSortCls:Ext.baseCSSPrefix+"column-header-sort-DESC",componentLayout:"columncomponent",groupSubHeaderCls:Ext.baseCSSPrefix+"group-sub-header",groupHeaderCls:Ext.baseCSSPrefix+"group-header",clickTargetName:"titleEl",detachOnRemove:true,initResizable:Ext.emptyFn,initComponent:function(){var me=this,renderer,listeners;if(me.header!=null){me.text=me.header;me.header=null}if(!me.triStateSort){me.possibleSortStates.length=2}if(me.columns!=null){me.isGroupHeader=true;if(me.dataIndex){Ext.Error.raise("Ext.grid.column.Column: Group header may not accept a dataIndex")}if(me.width&&me.width!==Ext.grid.header.Container.prototype.defaultWidth||me.flex){Ext.Error.raise("Ext.grid.column.Column: Group header does not support setting explicit widths or flexs. The group header width is calculated by the sum of its children.")}me.items=me.columns;me.columns=me.flex=me.width=null;me.cls=(me.cls||"")+" "+me.groupHeaderCls;me.sortable=me.resizable=false;me.align="center"}else{if(me.flex){me.minWidth=me.minWidth||Ext.grid.plugin.HeaderResizer.prototype.minColWidth}}me.addCls(Ext.baseCSSPrefix+"column-header-align-"+me.align);renderer=me.renderer;if(renderer){if(typeof renderer=="string"){me.renderer=Ext.util.Format[renderer]}me.hasCustomRenderer=true}else if(me.defaultRenderer){me.scope=me;me.renderer=me.defaultRenderer}me.callParent(arguments);listeners={element:me.clickTargetName,click:me.onTitleElClick,contextmenu:me.onTitleElContextMenu,mouseenter:me.onTitleMouseOver,mouseleave:me.onTitleMouseOut,scope:me};if(me.resizable){listeners.dblclick=me.onTitleElDblClick}me.on(listeners)},onAdd:function(child){if(child.isColumn){child.isSubHeader=true;child.addCls(this.groupSubHeaderCls)}if(this.hidden){child.hide()}this.callParent(arguments)},onRemove:function(child){if(child.isSubHeader){child.isSubHeader=false;child.removeCls(this.groupSubHeaderCls)}this.callParent(arguments)},initRenderData:function(){var me=this,tipMarkup="",tip=me.tooltip,attr=me.tooltipType=="qtip"?"data-qtip":"title";if(!Ext.isEmpty(tip)){tipMarkup=attr+'="'+tip+'" '}return Ext.applyIf(me.callParent(arguments),{text:me.text,menuDisabled:me.menuDisabled,tipMarkup:tipMarkup})},applyColumnState:function(state){var me=this;me.applyColumnsState(state.columns);if(state.hidden!=null){me.hidden=state.hidden}if(state.locked!=null){me.locked=state.locked}if(state.sortable!=null){me.sortable=state.sortable}if(state.width!=null){me.flex=null;me.width=state.width}else if(state.flex!=null){me.width=null;me.flex=state.flex}},getColumnState:function(){var me=this,items=me.items.items,iLen=items?items.length:0,i,columns=[],state={id:me.getStateId()};me.savePropsToState(["hidden","sortable","locked","flex","width"],state);if(me.isGroupHeader){for(i=0;i<iLen;i++){columns.push(items[i].getColumnState())}if(columns.length){state.columns=columns}}else if(me.isSubHeader&&me.ownerCt.hidden){delete me.hidden}if("width"in state){delete state.flex}return state},getStateId:function(){return this.stateId||this.headerId},setText:function(text){this.text=text;if(this.rendered){this.textEl.update(text)}},getIndex:function(){return this.isGroupColumn?false:this.getOwnerHeaderCt().getHeaderIndex(this)},getVisibleIndex:function(){return this.isGroupColumn?false:Ext.Array.indexOf(this.getOwnerHeaderCt().getVisibleGridColumns(),this)},beforeRender:function(){var me=this,grid=me.up("tablepanel");me.callParent();if(grid&&(!me.sortable||grid.sortableColumns===false)&&!me.groupable&&!me.lockable&&(grid.enableColumnHide===false||!me.getOwnerHeaderCt().getHideableColumns().length)){me.menuDisabled=true}me.protoEl.unselectable()},afterRender:function(){var me=this,triggerEl=me.triggerEl,triggerWidth;me.callParent(arguments);if(!Ext.isIE8||!Ext.isStrict){me.mon(me.getFocusEl(),{focus:me.onTitleMouseOver,blur:me.onTitleMouseOut,scope:me})}if(triggerEl&&me.self.triggerElWidth===undefined){triggerEl.setStyle("display","block");me.self.triggerElWidth=triggerEl.getWidth();triggerEl.setStyle("display","")}me.keyNav=new Ext.util.KeyNav(me.el,{enter:me.onEnterKey,down:me.onDownKey,scope:me})},afterComponentLayout:function(width,height,oldWidth,oldHeight){var me=this,ownerHeaderCt=me.getOwnerHeaderCt();me.callParent(arguments);if(ownerHeaderCt&&(oldWidth!=null||me.flex)&&width!==oldWidth){ownerHeaderCt.onHeaderResize(me,width,true)}},onDestroy:function(){var me=this;Ext.destroy(me.textEl,me.keyNav,me.field);me.keyNav=null;me.callParent(arguments)},onTitleMouseOver:function(){this.titleEl.addCls(this.hoverCls)},onTitleMouseOut:function(){this.titleEl.removeCls(this.hoverCls)},onDownKey:function(e){if(this.triggerEl){this.onTitleElClick(e,this.triggerEl.dom||this.el.dom)}},onEnterKey:function(e){this.onTitleElClick(e,this.el.dom)},onTitleElDblClick:function(e,t){var me=this,prev,leafColumns;if(me.isOnLeftEdge(e)){prev=me.previousNode("gridcolumn:not([hidden]):not([isGroupHeader])");if(prev&&prev.getOwnerHeaderCt()===me.getOwnerHeaderCt()){prev.autoSize()}}else if(me.isOnRightEdge(e)){if(me.isGroupHeader&&e.getPoint().isContainedBy(me.layout.innerCt)){leafColumns=me.query("gridcolumn:not([hidden]):not([isGroupHeader])");this.getOwnerHeaderCt().autoSizeColumn(leafColumns[leafColumns.length-1]);return}me.autoSize()}},autoSize:function(){var me=this,leafColumns,numLeaves,i,headerCt;if(me.isGroupHeader){leafColumns=me.query("gridcolumn:not([hidden]):not([isGroupHeader])");numLeaves=leafColumns.length;headerCt=this.getOwnerHeaderCt();Ext.suspendLayouts();for(i=0;i<numLeaves;i++){headerCt.autoSizeColumn(leafColumns[i])}Ext.resumeLayouts(true);return}this.getOwnerHeaderCt().autoSizeColumn(this)},onTitleElClick:function(e,t){var me=this,ownerHeaderCt=me.getOwnerHeaderCt();if(ownerHeaderCt&&!ownerHeaderCt.ddLock){if(me.triggerEl&&(e.target===me.triggerEl.dom||t===me.triggerEl.dom||e.within(me.triggerEl))){ownerHeaderCt.onHeaderTriggerClick(me,e,t)}else if(e.getKey()||!me.isOnLeftEdge(e)&&!me.isOnRightEdge(e)){me.toggleSortState();ownerHeaderCt.onHeaderClick(me,e,t)}}},onTitleElContextMenu:function(e,t){var me=this,ownerHeaderCt=me.getOwnerHeaderCt();if(ownerHeaderCt&&!ownerHeaderCt.ddLock){ownerHeaderCt.onHeaderContextMenu(me,e,t)}},processEvent:function(type,view,cell,recordIndex,cellIndex,e){return this.fireEvent.apply(this,arguments)},toggleSortState:function(){var me=this,idx,nextIdx;if(me.sortable){idx=Ext.Array.indexOf(me.possibleSortStates,me.sortState);nextIdx=(idx+1)%me.possibleSortStates.length;me.setSortState(me.possibleSortStates[nextIdx])}},doSort:function(state){var tablePanel=this.up("tablepanel"),store=tablePanel.store;if(tablePanel.ownerLockable&&store.isNodeStore){store=tablePanel.ownerLockable.lockedGrid.store}store.sort({property:this.getSortParam(),direction:state})},getSortParam:function(){return this.dataIndex},setSortState:function(state,skipClear,initial){var me=this,ascCls=me.ascSortCls,descCls=me.descSortCls,ownerHeaderCt=me.getOwnerHeaderCt(),oldSortState=me.sortState;state=state||null;if(!me.sorting&&oldSortState!==state&&me.getSortParam()!=null){if(state&&!initial){me.sorting=true;me.doSort(state);me.sorting=false}switch(state){case"DESC":me.addCls(descCls);me.removeCls(ascCls);break;case"ASC":me.addCls(ascCls);me.removeCls(descCls);break;default:me.removeCls([ascCls,descCls])}if(ownerHeaderCt&&!me.triStateSort&&!skipClear){ownerHeaderCt.clearOtherSortStates(me)}me.sortState=state;if(me.triStateSort||state!=null){ownerHeaderCt.fireEvent("sortchange",ownerHeaderCt,me,state)}}},isHideable:function(){var result={hideCandidate:this,result:this.hideable};if(result.result){this.ownerCt.bubble(this.hasOtherMenuEnabledChildren,null,[result])}return result.result},hasOtherMenuEnabledChildren:function(result){var visibleChildren,count;if(!this.isXType("headercontainer")){result.result=false;return false}visibleChildren=this.query(">:not([hidden]):not([menuDisabled])");count=visibleChildren.length;if(Ext.Array.contains(visibleChildren,result.hideCandidate)){count--}if(count){return false}result.hideCandidate=this},isLockable:function(){var result={result:this.lockable!==false};if(result.result){this.ownerCt.bubble(this.hasMultipleVisibleChildren,null,[result])}return result.result},isLocked:function(){return this.locked||!!this.up("[isColumn][locked]","[isRootHeader]")},hasMultipleVisibleChildren:function(result){if(!this.isXType("headercontainer")){result.result=false;return false}if(this.query(">:not([hidden])").length>1){return false}},hide:function(fromOwner){var me=this,ownerHeaderCt=me.getOwnerHeaderCt(),owner=me.ownerCt,ownerIsGroup,item,items,len,i;if(!me.isVisible()){return me}if(!ownerHeaderCt){me.callParent();return me}if(ownerHeaderCt.forceFit){me.visibleSiblingCount=ownerHeaderCt.getVisibleGridColumns().length-1;if(me.flex){me.savedWidth=me.getWidth();me.flex=null}}ownerIsGroup=owner.isGroupHeader;if(ownerIsGroup&&!fromOwner){items=owner.query(">:not([hidden])");if(items.length===1&&items[0]==me){me.ownerCt.hide();return}}Ext.suspendLayouts();if(me.isGroupHeader){items=me.items.items;for(i=0,len=items.length;i<len;i++){item=items[i];if(!item.hidden){item.hide(true)}}}me.callParent();ownerHeaderCt.onHeaderHide(me);Ext.resumeLayouts(true);return me},show:function(fromOwner,fromChild){var me=this,ownerHeaderCt=me.getOwnerHeaderCt(),ownerCt=me.ownerCt,items,len,i,item,myWidth,availFlex,totalFlex,oldLen,defaultWidth=Ext.grid.header.Container.prototype.defaultWidth;if(me.isVisible()){return me}if(!me.rendered){me.hidden=false;return}availFlex=ownerHeaderCt.el.getViewSize().width-(ownerHeaderCt.view.el.dom.scrollHeight>ownerHeaderCt.view.el.dom.clientHeight?Ext.getScrollbarSize().width:0);if(ownerHeaderCt.forceFit){items=Ext.ComponentQuery.query(":not([flex])",ownerHeaderCt.getVisibleGridColumns());if(items.length){me.width=me.savedWidth||me.width||defaultWidth}else{items=ownerHeaderCt.getVisibleGridColumns();len=items.length;oldLen=me.visibleSiblingCount;myWidth=me.savedWidth||me.width||defaultWidth;myWidth=Math.min(myWidth*(oldLen/len),defaultWidth,Math.max(availFlex-len*defaultWidth,defaultWidth));me.width=null;me.flex=myWidth;availFlex-=myWidth;totalFlex=0;for(i=0;i<len;i++){item=items[i];item.flex=item.width||item.getWidth();totalFlex+=item.flex;item.width=null}for(i=0;i<len;i++){item=items[i];item.flex=item.flex/totalFlex*availFlex}}}Ext.suspendLayouts();if(me.isSubHeader&&ownerCt.hidden){ownerCt.show(false,true)}me.callParent(arguments);if(me.isGroupHeader&&fromChild!==true&&!me.query(":not([hidden])").length){items=me.items.items;for(i=0,len=items.length;i<len;i++){item=items[i];if(item.hidden){item.show(true)}}}Ext.resumeLayouts(true);ownerCt=me.getOwnerHeaderCt();if(ownerCt){ownerCt.onHeaderShow(me)}},getDesiredWidth:function(){var me=this;if(me.rendered&&me.componentLayout&&me.componentLayout.lastComponentSize){return me.componentLayout.lastComponentSize.width}else if(me.flex){return me.width}else{return me.width}},getCellSelector:function(){return"."+Ext.baseCSSPrefix+"grid-cell-"+this.getItemId()},getCellInnerSelector:function(){return this.getCellSelector()+" ."+Ext.baseCSSPrefix+"grid-cell-inner"},isOnLeftEdge:function(e){return e.getXY()[0]-this.getX()<=this.handleWidth},isOnRightEdge:function(e){return this.getX()+this.getWidth()-e.getXY()[0]<=this.handleWidth},setMenuActive:function(isMenuOpen){this.titleEl[isMenuOpen?"addCls":"removeCls"](this.headerOpenCls)}});