Ext.define("Ext.layout.Context",{requires:["Ext.util.Queue","Ext.layout.ContextItem","Ext.layout.Layout","Ext.fx.Anim","Ext.fx.Manager"],remainingLayouts:0,state:0,constructor:function(config){var me=this;Ext.apply(me,config);me.items={};me.layouts={};me.blockCount=0;me.cycleCount=0;me.flushCount=0;me.calcCount=0;me.animateQueue=me.newQueue();me.completionQueue=me.newQueue();me.finalizeQueue=me.newQueue();me.finishQueue=me.newQueue();me.flushQueue=me.newQueue();me.invalidateData={};me.layoutQueue=me.newQueue();me.invalidQueue=[];me.triggers={data:{},dom:{}}},callLayout:function(layout,methodName){this.currentLayout=layout;layout[methodName](this.getCmp(layout.owner))},cancelComponent:function(comp,isChild,isDestroying){var me=this,components=comp,isArray=!comp.isComponent,length=isArray?components.length:1,i,k,klen,items,layout,newQueue,oldQueue,entry,temp,ownerCtContext;for(i=0;i<length;++i){if(isArray){comp=components[i]}if(isDestroying&&comp.ownerCt){ownerCtContext=this.items[comp.ownerCt.el.id];if(ownerCtContext){Ext.Array.remove(ownerCtContext.childItems,me.getCmp(comp))}}if(!isChild){oldQueue=me.invalidQueue;klen=oldQueue.length;if(klen){me.invalidQueue=newQueue=[];for(k=0;k<klen;++k){entry=oldQueue[k];temp=entry.item.target;if(temp!=comp&&!temp.isDescendant(comp)){newQueue.push(entry)}}}}layout=comp.componentLayout;me.cancelLayout(layout);if(layout.getLayoutItems){items=layout.getLayoutItems();if(items.length){me.cancelComponent(items,true)}}if(comp.isContainer&&!comp.collapsed){layout=comp.layout;me.cancelLayout(layout);items=layout.getVisibleItems();if(items.length){me.cancelComponent(items,true)}}}},cancelLayout:function(layout){var me=this;me.completionQueue.remove(layout);me.finalizeQueue.remove(layout);me.finishQueue.remove(layout);me.layoutQueue.remove(layout);if(layout.running){me.layoutDone(layout)}layout.ownerContext=null},clearTriggers:function(layout,inDom){var id=layout.id,collection=this.triggers[inDom?"dom":"data"],triggers=collection&&collection[id],length=triggers&&triggers.length||0,i,item,trigger;for(i=0;i<length;++i){trigger=triggers[i];item=trigger.item;collection=inDom?item.domTriggers:item.triggers;delete collection[trigger.prop][id]}},flush:function(){var me=this,items=me.flushQueue.clear(),length=items.length,i;if(length){++me.flushCount;for(i=0;i<length;++i){items[i].flush()}}},flushAnimations:function(){var me=this,items=me.animateQueue.clear(),len=items.length,i;if(len){for(i=0;i<len;i++){if(items[i].target.animate!==false){items[i].flushAnimations()}}Ext.fx.Manager.runner()}},flushInvalidates:function(){var me=this,queue=me.invalidQueue,length=queue&&queue.length,comp,components,entry,i;me.invalidQueue=[];if(length){components=[];for(i=0;i<length;++i){comp=(entry=queue[i]).item.target;if(!comp.container.isDetachedBody){components.push(comp);if(entry.options){me.invalidateData[comp.id]=entry.options}}}me.invalidate(components,null)}},flushLayouts:function(queueName,methodName,dontClear){var me=this,layouts=dontClear?me[queueName].items:me[queueName].clear(),length=layouts.length,i,layout;if(length){for(i=0;i<length;++i){layout=layouts[i];if(!layout.running){me.callLayout(layout,methodName)}}me.currentLayout=null}},getCmp:function(cmp){return this.getItem(cmp,cmp.el)},getEl:function(parent,el){var item=this.getItem(el,el);if(!item.parent){item.parent=parent;if(parent.children.length){parent.children.push(item)}else{parent.children=[item]}}return item},getItem:function(target,el){var id=el.id,items=this.items,item=items[id]||(items[id]=new Ext.layout.ContextItem({context:this,target:target,el:el}));return item},handleFailure:function(){var layouts=this.layouts,layout,key;Ext.failedLayouts=(Ext.failedLayouts||0)+1;for(key in layouts){layout=layouts[key];if(layouts.hasOwnProperty(key)){layout.running=false;layout.ownerContext=null}}if(Ext.repoDevMode&&!this.pageAnalyzerMode){Ext.Error.raise("Layout run failed")}else{Ext.log.error("Layout run failed")}},invalidate:function(components,full){var me=this,isArray=!components.isComponent,containerLayoutDone,firstTime,i,comp,item,items,length,componentLayout,layout,invalidateOptions,token;for(i=0,length=isArray?components.length:1;i<length;++i){comp=isArray?components[i]:components;if(comp.rendered&&!comp.hidden){item=me.getCmp(comp);componentLayout=comp.componentLayout;firstTime=!componentLayout.ownerContext;layout=comp.isContainer&&!comp.collapsed?comp.layout:null;invalidateOptions=me.invalidateData[item.id];delete me.invalidateData[item.id];token=item.init(full,invalidateOptions);if(invalidateOptions){me.processInvalidate(invalidateOptions,item,"before")}if(componentLayout.beforeLayoutCycle){componentLayout.beforeLayoutCycle(item)}if(layout&&layout.beforeLayoutCycle){layout.beforeLayoutCycle(item)}token=item.initContinue(token);containerLayoutDone=true;if(componentLayout.getLayoutItems){componentLayout.renderChildren();items=componentLayout.getLayoutItems();if(items.length){me.invalidate(items,true)}}if(layout){containerLayoutDone=false;layout.renderChildren();items=layout.getVisibleItems();if(items.length){me.invalidate(items,true)}}item.initDone(containerLayoutDone);me.resetLayout(componentLayout,item,firstTime);if(layout){me.resetLayout(layout,item,firstTime)}item.initAnimation();if(invalidateOptions){me.processInvalidate(invalidateOptions,item,"after")}}}me.currentLayout=null},layoutDone:function(layout){var ownerContext=layout.ownerContext;layout.running=false;if(layout.isComponentLayout){if(ownerContext.measuresBox){ownerContext.onBoxMeasured()}ownerContext.setProp("done",true)}else{ownerContext.setProp("containerLayoutDone",true)}--this.remainingLayouts;++this.progressCount},newQueue:function(){return new Ext.util.Queue},processInvalidate:function(options,item,name){if(options[name]){var me=this,currentLayout=me.currentLayout;me.currentLayout=options.layout||null;options[name](item,options);me.currentLayout=currentLayout}},queueAnimation:function(item){this.animateQueue.add(item)},queueCompletion:function(layout){this.completionQueue.add(layout)},queueFinalize:function(layout){this.finalizeQueue.add(layout)},queueFlush:function(item){this.flushQueue.add(item)},chainFns:function(oldOptions,newOptions,funcName){var me=this,oldLayout=oldOptions.layout,newLayout=newOptions.layout,oldFn=oldOptions[funcName],newFn=newOptions[funcName];return function(contextItem){var prev=me.currentLayout;if(oldFn){me.currentLayout=oldLayout;oldFn.call(oldOptions.scope||oldOptions,contextItem,oldOptions)}me.currentLayout=newLayout;newFn.call(newOptions.scope||newOptions,contextItem,newOptions);me.currentLayout=prev}},queueInvalidate:function(item,options){var me=this,newQueue=[],oldQueue=me.invalidQueue,index=oldQueue.length,comp,old,oldComp,oldOptions,oldState;if(item.isComponent){item=me.getCmp(comp=item)}else{comp=item.target}item.invalid=true;while(index--){old=oldQueue[index];oldComp=old.item.target;if(comp.isDescendant(oldComp)){return}if(oldComp==comp){if(!(oldOptions=old.options)){old.options=options}else if(options){if(options.widthModel){oldOptions.widthModel=options.widthModel}if(options.heightModel){oldOptions.heightModel=options.heightModel}if(!(oldState=oldOptions.state)){oldOptions.state=options.state}else if(options.state){Ext.apply(oldState,options.state)}if(options.before){oldOptions.before=me.chainFns(oldOptions,options,"before")}if(options.after){oldOptions.after=me.chainFns(oldOptions,options,"after")}}return}if(!oldComp.isDescendant(comp)){newQueue.push(old)}}newQueue.push({item:item,options:options});me.invalidQueue=newQueue},queueItemLayouts:function(item){var comp=item.isComponent?item:item.target,layout=comp.componentLayout;if(!layout.pending&&!layout.invalid&&!layout.done){this.queueLayout(layout)}layout=comp.layout;if(layout&&!layout.pending&&!layout.invalid&&!layout.done){this.queueLayout(layout)}},queueLayout:function(layout){this.layoutQueue.add(layout);layout.pending=true},removeEl:function(parent,el){var id=el.id,children=parent.children,items=this.items;if(children){Ext.Array.remove(children,items[id])}delete items[id]},resetLayout:function(layout,ownerContext,firstTime){var me=this;me.currentLayout=layout;layout.done=false;layout.pending=true;layout.firedTriggers=0;me.layoutQueue.add(layout);if(firstTime){me.layouts[layout.id]=layout;layout.running=true;if(layout.finishedLayout){me.finishQueue.add(layout)}++me.remainingLayouts;++layout.layoutCount;layout.ownerContext=ownerContext;layout.beginCount=0;layout.blockCount=0;layout.calcCount=0;layout.triggerCount=0;if(!layout.initialized){layout.initLayout()}layout.beginLayout(ownerContext)}else{++layout.beginCount;if(!layout.running){++me.remainingLayouts;layout.running=true;if(layout.isComponentLayout){ownerContext.unsetProp("done")}me.completionQueue.remove(layout);me.finalizeQueue.remove(layout)}}layout.beginLayoutCycle(ownerContext,firstTime)},run:function(){var me=this,flushed=false,watchDog=100;me.flushInvalidates();me.state=1;me.totalCount=me.layoutQueue.getCount();me.flush();while((me.remainingLayouts||me.invalidQueue.length)&&watchDog--){if(me.invalidQueue.length){me.flushInvalidates()}if(me.runCycle()){flushed=false}else if(!flushed){me.flush();flushed=true;me.flushLayouts("completionQueue","completeLayout")}else if(!me.invalidQueue.length){me.state=2;break}if(!(me.remainingLayouts||me.invalidQueue.length)){me.flush();me.flushLayouts("completionQueue","completeLayout");me.flushLayouts("finalizeQueue","finalizeLayout")}}return me.runComplete()},runComplete:function(){var me=this;me.state=2;if(me.remainingLayouts){me.handleFailure();return false}me.flush();me.flushLayouts("finishQueue","finishedLayout",true);me.flushLayouts("finishQueue","notifyOwner");me.flush();me.flushAnimations();return true},runCycle:function(){var me=this,layouts=me.layoutQueue.clear(),length=layouts.length,i;++me.cycleCount;me.progressCount=0;for(i=0;i<length;++i){me.runLayout(me.currentLayout=layouts[i])}me.currentLayout=null;return me.progressCount>0},runLayout:function(layout){var me=this,ownerContext=me.getCmp(layout.owner);layout.pending=false;if(ownerContext.state.blocks){return}layout.done=true;++layout.calcCount;++me.calcCount;layout.calculate(ownerContext);if(layout.done){me.layoutDone(layout);if(layout.completeLayout){me.queueCompletion(layout)}if(layout.finalizeLayout){me.queueFinalize(layout)}}else if(!layout.pending&&!layout.invalid&&!(layout.blockCount+layout.triggerCount-layout.firedTriggers)){me.queueLayout(layout)}},setItemSize:function(item,width,height){var items=item,len=1,contextItem,i;if(item.isComposite){items=item.elements;len=items.length;item=items[0]}else if(!item.dom&&!item.el){len=items.length;item=items[0]}for(i=0;i<len;){contextItem=this.get(item);contextItem.setSize(width,height);item=items[++i]}}});