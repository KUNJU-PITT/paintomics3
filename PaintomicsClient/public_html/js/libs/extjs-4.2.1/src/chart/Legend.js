Ext.define("Ext.chart.Legend",{requires:["Ext.chart.LegendItem"],visible:true,update:true,position:"bottom",x:0,y:0,labelColor:"#000",labelFont:"12px Helvetica, sans-serif",boxStroke:"#000",boxStrokeWidth:1,boxFill:"#FFF",itemSpacing:10,padding:5,width:0,height:0,boxZIndex:100,constructor:function(config){var me=this;if(config){Ext.apply(me,config)}me.items=[];me.isVertical="left|right|float".indexOf(me.position)!==-1;me.origX=me.x;me.origY=me.y},create:function(){var me=this,seriesItems=me.chart.series.items,i,ln,series;me.createBox();if(me.rebuild!==false){me.createItems()}if(!me.created&&me.isDisplayed()){me.created=true;for(i=0,ln=seriesItems.length;i<ln;i++){series=seriesItems[i];series.on("titlechange",me.redraw,me)}}},redraw:function(){var me=this;me.create();me.updatePosition()},isDisplayed:function(){return this.visible&&this.chart.series.findIndex("showInLegend",true)!==-1},createItems:function(){var me=this,seriesItems=me.chart.series.items,items=me.items,fields,i,li,j,lj,series,item;me.removeItems();for(i=0,li=seriesItems.length;i<li;i++){series=seriesItems[i];if(series.showInLegend){fields=[].concat(series.yField);for(j=0,lj=fields.length;j<lj;j++){item=me.createLegendItem(series,j);items.push(item)}}}me.alignItems()},removeItems:function(){var me=this,items=me.items,len=items?items.length:0,i;if(len){for(i=0;i<len;i++){items[i].destroy()}}items.length=[]},alignItems:function(){var me=this,padding=me.padding,vertical=me.isVertical,mfloor=Math.floor,dim,maxWidth,maxHeight,totalWidth,totalHeight;dim=me.updateItemDimensions();maxWidth=dim.maxWidth;maxHeight=dim.maxHeight;totalWidth=dim.totalWidth;totalHeight=dim.totalHeight;me.width=mfloor((vertical?maxWidth:totalWidth)+padding*2);me.height=mfloor((vertical?totalHeight:maxHeight)+padding*2)},updateItemDimensions:function(){var me=this,items=me.items,padding=me.padding,itemSpacing=me.itemSpacing,maxWidth=0,maxHeight=0,totalWidth=0,totalHeight=0,vertical=me.isVertical,mfloor=Math.floor,mmax=Math.max,spacing=0,i,l,item,bbox,width,height;for(i=0,l=items.length;i<l;i++){item=items[i];bbox=item.getBBox();width=bbox.width;height=bbox.height;spacing=i===0?0:itemSpacing;item.x=padding+mfloor(vertical?0:totalWidth+spacing);item.y=padding+mfloor(vertical?totalHeight+spacing:0)+height/2;totalWidth+=spacing+width;totalHeight+=spacing+height;maxWidth=mmax(maxWidth,width);maxHeight=mmax(maxHeight,height)}return{totalWidth:totalWidth,totalHeight:totalHeight,maxWidth:maxWidth,maxHeight:maxHeight}},createLegendItem:function(series,yFieldIndex){var me=this;return new Ext.chart.LegendItem({legend:me,series:series,surface:me.chart.surface,yFieldIndex:yFieldIndex})},getBBox:function(){var me=this;return{x:Math.round(me.x)-me.boxStrokeWidth/2,y:Math.round(me.y)-me.boxStrokeWidth/2,width:me.width+me.boxStrokeWidth,height:me.height+me.boxStrokeWidth}},createBox:function(){var me=this,box,bbox;if(me.boxSprite){me.boxSprite.destroy()}bbox=me.getBBox();if(isNaN(bbox.width)||isNaN(bbox.height)){me.boxSprite=false;return}box=me.boxSprite=me.chart.surface.add(Ext.apply({type:"rect",stroke:me.boxStroke,"stroke-width":me.boxStrokeWidth,fill:me.boxFill,zIndex:me.boxZIndex},bbox));box.redraw()},calcPosition:function(){var me=this,x,y,legendWidth=me.width,legendHeight=me.height,chart=me.chart,chartBBox=chart.chartBBox,insets=chart.insetPadding,chartWidth=chartBBox.width-insets*2,chartHeight=chartBBox.height-insets*2,chartX=chartBBox.x+insets,chartY=chartBBox.y+insets,surface=chart.surface,mfloor=Math.floor;switch(me.position){case"left":x=insets;y=mfloor(chartY+chartHeight/2-legendHeight/2);break;case"right":x=mfloor(surface.width-legendWidth)-insets;y=mfloor(chartY+chartHeight/2-legendHeight/2);break;case"top":x=mfloor(chartX+chartWidth/2-legendWidth/2);y=insets;break;case"bottom":x=mfloor(chartX+chartWidth/2-legendWidth/2);y=mfloor(surface.height-legendHeight)-insets;break;default:x=mfloor(me.origX)+insets;y=mfloor(me.origY)+insets}return{x:x,y:y}},updatePosition:function(){var me=this,items=me.items,pos,i,l,bbox;if(me.isDisplayed()){pos=me.calcPosition();me.x=pos.x;me.y=pos.y;for(i=0,l=items.length;i<l;i++){items[i].updatePosition()}bbox=me.getBBox();if(isNaN(bbox.width)||isNaN(bbox.height)){if(me.boxSprite){me.boxSprite.hide(true)}}else{if(!me.boxSprite){me.createBox()}me.boxSprite.setAttributes(bbox,true);me.boxSprite.show(true)}}},toggle:function(show){var me=this,i=0,items=me.items,len=items.length;if(me.boxSprite){if(show){me.boxSprite.show(true)}else{me.boxSprite.hide(true)}}for(;i<len;++i){if(show){items[i].show(true)}else{items[i].hide(true)}}me.visible=show}});