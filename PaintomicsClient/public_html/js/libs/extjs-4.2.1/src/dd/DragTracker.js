Ext.define("Ext.dd.DragTracker",{uses:["Ext.util.Region"],mixins:{observable:"Ext.util.Observable"},active:false,trackOver:false,tolerance:5,autoStart:false,constructor:function(config){var me=this;Ext.apply(me,config);me.addEvents("mouseover","mouseout","mousedown","mouseup","mousemove","beforedragstart","dragstart","dragend","drag");me.dragRegion=new Ext.util.Region(0,0,0,0);if(me.el){me.initEl(me.el)}me.mixins.observable.constructor.call(me);if(me.disabled){me.disable()}},initEl:function(el){var me=this;me.el=Ext.get(el);me.handle=Ext.get(me.delegate);me.delegate=me.handle?undefined:me.delegate;if(!me.handle){me.handle=me.el}me.handleListeners={scope:me,delegate:me.delegate,mousedown:me.onMouseDown};if(me.trackOver||me.overCls){Ext.apply(me.handleListeners,{mouseover:me.onMouseOver,mouseout:me.onMouseOut})}me.mon(me.handle,me.handleListeners)},disable:function(){this.disabled=true},enable:function(){this.disabled=false},destroy:function(){var me=this;if(me.active){me.endDrag({})}me.clearListeners();me.mun(me.handle,me.handleListeners);me.el=me.handle=null},onMouseOver:function(e,target){var me=this;if(!me.disabled){if(Ext.EventManager.contains(e)||me.delegate){me.mouseIsOut=false;if(me.overCls){me.el.addCls(me.overCls)}me.fireEvent("mouseover",me,e,me.delegate?e.getTarget(me.delegate,target):me.handle)}}},onMouseOut:function(e){var me=this;if(me.mouseIsDown){me.mouseIsOut=true}else{if(me.overCls){me.el.removeCls(me.overCls)}me.fireEvent("mouseout",me,e)}},onMouseDown:function(e,target){var me=this,el;if(me.disabled||e.dragTracked){return}me.dragTarget=me.delegate?target:me.handle.dom;me.startXY=me.lastXY=e.getXY();me.startRegion=Ext.fly(me.dragTarget).getRegion();if(me.fireEvent("mousedown",me,e)===false||me.fireEvent("beforedragstart",me,e)===false||me.onBeforeStart(e)===false){return}me.mouseIsDown=true;e.dragTracked=true;el=me.el.dom;if(Ext.isIE&&el.setCapture){el.setCapture()}if(me.preventDefault!==false){e.preventDefault()}Ext.getDoc().on({scope:me,mouseup:me.onMouseUp,mousemove:me.onMouseMove,selectstart:me.stopSelect});if(me.autoStart){me.timer=Ext.defer(me.triggerStart,me.autoStart===true?1e3:me.autoStart,me,[e])}},onMouseMove:function(e,target){var me=this,xy=e.getXY(),s=me.startXY;e.preventDefault();me.lastXY=xy;if(!me.active){if(Math.max(Math.abs(s[0]-xy[0]),Math.abs(s[1]-xy[1]))>me.tolerance){me.triggerStart(e)}else{return}}if(me.fireEvent("mousemove",me,e)===false){me.onMouseUp(e)}else{me.onDrag(e);me.fireEvent("drag",me,e)}},onMouseUp:function(e){var me=this;me.mouseIsDown=false;if(me.mouseIsOut){me.mouseIsOut=false;me.onMouseOut(e)}e.preventDefault();if(Ext.isIE&&document.releaseCapture){document.releaseCapture()}me.fireEvent("mouseup",me,e);me.endDrag(e)},endDrag:function(e){var me=this,wasActive=me.active;Ext.getDoc().un({mousemove:me.onMouseMove,mouseup:me.onMouseUp,selectstart:me.stopSelect,scope:me});me.clearStart();me.active=false;if(wasActive){me.onEnd(e);me.fireEvent("dragend",me,e)}me._constrainRegion=Ext.EventObject.dragTracked=null},triggerStart:function(e){var me=this;me.clearStart();me.active=true;me.onStart(e);me.fireEvent("dragstart",me,e)},clearStart:function(){var timer=this.timer;if(timer){clearTimeout(timer);this.timer=null}},stopSelect:function(e){e.stopEvent();return false},onBeforeStart:function(e){},onStart:function(xy){},onDrag:function(e){},onEnd:function(e){},getDragTarget:function(){return this.dragTarget},getDragCt:function(){return this.el},getConstrainRegion:function(){var me=this;if(me.constrainTo){if(me.constrainTo instanceof Ext.util.Region){return me.constrainTo}if(!me._constrainRegion){me._constrainRegion=Ext.fly(me.constrainTo).getViewRegion()}}else{if(!me._constrainRegion){me._constrainRegion=me.getDragCt().getViewRegion()}}return me._constrainRegion},getXY:function(constrain){return constrain?this.constrainModes[constrain](this,this.lastXY):this.lastXY},getOffset:function(constrain){var xy=this.getXY(constrain),s=this.startXY;return[xy[0]-s[0],xy[1]-s[1]]},constrainModes:{point:function(me,xy){var dr=me.dragRegion,constrainTo=me.getConstrainRegion();if(!constrainTo){return xy}dr.x=dr.left=dr[0]=dr.right=xy[0];dr.y=dr.top=dr[1]=dr.bottom=xy[1];dr.constrainTo(constrainTo);return[dr.left,dr.top]},dragTarget:function(me,xy){var s=me.startXY,dr=me.startRegion.copy(),constrainTo=me.getConstrainRegion(),adjust;if(!constrainTo){return xy}dr.translateBy(xy[0]-s[0],xy[1]-s[1]);if(dr.right>constrainTo.right){xy[0]+=adjust=constrainTo.right-dr.right;dr.left+=adjust}if(dr.left<constrainTo.left){xy[0]+=constrainTo.left-dr.left}if(dr.bottom>constrainTo.bottom){xy[1]+=adjust=constrainTo.bottom-dr.bottom;dr.top+=adjust}if(dr.top<constrainTo.top){xy[1]+=constrainTo.top-dr.top}return xy}}});