Ext.define("Ext.data.NodeInterface",{requires:["Ext.data.Field","Ext.data.writer.Json"],statics:{decorate:function(modelClass){var idName,idField,idType;if(typeof modelClass=="string"){modelClass=Ext.ModelManager.getModel(modelClass)}else if(modelClass.isModel){modelClass=Ext.ModelManager.getModel(modelClass.modelName)}if(modelClass.prototype.isNode){return}idName=modelClass.prototype.idProperty;idField=modelClass.prototype.fields.get(idName);idType=modelClass.prototype.fields.get(idName).type.type;modelClass.override(this.getPrototypeBody());this.applyFields(modelClass,[{name:"parentId",type:idType,defaultValue:null,useNull:idField.useNull},{name:"index",type:"int",defaultValue:0,persist:false,convert:null},{name:"depth",type:"int",defaultValue:0,persist:false,convert:null},{name:"expanded",type:"bool",defaultValue:false,persist:false,convert:null},{name:"expandable",type:"bool",defaultValue:true,persist:false,convert:null},{name:"checked",type:"auto",defaultValue:null,persist:false,convert:null},{name:"leaf",type:"bool",defaultValue:false},{name:"cls",type:"string",defaultValue:"",persist:false,convert:null},{name:"iconCls",type:"string",defaultValue:"",persist:false,convert:null},{name:"icon",type:"string",defaultValue:"",persist:false,convert:null},{name:"root",type:"boolean",defaultValue:false,persist:false,convert:null},{name:"isLast",type:"boolean",defaultValue:false,persist:false,convert:null},{name:"isFirst",type:"boolean",defaultValue:false,persist:false,convert:null},{name:"allowDrop",type:"boolean",defaultValue:true,persist:false,convert:null},{name:"allowDrag",type:"boolean",defaultValue:true,persist:false,convert:null},{name:"loaded",type:"boolean",defaultValue:false,persist:false,convert:null},{name:"loading",type:"boolean",defaultValue:false,persist:false,convert:null},{name:"href",type:"string",defaultValue:"",persist:false,convert:null},{name:"hrefTarget",type:"string",defaultValue:"",persist:false,convert:null},{name:"qtip",type:"string",defaultValue:"",persist:false,convert:null},{name:"qtitle",type:"string",defaultValue:"",persist:false,convert:null},{name:"qshowDelay",type:"int",defaultValue:0,persist:false,convert:null},{name:"children",type:"auto",defaultValue:null,persist:false,convert:null}])},applyFields:function(modelClass,addFields){var modelPrototype=modelClass.prototype,fields=modelPrototype.fields,keys=fields.keys,ln=addFields.length,addField,i;for(i=0;i<ln;i++){addField=addFields[i];if(!Ext.Array.contains(keys,addField.name)){fields.add(new Ext.data.Field(addField))}}},getPrototypeBody:function(){var bubbledEvents={idchanged:true,append:true,remove:true,move:true,insert:true,beforeappend:true,beforeremove:true,beforemove:true,beforeinsert:true,expand:true,collapse:true,beforeexpand:true,beforecollapse:true,sort:true,rootchange:true};return{isNode:true,constructor:function(){var me=this;me.callParent(arguments);me.firstChild=me.lastChild=me.parentNode=me.previousSibling=me.nextSibling=null;me.childNodes=[];return me},createNode:function(node){if(!node.isModel){node=Ext.ModelManager.create(node,this.modelName)}if(!node.childNodes){node.firstChild=node.lastChild=node.parentNode=node.previousSibling=node.nextSibling=null;node.childNodes=[]}return node},isLeaf:function(){return this.get("leaf")===true},setFirstChild:function(node){this.firstChild=node},setLastChild:function(node){this.lastChild=node},updateInfo:function(commit,info){var me=this,oldDepth=me.data.depth,childInfo={},children=me.childNodes,childCount=children.length,i,phantom=me.phantom,dataObject=me[me.persistenceProperty],propName,newValue,field;if(!info){Ext.Error.raise("NodeInterface expects update info to be passed")}for(propName in info){field=me.fields.get(propName);newValue=info[propName];if(field&&field.persist){me.dirty=me.dirty||!me.isEqual(dataObject[propName],newValue)}dataObject[propName]=newValue}if(commit){me.commit();me.phantom=phantom}if(me.data.depth!==oldDepth){childInfo={depth:me.data.depth+1};for(i=0;i<childCount;i++){children[i].updateInfo(commit,childInfo)}}},isLast:function(){return this.get("isLast")},isFirst:function(){return this.get("isFirst")},hasChildNodes:function(){return!this.isLeaf()&&this.childNodes.length>0},isExpandable:function(){var me=this;if(me.get("expandable")){return!(me.isLeaf()||me.isLoaded()&&!me.hasChildNodes())}return false},triggerUIUpdate:function(){this.afterEdit([])},appendChild:function(node,suppressEvents,commit){var me=this,i,ln,index,oldParent,previousSibling,childInfo={isLast:true,parentId:me.getId(),depth:(me.data.depth||0)+1};if(Ext.isArray(node)){me.callStore("suspendAutoSync");for(i=0,ln=node.length-1;i<ln;i++){me.appendChild(node[i],suppressEvents,commit)}me.callStore("resumeAutoSync");me.appendChild(node[ln],suppressEvents,commit)}else{node=me.createNode(node);if(suppressEvents!==true&&me.fireEventArgs("beforeappend",[me,node])===false){return false}index=me.childNodes.length;oldParent=node.parentNode;if(oldParent){if(suppressEvents!==true&&node.fireEventArgs("beforemove",[node,oldParent,me,index])===false){return false}oldParent.removeChild(node,false,false,true)}Ext.suspendLayouts();index=me.childNodes.length;if(index===0){me.setFirstChild(node)}me.childNodes[index]=node;node.parentNode=me;node.nextSibling=null;me.setLastChild(node);previousSibling=me.childNodes[index-1];if(previousSibling){node.previousSibling=previousSibling;previousSibling.nextSibling=node;previousSibling.updateInfo(commit,{isLast:false});previousSibling.triggerUIUpdate()}else{node.previousSibling=null}childInfo.isFirst=index===0;childInfo.index=index;node.updateInfo(commit,childInfo);if(!me.isLoaded()){me.set("loaded",true)}else if(me.childNodes.length===1){me.triggerUIUpdate()}if(index&&me.childNodes[index-1].isExpanded()){me.childNodes[index-1].cascadeBy(me.triggerUIUpdate)}if(!node.isLeaf()&&node.phantom){node.set("loaded",true)}Ext.resumeLayouts(true);if(suppressEvents!==true){me.fireEventArgs("append",[me,node,index]);if(oldParent){node.fireEventArgs("move",[node,oldParent,me,index])}}return node}},getOwnerTree:function(){var node=this,store;while(node.parentNode){node=node.parentNode}store=node.store;if(store){if(store.treeStore){store=store.treeStore}if(store.tree){return store.ownerTree}}return undefined},removeChild:function(node,destroy,suppressEvents,isMove){var me=this,index=me.indexOf(node),i,childCount,previousSibling;if(index===-1||suppressEvents!==true&&me.fireEventArgs("beforeremove",[me,node,!!isMove])===false){return false}Ext.suspendLayouts();Ext.Array.erase(me.childNodes,index,1);if(me.firstChild===node){me.setFirstChild(node.nextSibling)}if(me.lastChild===node){me.setLastChild(node.previousSibling)}if(previousSibling=node.previousSibling){node.previousSibling.nextSibling=node.nextSibling}if(node.nextSibling){node.nextSibling.previousSibling=node.previousSibling;if(index===0){node.nextSibling.updateInfo(false,{isFirst:true})}for(i=index,childCount=me.childNodes.length;i<childCount;i++){me.childNodes[i].updateInfo(false,{index:i})}}else if(previousSibling){previousSibling.updateInfo(false,{isLast:true});if(previousSibling.isExpanded()){previousSibling.cascadeBy(me.triggerUIUpdate)}else{previousSibling.triggerUIUpdate()}}if(!me.childNodes.length){me.triggerUIUpdate()}Ext.resumeLayouts(true);if(suppressEvents!==true){node.removeContext={parentNode:node.parentNode,previousSibling:node.previousSibling,nextSibling:node.nextSibling};node.previousSibling=node.nextSibling=node.parentNode=null;me.fireEventArgs("remove",[me,node,!!isMove]);node.removeContext=null}if(destroy){node.destroy(true)}else{node.clear()}return node},copy:function(newId,deep){var me=this,result=me.callParent(arguments),len=me.childNodes?me.childNodes.length:0,i;if(deep){for(i=0;i<len;i++){result.appendChild(me.childNodes[i].copy(undefined,true))}}return result},clear:function(destroy){var me=this;me.parentNode=me.previousSibling=me.nextSibling=null;if(destroy){me.firstChild=me.lastChild=null}},destroy:function(silent){var me=this,options=me.destroyOptions,nodes=me.childNodes,nLen=nodes.length,n;if(silent===true){me.clear(true);for(n=0;n<nLen;n++){nodes[n].destroy(true)}me.childNodes=null;delete me.destroyOptions;me.callParent([options])}else{me.destroyOptions=silent;me.remove(true)}},insertBefore:function(node,refNode,suppressEvents){var me=this,index=me.indexOf(refNode),oldParent=node.parentNode,refIndex=index,childCount,previousSibling,i;if(!refNode){return me.appendChild(node)}if(node===refNode){return false}node=me.createNode(node);if(suppressEvents!==true&&me.fireEventArgs("beforeinsert",[me,node,refNode])===false){return false}if(oldParent===me&&me.indexOf(node)<index){refIndex--}if(oldParent){if(suppressEvents!==true&&node.fireEventArgs("beforemove",[node,oldParent,me,index,refNode])===false){return false}oldParent.removeChild(node,false,false,true)}if(refIndex===0){me.setFirstChild(node)}Ext.Array.splice(me.childNodes,refIndex,0,node);node.parentNode=me;node.nextSibling=refNode;refNode.previousSibling=node;previousSibling=me.childNodes[refIndex-1];if(previousSibling){node.previousSibling=previousSibling;previousSibling.nextSibling=node}else{node.previousSibling=null}node.updateInfo(false,{parentId:me.getId(),index:refIndex,isFirst:refIndex===0,isLast:false,depth:(me.data.depth||0)+1});for(i=refIndex+1,childCount=me.childNodes.length;i<childCount;i++){me.childNodes[i].updateInfo(false,{index:i})}if(!me.isLoaded()){me.set("loaded",true)}else if(me.childNodes.length===1){me.triggerUIUpdate()}if(!node.isLeaf()&&node.phantom){node.set("loaded",true)}if(suppressEvents!==true){me.fireEventArgs("insert",[me,node,refNode]);if(oldParent){node.fireEventArgs("move",[node,oldParent,me,refIndex,refNode])}}return node},insertChild:function(index,node){var sibling=this.childNodes[index];if(sibling){return this.insertBefore(node,sibling)}else{return this.appendChild(node)}},remove:function(destroy,suppressEvents){var me=this,parentNode=me.parentNode;if(parentNode){parentNode.removeChild(me,destroy,suppressEvents)}else if(destroy){me.destroy(true)}return me},removeAll:function(destroy,suppressEvents,fromParent){var me=this,childNodes=me.childNodes,i=0,len=childNodes.length,node;if(!len){return}me.fireEventArgs("bulkremove",[me,childNodes,false]);for(;i<len;++i){node=childNodes[i];node.removeContext={parentNode:node.parentNode,previousSibling:node.previousSibling,nextSibling:node.nextSibling};node.previousSibling=node.nextSibling=node.parentNode=null;me.fireEventArgs("remove",[me,node,false]);node.removeContext=null;if(destroy){node.destroy(true)}else{node.removeAll(false,suppressEvents,true)}}me.firstChild=me.lastChild=null;if(fromParent){me.childNodes=null}else{me.childNodes.length=0;me.triggerUIUpdate()}return me},getChildAt:function(index){return this.childNodes[index]},replaceChild:function(newChild,oldChild,suppressEvents){var s=oldChild?oldChild.nextSibling:null;this.removeChild(oldChild,false,suppressEvents);this.insertBefore(newChild,s,suppressEvents);return oldChild},indexOf:function(child){return Ext.Array.indexOf(this.childNodes,child)},indexOfId:function(id){var childNodes=this.childNodes,len=childNodes.length,i=0;for(;i<len;++i){if(childNodes[i].getId()===id){return i}}return-1},getPath:function(field,separator){field=field||this.idProperty;separator=separator||"/";var path=[this.get(field)],parent=this.parentNode;while(parent){path.unshift(parent.get(field));parent=parent.parentNode}return separator+path.join(separator)},getDepth:function(){return this.get("depth")},bubble:function(fn,scope,args){var p=this;while(p){if(fn.apply(scope||p,args||[p])===false){break}p=p.parentNode}},cascade:function(){if(Ext.isDefined(Ext.global.console)){Ext.global.console.warn("Ext.data.Node: cascade has been deprecated. Please use cascadeBy instead.")}return this.cascadeBy.apply(this,arguments)},cascadeBy:function(fn,scope,args){if(fn.apply(scope||this,args||[this])!==false){var childNodes=this.childNodes,length=childNodes.length,i;for(i=0;i<length;i++){childNodes[i].cascadeBy(fn,scope,args)}}},eachChild:function(fn,scope,args){var childNodes=this.childNodes,length=childNodes.length,i;for(i=0;i<length;i++){if(fn.apply(scope||this,args||[childNodes[i]])===false){break}}},findChild:function(attribute,value,deep){return this.findChildBy(function(){return this.get(attribute)==value},null,deep)},findChildBy:function(fn,scope,deep){var cs=this.childNodes,len=cs.length,i=0,n,res;for(;i<len;i++){n=cs[i];if(fn.call(scope||n,n)===true){return n}else if(deep){res=n.findChildBy(fn,scope,deep);if(res!==null){return res}}}return null},contains:function(node){return node.isAncestor(this)},isAncestor:function(node){var p=this.parentNode;while(p){if(p===node){return true}p=p.parentNode}return false},sort:function(sortFn,recursive,suppressEvent){var cs=this.childNodes,ln=cs.length,i,n,info={isFirst:true};if(ln>0){Ext.Array.sort(cs,sortFn);this.setFirstChild(cs[0]);this.setLastChild(cs[ln-1]);for(i=0;i<ln;i++){n=cs[i];n.previousSibling=cs[i-1];n.nextSibling=cs[i+1];info.isLast=i===ln-1;info.index=i;n.updateInfo(false,info);info.isFirst=false;if(recursive&&!n.isLeaf()){n.sort(sortFn,true,true)}}if(suppressEvent!==true){this.fireEventArgs("sort",[this,cs])}}},isExpanded:function(){return this.get("expanded")},isLoaded:function(){return this.get("loaded")},isLoading:function(){return this.get("loading")},isRoot:function(){return!this.parentNode},isVisible:function(){var parent=this.parentNode;while(parent){if(!parent.isExpanded()){return false}parent=parent.parentNode}return true},expand:function(recursive,callback,scope){var me=this,owner;if(!me.isLeaf()){if(me.isLoading()){me.on("expand",function(){me.expand(recursive,callback,scope)},me,{single:true})}else{if(!me.isExpanded()){me.fireEventArgs("beforeexpand",[me,me.onChildNodesAvailable,me,[recursive,callback,scope]])}else if(recursive){owner=me.getOwnerTree();me.expandChildren(true,owner?owner.singleExpand:false,callback,scope)}else{Ext.callback(callback,scope||me,[me.childNodes])}}}else{Ext.callback(callback,scope||me)}},onChildNodesAvailable:function(records,recursive,callback,scope){var me=this,owner;Ext.suspendLayouts();me.set("expanded",true);me.fireEventArgs("expand",[me,me.childNodes,false]);if(recursive){owner=me.getOwnerTree();me.expandChildren(true,owner?owner.singleExpand:false,callback,scope)}else{Ext.callback(callback,scope||me,[me.childNodes])}Ext.resumeLayouts(true)},expandChildren:function(recursive,singleExpand,callback,scope){var me=this,i,allNodes=me.childNodes,expandNodes=[],ln=singleExpand?Math.min(allNodes.length,1):allNodes.length,node;for(i=0;i<ln;++i){node=allNodes[i];if(!node.isLeaf()){expandNodes[expandNodes.length]=node}}ln=expandNodes.length;for(i=0;i<ln;++i){expandNodes[i].expand(recursive)}if(callback){Ext.callback(callback,scope||me,[me.childNodes])}},collapse:function(recursive,callback,scope){var me=this,expanded=me.isExpanded(),len=me.childNodes.length,i,collapseChildren;if(!me.isLeaf()&&(!expanded&&recursive||me.fireEventArgs("beforecollapse",[me])!==false)){Ext.suspendLayouts();if(me.isExpanded()){if(recursive){collapseChildren=function(){for(i=0;i<len;i++){me.childNodes[i].setCollapsed(true)}};if(callback){callback=Ext.Function.createSequence(collapseChildren,callback)}else{callback=collapseChildren}}me.set("expanded",false);me.fireEventArgs("collapse",[me,me.childNodes,false,callback?Ext.Function.bind(callback,scope,[me.childNodes]):null,null]);callback=null}else if(recursive){for(i=0;i<len;i++){me.childNodes[i].setCollapsed(true)}}Ext.resumeLayouts(true)}Ext.callback(callback,scope||me,[me.childNodes])},setCollapsed:function(recursive){var me=this,len=me.childNodes.length,i;if(!me.isLeaf()&&me.fireEventArgs("beforecollapse",[me,Ext.emptyFn])!==false){me.data.expanded=false;me.fireEventArgs("collapse",[me,me.childNodes,false,null,null]);if(recursive){for(i=0;i<len;i++){me.childNodes[i].setCollapsed(true)}}}},collapseChildren:function(recursive,callback,scope){var me=this,i,allNodes=me.childNodes,ln=allNodes.length,collapseNodes=[],node;for(i=0;i<ln;++i){node=allNodes[i];if(!node.isLeaf()&&node.isLoaded()&&node.isExpanded()){collapseNodes.push(node)}}ln=collapseNodes.length;for(i=0;i<ln;++i){node=collapseNodes[i];if(i===ln-1){node.collapse(recursive,callback,scope)}else{node.collapse(recursive)}}},fireEventArgs:function(eventName,args){var fireEventArgs=Ext.data.Model.prototype.fireEventArgs,result,eventSource,tree,treeStore,rootNode;if(bubbledEvents[eventName]){for(eventSource=this;result!==false&&eventSource;eventSource=(rootNode=eventSource).parentNode){if(eventSource.hasListeners[eventName]){result=fireEventArgs.call(eventSource,eventName,args)}}tree=rootNode.rootOf;if(result!==false&&tree){treeStore=tree.treeStore;if(treeStore&&treeStore.hasListeners[eventName]){result=treeStore.fireEventArgs.call(treeStore,eventName,args)}if(result!==false&&tree.hasListeners[eventName]){result=tree.fireEventArgs.call(tree,eventName,args)}}return result}else{return fireEventArgs.apply(this,arguments)}},serialize:function(){var result=Ext.data.writer.Json.prototype.getRecordData(this),childNodes=this.childNodes,len=childNodes.length,children,i;if(len>0){children=[];for(i=0;i<len;i++){children.push(childNodes[i].serialize())}result.children=children}return result}}}}});