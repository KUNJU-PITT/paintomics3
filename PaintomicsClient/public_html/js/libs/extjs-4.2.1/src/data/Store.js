Ext.define("Ext.data.Store",{extend:"Ext.data.AbstractStore",alias:"store.store",requires:["Ext.data.StoreManager","Ext.data.Model","Ext.data.proxy.Ajax","Ext.data.proxy.Memory","Ext.data.reader.Json","Ext.data.writer.Json","Ext.data.PageMap","Ext.data.Group"],uses:["Ext.ModelManager","Ext.util.Grouper"],remoteSort:false,remoteFilter:false,remoteGroup:false,groupField:undefined,groupDir:"ASC",trailingBufferZone:25,leadingBufferZone:200,pageSize:undefined,currentPage:1,clearOnPageLoad:true,loading:false,sortOnFilter:true,buffered:false,purgePageCount:5,clearRemovedOnLoad:true,defaultPageSize:25,defaultViewSize:100,addRecordsOptions:{addRecords:true},statics:{recordIdFn:function(record){return record.internalId},recordIndexFn:function(record){return record.index},grouperIdFn:function(grouper){return grouper.id||grouper.property},groupIdFn:function(group){return group.key}},constructor:function(config){config=Ext.apply({},config);var me=this,groupers=config.groupers||me.groupers,groupField=config.groupField||me.groupField,proxy,data;data=config.data||me.data;if(data){me.inlineData=data;delete config.data}if(!groupers&&groupField){groupers=[{property:groupField,direction:config.groupDir||me.groupDir}];if(config.getGroupString||me.getGroupString!==Ext.data.Store.prototype.getGroupString){groupers[0].getGroupString=function(record){return me.getGroupString(record)}}}delete config.groupers;me.groupers=new Ext.util.MixedCollection(false,Ext.data.Store.grouperIdFn);me.groupers.addAll(me.decodeGroupers(groupers));me.groups=new Ext.util.MixedCollection(false,Ext.data.Store.groupIdFn);me.callParent([config]);if(me.buffered){me.data=new Ext.data.PageMap({store:me,keyFn:Ext.data.Store.recordIdFn,pageSize:me.pageSize,maxSize:me.purgePageCount,listeners:{clear:me.onPageMapClear,scope:me}});me.pageRequests={};me.remoteSort=me.remoteGroup=me.remoteFilter=true;me.sortOnLoad=false;me.filterOnLoad=false}else{me.data=new Ext.util.MixedCollection({getKey:Ext.data.Store.recordIdFn,maintainIndices:true});me.data.pageSize=me.pageSize}if(me.remoteGroup){me.remoteSort=true}me.sorters.insert(0,me.groupers.getRange());proxy=me.proxy;data=me.inlineData;if(!me.buffered&&!me.pageSize){me.pageSize=me.defaultPageSize}if(data){if(proxy instanceof Ext.data.proxy.Memory){proxy.data=data;me.read()}else{me.add.apply(me,[data])}if(me.sorters.items.length&&!me.remoteSort){me.group(null,null,true)}delete me.inlineData}else if(me.autoLoad){Ext.defer(me.load,1,me,[typeof me.autoLoad==="object"?me.autoLoad:undefined])}},onBeforeSort:function(){var groupers=this.groupers;if(groupers.getCount()>0){this.sort(groupers.items,"prepend",false)}},decodeGroupers:function(groupers){if(!Ext.isArray(groupers)){if(groupers===undefined){groupers=[]}else{groupers=[groupers]}}var length=groupers.length,Grouper=Ext.util.Grouper,config,i,result=[];for(i=0;i<length;i++){config=groupers[i];if(!(config instanceof Grouper)){if(Ext.isString(config)){config={property:config}}config=Ext.apply({root:"data",direction:"ASC"},config);if(config.fn){config.sorterFn=config.fn}if(typeof config=="function"){config={sorterFn:config}}result.push(new Grouper(config))}else{result.push(config)}}return result},group:function(groupers,direction,suppressEvent){var me=this,grouper,newGroupers;if(groupers){me.sorters.removeAll(me.groupers.items);if(Ext.isArray(groupers)){newGroupers=groupers}else if(Ext.isObject(groupers)){newGroupers=[groupers]}else if(Ext.isString(groupers)){grouper=me.groupers.get(groupers);if(!grouper){grouper={property:groupers,direction:direction||"ASC"};newGroupers=[grouper]}else if(direction===undefined){grouper.toggle()}else{grouper.setDirection(direction)}}if(newGroupers&&newGroupers.length){me.groupers.clear();me.groupers.addAll(me.decodeGroupers(newGroupers))}me.sorters.insert(0,me.groupers.items)}if(me.remoteGroup){if(me.buffered){me.data.clear();me.loadPage(1,{groupChange:true})}else{me.load({scope:me,callback:suppressEvent?null:me.fireGroupChange})}}else{me.doSort(me.generateComparator());me.constructGroups();if(!suppressEvent){me.fireGroupChange()}}},getGroupField:function(){var first=this.groupers.first(),group;if(first){group=first.property}return group},constructGroups:function(){var me=this,data=this.data.items,len=data.length,groups=me.groups,groupValue,i,group,rec;groups.clear();if(me.isGrouped()){for(i=0;i<len;++i){rec=data[i];groupValue=me.getGroupString(rec);group=groups.get(groupValue);if(!group){group=new Ext.data.Group({key:groupValue,store:me});groups.add(groupValue,group)}group.add(rec)}}},clearGrouping:function(){var me=this,groupers=me.groupers.items,gLen=groupers.length,g;for(g=0;g<gLen;g++){me.sorters.remove(groupers[g])}me.groupers.clear();if(me.remoteGroup){if(me.buffered){me.data.clear();me.loadPage(1,{groupChange:true})}else{me.load({scope:me,callback:me.fireGroupChange})}}else{me.groups.clear();if(me.sorters.length){me.sort()}else{me.fireEvent("datachanged",me);me.fireEvent("refresh",me)}me.fireGroupChange()}},isGrouped:function(){return this.groupers.getCount()>0},fireGroupChange:function(){this.fireEvent("groupchange",this,this.groupers)},getGroups:function(requestGroupString){var records=this.data.items,length=records.length,groups=[],pointers={},record,groupStr,group,i;for(i=0;i<length;i++){record=records[i];groupStr=this.getGroupString(record);group=pointers[groupStr];if(group===undefined){group={name:groupStr,children:[]};groups.push(group);pointers[groupStr]=group}group.children.push(record)}return requestGroupString?pointers[requestGroupString]:groups},getGroupsForGrouper:function(records,grouper){var length=records.length,groups=[],oldValue,newValue,record,group,i;for(i=0;i<length;i++){record=records[i];newValue=grouper.getGroupString(record);if(newValue!==oldValue){group={name:newValue,grouper:grouper,records:[]};groups.push(group)}group.records.push(record);oldValue=newValue}return groups},getGroupsForGrouperIndex:function(records,grouperIndex){var me=this,groupers=me.groupers,grouper=groupers.getAt(grouperIndex),groups=me.getGroupsForGrouper(records,grouper),length=groups.length,i;if(grouperIndex+1<groupers.length){for(i=0;i<length;i++){groups[i].children=me.getGroupsForGrouperIndex(groups[i].records,grouperIndex+1)}}for(i=0;i<length;i++){groups[i].depth=grouperIndex}return groups},getGroupData:function(sort){var me=this;if(sort!==false){me.sort()}return me.getGroupsForGrouperIndex(me.data.items,0)},getGroupString:function(instance){var group=this.groupers.first();if(group){return group.getGroupString(instance)}return""},insert:function(index,records){var me=this,sync=false,i,len,record,defaults=me.modelDefaults,out;if(!Ext.isIterable(records)){out=records=[records]}else{out=[]}len=records.length;if(len){for(i=0;i<len;i++){record=records[i];if(!record.isModel){record=me.createModel(record)}out[i]=record;if(defaults){record.set(defaults)}record.join(me);sync=sync||record.phantom===true}me.data.insert(index,out);if(me.snapshot){me.snapshot.addAll(out)}if(me.requireSort){me.suspendEvents();me.sort();me.resumeEvents()}if(me.isGrouped()){me.updateGroupsOnAdd(out)}me.fireEvent("add",me,out,index);me.fireEvent("datachanged",me);if(me.autoSync&&sync&&!me.autoSyncSuspended){me.sync()}}return out},updateGroupsOnAdd:function(records){var me=this,groups=me.groups,len=records.length,i,groupName,group,rec;for(i=0;i<len;++i){rec=records[i];groupName=me.getGroupString(rec);group=groups.getByKey(groupName);if(!group){group=groups.add(new Ext.data.Group({key:groupName,store:me}))}group.add(rec)}},updateGroupsOnRemove:function(records){var me=this,groups=me.groups,len=records.length,i,groupName,group,rec;for(i=0;i<len;++i){rec=records[i];groupName=me.getGroupString(rec);group=groups.getByKey(groupName);if(group){group.remove(rec);if(group.records.length===0){groups.remove(group)}}}},updateGroupsOnUpdate:function(record,modifiedFieldNames){var me=this,groupField=me.getGroupField(),groupName=me.getGroupString(record),groups=me.groups,len,i,items,group;if(modifiedFieldNames&&Ext.Array.indexOf(modifiedFieldNames,groupField)!==-1){if(me.buffered){Ext.Error.raise({msg:"Cannot move records between groups in a buffered store record"})}items=groups.items;for(i=0,len=items.length;i<len;++i){group=items[i];if(group.contains(record)){group.remove(record);break}}group=groups.getByKey(groupName);if(!group){group=groups.add(new Ext.data.Group({key:groupName,store:me}))}group.add(record);me.data.remove(record);me.data.insert(me.data.findInsertionIndex(record,me.generateComparator()),record);for(i=0,len=this.getCount();i<len;i++){me.data.items[i].index=i}}else{groups.getByKey(groupName).setDirty()}},add:function(arg){var me=this,records,length,isSorted;if(me.buffered){Ext.Error.raise({msg:"add method may not be called on a buffered store"})}if(Ext.isArray(arg)){records=arg}else{records=arguments}length=records.length;isSorted=!me.remoteSort&&me.sorters&&me.sorters.items.length;if(isSorted&&length===1){return[me.addSorted(me.createModel(records[0]))]}if(isSorted){me.requireSort=true}records=me.insert(me.data.length,records);delete me.requireSort;return records},addSorted:function(record){var me=this,index=me.data.findInsertionIndex(record,me.generateComparator());me.insert(index,record);return record},createModel:function(record){if(!record.isModel){record=Ext.ModelManager.create(record,this.model)}return record},onUpdate:function(record,type,modifiedFieldNames){if(this.isGrouped()){this.updateGroupsOnUpdate(record,modifiedFieldNames)}},each:function(fn,scope){var data=this.data.items,dLen=data.length,record,d;for(d=0;d<dLen;d++){record=data[d];if(fn.call(scope||record,record,d,dLen)===false){break}}},remove:function(records,isMove,silent){isMove=isMove===true;var me=this,sync=false,snapshot=me.snapshot,data=me.data,i=0,length,info=[],allRecords=[],indexes=[],item,isNotPhantom,index,record,removeRange,removeCount,fireRemoveEvent=!silent&&me.hasListeners.remove;if(records.isModel){records=[records];length=1}else if(Ext.isIterable(records)){length=records.length}else if(typeof records==="object"){removeRange=true;i=records.start;length=records.end+1;removeCount=length-i}if(!removeRange){for(i=0;i<length;++i){record=records[i];if(typeof record=="number"){index=record;record=data.getAt(index)}else{index=me.indexOf(record)}if(record&&index>-1){info.push({record:record,index:index})}if(snapshot){snapshot.remove(record)}}info=Ext.Array.sort(info,function(o1,o2){var index1=o1.index,index2=o2.index;return index1===o2.index2?0:index1<index2?-1:1});i=0;length=info.length}for(;i<length;i++){if(removeRange){record=data.getAt(i);index=i}else{item=info[i];record=item.record;index=item.index}allRecords.push(record);indexes.push(index);isNotPhantom=record.phantom!==true;if(!isMove&&isNotPhantom){record.removedFrom=index;me.removed.push(record)}record.unjoin(me);index-=i;sync=sync||isNotPhantom;if(!removeRange){data.removeAt(index);if(fireRemoveEvent){me.fireEvent("remove",me,record,index,!!isMove)}}}if(removeRange){data.removeRange(records.start,removeCount)}if(!silent){me.fireEvent("bulkremove",me,allRecords,indexes,!!isMove);me.fireEvent("datachanged",me)}if(!isMove&&me.autoSync&&sync&&!me.autoSyncSuspended){me.sync()}},removeAt:function(index,count){var me=this,storeCount=me.getCount();if(index<=storeCount){if(arguments.length===1){me.remove([index])}else if(count){me.remove({start:index,end:Math.min(index+count,storeCount)-1})}}},removeAll:function(silent){var me=this,snapshot=me.snapshot,data=me.data;if(snapshot){snapshot.removeAll(data.getRange())}if(me.buffered){if(data){if(silent){me.suspendEvent("clear")}data.clear();if(silent){me.resumeEvent("clear")}}}else{me.remove({start:0,end:me.getCount()-1},false,silent);if(silent!==true){me.fireEvent("clear",me)}}},load:function(options){var me=this;options=options||{};if(typeof options=="function"){options={callback:options}}options.groupers=options.groupers||me.groupers.items;options.page=options.page||me.currentPage;options.start=options.start!==undefined?options.start:(options.page-1)*me.pageSize;options.limit=options.limit||me.pageSize;options.addRecords=options.addRecords||false;if(me.buffered){options.limit=me.viewSize||me.defaultViewSize;return me.loadToPrefetch(options)}return me.callParent([options])},reload:function(options){var me=this,startIdx,endIdx,startPage,endPage,i,waitForReload,bufferZone,records,count=me.getCount();if(!options){options={}}if(me.buffered){delete me.totalCount;waitForReload=function(){if(me.rangeCached(startIdx,endIdx)){me.loading=false;me.data.un("pageAdded",waitForReload);records=me.data.getRange(startIdx,endIdx);me.fireEvent("load",me,records,true)}};bufferZone=Math.ceil((me.leadingBufferZone+me.trailingBufferZone)/2);startIdx=options.start||(count?me.getAt(0).index:0);endIdx=startIdx+(options.count||(count?count:me.pageSize))-1;startPage=me.getPageFromRecordIndex(Math.max(startIdx-bufferZone,0));endPage=me.getPageFromRecordIndex(endIdx+bufferZone);me.data.clear(true);if(me.fireEvent("beforeload",me,options)!==false){me.loading=true;me.data.on("pageAdded",waitForReload);for(i=startPage;i<=endPage;i++){me.prefetchPage(i,options)}}}else{return me.callParent(arguments)}},onProxyLoad:function(operation){var me=this,resultSet=operation.getResultSet(),records=operation.getRecords(),successful=operation.wasSuccessful();if(me.isDestroyed){return}if(resultSet){me.totalCount=resultSet.total}me.loading=false;if(successful){me.loadRecords(records,operation)}if(me.hasListeners.load){me.fireEvent("load",me,records,successful)}if(me.hasListeners.read){me.fireEvent("read",me,records,successful)}Ext.callback(operation.callback,operation.scope||me,[records,operation,successful])},getNewRecords:function(){return this.data.filterBy(this.filterNew).items},getUpdatedRecords:function(){return this.data.filterBy(this.filterUpdated).items},filter:function(filters,value){if(Ext.isString(filters)){filters={property:filters,value:value}}var me=this,decoded=me.decodeFilters(filters),i,doLocalSort=me.sorters.length&&me.sortOnFilter&&!me.remoteSort,length=decoded.length;for(i=0;i<length;i++){me.filters.replace(decoded[i])}filters=me.filters.items;if(filters.length){if(me.remoteFilter){delete me.totalCount;if(me.buffered){me.data.clear();me.loadPage(1)}else{me.currentPage=1;me.load()}}else{me.snapshot=me.snapshot||me.data.clone();me.data=me.snapshot.filter(filters);me.constructGroups();if(doLocalSort){me.sort()}else{me.fireEvent("datachanged",me);me.fireEvent("refresh",me)}}me.fireEvent("filterchange",me,filters)}},clearFilter:function(suppressEvent){var me=this;me.filters.clear();if(me.remoteFilter){if(suppressEvent){return}delete me.totalCount;if(me.buffered){me.data.clear();me.loadPage(1)}else{me.currentPage=1;me.load()}}else if(me.isFiltered()){me.data=me.snapshot;delete me.snapshot;me.constructGroups();if(suppressEvent!==true){me.fireEvent("datachanged",me);me.fireEvent("refresh",me)}}me.fireEvent("filterchange",me,me.filters.items)},removeFilter:function(toRemove,applyFilters){var me=this;if(!me.remoteFilter&&me.isFiltered()){if(toRemove instanceof Ext.util.Filter){me.filters.remove(toRemove)}else{me.filters.removeAtKey(toRemove)}if(applyFilters!==false){if(me.filters.length){me.filter()}else{me.clearFilter()}}else{me.fireEvent("filterchange",me,me.filters.items)}}},addFilter:function(filters,applyFilters){var me=this,decoded,i,length;decoded=me.decodeFilters(filters);length=decoded.length;for(i=0;i<length;i++){me.filters.replace(decoded[i])}if(applyFilters!==false&&me.filters.length){me.filter()}else{me.fireEvent("filterchange",me,me.filters.items)}},isFiltered:function(){var snapshot=this.snapshot;return!!(snapshot&&snapshot!==this.data)},filterBy:function(fn,scope){var me=this;me.snapshot=me.snapshot||me.data.clone();me.data=me.queryBy(fn,scope||me);me.fireEvent("datachanged",me);me.fireEvent("refresh",me)},queryBy:function(fn,scope){var me=this;return(me.snapshot||me.data).filterBy(fn,scope||me)},query:function(property,value,anyMatch,caseSensitive,exactMatch){var me=this,queryFn=me.createFilterFn(property,value,anyMatch,caseSensitive,exactMatch),results=me.queryBy(queryFn);if(!results){results=new Ext.util.MixedCollection}return results},loadData:function(data,append){var length=data.length,newData=[],i;for(i=0;i<length;i++){newData.push(this.createModel(data[i]))}this.loadRecords(newData,append?this.addRecordsOptions:undefined)},loadRawData:function(data,append){var me=this,result=me.proxy.reader.read(data),records=result.records;if(result.success){me.totalCount=result.total;me.loadRecords(records,append?me.addRecordsOptions:undefined)}},loadRecords:function(records,options){var me=this,i=0,length=records.length,start,addRecords,snapshot=me.snapshot;if(options){start=options.start;addRecords=options.addRecords}if(!addRecords){delete me.snapshot;me.clearData(true)}else if(snapshot){snapshot.addAll(records)}me.data.addAll(records);if(start!==undefined){for(;i<length;i++){records[i].index=start+i;records[i].join(me)}}else{for(;i<length;i++){records[i].join(me)}}me.suspendEvents();if(me.filterOnLoad&&!me.remoteFilter){me.filter()}if(me.sortOnLoad&&!me.remoteSort){me.sort(undefined,undefined,undefined,true)}me.resumeEvents();if(me.isGrouped()){me.constructGroups()}me.fireEvent("datachanged",me);me.fireEvent("refresh",me)},loadPage:function(page,options){var me=this;me.currentPage=page;options=Ext.apply({page:page,start:(page-1)*me.pageSize,limit:me.pageSize,addRecords:!me.clearOnPageLoad},options);if(me.buffered){options.limit=me.viewSize||me.defaultViewSize;return me.loadToPrefetch(options)}me.read(options)},nextPage:function(options){this.loadPage(this.currentPage+1,options)},previousPage:function(options){this.loadPage(this.currentPage-1,options)},clearData:function(isLoad){var me=this,records,i;if(!me.buffered&&me.data){records=me.data.items;i=records.length;while(i--){records[i].unjoin(me)}}if(me.data){me.data.clear()}if(isLoad!==true||me.clearRemovedOnLoad){me.removed.length=0}},loadToPrefetch:function(options){var me=this,i,records,dataSetSize,prefetchOptions=options,startIdx=options.start,endIdx=options.start+options.limit-1,loadEndIdx=Math.min(endIdx,options.start+(me.viewSize||options.limit)-1),startPage=me.getPageFromRecordIndex(Math.max(startIdx-me.trailingBufferZone,0)),endPage=me.getPageFromRecordIndex(endIdx+me.leadingBufferZone),waitForRequestedRange=function(){if(me.rangeCached(startIdx,loadEndIdx)){me.loading=false;records=me.data.getRange(startIdx,loadEndIdx);me.data.un("pageAdded",waitForRequestedRange);if(me.hasListeners.guaranteedrange){me.guaranteeRange(startIdx,loadEndIdx,options.callback,options.scope)}if(options.callback){options.callback.call(options.scope||me,records,startIdx,endIdx,options)}me.fireEvent("datachanged",me);me.fireEvent("refresh",me);me.fireEvent("load",me,records,true);if(options.groupChange){me.fireGroupChange()}}};if(me.fireEvent("beforeload",me,options)!==false){delete me.totalCount;me.loading=true;if(options.callback){prefetchOptions=Ext.apply({},options);delete prefetchOptions.callback}me.on("prefetch",function(store,records,successful,operation){if(successful){if(dataSetSize=me.getTotalCount()){me.data.on("pageAdded",waitForRequestedRange);loadEndIdx=Math.min(loadEndIdx,dataSetSize-1);endPage=me.getPageFromRecordIndex(Math.min(loadEndIdx+me.leadingBufferZone,dataSetSize-1));for(i=startPage+1;i<=endPage;++i){me.prefetchPage(i,prefetchOptions)}}else{me.fireEvent("datachanged",me);me.fireEvent("refresh",me);me.fireEvent("load",me,records,true)}}else{me.fireEvent("load",me,records,false)}},null,{single:true});me.prefetchPage(startPage,prefetchOptions)}},prefetch:function(options){var me=this,pageSize=me.pageSize,proxy,operation;if(pageSize){if(me.lastPageSize&&pageSize!=me.lastPageSize){Ext.Error.raise("pageSize cannot be dynamically altered")}if(!me.data.pageSize){me.data.pageSize=pageSize}}else{me.pageSize=me.data.pageSize=pageSize=options.limit}me.lastPageSize=pageSize;if(!options.page){options.page=me.getPageFromRecordIndex(options.start);options.start=(options.page-1)*pageSize;options.limit=Math.ceil(options.limit/pageSize)*pageSize}if(!me.pageRequests[options.page]){options=Ext.apply({action:"read",filters:me.filters.items,sorters:me.sorters.items,groupers:me.groupers.items,pageMapGeneration:me.data.pageMapGeneration},options);operation=new Ext.data.Operation(options);if(me.fireEvent("beforeprefetch",me,operation)!==false){proxy=me.proxy;me.pageRequests[options.page]=proxy.read(operation,me.onProxyPrefetch,me);if(proxy.isSynchronous){delete me.pageRequests[options.page]}}}return me},onPageMapClear:function(){var me=this,loadingFlag=me.wasLoading,reqs=me.pageRequests,req,page;if(me.data.events.pageadded){me.data.events.pageadded.clearListeners()}me.loading=true;me.totalCount=0;for(page in reqs){if(reqs.hasOwnProperty(page)){req=reqs[page];delete reqs[page];delete req.callback}}me.fireEvent("clear",me);me.loading=loadingFlag},prefetchPage:function(page,options){var me=this,pageSize=me.pageSize||me.defaultPageSize,start=(page-1)*me.pageSize,total=me.totalCount;if(total!==undefined&&me.getCount()===total){return}me.prefetch(Ext.applyIf({page:page,start:start,limit:pageSize},options))},onProxyPrefetch:function(operation){var me=this,resultSet=operation.getResultSet(),records=operation.getRecords(),successful=operation.wasSuccessful(),page=operation.page;if(operation.pageMapGeneration===me.data.pageMapGeneration){if(resultSet){me.totalCount=resultSet.total;me.fireEvent("totalcountchange",me.totalCount)}if(page!==undefined){delete me.pageRequests[page]}me.loading=false;me.fireEvent("prefetch",me,records,successful,operation);if(successful){me.cachePage(records,operation.page)}Ext.callback(operation.callback,operation.scope||me,[records,operation,successful])}},cachePage:function(records,page){var me=this,len=records.length,i;if(!Ext.isDefined(me.totalCount)){me.totalCount=records.length;me.fireEvent("totalcountchange",me.totalCount)}for(i=0;i<len;i++){records[i].join(me)}me.data.addPage(page,records)},rangeCached:function(start,end){return this.data&&this.data.hasRange(start,end)},pageCached:function(page){return this.data&&this.data.hasPage(page)},pagePending:function(page){return!!this.pageRequests[page]},rangeSatisfied:function(start,end){return this.rangeCached(start,end)},getPageFromRecordIndex:function(index){return Math.floor(index/this.pageSize)+1},onGuaranteedRange:function(options){var me=this,totalCount=me.getTotalCount(),start=options.prefetchStart,end=options.prefetchEnd>totalCount-1?totalCount-1:options.prefetchEnd,range;end=Math.max(0,end);if(start>end){Ext.log({level:"warn",msg:"Start ("+start+") was greater than end ("+end+") for the range of records requested ("+start+"-"+options.prefetchEnd+")"+(this.storeId?' from store "'+this.storeId+'"':"")})}range=me.data.getRange(start,end);if(options.fireEvent!==false){me.fireEvent("guaranteedrange",range,start,end,options)}if(options.callback){options.callback.call(options.scope||me,range,start,end,options)}},guaranteeRange:function(start,end,callback,scope,options){options=Ext.apply({callback:callback,scope:scope},options);this.getRange(start,end,options)},prefetchRange:function(start,end){var me=this,startPage,endPage,page;if(!me.rangeCached(start,end)){startPage=me.getPageFromRecordIndex(start);endPage=me.getPageFromRecordIndex(end);me.data.maxSize=me.purgePageCount?endPage-startPage+1+me.purgePageCount:0;for(page=startPage;page<=endPage;page++){if(!me.pageCached(page)){me.prefetchPage(page)}}}},primeCache:function(start,end,direction){var me=this;if(direction===-1){start=Math.max(start-me.leadingBufferZone,0);end=Math.min(end+me.trailingBufferZone,me.totalCount-1)}else if(direction===1){start=Math.max(Math.min(start-me.trailingBufferZone,me.totalCount-me.pageSize),0);end=Math.min(end+me.leadingBufferZone,me.totalCount-1)}else{start=Math.min(Math.max(Math.floor(start-(me.leadingBufferZone+me.trailingBufferZone)/2),0),me.totalCount-me.pageSize);end=Math.min(Math.max(Math.ceil(end+(me.leadingBufferZone+me.trailingBufferZone)/2),0),me.totalCount-1)}me.prefetchRange(start,end)},sort:function(){var me=this;if(me.buffered&&me.remoteSort){me.data.clear()}return me.callParent(arguments)},doSort:function(sorterFn){var me=this,range,ln,i;if(me.remoteSort){if(me.buffered){me.data.clear();me.loadPage(1)}else{me.load()}}else{if(me.buffered){Ext.Error.raise({msg:"Local sorting may not be used on a buffered store"})}me.data.sortBy(sorterFn);if(!me.buffered){range=me.getRange();ln=range.length;for(i=0;i<ln;i++){range[i].index=i}}me.fireEvent("datachanged",me);me.fireEvent("refresh",me)}},find:function(property,value,start,anyMatch,caseSensitive,exactMatch){var fn=this.createFilterFn(property,value,anyMatch,caseSensitive,exactMatch);return fn?this.data.findIndexBy(fn,null,start):-1},findRecord:function(){var me=this,index=me.find.apply(me,arguments);return index!==-1?me.getAt(index):null},createFilterFn:function(property,value,anyMatch,caseSensitive,exactMatch){if(Ext.isEmpty(value)){return false}value=this.data.createValueMatcher(value,anyMatch,caseSensitive,exactMatch);return function(r){return value.test(r.data[property])}},findExact:function(property,value,start){return this.data.findIndexBy(function(rec){return rec.isEqual(rec.get(property),value)},this,start)},findBy:function(fn,scope,start){return this.data.findIndexBy(fn,scope,start)},collect:function(dataIndex,allowNull,bypassFilter){var me=this,data=bypassFilter===true&&me.snapshot?me.snapshot:me.data;return data.collect(dataIndex,"data",allowNull)},getCount:function(){return this.data.getCount()},getTotalCount:function(){return this.totalCount||0},getAt:function(index){return this.data.getAt(index)},getRange:function(start,end,options){if(options&&options.cb){options.callback=options.cb;Ext.Error.raise({msg:"guaranteeRange options.cb is deprecated, use options.callback"})}var me=this,requiredStart,requiredEnd,maxIndex=me.totalCount-1,lastRequestStart=me.lastRequestStart,pageAddHandler,result;options=Ext.apply({prefetchStart:start,prefetchEnd:end},options);if(me.buffered){end=end>=me.totalCount?maxIndex:end;requiredStart=start===0?0:start-1;requiredEnd=end===maxIndex?end:end+1;me.lastRequestStart=start;if(me.rangeCached(requiredStart,requiredEnd)){me.onGuaranteedRange(options);result=me.data.getRange(start,end)}else{me.fireEvent("cachemiss",me,start,end);pageAddHandler=function(page,records){if(me.rangeCached(requiredStart,requiredEnd)){me.fireEvent("cachefilled",me,start,end);me.data.un("pageAdded",pageAddHandler);me.onGuaranteedRange(options)}};me.data.on("pageAdded",pageAddHandler);me.prefetchRange(start,end)}me.primeCache(start,end,start<lastRequestStart?-1:1)}else{result=me.data.getRange(start,end);if(options.callback){options.callback.call(options.scope||me,result,start,end,options)}}return result},getById:function(id){var result=(this.snapshot||this.data).findBy(function(record){return record.getId()===id});if(this.buffered&&!result){Ext.Error.raise("getById called for ID that is not present in local cache")}return result},indexOf:function(record){return this.data.indexOf(record)},indexOfTotal:function(record){var index=record.index;if(index||index===0){return index}return this.indexOf(record)},indexOfId:function(id){return this.indexOf(this.getById(id))},first:function(grouped){var me=this;if(grouped&&me.isGrouped()){return me.aggregate(function(records){return records.length?records[0]:undefined},me,true)}else{return me.data.first()}},last:function(grouped){var me=this;if(grouped&&me.isGrouped()){return me.aggregate(function(records){var len=records.length;return len?records[len-1]:undefined},me,true)}else{return me.data.last()}},sum:function(field,grouped){var me=this;if(grouped&&me.isGrouped()){return me.aggregate(me.getSum,me,true,[field])}else{return me.getSum(me.data.items,field)}},getSum:function(records,field){var total=0,i=0,len=records.length;for(;i<len;++i){total+=records[i].get(field)}return total},count:function(grouped){var me=this;if(grouped&&me.isGrouped()){return me.aggregate(function(records){return records.length},me,true)}else{return me.getCount()}},min:function(field,grouped){var me=this;if(grouped&&me.isGrouped()){return me.aggregate(me.getMin,me,true,[field])}else{return me.getMin(me.data.items,field)}},getMin:function(records,field){var i=1,len=records.length,value,min;if(len>0){min=records[0].get(field)}for(;i<len;++i){value=records[i].get(field);if(value<min){min=value}}return min},max:function(field,grouped){var me=this;if(grouped&&me.isGrouped()){return me.aggregate(me.getMax,me,true,[field])}else{return me.getMax(me.data.items,field)}},getMax:function(records,field){var i=1,len=records.length,value,max;if(len>0){max=records[0].get(field)}for(;i<len;++i){value=records[i].get(field);if(value>max){max=value}}return max},average:function(field,grouped){var me=this;if(grouped&&me.isGrouped()){return me.aggregate(me.getAverage,me,true,[field])}else{return me.getAverage(me.data.items,field)}},getAverage:function(records,field){var i=0,len=records.length,sum=0;if(records.length>0){for(;i<len;++i){sum+=records[i].get(field)}return sum/len}return 0},aggregate:function(fn,scope,grouped,args){args=args||[];if(grouped&&this.isGrouped()){var groups=this.getGroups(),len=groups.length,out={},group,i;for(i=0;i<len;++i){group=groups[i];out[group.name]=this.getAggregate(fn,scope||this,group.children,args)}return out}else{return this.getAggregate(fn,scope,this.data.items,args)}},getAggregate:function(fn,scope,records,args){args=args||[];return fn.apply(scope||this,[records].concat(args))},onIdChanged:function(rec,oldId,newId,oldInternalId){var snapshot=this.snapshot;if(snapshot){snapshot.updateKey(oldInternalId,newId)}this.data.updateKey(oldInternalId,newId);this.callParent(arguments)},commitChanges:function(){var me=this,recs=me.getModifiedRecords(),len=recs.length,i=0;for(;i<len;i++){recs[i].commit()}me.removed.length=0},filterNewOnly:function(item){return item.phantom===true},getRejectRecords:function(){return Ext.Array.push(this.data.filterBy(this.filterNewOnly).items,this.getUpdatedRecords())},rejectChanges:function(){var me=this,recs=me.getRejectRecords(),len=recs.length,i=0,rec;for(;i<len;i++){rec=recs[i];rec.reject();if(rec.phantom){me.remove(rec)}}recs=me.removed;len=recs.length;for(i=0;i<len;i++){rec=recs[i];me.insert(rec.removedFrom||0,rec);rec.reject()}me.removed.length=0}},function(){Ext.regStore("ext-empty-store",{fields:[],proxy:"memory"})});