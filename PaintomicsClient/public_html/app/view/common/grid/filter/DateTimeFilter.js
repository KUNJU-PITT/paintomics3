Ext.define("Ext.ux.grid.filter.DateTimeFilter",{extend:"Ext.ux.grid.filter.DateFilter",alias:"gridfilter.datetime",dateDefaults:{xtype:"datepicker",format:"m/d/Y"},timeDefaults:{xtype:"timepicker",width:100,height:200,format:"g:i A"},dockDefaults:{dock:"top",buttonText:"Filter"},selectDateToFilter:true,positionDatepickerFirst:true,reTime:/\s(am|pm)/i,addTimeSelection:function(date,timepicker){var me=this,selection=timepicker.getSelectionModel().getSelection(),time,len,fn,val,i=0,arr=[],timeFns=["setHours","setMinutes","setSeconds","setMilliseconds"];if(selection.length){time=selection[0].get("disp");arr=time.replace(me.reTime,"").split(":");for(len=arr.length;i<len;i++){fn=timeFns[i];val=arr[i];if(val){date[fn](parseInt(val,10))}}}return date},init:function(config){var me=this,dateCfg=Ext.applyIf(me.date||{},me.dateDefaults),timeCfg=Ext.applyIf(me.time||{},me.timeDefaults),dockCfg=me.dock,defaultListeners={click:{scope:me,click:me.onMenuSelect},select:{scope:me,select:me.onMenuSelect}},pickerCtnCfg,i,len,item,cfg,items=[dateCfg,timeCfg],datepickerPosition=0;if(!me.positionDatepickerFirst){items=items.reverse();datepickerPosition=1}pickerCtnCfg=Ext.apply(me.pickerOpts,{xtype:!dockCfg?"container":"panel",layout:"hbox",items:items});if(!dockCfg){if(me.selectDateToFilter){dateCfg.listeners=defaultListeners.select}else{timeCfg.listeners=defaultListeners.select}}else if(dockCfg){me.selectDateToFilter=null;if(dockCfg.dockedItems){pickerCtnCfg.dockedItems=dockCfg.dockedItems;pickerCtnCfg.dockedItems.items[dockCfg.bindToItem||0].listeners=defaultListeners.click}else{if(Ext.isBoolean(dockCfg)){dockCfg={}}dockCfg=Ext.applyIf(dockCfg,me.dockDefaults);pickerCtnCfg.dockedItems={xtype:"toolbar",dock:dockCfg.dock,items:[{xtype:"button",text:dockCfg.buttonText,flex:1,listeners:defaultListeners.click}]}}}me.fields={};for(i=0,len=me.menuItems.length;i<len;i++){item=me.menuItems[i];if(item!=="-"){pickerCtnCfg.items[datepickerPosition].itemId=item;cfg={itemId:item,text:me[item+"Text"],menu:Ext.create("Ext.menu.Menu",{items:pickerCtnCfg}),listeners:{scope:me,checkchange:me.onCheckChange}};item=me.fields[item]=Ext.create("Ext.menu.CheckItem",cfg)}me.menu.add(item)}me.values={}},onCheckChange:function(item,checked){var me=this,menu=item.menu,timepicker=menu.down("timepicker"),datepicker=menu.down("datepicker"),itemId=datepicker.itemId,values=me.values;if(checked){values[itemId]=me.addTimeSelection(datepicker.value,timepicker)}else{delete values[itemId]}me.setActive(me.isActivatable());me.fireEvent("update",me)},onMenuSelect:function(picker,date){var me=this,menu=me.menu,fields=me.fields,field;if(me.dock){picker=menu.getFocusEl().down("datepicker")}field=me.fields[picker.itemId];field.setChecked(true);if(field==fields.on){fields.before.setChecked(false,true);fields.after.setChecked(false,true)}else{fields.on.setChecked(false,true);if(field==fields.after&&me.getFieldValue("before")<date){fields.before.setChecked(false,true)}else if(field==fields.before&&me.getFieldValue("after")>date){fields.after.setChecked(false,true)}}me.fireEvent("update",me);picker.ownerCt.ownerCt.hide()},getSerialArgs:function(){var me=this,key,fields=me.fields,args=[],date=Ext.apply(me.dateDefaults,me.date||{}),time=Ext.apply(me.timeDefaults,me.time||{});for(key in fields){if(fields[key].checked){args.push({type:"datetime",comparison:me.compareMap[key],value:Ext.Date.format(me.getFieldValue(key),date.format+" "+time.format)})}}return args},setValue:function(value,preserve){var me=this,fields=me.fields,key,val,datepicker;for(key in fields){val=value[key];if(val){datepicker=me.menu.down('datepicker[itemId="'+key+'"]');datepicker.update(val);datepicker.value=val;fields[key].setChecked(true)}else if(!preserve){fields[key].setChecked(false)}}me.fireEvent("update",me)},validateRecord:function(record){var me=this,key,pickerValue,val=record.get(me.dataIndex);if(!Ext.isDate(val)){return false}val=val.getTime();for(key in me.fields){if(me.fields[key].checked){pickerValue=me.getFieldValue(key).getTime();if(key=="before"&&pickerValue<=val){return false}if(key=="after"&&pickerValue>=val){return false}if(key=="on"&&pickerValue!=val){return false}}}return true}});