Ext.define("Ext.ux.grid.menu.ListMenu",{extend:"Ext.menu.Menu",idField:"id",labelField:"text",loadingText:"Loading...",loadOnShow:true,single:false,plain:true,constructor:function(cfg){var me=this,gridStore;me.selected=[];me.addEvents("checkchange");me.callParent(arguments);gridStore=me.grid.store;if(me.store){me.add({text:me.loadingText,iconCls:"loading-indicator"});me.store.on("load",me.onLoad,me)}else if(gridStore.data.length){me.createMenuStore()}else{gridStore.on("load",me.createMenuStore,me,{single:true})}},destroy:function(){var me=this,store=me.store;if(store){if(me.autoStore){store.destroyStore()}else{store.un("unload",me.onLoad,me)}}me.callParent()},show:function(){var me=this;if(me.loadOnShow&&!me.loaded&&!me.store.loading){me.store.load()}me.callParent()},onLoad:function(store,records){var me=this,gid,itemValue,i,len,listeners={checkchange:me.checkChange,scope:me};Ext.suspendLayouts();me.removeAll(true);gid=me.single?Ext.id():null;for(i=0,len=records.length;i<len;i++){itemValue=records[i].get(me.idField);me.add(Ext.create("Ext.menu.CheckItem",{text:records[i].get(me.labelField),group:gid,checked:Ext.Array.contains(me.selected,itemValue),hideOnClick:false,value:itemValue,listeners:listeners}))}me.loaded=true;Ext.resumeLayouts(true);me.fireEvent("load",me,records)},createMenuStore:function(){var me=this,options=[],i,len,value;me.options=me.grid.store.collect(me.dataIndex,false,true);for(i=0,len=me.options.length;i<len;i++){value=me.options[i];switch(Ext.type(value)){case"array":options.push(value);break;case"object":options.push([value[me.idField],value[me.labelField]]);break;default:if(value!=null){options.push([value,value])}}}me.store=Ext.create("Ext.data.ArrayStore",{fields:[me.idField,me.labelField],data:options,listeners:{load:me.onLoad,scope:me}});me.loaded=true;me.autoStore=true},getSelected:function(){return this.selected},setSelected:function(value){value=this.selected=[].concat(value);if(this.loaded){this.items.each(function(item){item.setChecked(false,true);for(var i=0,len=value.length;i<len;i++){if(item.value==value[i]){item.setChecked(true,true)}}})}},checkChange:function(item,checked){var value=[];this.items.each(function(item){if(item.checked){value.push(item.value)}});this.selected=value;this.fireEvent("checkchange",item,checked)}});